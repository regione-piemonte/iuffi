package it.csi.iuffi.iuffiweb.integration;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.sql.Array;
import java.sql.CallableStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Vector;

import javax.sql.DataSource;

import org.apache.commons.validator.GenericValidator;
import org.springframework.dao.DataAccessException;
import org.springframework.jdbc.core.ResultSetExtractor;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.SqlOutParameter;
import org.springframework.jdbc.core.SqlParameter;
import org.springframework.jdbc.core.SqlReturnType;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcCall;
import org.springframework.jdbc.core.support.SqlLobValue;

import it.csi.iuffi.iuffiweb.dto.AmmCompetenzaDTO;
import it.csi.iuffi.iuffiweb.dto.AziendaDTO;
import it.csi.iuffi.iuffiweb.dto.DecodificaAmmCompentenza;
import it.csi.iuffi.iuffiweb.dto.DecodificaDTO;
import it.csi.iuffi.iuffiweb.dto.DecodificaSoggFirmatario;
import it.csi.iuffi.iuffiweb.dto.DomandaPagamentoProspettoEconomicoDTO;
import it.csi.iuffi.iuffiweb.dto.ElencoCduDTO;
import it.csi.iuffi.iuffiweb.dto.FornitoreDTO;
import it.csi.iuffi.iuffiweb.dto.GraduatoriaDTO;
import it.csi.iuffi.iuffiweb.dto.ImportoInterventoVO;
import it.csi.iuffi.iuffiweb.dto.ImportoLiquidatoDTO;
import it.csi.iuffi.iuffiweb.dto.IntegrazioneAlPremioDTO;
import it.csi.iuffi.iuffiweb.dto.IterProcedimentoOggettoDTO;
import it.csi.iuffi.iuffiweb.dto.ProcedimentoDTO;
import it.csi.iuffi.iuffiweb.dto.ProcedimentoEstrattoVO;
import it.csi.iuffi.iuffiweb.dto.ProcedimentoOggettoDTO;
import it.csi.iuffi.iuffiweb.dto.ProspettoEconomicoDTO;
import it.csi.iuffi.iuffiweb.dto.RiduzioniSanzioniDTO;
import it.csi.iuffi.iuffiweb.dto.RigaFiltroDTO;
import it.csi.iuffi.iuffiweb.dto.RipartizioneImportoDTO;
import it.csi.iuffi.iuffiweb.dto.VolturaDTO;
import it.csi.iuffi.iuffiweb.dto.estrazionecampione.EstrazioneACampioneDTO;
import it.csi.iuffi.iuffiweb.dto.estrazionecampione.NumeroLottoDTO;
import it.csi.iuffi.iuffiweb.dto.internal.LogParameter;
import it.csi.iuffi.iuffiweb.dto.internal.LogVariable;
import it.csi.iuffi.iuffiweb.dto.nuovoprocedimento.FileAllegatoDTO;
import it.csi.iuffi.iuffiweb.dto.nuovoprocedimento.LivelloDTO;
import it.csi.iuffi.iuffiweb.dto.nuovoprocedimento.OggettoDTO;
import it.csi.iuffi.iuffiweb.dto.permission.UpdatePermissionProcedimentoOggetto;
import it.csi.iuffi.iuffiweb.dto.plsql.EstrazioneCampioneDTO;
import it.csi.iuffi.iuffiweb.dto.plsql.MainControlloDTO;
import it.csi.iuffi.iuffiweb.dto.plsql.MainPunteggioDTO;
import it.csi.iuffi.iuffiweb.dto.procedimento.DocumentoSpesaVO;
import it.csi.iuffi.iuffiweb.dto.procedimento.OrganismoDelegatoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimento.TestataProcedimento;
import it.csi.iuffi.iuffiweb.dto.procedimento.TipoDocumentoSpesaVO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.IconaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.OggettoIconaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.ProcedimentoOggetto;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.ResponsabileDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.allegati.FileAllegatiDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.allegati.SelezioneInfoInserimentoAllegatiDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.anticipo.DatiAnticipoModificaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.anticipo.SospensioneAnticipoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.anticipo.SportelloBancaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.canalidivendita.CanaliDiVendita;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.canalidivendita.ImmaginiCanaliDiVendita;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.caratteristicheaziendali.CaratteristicheAziendali;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.caratteristicheaziendali.OrganismoControllo;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.consistenzaaziendale.ProduzioneAnimale;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.consistenzaaziendale.ProduzioneVegetale;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.conticorrenti.ContoCorrenteDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.conticorrenti.ContoCorrenteEstesoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.FonteControlloDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.GiustificazioneAnomaliaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlliamministrativi.ControlloAmministrativoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlliamministrativi.EsitoControlliAmmDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlliamministrativi.VisitaLuogoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlliamministrativi.VisitaLuogoExtDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlliinlocomisureinvestimento.ControlliInLocoInvestDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlliinlocomisureinvestimento.DatiSpecificiDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datafinelavori.DataFineLavoriDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.DatiAziendaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.DatiIdentificativi;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.DatiIdentificativiModificaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.DatiProcedimento;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.DatiRappresentanteLegaleDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.DatiSoggettoFirmatarioDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.datiidentificativi.SettoriDiProduzioneDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.dichiarazioni.DettaglioInfoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.dichiarazioni.GruppoInfoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.dichiarazioni.ValoriInseritiDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.esitofinale.EsitoFinaleDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.estrazionecampione.RigaSimulazioneEstrazioneDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.interventi.DecodificaInterventoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.interventi.RigaRendicontazioneDocumentiSpesaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.interventi.RigaRendicontazioneSpese;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.partecipanti.PartecipanteDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.pianiselettivi.RicercaDistretto;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.premioprestitoconduzione.PremiAllevamento;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.premioprestitoconduzione.PremiColture;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.produzionicertificate.ProduzioniCertificate;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.produzionicertificate.ProduzioniTradizionali;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.punteggi.CriterioVO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.punteggi.RaggruppamentoLivelloCriterio;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.regimeaiuto.RegimeAiuto;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.stampa.ProcedimOggettoStampaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.stampa.SegnapostoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.stampa.StampaOggettoDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.stampa.StampaOggettoIconaDTO;
import it.csi.iuffi.iuffiweb.dto.procedimentooggetto.trasformazioneprodotti.ProdottoTrasformato;
import it.csi.iuffi.iuffiweb.exception.ApplicationException;
import it.csi.iuffi.iuffiweb.exception.InternalUnexpectedException;
import it.csi.iuffi.iuffiweb.exception.IuffiPermissionException;
import it.csi.iuffi.iuffiweb.exception.IuffiPermissionException.ExceptionType;
import it.csi.iuffi.iuffiweb.util.IuffiConstants;
import it.csi.iuffi.iuffiweb.util.IuffiUtils;
import it.csi.smrcomms.siapcommws.dto.smrcomm.SiapCommWsDatiProtocolloVO;
import it.csi.solmr.dto.anag.services.DelegaAnagrafeVO;

public class QuadroDAO extends BaseDAO
{
  private static final String THIS_CLASS = QuadroDAO.class.getSimpleName();

  public QuadroDAO()
  {
  }

  public RegimeAiuto getRegimeAiutoProcedimentoOggetto(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimentoOggettoByIdProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select rar.ALTRO_ISTITUTO as altroistituto, rar.pec_istituto as pec, rar.email_istituto as email,\r\n"
        +
        " ra.descrizione_breve as descbreve, ra.descrizione_estesa as descestesa, bs.abi as abi, bs.cab as cab, bs.denominazione_banca as denominazione, \r\n"
        +
        " bs.indirizzo as indirizzo, bs.sigla_provincia as provincia, bs.descrizione_comune_sportello as desccomune, bs.cap as cap\r\n"
        +
        " from IUF_T_REGIME_AIUTO_RICHIESTO rar\r\n" +
        " left join IUF_T_REGIME_AIUTO_PREVISTO rap on rap.id_regime_aiuto_previsto = rar.id_regime_aiuto_previsto\r\n"
        +
        " left join IUF_D_REGIME_AIUTO ra on ra.id_regime_aiuto = rap.id_regime_aiuto\r\n"
        +
        " left join SMRGAA_V_BANCA_SPORTELLO bs on bs.id_sportello = rar.ext_id_sportello\r\n"
        +
        " where rar.id_procedimento_oggetto = :ID_PROCEDIMENTO_OGGETTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO", idProcedimento,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          RegimeAiuto.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_OGGETTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DatiIdentificativi getDatiIdentificativiProcedimentoOggetto(
      long idProcedimentoOggetto, long idQuadroOggetto, Date dataValidita,
      int idProcedimentoAgricolo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getDatiIdentificativiProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT DISTINCT                                                                                                       \n"
        + "   AC.DESCRIZIONE AS DESC_ORGANISMO_DELEGATO,                                                                                         \n"
        + "   AC.DENOMINAZIONE_1,						                                                                                         \n"
        + "   PA.EXT_ID_AMM_COMPETENZA AS ID_AMM_COMPETENZA,                                                                                 \n"
        + "   PO.NOTE,                                                                                                                           \n"
        + "   POQ.DATA_ULTIMO_AGGIORNAMENTO,                                                                                                     \n"
        + "   POQ.EXT_ID_UTENTE_AGGIORNAMENTO,                                                                                                   \n"
        + "   DA.CUAA,                                                                                                                           \n"
        + "   DA.ID_AZIENDA,                                                                                                                     \n"
        + "   DA.PARTITA_IVA,                                                                                                                    \n"
        + "   DA.INTESTAZIONE_PARTITA_IVA,                                                                                                       \n"
        + "   DA.DENOMINAZIONE,                                                                                                                  \n"
        + "   DA.DESCRIZIONE_FORMA_GIURIDICA,                                                                                                    \n"
        + "   DA.INDIRIZZO_SEDE_LEGALE,                                                                                                          \n"
        + "   DA.TELEFONO,                                                                                                                       \n"
        + "   DA.FAX,                                                                                                                            \n"
        + "   DA.MAIL,                                                                                                                           \n"
        + "   DA.PEC,                                                                                                                            \n"
        + "   DA.DESCRIZIONE_ATTIVITA_ATECO,                                                                                                     \n"
        + "   DA.CCIAA_NUMERO_REGISTRO_IMPRESE,                                                                                                  \n"
        + "   DA.CCIAA_ANNO_ISCRIZIONE,                                                                                                          \n"
        + "   SC.CODICE_FISCALE,                                                                                                                 \n"
        + "   SC.COGNOME,                                                                                                                        \n"
        + "   SC.NOME,                                                                                                                           \n"
        + "   SC.SESSO,                                                                                                                          \n"
        + "   SC.INDIRIZZO_RESIDENZA,                                                                                                            \n"
        + "   SC.NASCITA_DATA,                                                                                                                   \n"
        + "   SC.COMUNE_CITTA,                                                                                                                   \n"
        + "   SC.RES_TELEFONO AS RL_TELEFONO,                                                                                                    \n"
        + "   SC.RES_MAIL AS RL_MAIL,                                                                                                        	 \n"
        + "   SC1.CODICE_FISCALE AS CONT_CODICE_FISCALE,                                                                                         \n"
        + "   SC1.COGNOME AS CONT_COGNOME,                                                                                                       \n"
        + "   SC1.NOME AS CONT_NOME,                                                                                                             \n"
        + "   SC1.SESSO AS CONT_SESSO,                                                                                                           \n"
        + "   SC1.INDIRIZZO_RESIDENZA AS CONT_INDIRIZZO_RESIDENZA,                                                                               \n"
        + "   SC1.NASCITA_DATA AS CONT_NASCITA_DATA,                                                                                             \n"
        + "   SC1.DESCRIZIONE_RUOLO AS CONT_DESCR_RUOLO,                                                                                         \n"
        + "   SC1.COMUNE_CITTA AS CONT_COMUNE_CITTA,                                                                                             \n"
        + "   SC1.RES_TELEFONO AS RICHIEDENTE_TELEFONO,                                                                                          \n"
        + "   SC1.RES_MAIL AS RICHIEDENTE_MAIL,																									 \n"
        + "	  SP.ID_SETTORE_PRODUZIONE AS ID_SETTORE,  																							 \n"
        + "   SP.DESCRIZIONE AS DESCR_SETTORE, 																									 \n"
        + "   SP.DATA_INIZIO AS DATA_INIZIO,																									 \n"
        + "   SP.DATA_FINE AS DATA_FINE,       																									 \n"
        + "	  P.CODICE_CUP AS CODICE_CUP,																										 \n"
        + "	  P.NUMERO_VERCOD AS VERCOD,																										 \n"
        + "	  P.DATA_VISURA AS DATA_VISURA_CAMERALE,																							 \n"
        + "   AC.RESPONSABILE AS RESPONSABILE,																									 \n"
        + "	  (UZ.DENOMINAZIONE||' '|| UZ.INDIRIZZO) as Ufficio,																				 \n"
        + "   (DTE.COGNOME||' '|| DTE.NOME) as funzionario        		    																	 \n"
        + " FROM                                                                                                                                 \n"
        + "   IUF_T_PROCEDIMENTO P,                                                                                                              \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                                                     \n"
        + "   IUF_T_PROCEDIM_OGGETTO_QUADR POQ,                                                                                                 \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA,                                                                                                 \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA AC,                                                                                                     \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PAZ,                                                                                                    \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI  DA,                                                                                                      \n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC,                                                                                                    \n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC1,                                                                                                   \n"
        + "    IUF_D_SETTORE_PRODUZIONE SP,																										 \n"
        + "	  SMRCOMUNE_V_TECNICO TE,																										     \n"
        + "	  DB_TECNICO DTE,																													 \n"
        + "	  DB_UFFICIO_ZONA UZ																												 \n"
        + " WHERE                                                                                                                                \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                                              \n"
        + "   AND P.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO                                                                                         \n"
        + "   AND P.ID_PROCEDIMENTO = PA.ID_PROCEDIMENTO(+)                                                                                      \n"
        + "   AND PA.EXT_ID_AMM_COMPETENZA = AC.ID_AMM_COMPETENZA(+)                                                                             \n"
        + "   AND PO.ID_PROCEDIMENTO_OGGETTO = POQ.ID_PROCEDIMENTO_OGGETTO(+)                                                                    \n"
        + "   AND POQ.ID_QUADRO_OGGETTO(+) = :ID_QUADRO_OGGETTO                                                                                  \n"
        + "   AND NVL(:DATA_VALIDITA,SYSDATE) BETWEEN TRUNC(PAZ.DATA_INIZIO) AND NVL(PAZ.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY'))                 \n"
        + "   AND NVL(:DATA_VALIDITA,SYSDATE) BETWEEN TRUNC(NVL(PA.DATA_INIZIO,SYSDATE)) AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY'))      \n"
        + "   AND P.ID_PROCEDIMENTO  = PAZ.ID_PROCEDIMENTO                                                                                       \n"
        + "   AND PAZ.EXT_ID_AZIENDA = DA.ID_AZIENDA                                                                                             \n"
        + "   AND DA.ID_AZIENDA      = SC.ID_AZIENDA                                                                                             \n"
        + "   AND SC.ID_RUOLO     = 1                                                                                                            \n"
        + "   AND SC1.ID_CONTITOLARE(+) = PO.EXT_ID_CONTITOLARE                                                                                  \n"
        + "   AND TRUNC(NVL(:DATA_VALIDITA,SYSDATE)) BETWEEN DA.DATA_INIZIO_VALIDITA AND NVL(DA.DATA_FINE_VALIDITA, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "   AND TRUNC(NVL(:DATA_VALIDITA,SYSDATE)) BETWEEN SC.DATA_INIZIO_RUOLO AND NVL(SC.DATA_FINE_RUOLO, TO_DATE('31/12/9999','DD/MM/YYYY'))       \n"
        + "   AND SP.ID_SETTORE_PRODUZIONE(+) =  PO.ID_SETTORE_PRODUZIONE \n"
        + "   AND  Te.ID_AMM_COMPETENZA (+)= pa.EXT_ID_AMM_COMPETENZA   										\n"
        + "	  AND  Te.EXT_ID_PROCEDIMENTO (+) = " + idProcedimentoAgricolo
        + "														\n"
        + "	  AND  UZ.ID_UFFICIO_ZONA  (+)= pa.EXT_ID_UFFICIO_ZONA 												\n"
        + "   AND  DTE.ID_TECNICO (+) = pa.EXT_ID_TECNICO 		   												\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
        Types.NUMERIC);
    mapParameterSource.addValue("DATA_VALIDITA", dataValidita, Types.TIMESTAMP);
    try
    {
      DatiIdentificativi datiAzienda = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource,
          new ResultSetExtractor<DatiIdentificativi>()
          {

            @Override
            public DatiIdentificativi extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              DatiIdentificativi result = null;
              if (rs.next())
              {
                result = new DatiIdentificativi();
                DatiAziendaDTO azienda = new DatiAziendaDTO();
                azienda.setCuaa(rs.getString("CUAA"));
                azienda.setIdAzienda(rs.getLong("ID_AZIENDA"));
                azienda.setPartitaIva(rs.getString("PARTITA_IVA"));
                azienda.setItestazionePartitaIva(
                    rs.getString("INTESTAZIONE_PARTITA_IVA"));
                azienda.setDenominazione(rs.getString("DENOMINAZIONE"));
                azienda.setFormaGiuridica(
                    rs.getString("DESCRIZIONE_FORMA_GIURIDICA"));
                azienda.setIndirizzoSedeLegale(
                    rs.getString("INDIRIZZO_SEDE_LEGALE"));
                azienda.setTelefono(rs.getString("TELEFONO"));
                azienda.setFax(rs.getString("FAX"));
                azienda.setEmail(rs.getString("MAIL"));
                azienda.setPec(rs.getString("PEC"));
                azienda.setAttivitaAteco(
                    rs.getString("DESCRIZIONE_ATTIVITA_ATECO"));
                DatiRappresentanteLegaleDTO rappLegale = new DatiRappresentanteLegaleDTO();
                rappLegale.setCodiceFiscale(rs.getString("CODICE_FISCALE"));
                rappLegale.setCognome(rs.getString("COGNOME"));
                rappLegale.setNome(rs.getString("NOME"));
                rappLegale.setSesso(rs.getString("SESSO"));
                rappLegale
                    .setIndirizzoResidenza(rs.getString("INDIRIZZO_RESIDENZA"));
                rappLegale.setDataNascita(rs.getDate("NASCITA_DATA"));
                rappLegale.setLuogoNascita(rs.getString("COMUNE_CITTA"));
                rappLegale.setTelefono(rs.getString("RL_TELEFONO"));
                rappLegale.setMail(rs.getString("RL_MAIL"));
                DatiProcedimento datiProcedimento = new DatiProcedimento();
                datiProcedimento.setDataUltimoAggiornamento(
                    rs.getTimestamp("DATA_ULTIMO_AGGIORNAMENTO"));
                datiProcedimento
                    .setExtIdAmmCompetenza(rs.getLong("ID_AMM_COMPETENZA"));
                datiProcedimento.setNote(rs.getString("NOTE"));
                datiProcedimento.setOrganismoDelegato(
                    rs.getString("DESC_ORGANISMO_DELEGATO"));
                datiProcedimento
                    .setOrganismoDelegatoInfo(rs.getString("DENOMINAZIONE_1"));
                datiProcedimento.setExtIdUtenteAggiornamento(
                    rs.getLong("EXT_ID_UTENTE_AGGIORNAMENTO"));
                datiProcedimento.setCodiceCup(rs.getString("CODICE_CUP"));
                datiProcedimento.setFunzionario(rs.getString("FUNZIONARIO"));
                datiProcedimento.setUfficio(rs.getString("UFFICIO"));
                datiProcedimento.setResponsabile(rs.getString("RESPONSABILE"));
                datiProcedimento.setVercod(rs.getString("VERCOD"));
                datiProcedimento
                    .setDataVisuraCamerale(rs.getDate("DATA_VISURA_CAMERALE"));

                String contCognome = rs.getString("CONT_COGNOME");
                if (!GenericValidator.isBlankOrNull(contCognome))
                {
                  DatiSoggettoFirmatarioDTO firmatarioDTO = new DatiSoggettoFirmatarioDTO();
                  firmatarioDTO
                      .setCodiceFiscale(rs.getString("CONT_CODICE_FISCALE"));
                  firmatarioDTO.setCognome(rs.getString("CONT_COGNOME"));
                  firmatarioDTO
                      .setComuneCitta(rs.getString("CONT_COMUNE_CITTA"));
                  firmatarioDTO
                      .setDescrizioneRuolo(rs.getString("CONT_DESCR_RUOLO"));
                  firmatarioDTO.setIndirizzoResidenza(
                      rs.getString("CONT_INDIRIZZO_RESIDENZA"));
                  firmatarioDTO.setNascitaData(rs.getDate("CONT_NASCITA_DATA"));
                  firmatarioDTO.setNome(rs.getString("CONT_NOME"));
                  firmatarioDTO.setSesso(rs.getString("CONT_SESSO"));
                  firmatarioDTO
                      .setTelefono(rs.getString("RICHIEDENTE_TELEFONO"));
                  firmatarioDTO.setMail(rs.getString("RICHIEDENTE_MAIL"));
                  result.setSoggFirmatario(firmatarioDTO);
                }
                result.setAzienda(azienda);
                result.setRappLegale(rappLegale);
                result.setDatiProcedimento(datiProcedimento);
                Long idSettore = getLongNull(rs, "ID_SETTORE");
                if (idSettore != null)
                {
                  SettoriDiProduzioneDTO s = new SettoriDiProduzioneDTO();
                  s.setIdSettore(idSettore);
                  s.setDescrizione(rs.getString("DESCR_SETTORE"));
                  s.setDataInizio(rs.getDate("DATA_INIZIO"));
                  s.setDataFine(rs.getDate("DATA_FINE"));
                  result.setSettore(s);
                }
              }
              return result;
            }
          });
      // caricaDatiAttivitaOte(datiAzienda, dataValidita);
      caricaDatiSottosettoriOte(idProcedimentoOggetto, datiAzienda,
          dataValidita, idProcedimentoAgricolo);
      return datiAzienda;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idQuadroOggetto", idQuadroOggetto),
              new LogParameter("dataValidita", dataValidita) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DatiIdentificativi caricaDatiSottosettoriOte(
      final long idProcedimentoOggetto,
      final DatiIdentificativi datiIdentificativi, Date dataValidita,
      long idProcedimentoAgricolo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::caricaDatiSottosettoriOte]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                                                                                      			   \n"
        + "  NVL(DS.SOTTOSETTORI_AGGIUNTIVI, DS.SOTTOSETTORI) AS DESCR_SOTTOSETTORE                                      \n"
        + " FROM                                                                                                         \n"
        + "  SMRGAA_V_INDICATORI_AZIENDA IA,                                                                             \n"
        + "  IUF_D_OTE_SOTTOSETTORI DS                                                                                   \n"
        + " WHERE                                                                                                        \n"
        + "  IA.ID_TIPO_GREENING(+)                 = 12                                                                 \n"
        + "  AND IA.ID_DICHIARAZIONE_CONSISTENZA(+) = PCK_IUF_UTILITY.ReturnDichConsistenza(:ID_AZIENDA, :DATA_VALIDITA, :ID_PROCEDIMENTO_AGRICOLO) \n"
        + "  AND DS.CODICE_OTE = SUBSTR(IA.VALORE_CALCOLATO_VARCHAR2,1,3)                                                \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_AZIENDA",
        datiIdentificativi.getAzienda().getIdAzienda(), Types.NUMERIC);
    mapParameterSource.addValue("DATA_VALIDITA", dataValidita, Types.TIMESTAMP);
    mapParameterSource.addValue("ID_PROCEDIMENTO_AGRICOLO",
        idProcedimentoAgricolo);

    try
    {
      DatiIdentificativi datiAzienda = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<DatiIdentificativi>()
          {
            @Override
            public DatiIdentificativi extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                final DatiAziendaDTO azienda = datiIdentificativi.getAzienda();
                azienda.setSottosettoreOte(rs.getString("DESCR_SOTTOSETTORE"));
              }
              return datiIdentificativi;
            }
          });
      return datiAzienda;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("datiIdentificativi", datiIdentificativi),
              new LogParameter("dataValidita", dataValidita) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /*
   * public DatiIdentificativi caricaDatiAttivitaOte(final DatiIdentificativi
   * datiIdentificativi, Date dataValidita) throws InternalUnexpectedException {
   * String THIS_METHOD = "[" + THIS_CLASS + "::caricaDatiAttivitaOte]"; if
   * (logger.isDebugEnabled()) { logger.debug(THIS_METHOD + " BEGIN."); }
   * 
   * final String QUERY =
   * " SELECT                                                                                                        \n"
   * +
   * "   IA.VALORE_CALCOLATO_VARCHAR2 AS DESCRIZIONE_ATTIVITA_OTE,                                                   \n"
   * +
   * "   IA.DESCRIZIONE_TIPO_GREENING AS LABEL_ATTIVITA_OTE                                                                   \n"
   * +
   * " FROM                                                                                                          \n"
   * +
   * "   SMRGAA_V_INDICATORI_AZIENDA IA                                                                              \n"
   * +
   * " WHERE                                                                                                         \n"
   * +
   * "   IA.ID_TIPO_GREENING(+)                 = 12                                                                 \n"
   * +
   * "   AND IA.ID_DICHIARAZIONE_CONSISTENZA(+) = PCK_IUF_UTILITY.ReturnDichConsistenza(:ID_AZIENDA, :DATA_VALIDITA) \n"
   * ; MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
   * mapParameterSource.addValue("ID_AZIENDA",
   * datiIdentificativi.getAzienda().getIdAzienda(), Types.NUMERIC);
   * mapParameterSource.addValue("DATA_VALIDITA", dataValidita,
   * Types.TIMESTAMP); try { DatiIdentificativi datiAzienda =
   * namedParameterJdbcTemplate.query(QUERY, mapParameterSource, new
   * ResultSetExtractor<DatiIdentificativi>() {
   * 
   * @Override public DatiIdentificativi extractData(ResultSet rs) throws
   * SQLException, DataAccessException { if (rs.next()) { final DatiAziendaDTO
   * azienda = datiIdentificativi.getAzienda();
   * azienda.setAttivitaOte(rs.getString("DESCRIZIONE_ATTIVITA_OTE"));
   * azienda.setLabelAttivitaOte(rs.getString("LABEL_ATTIVITA_OTE")); } return
   * datiIdentificativi; } }); return datiAzienda;
   * 
   * } catch (Throwable t) { InternalUnexpectedException e = new
   * InternalUnexpectedException(t, new LogParameter[] { new
   * LogParameter("datiIdentificativi", datiIdentificativi), new
   * LogParameter("dataValidita", dataValidita) }, new LogVariable[] {}, QUERY,
   * mapParameterSource); logInternalUnexpectedException(e, THIS_METHOD); throw
   * e; } finally { if (logger.isDebugEnabled()) { logger.debug(THIS_METHOD +
   * " END."); } } }
   */
  public DatiIdentificativiModificaDTO getDatiIdentificativiModificaProcedimentoOggetto(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getDatiIdentificativiModificaProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                   \n"
        + "   PA.EXT_ID_AMM_COMPETENZA,                             \n"
        + "   PO.EXT_ID_CONTITOLARE,                                \n"
        + "   PO.NOTE,												\n"
        + "	  SP.ID_SETTORE_PRODUZIONE AS ID_SETTORE,  				\n"
        + "   SP.DESCRIZIONE AS DESCR_SETTORE, 						\n"
        + "   SP.DATA_INIZIO AS DATA_INIZIO,						\n"
        + "   SP.DATA_FINE AS DATA_FINE                     		\n"
        + " FROM                                                    \n"
        + "   IUF_T_PROCEDIMENTO P,                                 \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                        \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA,					\n"
        + "   IUF_D_SETTORE_PRODUZIONE SP                  			\n"
        + " WHERE                                                   \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND P.ID_PROCEDIMENTO      = PO.ID_PROCEDIMENTO       \n"
        + "   AND P.ID_PROCEDIMENTO      = PA.ID_PROCEDIMENTO(+)	\n"
        + "   AND SP.ID_SETTORE_PRODUZIONE(+) =  PO.ID_SETTORE_PRODUZIONE    \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      DatiIdentificativiModificaDTO datiAzienda = namedParameterJdbcTemplate
          .query(QUERY, mapParameterSource,
              new ResultSetExtractor<DatiIdentificativiModificaDTO>()
              {

                @Override
                public DatiIdentificativiModificaDTO extractData(ResultSet rs)
                    throws SQLException, DataAccessException
                {
                  DatiIdentificativiModificaDTO result = null;
                  if (rs.next())
                  {
                    result = new DatiIdentificativiModificaDTO();
                    result.setIdAmmCompetenza(
                        getLongNull(rs, "EXT_ID_AMM_COMPETENZA"));
                    result.setIdContitolare(
                        getLongNull(rs, "EXT_ID_CONTITOLARE"));
                    result.setNote(rs.getString("NOTE"));
                    SettoriDiProduzioneDTO s = new SettoriDiProduzioneDTO();
                    s.setIdSettore(rs.getLong("ID_SETTORE"));
                    s.setDescrizione(rs.getString("DESCR_SETTORE"));
                    s.setDataInizio(rs.getDate("DATA_INIZIO"));
                    s.setDataFine(rs.getDate("DATA_FINE"));
                    result.setSettore(s);

                  }
                  return result;
                }
              });
      return datiAzienda;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaAmmCompentenza> getListAmmCompetenzaAbilitateBando(
      long idBando)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getListAmmCompetenzaAbilitateBando]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                             \n"
        + "   AC.ID_AMM_COMPETENZA,                            \n"
        + "   AC.CODICE_AMMINISTRAZIONE as CODICE,             \n"
        + "   AC.DESCRIZIONE || DECODE(AC.DENOMINAZIONE_1,NULL,'', ' - ' || AC.DENOMINAZIONE_1 )AS DESCRIZIONE                                   \n"
        + " FROM                                               \n"
        + "   IUF_D_BANDO_AMM_COMPETENZA BAC,                  \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA AC                    \n"
        + " WHERE                                              \n"
        + "   BAC.EXT_ID_AMM_COMPETENZA = AC.ID_AMM_COMPETENZA \n"
        + "   AND BAC.ID_BANDO = :ID_BANDO                     \n"
        + " ORDER BY DESCRIZIONE ASC                           \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_BANDO", idBando, Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          DecodificaAmmCompentenza.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idBando", idBando)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaSoggFirmatario> getListSoggettiFirmatari(
      long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getListSoggettiFirmatari]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                \n"
        + "  SC.ID_CONTITOLARE,                                                   \n"
        + "   SC.COGNOME || ' '||                                                 \n"
        + "   SC.NOME || ' - '||                                                  \n"
        + "   SC.DESCRIZIONE_RUOLO AS DESCRIZIONE,                                \n"
        + "   SC.ID_RUOLO AS CODICE                                               \n"
        + " FROM                                                                  \n"
        + "       IUF_T_PROCEDIMENTO P,                                           \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                      \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PAZ,                                     \n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC                                      \n"
        + " WHERE                                                                 \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO               \n"
        + "   AND PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                          \n"
        + "   AND PAZ.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                         \n"
        + "   AND PAZ.DATA_FINE IS NULL                                           \n"
        + "   AND SC.ID_AZIENDA = PAZ.EXT_ID_AZIENDA                              \n"
        + "   AND (SC.ID_RUOLO = 1                                                \n"
        + "    OR SC.FLAG_POTERE_FIRMA = 'S')                                     \n"
        + "   AND SC.DATA_FINE_RUOLO IS NULL                                      \n"
        + " ORDER BY                                                              \n"
        + "   DECODE(SC.ID_RUOLO,1, NULL, COGNOME || ' ' || NOME) ASC NULLS FIRST \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          DecodificaSoggFirmatario.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void lockProcedimento(long idProcedimento)
  {
    final String QUERY = " SELECT 1 FROM IUF_T_PROCEDIMENTO WHERE ID_PROCEDIMENTO = :ID_PROCEDIMENTO FOR UPDATE ";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    queryForLong(QUERY, mapParameterSource);
  }

  public void updateNoteProcedimentoOggetto(long idProcedimentoOggetto,
      String note, long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateNoteProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO                                  \n"
        + " SET                                                           \n"
        + "   NOTE                        = :NOTE,                        \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO = :EXT_ID_UTENTE_AGGIORNAMENTO, \n"
        + "   DATA_ULTIMO_AGGIORNAMENTO   = SYSDATE                       \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("note", note),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateContitolareProcedimentoOggetto(long idProcedimentoOggetto,
      String idContitolare, long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateContitolareProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO                                  \n"
        + " SET                                                           \n"
        + "   EXT_ID_CONTITOLARE = :EXT_ID_CONTITOLARE,                   \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO = :EXT_ID_UTENTE_AGGIORNAMENTO, \n"
        + "   DATA_ULTIMO_AGGIORNAMENTO   = SYSDATE                       \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("EXT_ID_CONTITOLARE", idContitolare,
          Types.VARCHAR);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idContitolare", idContitolare),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public UpdatePermissionProcedimentoOggetto canUpdateProcedimentoOggetto(
      long idProcedimentoOggetto) throws IuffiPermissionException,
      InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::canUpdateProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                 \n"
        + "   PO.DATA_FINE AS PO_DATA_FINE,                                        \n"
        + "   CASE                                                                 \n"
        + "     WHEN SYSDATE BETWEEN BO.DATA_INIZIO AND NVL(BO.DATA_RITARDO, NVL(BO.DATA_FINE, SYSDATE)) \n"
        + "     THEN NULL                                                          \n"
        + "     ELSE BO.DATA_FINE                                                  \n"
        + "   END            AS BO_DATA_FINE,                                      \n"
        + "   BO.FLAG_ATTIVO AS BO_FLAG_ATTIVO,                                    \n"
        + "   BO.ID_BANDO_OGGETTO AS ID_BANDO_OGGETTO,                             \n"
        + "   BO.FLAG_ATTIVO AS BO_FLAG_ATTIVO,                                    \n"
        + "   (                                                                    \n"
        + "     SELECT                                                             \n"
        + "       COUNT(*)                                                         \n"
        + "     FROM                                                               \n"
        + "       IUF_T_NOTIFICA N,												   \n"
        + "		  IUF_D_GRAVITA_NOTIFICA G                                         \n"
        + "     WHERE                                                              \n"
        + "       N.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                            \n"
        + "       AND N.ID_GRAVITA_NOTIFICA = G.ID_GRAVITA_NOTIFICA		           \n"
        + "       AND N.CODICE     = 'B'                                           \n"
        + "       AND N.DATA_FINE  IS NULL                                         \n"
        + "   ) AS COUNT_NOTIFICHE_BLOCCANTI,                                      \n"
        + "   (                                                                    \n"
        + "     SELECT                                                             \n"
        + "       COUNT(*)                                                         \n"
        + "     FROM                                                               \n"
        + "       IUF_T_NOTIFICA N,												   \n"
        + "		  IUF_D_GRAVITA_NOTIFICA G                                         \n"
        + "     WHERE                                                              \n"
        + "       N.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                            \n"
        + "       AND N.ID_GRAVITA_NOTIFICA = G.ID_GRAVITA_NOTIFICA		           \n"
        + "       AND G.CODICE = 'G'                     						   \n"
        + "       AND N.DATA_FINE  IS NULL                                         \n"
        + "   ) AS COUNT_NOTIFICHE_GRAVI,	                                       \n"
        + " FROM                                                                   \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                       \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                                     \n"
        + "   IUF_R_BANDO_OGGETTO BO,                                              \n"
        + "   IUF_T_PROCEDIMENTO P                                                 \n"
        + " WHERE                                                                  \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO      = :ID_PROCEDIMENTO_OGGETTO           \n"
        + "   AND PO.DATA_FINE               IS NULL                               \n"
        + "   AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO       \n"
        + "   AND LGO.ID_LEGAME_GRUPPO_OGGETTO= BO.ID_LEGAME_GRUPPO_OGGETTO        \n"
        + "   AND PO.ID_PROCEDIMENTO          = P.ID_PROCEDIMENTO                  \n"
        + "   AND P.ID_BANDO                  = BO.ID_BANDO                        \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      UpdatePermissionProcedimentoOggetto status = namedParameterJdbcTemplate
          .query(QUERY, mapParameterSource,
              new ResultSetExtractor<UpdatePermissionProcedimentoOggetto>()
              {

                @Override
                public UpdatePermissionProcedimentoOggetto extractData(
                    ResultSet rs) throws SQLException, DataAccessException
                {
                  UpdatePermissionProcedimentoOggetto status = null;
                  if (rs.next())
                  {
                    status = new UpdatePermissionProcedimentoOggetto();
                    status.setDataFineProcedimentoOggetto(
                        rs.getDate("PO_DATA_FINE"));
                    status.setDataFineBandoOggetto(rs.getDate("BO_DATA_FINE"));
                    status.setFlagBandoOggettoAttivo(
                        rs.getString("BO_FLAG_ATTIVO"));
                    status.setCountNotificheBloccanti(
                        rs.getInt("COUNT_NOTIFICHE_BLOCCANTI"));
                    status.setCountNotificheGravi(
                        rs.getInt("COUNT_NOTIFICHE_GRAVI"));
                  }
                  return status;
                }
              });
      if (status != null)
      {
        if (status.getDataFineProcedimentoOggetto() != null)
        {
          throw new IuffiPermissionException(
              ExceptionType.PROCEDIMENTO_OGGETTO_CHIUSO);
        }
        if (status.getDataFineBandoOggetto() != null)
        {
          throw new IuffiPermissionException(
              ExceptionType.PROCEDIMENTO_CHIUSO);
        }
        if (IuffiConstants.FLAGS.SI
            .equals(status.getFlagBandoOggettoAttivo()))
        {
          throw new IuffiPermissionException(
              ExceptionType.OGGETTO_BANDO_NON_ATTIVO);
        }
        if (status.getCountNotificheBloccanti() > 0)
        {
          if (status.getFlagIstanza() != null
              && status.getFlagIstanza().compareTo("N") == 0)
            throw new IuffiPermissionException(
                ExceptionType.NOTIFICHE_BLOCCANTI);
        }
        if (status.getCountNotificheGravi() > 0)
        {
          throw new IuffiPermissionException(ExceptionType.NOTIFICHE_GRAVI);
        }
      }
      else
      {
        throw new IuffiPermissionException(
            ExceptionType.PROCEDIMENTO_OGGETTO_NON_TROVATO);
      }
      return status;
    }
    catch (IuffiPermissionException p)
    {
      throw p;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean updateAmmCompetenzaByIdProcedimentoOggetto(
      long idProcedimentoOggetto, int idAmmCompetenza,
      long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateAmmCompetenzaByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                          		\n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO                                \n"
        + " SET                                                             \n"
        + "   EXT_ID_AMM_COMPETENZA       = :ID_AMM_COMPETENZA,             \n"
        + "   EXT_ID_TECNICO       = NULL,					                \n"
        + "   EXT_ID_UFFICIO_ZONA = NULL,					                \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO = :EXT_ID_UTENTE_AGGIORNAMENTO    \n"
        + " WHERE                                                           \n"
        + "   ID_PROCEDIM_AMMINISTRAZIONE=                                  \n"
        + "   (                                                             \n"
        + "     SELECT                                                      \n"
        + "       ID_PROCEDIM_AMMINISTRAZIONE                               \n"
        + "     FROM                                                        \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO OP,                            \n"
        + "       IUF_T_PROCEDIM_AMMINISTRAZIO PA                         \n"
        + "     WHERE                                                       \n"
        + "       OP.ID_PROCEDIMENTO             = PA.ID_PROCEDIMENTO       \n"
        + "       AND PA.DATA_FINE IS NULL                                  \n"
        + "       AND OP.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   )                                                             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_AMM_COMPETENZA", idAmmCompetenza,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource) > 0;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idAmmCompetenza", idAmmCompetenza),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean updateAmmCompetenzaByIdProcedimentoOggetto(
      long idProcedimentoOggetto, long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateAmmCompetenzaByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                          		\n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO                                \n"
        + " SET                                                             \n"
        + "   EXT_ID_TECNICO       = NULL,					                \n"
        + "   EXT_ID_UFFICIO_ZONA = NULL,					                \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO = :EXT_ID_UTENTE_AGGIORNAMENTO    \n"
        + " WHERE                                                           \n"
        + "   ID_PROCEDIM_AMMINISTRAZIONE=                                  \n"
        + "   (                                                             \n"
        + "     SELECT                                                      \n"
        + "       ID_PROCEDIM_AMMINISTRAZIONE                               \n"
        + "     FROM                                                        \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO OP,                            \n"
        + "       IUF_T_PROCEDIM_AMMINISTRAZIO PA                         \n"
        + "     WHERE                                                       \n"
        + "       OP.ID_PROCEDIMENTO             = PA.ID_PROCEDIMENTO       \n"
        + "       AND PA.DATA_FINE IS NULL                                  \n"
        + "       AND OP.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   )                                                             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource) > 0;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertAmmCompetenzaProcedimento(long idProcedimento,
      int idAmmCompetenza, long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::insertAmmCompetenzaByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO            \n"
        + "   (                                         \n"
        + "     ID_PROCEDIM_AMMINISTRAZIONE,            \n"
        + "     ID_PROCEDIMENTO,                        \n"
        + "     EXT_ID_AMM_COMPETENZA,                  \n"
        + "     DATA_INIZIO,                            \n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO             \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_PROCEDIM_AMMINISTR.NEXTVAL, \n"
        + "     :ID_PROCEDIMENTO,                       \n"
        + "     :EXT_ID_AMM_COMPETENZA,                 \n"
        + "     SYSDATE,                                \n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO            \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AMM_COMPETENZA", idAmmCompetenza,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idAmmCompetenza", idAmmCompetenza),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getAziendaAgricolaProcedimento(long idProcedimento, Date date)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAziendaAgricolaProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                                                 \n"
        + "   PA.EXT_ID_AZIENDA                                                                                                    \n"
        + " FROM                                                                                                                   \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PA                                                                                        \n"
        + " WHERE                                                                                                                  \n"
        + "   PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                                                                                \n"
        + "   AND NVL(:DATA_RIFERIMENTO, SYSDATE) BETWEEN PA.DATA_INIZIO AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY')) \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", date, Types.TIMESTAMP);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("date", date)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public AziendaDTO getDatiAziendaAgricolaProcedimento(long idProcedimento,
      Date date) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getDatiAziendaAgricolaProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                 \n"
        + "   ID_AZIENDA ,                                                         \n"
        + "   DATA_INIZIO_VALIDITA ,                                               \n"
        + "   DATA_FINE_VALIDITA ,                                                 \n"
        + "   CUAA ,                                                               \n"
        + "   PARTITA_IVA ,                                                        \n"
        + "   DENOMINAZIONE ,                                                      \n"
        + "   ID_FORMA_GIURIDICA ,                                                 \n"
        + "   DESCRIZIONE_FORMA_GIURIDICA ,                                        \n"
        + "   DESCRIZIONE_ATTIVITA_ATECO ,                                         \n"
        + "   MAIL ,                                                               \n"
        + "   ISTAT_COMUNE_SEDE_LEGALE ,                                           \n"
        + "   INDIRIZZO_SEDE_LEGALE ,                                              \n"
        + "   DATA_CESSAZIONE ,                                                    \n"
        + "   INTESTAZIONE_PARTITA_IVA ,                                           \n"
        + "   TELEFONO ,                                                           \n"
        + "   FAX ,                                                                \n"
        + "   PEC ,                                                                \n"
        + "   CCIAA_ANNO_ISCRIZIONE ,                                              \n"
        + "   CCIAA_NUMERO_REA ,                                                   \n"
        + "   CCIAA_NUMERO_REGISTRO_IMPRESE,                                       \n"
        + "   ID_TIPOLOGIA_AZIENDA ,                                               \n"
        + "   TIPOLOGIA_AZIENDA                                                    \n"
        + " FROM                                                                   \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PA,                                       \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI DA                                             \n"
        + " WHERE                                                                  \n"
        + "   PA.EXT_ID_AZIENDA = DA.ID_AZIENDA                                    \n"
        + "   AND NVL(:DATA_RIFERIMENTO, SYSDATE)                                  \n"
        + "     BETWEEN PA.DATA_INIZIO                                             \n"
        + "     AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY'))          \n"
        + "   AND NVL(:DATA_RIFERIMENTO, SYSDATE)                                  \n"
        + "     BETWEEN DA.DATA_INIZIO_VALIDITA                                    \n"
        + "     AND NVL(DA.DATA_FINE_VALIDITA, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "   AND PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                            \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", date, Types.TIMESTAMP);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<AziendaDTO>()
          {

            @Override
            public AziendaDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                DatiAziendaDTO azienda = new DatiAziendaDTO();
                azienda.setCuaa(rs.getString("CUAA"));
                azienda.setIdAzienda(rs.getLong("ID_AZIENDA"));
                azienda.setPartitaIva(rs.getString("PARTITA_IVA"));
                azienda.setItestazionePartitaIva(
                    rs.getString("INTESTAZIONE_PARTITA_IVA"));
                azienda.setDenominazione(rs.getString("DENOMINAZIONE"));
                azienda.setFormaGiuridica(
                    rs.getString("DESCRIZIONE_FORMA_GIURIDICA"));
                azienda.setIndirizzoSedeLegale(
                    rs.getString("INDIRIZZO_SEDE_LEGALE"));
                azienda.setTelefono(rs.getString("TELEFONO"));
                azienda.setFax(rs.getString("FAX"));
                azienda.setEmail(rs.getString("MAIL"));
                azienda.setPec(rs.getString("PEC"));
                azienda.setAttivitaAteco(
                    rs.getString("DESCRIZIONE_ATTIVITA_ATECO"));
                return azienda;
              }
              else
              {
                return null;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("date", date)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DatiAziendaDTO getDatiAziendaDtoAgricolaProcedimento(
      long idProcedimento, Date date) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getDatiAziendaAgricolaProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                 \n"
        + "   ID_AZIENDA ,                                                         \n"
        + "   DATA_INIZIO_VALIDITA ,                                               \n"
        + "   DATA_FINE_VALIDITA ,                                                 \n"
        + "   CUAA ,                                                               \n"
        + "   PARTITA_IVA ,                                                        \n"
        + "   DENOMINAZIONE ,                                                      \n"
        + "   ID_FORMA_GIURIDICA ,                                                 \n"
        + "   DESCRIZIONE_FORMA_GIURIDICA ,                                        \n"
        + "   DESCRIZIONE_ATTIVITA_ATECO ,                                         \n"
        + "   MAIL ,                                                               \n"
        + "   ISTAT_COMUNE_SEDE_LEGALE ,                                           \n"
        + "   INDIRIZZO_SEDE_LEGALE ,                                              \n"
        + "   DATA_CESSAZIONE ,                                                    \n"
        + "   INTESTAZIONE_PARTITA_IVA ,                                           \n"
        + "   TELEFONO ,                                                           \n"
        + "   FAX ,                                                                \n"
        + "   PEC ,                                                                \n"
        + "   CCIAA_ANNO_ISCRIZIONE ,                                              \n"
        + "   CCIAA_NUMERO_REA ,                                                   \n"
        + "   CCIAA_NUMERO_REGISTRO_IMPRESE,                                       \n"
        + "   ID_TIPOLOGIA_AZIENDA ,                                               \n"
        + "   TIPOLOGIA_AZIENDA                                                    \n"
        + " FROM                                                                   \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PA,                                       \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI DA                                             \n"
        + " WHERE                                                                  \n"
        + "   PA.EXT_ID_AZIENDA = DA.ID_AZIENDA                                    \n"
        + "   AND NVL(:DATA_RIFERIMENTO, SYSDATE)                                  \n"
        + "     BETWEEN PA.DATA_INIZIO                                             \n"
        + "     AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY'))          \n"
        + "   AND NVL(:DATA_RIFERIMENTO, SYSDATE)                                  \n"
        + "     BETWEEN DA.DATA_INIZIO_VALIDITA                                    \n"
        + "     AND NVL(DA.DATA_FINE_VALIDITA, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "   AND PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                            \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", date, Types.TIMESTAMP);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<DatiAziendaDTO>()
          {

            @Override
            public DatiAziendaDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                DatiAziendaDTO azienda = new DatiAziendaDTO();
                azienda.setCuaa(rs.getString("CUAA"));
                azienda.setIdAzienda(rs.getLong("ID_AZIENDA"));
                azienda.setPartitaIva(rs.getString("PARTITA_IVA"));
                azienda.setItestazionePartitaIva(
                    rs.getString("INTESTAZIONE_PARTITA_IVA"));
                azienda.setDenominazione(rs.getString("DENOMINAZIONE"));
                azienda.setFormaGiuridica(
                    rs.getString("DESCRIZIONE_FORMA_GIURIDICA"));
                azienda.setIndirizzoSedeLegale(
                    rs.getString("INDIRIZZO_SEDE_LEGALE"));
                azienda.setTelefono(rs.getString("TELEFONO"));
                azienda.setFax(rs.getString("FAX"));
                azienda.setEmail(rs.getString("MAIL"));
                azienda.setPec(rs.getString("PEC"));
                azienda.setAttivitaAteco(
                    rs.getString("DESCRIZIONE_ATTIVITA_ATECO"));
                return azienda;
              }
              else
              {
                return null;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("date", date)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimentoOggetto getProcedimentoOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                          \n"
        + "  PO.ID_PROCEDIMENTO,                                            \n"
        + "  PO.ID_PROCEDIMENTO_OGGETTO,                                    \n"
        + "  PO.EXT_COD_ATTORE AS CODICE_ATTORE,                            \n"
        + "  PO.EXT_ID_UTENTE_AGGIORNAMENTO AS ID_UTENTE_AGGIORNAMENTO,     \n"
        + "  PO.DATA_FINE,                                                  \n"
        + "  PO.DATA_INIZIO,                                                \n"
        + "  PO.CODICE_RAGGRUPPAMENTO,                                                \n"
        + "  PO.ID_ESITO,		                                              \n"
        + "  PO.ID_ATTO_AMMI,                                                 \n"
        + "  PO.IDENTIFICATIVO,                                             \n"
        + "  PO.FLAG_PREMIO_ACCERTATO,                                      \n"
        + "  O.FLAG_ISTANZA,                                                \n"
        + "  O.DESCRIZIONE,                                                 \n"
        + "  O.FLAG_AMMISSIONE,                                             \n"
        + "  O.CODICE AS COD_OGGETTO,                                       \n"
        + "  IPO.DATA_INIZIO AS DATA_INIZIO_LAST_ITER,                      \n"
        + "  IPO.ID_STATO_OGGETTO,					                      \n"
        + "  E.DESCRIZIONE AS DESC_ESITO,                                   \n"
        + "  E.CODICE AS CODICE_ESITO,         	                          \n"
        + "  SO.DESCRIZIONE AS DESC_STATO ,                                 \n"
        + "  IPO2.NOTE AS SPECIFICITA,                                      \n"
        + "  PO.FLAG_VALIDAZIONE_GRAFICA                                    \n"
        + " FROM                                                            \n"
        + "  IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "  IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                               \n"
        + "  IUF_D_OGGETTO O,                                               \n"
        + "  IUF_D_ESITO E,                                                 \n"
        + "  IUF_T_ITER_PROCEDIMENTO_OGGE IPO,                            \n"
        + "  IUF_T_ITER_PROCEDIMENTO_OGGE IPO2,                           \n"
        + "  IUF_D_STATO_OGGETTO SO                                         \n"
        + " WHERE                                                           \n"
        + "  PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n"
        + "  AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "  AND LGO.ID_OGGETTO = O.ID_OGGETTO                              \n"
        + "  AND PO.ID_ESITO = E.ID_ESITO(+)                                \n"
        + "  AND PO.ID_PROCEDIMENTO_OGGETTO = IPO.ID_PROCEDIMENTO_OGGETTO   \n"
        + "  AND IPO.DATA_FINE IS NULL                                      \n"
        + "  AND IPO.ID_STATO_OGGETTO = SO.ID_STATO_OGGETTO                 \n"
        + "  AND IPO2.ID_ITER_PROCEDIMENTO_OGGETT =                         \n"
        + "  (SELECT                                                        \n"
        + "     MIN(ID_ITER_PROCEDIMENTO_OGGETT)                            \n"
        + "   FROM                                                          \n"
        + "     IUF_T_ITER_PROCEDIMENTO_OGGE IPO2                         \n"
        + "   WHERE                                                         \n"
        + "     IPO2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO     \n"
        + "   )                                                             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          ProcedimentoOggetto.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_OGGETTO", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimentoOggetto getProcedimentoOggettoByIdProcedimento(
      long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimentoOggettoByIdProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " WITH PROCEDIMENTIOGGETTO AS (                                     \n"
        + "  SELECT                                                           \n"
        + "    PO.ID_PROCEDIMENTO,                                            \n"
        + "    PO.ID_PROCEDIMENTO_OGGETTO,                                    \n"
        + "    PO.EXT_COD_ATTORE AS CODICE_ATTORE,                            \n"
        + "    PO.DATA_FINE ,                                                 \n"
        + "    PO.ID_ESITO ,                                                  \n"
        + "    PO.FLAG_PREMIO_ACCERTATO,                                      \n"
        + "    PO.EXT_ID_UTENTE_AGGIORNAMENTO AS ID_UTENTE_AGGIORNAMENTO,     \n"
        + "    PO.DATA_INIZIO,                                                \n"
        + "    IPO.DATA_INIZIO AS DATA_INIZIO_LAST_ITER,                      \n"
        + "    IPO.ID_STATO_OGGETTO,					                        \n"
        + "    IPO2.NOTE AS SPECIFICITA,                                      \n"
        + "    PO.IDENTIFICATIVO,                                             \n"
        + "    O.DESCRIZIONE,                                                 \n"
        + "    O.FLAG_AMMISSIONE,                                                 \n"
        + "    O.FLAG_ISTANZA,                                                 \n"
        + "    E.DESCRIZIONE  AS DESC_ESITO,                                  \n"
        + "    SO.DESCRIZIONE AS DESC_STATO                                   \n"
        + "  FROM                                                             \n"
        + "    IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "    IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                               \n"
        + "    IUF_D_OGGETTO O,                                               \n"
        + "    IUF_D_ESITO E,                                                 \n"
        + "    IUF_T_ITER_PROCEDIMENTO_OGGE IPO,                            \n"
        + "    IUF_T_ITER_PROCEDIMENTO_OGGE IPO2,                            \n"
        + "    IUF_D_STATO_OGGETTO SO                                         \n"
        + "  WHERE                                                            \n"
        + "    PO.ID_PROCEDIMENTO              = :ID_PROCEDIMENTO             \n"
        + "    AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "    AND LGO.ID_OGGETTO              = O.ID_OGGETTO                 \n"
        + "    AND PO.ID_ESITO                 = E.ID_ESITO(+)                \n"
        + "    AND PO.ID_PROCEDIMENTO_OGGETTO  = IPO.ID_PROCEDIMENTO_OGGETTO  \n"
        + "    AND IPO.DATA_FINE              IS NULL                         \n"
        + "    AND IPO.ID_STATO_OGGETTO        = SO.ID_STATO_OGGETTO          \n"
        + " 	AND IPO2.ID_ITER_PROCEDIMENTO_OGGETT =                      	\n"
        + "  (SELECT                                                    		\n"
        + "     MIN(ID_ITER_PROCEDIMENTO_OGGETT)                        		\n"
        + "   FROM                                                      		\n"
        + "     IUF_T_ITER_PROCEDIMENTO_OGGE IPO2                     		\n"
        + "   WHERE                                                     		\n"
        + "     IPO2.ID_PROCEDIMENTO_OGGETTO = IPO.ID_PROCEDIMENTO_OGGETTO 		\n"
        + "   )                                                         		\n"
        + "  ORDER BY                                                         \n"
        + "    PO.ID_PROCEDIMENTO_OGGETTO DESC                                \n"
        + " )                                                                 \n"
        + " SELECT * FROM PROCEDIMENTIOGGETTO WHERE ROWNUM = 1                \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          ProcedimentoOggetto.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public CaratteristicheAziendali getCaratteristicheAziendali(
      long idProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimentoOggettoByIdProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT nab.id_azienda_bio AS ID, nab.denominazione AS DENOMINAZIONE, nab.descrizione AS DESCRIZIONE, \r\n"
        +
        "nab.altro_tipo_attivita AS ALTROTIPOATTIVITA, cab.DESC_ODC AS DESCODC, mc.descrizione AS DESCMETODOCOLT, FP.descrizione AS DESCFILIERA, \r\n"
        +
        "m.descrizione AS DESCMULTI, nab.altra_filiera_produttiva AS ALTRAFILIERA, nab.altra_multifunzionalita AS ALTRAFUNZ, \r\n"
        +
        "nab.desc_trasformazione_prodotti AS DESCTRASFORMAZIONE, cab.desc_cat_attivita AS DESCCATATTIVA, nab.ext_cod_ue_odc AS cododc"
        +
        " FROM IUF_T_AZIENDA_BIO NAB\r\n" +
        "LEFT JOIN ABIO.ABIO_V_CATEGORIE_ATTIVITA_BIO CAB ON nab.ext_cod_ue_odc = cab.cod_ue_odc\r\n"
        +
        "LEFT JOIN IUF_R_AZIENDA_BIO_ATTIVITA ABA ON aba.id_azienda_bio = nab.id_azienda_bio\r\n"
        +
        "LEFT JOIN IUF_R_AZIENDA_BIO_METODO_COL BMC ON BMC.ID_AZIENDA_BIO = nab.id_azienda_bio\r\n"
        +
        "LEFT JOIN IUF_D_METODO_COLTIVAZIONE MC ON mc.id_metodo_coltivazione = bmc.id_metodo_coltivazione\r\n"
        +
        "LEFT JOIN IUF_R_AZIENDA_BIO_FILIERA_PR BFP ON BFP.ID_AZIENDA_BIO = nab.id_azienda_bio\r\n"
        +
        "LEFT JOIN IUF_D_FILIERA_PRODUTTIVA FP ON fp.id_filiera_produttiva = bfp.id_filiera_produttiva\r\n"
        +
        "LEFT JOIN IUF_R_AZIENDA_BIO_MULTIFUNZ ABF ON ABF.ID_AZIENDA_BIO = nab.id_azienda_bio\r\n"
        +
        "LEFT JOIN IUF_D_MULTIFUNZIONALITA M ON m.id_multifunzionalita = abf.id_multifunzionalita\r\n"
        +
        "WHERE NAB.ID_DATI_PROCEDIMENTO = (\r\n" +
        "  SELECT ID_DATI_PROCEDIMENTO FROM IUF_T_DATI_PROCEDIMENTO NDP WHERE NDP.ID_PROCEDIMENTO_OGGETTO =  :ID_PROCEDIMENTO)\r\n"
        +
        "  \r\n" +
        "\r\n" +
        "\r\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          CaratteristicheAziendali.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public CanaliDiVendita getCanaliDiVendita(long idDatiProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getCanaliDiVendita]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select " +
        "c.id_contatti as id, " +
        "c.amazon as amazon, " +
        "c.altro_canale_vendita as altrocanale, " +
        "c.come_arrivare as comearrivate, " +
        "c.dettagli_mercati as dettaglimercati, " +
        "c.email_vendita as email, " +
        "c.facebook as facebook, " +
        "c.indirizzo_vendita as indirizzo, " +
        "c.instagram as instagram, " +
        "c.note as note, " +
        "c.orari_apertura as orari, " +
        "c.sito_web as sitoweb, " +
        "c.telefono_vendita as telefono, " +
        "c.id_img_agriq as idimmagine, " +
        "im.IMMAGINE as immagine, " +
        "im.descrizione as descimmagine " +
        "from IUF_t_contatti C " +
        "inner join IUF_D_IMG_AGRIQ im on c.id_img_agriq = im.id_img_agriq where c.id_dati_procedimento =:ID_DATI_PROCEDIMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          CanaliDiVendita.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProduzioneAnimale> getProduzioniAnimali(long idDatiProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniAnimali]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT distinct A.CODICE_AZIENDA_ZOOTECNICA as codiceaziendazootecnica, "
        + "A.DESCRIZIONE_SPECIE_ANIMALE as specieanimale, "
        + "AA.ID_PUBBLICA_ALLEVAMENTO as id, "
        + "A.DESCRIZIONE_CATEGORIA_ANIMALE as categoriaanimale, "
        + "A.QUANTITA || ' (' || A.UNITA_MISURA_SPECIE || ')' as quantita, "
        + "DECODE(A.FLAG_BIOLOGICO, 'S', 'Si', 'N', 'No') as produzionebiologica, "
        + "AA.FLAG_PUBBLICA as pubblica \r\n" +
        "FROM   SMRGAA_V_ALLEVAMENTI A, IUF_T_PUBBLICA_ALLEVAMENTO AA \r\n" +
        "WHERE  A.ID_ALLEVAMENTO = AA.EXT_ID_ALLEVAMENTO \r\n" +
        "AND      A.ID_SPECIE_ANIMALE = AA.EXT_ID_SPECIE_ANIMALE \r\n" +
        "AND      A.ID_CATEGORIA_ANIMALE = AA.EXT_ID_CATEGORIA_ANIMALE \r\n" +
        "AND      AA.ID_DATI_PROCEDIMENTO = :ID_DATI_PROCEDIMENTO \r\n" +
        " ORDER BY codiceaziendazootecnica, specieanimale, categoriaanimale";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ProduzioneAnimale.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<PremiColture> getPremiColture(long idProcedimentoOggetto,
      long idDichCons) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getPremiColture]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select distinct(scu.desc_tipo_utilizzo) AS TIPO, pc.superficie_premio AS SUPERFICIE, pc.importo_unitario AS IMPORTOUNITARIO, pc.importo_premio AS IMPORTOPREMIO from IUF_T_PREMIO_COLTURE PC "
        +
        "left join SMRGAA_V_CONDUZIONE_UTILIZZO SCU on pc.ext_id_utilizzo = scu.id_utilizzo AND scu.id_dichiarazione_consistenza = :ID_DICHIARAZIONE_CONSISTENZA "
        +
        "where pc.id_procedimento_oggetto = :ID_PROCEDIMENTO_OGGETTO order by scu.desc_tipo_utilizzo";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_DICHIARAZIONE_CONSISTENZA", idDichCons,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, PremiColture.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_OGGETTO", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public MainPunteggioDTO calcolaPremio(final long idProcedimento,
      final long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "calcolaPremio";
    StringBuffer CALL = new StringBuffer("PCK_IUF_CALCOLO_PRESTITO.Main");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("pIdProcedimentoOggetto", idProcedimento,
          Types.NUMERIC);
      parameterSource.addValue("pExtIdUtente", idProcedimentoOggetto,
          Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_CALCOLO_PRESTITO")
              .withProcedureName("Main").withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("pIdProcedimentoOggetto", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("pExtIdUtente", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainPunteggioDTO dto = new MainPunteggioDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public List<PremiAllevamento> getPremiAllevamento(long idProcedimentoOggetto,
      long idDichCons) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getPremiAllevamento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select distinct(scu.descrizione_specie_animale) AS SPECIE, scu.descrizione_categoria_animale AS CATEGORIA, pc.uba_premio UBA, pc.importo_premio AS IMPORTOPREMIO, pc.importo_unitario AS IMPORTOUNITARIO, da.coefficiente_uba AS coefficiente \r\n"
        +
        " from IUF_T_PREMIO_ALLEVAM PC \r\n" +
        " left join SMRGAA_V_ALLEVAMENTI SCU on pc.EXT_ID_CATEGORIA_ANIMALE = scu.ID_CATEGORIA_ANIMALE AND SCU.ID_DICHIARAZIONE_CONSISTENZA = :ID_DICHIARAZIONE_CONSISTENZA\r\n"
        +
        " left join SMRGAA_V_DECO_ALLEVAMENTI DA on DA.ID_SPECIE_ANIMALE = pc.EXT_id_specie and DA.ID_CATEGORIA_ANIMALE = pc.EXT_id_categoria_animale \r\n"
        +
        " where pc.id_procedimento_oggetto = :ID_PROCEDIMENTO_OGGETTO order by scu.descrizione_specie_animale, scu.descrizione_categoria_animale";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_DICHIARAZIONE_CONSISTENZA", idDichCons,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, PremiAllevamento.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_OGGETTO", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProdottoTrasformato> getProdottoTrasformato(
      long idDatiProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniAnimali]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select pt.id_dati_procedimento as iddatiprocedimento, "
        + "pt.id_prodotto idprodotto, pt.id_prodotto_trasformato as idprodottotrasformato, "
        + "pt.note_biologico as note, p.descrizione as descrizione  "
        + "from IUF_T_PRODOTTO_TRASFORMATO PT \r\n" +
        "left join IUF_d_prodotto P on p.data_fine_validita is null  and p.id_prodotto = pt.id_prodotto \r\n"
        +
        "where pt.id_dati_procedimento = :ID_DATI_PROCEDIMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ProdottoTrasformato.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProduzioniCertificate> getProduzioniCertificate(
      long idDatiProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniCertificate]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select pa.id_produzione_azienda as id, tp.descrizione as descprod, tp.id_tipo_produzione as idprod, pc.descrizione as descprodcert, pc.id_produzione_certificata as idprodcert, rq.descrizione as descqualita, pa.flag_bio as bio "
        +
        "from IUF_T_PRODUZIONE_AZIENDA PA " +
        "left join IUF_D_PRODUZIONE_CERTIFICATA PC on pc.id_produzione_certificata = pa.id_produzione_certificata "
        +
        "left join IUF_D_TIPO_PRODUZIONE TP on tp.id_tipo_produzione = pc.id_tipo_produzione "
        +
        "left join IUF_D_REGIME_QUALITA RQ on rq.id_regime_qualita = pc.id_regime_qualita "
        +
        "where pa.id_produzione_certificata is not null  and pa.id_dati_procedimento = :ID_DATI_PROCEDIMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          ProduzioniCertificate.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProduzioniTradizionali> getProduzioniTradizionali(
      long idDatiProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniTradizionali]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select pa.id_produzione_azienda as id, tp.descrizione as descprod, "
        +
        "tp.id_tipo_produzione as idprod, " +
        "pc.descrizione as descprodtrad, \r\n" +
        "pc.id_produzione_tradizionale as idprodtrad, " +
        "pa.flag_bio as bio " +
        "from IUF_T_PRODUZIONE_AZIENDA PA " +
        "left join IUF_D_PRODUZIONE_TRADIZIONAL PC on pc.id_produzione_tradizionale = pa.id_produzione_tradizionale "
        +
        "left join IUF_D_TIPO_PRODUZIONE TP on tp.id_tipo_produzione = pc.id_tipo_produzione "
        +
        "where pa.id_produzione_tradizionale is not null  and pa.id_dati_procedimento = :ID_DATI_PROCEDIMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          ProduzioniTradizionali.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaProdottiTrasformati(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaProdottiTrasformati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_PRODOTTO_TRASFORMATO                                     \n"
        + " WHERE ID_DATI_PROCEDIMENTO = :ID_DATI_PROCEDIMENTO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaProduzioni(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaProdottiTrasformati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_PRODUZIONE_AZIENDA                                     \n"
        + " WHERE ID_DATI_PROCEDIMENTO = :ID_DATI_PROCEDIMENTO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public void eliminaCanaliVendita(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaCanaliVendita]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_CONTATTI                                     \n"
        + " WHERE ID_DATI_PROCEDIMENTO = :ID_DATI_PROCEDIMENTO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public void eliminaCanaliVenditaContatti(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaCanaliVenditaContatti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_R_CONTATTI_CANALE_VENDIT                                     \n"
        + " WHERE ID_CONTATTI = :ID_CONTATTI \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_CONTATTI",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CONTATTI", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaProdottiTrasformati(long azienda, long prodotto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaProdottiTrasformati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_PRODOTTO_TRASFORMATO                                     \n"
        + " WHERE ID_DATI_PROCEDIMENTO = :ID_DATI_PROCEDIMENTO AND ID_PRODOTTO = :ID_PRODOTTO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO",
          azienda, Types.NUMERIC);
      mapParameterSource.addValue("ID_PRODOTTO",
          prodotto, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProduzioneAnimale> getProduzioniAnimaliInserimento(
      long idDatiProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniAnimaliInserimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT distinct A.ID_ALLEVAMENTO as idallevamento, "
        + "A.ID_SPECIE_ANIMALE as idspecieanimale, "
        + "A.ID_CATEGORIA_ANIMALE as idcategoria, "
        + "A.CODICE_AZIENDA_ZOOTECNICA as codiceaziendazootecnica, "
        + "A.DESCRIZIONE_SPECIE_ANIMALE as specieanimale, "
        + "A.DESCRIZIONE_CATEGORIA_ANIMALE as categoriaanimale, "
        + "A.QUANTITA || ' (' || A.UNITA_MISURA_SPECIE || ')' as quantita , "
        + "DECODE(A.FLAG_BIOLOGICO, 'S', 'Si', 'N', 'No') as produzionebiologica\r\n"
        +
        "FROM   SMRGAA_V_ALLEVAMENTI A,SMRGAA_V_DICH_CONSISTENZA DC, IUF_T_PROCEDIMENTO_OGGETTO PO, IUF_T_PROCEDIMENTO P\r\n"
        +
        "WHERE  PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO\r\n" +
        "AND    PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO\r\n" +
        "AND    DC.ID_DICHIARAZIONE_CONSISTENZA = PO.EXT_ID_DICHIARAZIONE_CONSISTEN\r\n"
        +
        "AND    DC.ID_PROCEDIMENTO              = P.ID_PROCEDIMENTO_AGRICOLO\r\n"
        +
        "AND    A.ID_DICHIARAZIONE_CONSISTENZA = DC.ID_DICHIARAZIONE_CONSISTENZA\r\n"
        +
        "ORDER BY codiceAziendaZootecnica, specieAnimale, categoriaAnimale\r\n"
        +
        "";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ProduzioneAnimale.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProduzioneVegetale> getProduzioniVegetali(long idDatiProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniVegetali]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT  distinct CU.DESC_COMUNE || ' (' || CU.SIGLA_PROVINCIA || ')' as comune, "
        + "CU.SEZIONE as sez, "
        + "AP.ID_PUBBLICA_PARTICELLA as id, "
        + "CU.FOGLIO as fg, "
        + "CU.PARTICELLA as part, "
        + "CU.SUBALTERNO as sub, "
        + "'[' || CU.COD_TIPO_UTILIZZO || '] ' || CU.DESC_TIPO_UTILIZZO as usoDelSuolo, "
        + "decode(CU.FLAG_BIOLOGICO, 'S', 'Si', 'N', 'No') as produzioneBiologica, "
        + "AP.FLAG_PUBBLICA as pubblica\r\n" +
        "FROM   SMRGAA_V_CONDUZIONE_UTILIZZO CU, IUF_T_PUBBLICA_PARTICELLA AP\r\n"
        +
        "WHERE  CU.ID_CONDUZIONE_DICHIARATA = AP.EXT_ID_CONDUZIONE_DICHIARATA\r\n"
        +
        "AND      CU.ID_UTILIZZO_DICHIARATO = AP.EXT_ID_UTILIZZO_DICHIARATO\r\n"
        +
        "AND      AP.ID_DATI_PROCEDIMENTO = :ID_DATI_PROCEDIMENTO \r\n" +
        " order by comune, sez, to_number(fg), to_number(part), sub, usoDelSuolo";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ProduzioneVegetale.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProduzioneVegetale> getProduzioniVegetaliInserimento(
      long idDatiProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProduzioniVegetaliInserimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT  distinct CU.ID_CONDUZIONE_DICHIARATA as idconduzione, "
        + "CU.ID_UTILIZZO_DICHIARATO as idutilizzodichirato, "
        + "CU.ID_UTILIZZO as idutilizzo, "
        + "CU.DESC_COMUNE || ' (' || CU.SIGLA_PROVINCIA || ')' as comune, "
        + "CU.SEZIONE as sez, "
        + "CU.FOGLIO as fg, "
        + "CU.PARTICELLA as part, "
        + "CU.SUBALTERNO as sub, "
        + "'[' || CU.COD_TIPO_UTILIZZO || '] ' || CU.DESC_TIPO_UTILIZZO as usodelsuolo, "
        + "decode(CU.FLAG_BIOLOGICO, 'S', 'Si', 'N', 'No') as produzionebiologica\r\n"
        +
        "FROM   SMRGAA_V_DICH_CONSISTENZA DC,SMRGAA_V_CONDUZIONE_UTILIZZO CU, IUF_T_PROCEDIMENTO_OGGETTO PO, IUF_T_PROCEDIMENTO P\r\n"
        +
        "WHERE  PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO\r\n" +
        "AND    PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO\r\n" +
        "AND    DC.ID_DICHIARAZIONE_CONSISTENZA = PO.EXT_ID_DICHIARAZIONE_CONSISTEN\r\n"
        +
        "AND    DC.ID_PROCEDIMENTO               = P.ID_PROCEDIMENTO_AGRICOLO\r\n"
        +
        "AND    CU.ID_DICHIARAZIONE_CONSISTENZA  = DC.ID_DICHIARAZIONE_CONSISTENZA\r\n"
        +
        "AND    CU.ID_TITOLO_POSSESSO           != 5--si escludono i terreni in asservimento\r\n"
        +
        "AND    CU.FLAG_SAU           = 'S'--si considerano solo i terreni ad uso agricolo\r\n"
        +
        "order by comune, sez, to_number(fg), to_number(part), sub, usoDelSuolo\r\n"
        +
        "";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO", idDatiProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ProduzioneVegetale.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO", idDatiProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getDenominazioneAziendaById(long idAzienda)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT DENOMINAZIONE FROM SMRGAA_V_DATI_ANAGRAFICI SDA \r\n"
        +
        "WHERE DATA_FINE_VALIDITA IS NULL AND ID_AZIENDA = \r\n" +
        "  (SELECT EXT_ID_AZIENDA FROM IUF_T_PROCEDIMENTO_AZIENDA PA WHERE PA.ID_PROCEDIMENTO = :ID_AZIENDA \r\n"
        +
        "   AND ((SELECT PO.DATA_FINE FROM IUF_T_PROCEDIMENTO_OGGETTO PO WHERE ID_PROCEDIMENTO = :ID_AZIENDA) IS NULL OR\r\n"
        +
        "  (SELECT PO.DATA_FINE FROM IUF_T_PROCEDIMENTO_OGGETTO PO WHERE ID_PROCEDIMENTO = :ID_AZIENDA) BETWEEN TO_DATE(sda.data_inizio_validita, 'DD/MM/YYYY')\r\n"
        +
        "AND TO_DATE(sda.data_fine_validita, 'DD/MM/YYYY')))";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA", idAzienda, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("ID_AZIENDA", idAzienda) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public OrganismoControllo getOrganismoControllo(long idAzienda)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT DISTINCT C.COD_UE_ODC AS codueodc\r\n" + 
        ",C.DESC_ODC AS descodc\r\n" + 
        "FROM ABIO.ABIO_V_AZIENDE_BIOLOGICHE AZ\r\n" + 
        ",ABIO.ABIO_V_CATEGORIE_ATTIVITA_BIO C, IUF_T_PROCEDIMENTO_OGGETTO PO\r\n" + 
        "WHERE C.EXT_ID_AZIENDA=AZ.EXT_ID_AZIENDA\r\n" + 
        "AND AZ.ID_CATEGORIA_ATTIVITA=C.ID_CATEGORIA_ATTIVITA\r\n" + 
        "AND C.DT_FINE_ATT_BIO IS NULL\r\n" + 
        "AND C.DT_FINE_VAL_POS IS NULL\r\n" + 
        "AND AZ.DATA_FINE_POSIZIONE_ATTUALE IS NULL\r\n" + 
        "AND AZ.FLAG_GIA_IDONEA='S'\r\n" + 
        "AND AZ.FLAG_PRESENZA_DOC_GIUSTIFICAT='S'\r\n" + 
        "AND (AZ.ID_STATO_ATTIVITA IN (1, 6) OR (AZ.ID_STATO_ATTIVITA = 7 AND AZ.DATA_FINE_DOC_GIUST > TRUNC(SYSDATE)))\r\n" + 
        "AND AZ.EXT_ID_AZIENDA = (SELECT EXT_ID_AZIENDA FROM IUF_T_PROCEDIMENTO_AZIENDA PA WHERE PA.ID_PROCEDIMENTO = :ID_AZIENDA)\r\n" + 
        "AND ((po.data_fine IS NULL OR po.data_fine BETWEEN TO_DATE(az.data_inizio_attivita, 'DD/MM/YYYY')\r\n" + 
        "AND TO_DATE(az.data_fine_attivita, 'DD/MM/YYYY')))";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA", idAzienda, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          OrganismoControllo.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("ID_AZIENDA", idAzienda) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<GruppoInfoDTO> getDichiarazioniOggetto(
      final long idProcedimentoOggetto, long idQuadroOggetto,
      long idBandoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDichiarazioniOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                             \n"
        + "   G.ID_GRUPPO_INFO,                                                                               \n"
        + "   G.DESCRIZIONE,                                                                                  \n"
        + "   D.ID_DETTAGLIO_INFO,                                                                            \n"
        + "   D.DESCRIZIONE AS DESCRIZIONE_INFO,                                                              \n"
        + "   D.FLAG_OBBLIGATORIO,                                                                            \n"
        + "   D.FLAG_GESTIONE_FILE,                                                                           \n"
        + "   D.EXT_ID_TIPO_DOCUMENTO  AS EXT_ID_TIPO_DOCUMENTO,                                              \n"
        + "   I.ID_SELEZIONE_INFO,                                                                            \n"
        + "   D.ID_LEGAME_INFO,		                                                                          \n"
        + "   ( SELECT EXT_ID_UTENTE_AGGIORNAMENTO FROM IUF_T_PROCEDIM_OGGETTO_QUADR 						   \n"
        + " 		WHERE  G.ID_QUADRO_OGGETTO = ID_QUADRO_OGGETTO                                            \n"
        + "   		AND I.ID_PROCEDIMENTO_OGGETTO = ID_PROCEDIMENTO_OGGETTO                                   \n"
        + "   		AND G.ID_BANDO_OGGETTO = ID_BANDO_OGGETTO ) AS EXT_ID_UTENTE_AGGIORNAMENTO  ,             \n"
        + "   F.TIPO_VINCOLO                                                                              	  \n"
        + " FROM                                                                                              \n"
        + "   IUF_D_GRUPPO_INFO G,                                                                            \n"
        + "   IUF_D_DETTAGLIO_INFO D,                                                                         \n"
        + "   IUF_T_SELEZIONE_INFO I,                                                                         \n"
        + "   IUF_D_LEGAME_INFO E,                                                                            \n"
        + "   IUF_D_VINCOLO_INFO F                                                                            \n"
        + " WHERE                                                                                             \n"
        + "   G.ID_GRUPPO_INFO = D.ID_GRUPPO_INFO   														  \n"
        + "   AND I.ID_DETTAGLIO_INFO(+) = D.ID_DETTAGLIO_INFO                                                \n"
        + "   AND I.ID_PROCEDIMENTO_OGGETTO (+) =  :ID_PROCEDIMENTO_OGGETTO                                   \n"
        + "   AND E.ID_LEGAME_INFO(+) = D.ID_LEGAME_INFO 													  \n"
        + "   AND E.ID_VINCOLO_DICHIARAZIONE = F.ID_VINCOLO_DICHIARAZIONE(+)								  \n"
        + "   AND G.ID_QUADRO_OGGETTO = :ID_QUADRO_OGGETTO                                                    \n"
        + "   AND G.ID_BANDO_OGGETTO = :ID_BANDO_OGGETTO                                                      \n"
        + " ORDER BY G.ORDINE, D.ORDINE                                                                       \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO_OGGETTO", idBandoOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<GruppoInfoDTO>>()
          {

            @Override
            public List<GruppoInfoDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<GruppoInfoDTO> list = new ArrayList<GruppoInfoDTO>();
              Long lastKey = null;
              List<DettaglioInfoDTO> info = null;
              while (rs.next())
              {
                long idGruppoInfo = rs.getLong("ID_GRUPPO_INFO");
                if (lastKey == null || lastKey != idGruppoInfo)
                {
                  GruppoInfoDTO gruppoInfoDTO = null;
                  gruppoInfoDTO = new GruppoInfoDTO();
                  gruppoInfoDTO.setDescrizione(rs.getString("DESCRIZIONE"));
                  gruppoInfoDTO.setIdGruppoInfo(rs.getLong("ID_GRUPPO_INFO"));
                  gruppoInfoDTO.setIdUtenteAggiornamento(
                      rs.getLong("EXT_ID_UTENTE_AGGIORNAMENTO"));
                  info = new ArrayList<DettaglioInfoDTO>();
                  gruppoInfoDTO.setDettaglioInfo(info);
                  list.add(gruppoInfoDTO);
                  lastKey = idGruppoInfo;
                }

                DettaglioInfoDTO infoDTO = new DettaglioInfoDTO();
                infoDTO.setDescrizione(rs.getString("DESCRIZIONE_INFO"));
                infoDTO.setFlagGestioneFile(rs.getString("FLAG_GESTIONE_FILE"));
                infoDTO.setFlagObbligatorio(rs.getString("FLAG_OBBLIGATORIO"));
                infoDTO.setIdDettaglioInfo(rs.getLong("ID_DETTAGLIO_INFO"));
                infoDTO.setIdTipoDocumento(rs.getLong("EXT_ID_TIPO_DOCUMENTO"));
                infoDTO.setIdSelezioneInfo(rs.getLong("ID_SELEZIONE_INFO"));
                infoDTO.setIdLegameInfo(rs.getLong("ID_LEGAME_INFO"));
                infoDTO.setTipoVincolo(rs.getString("TIPO_VINCOLO"));
                if (infoDTO.getIdSelezioneInfo() != null
                    && infoDTO.getIdSelezioneInfo().longValue() > 0)
                  infoDTO.setChecked(true);
                try
                {
                  infoDTO.setValoriInseriti(getValoriInseriti(
                      idProcedimentoOggetto, rs.getLong("ID_DETTAGLIO_INFO")));
                }
                catch (Exception e)
                {
                  throw new SQLException(e);
                }

                info.add(infoDTO);
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idQuadroOggetto", idQuadroOggetto),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idBandoOggetto", idBandoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public TestataProcedimento getTestataProcedimento(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getTestataProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                    \n"
        + "   DA.ID_AZIENDA,                                         \n"
        + "   DA.CUAA,                                               \n"
        + "   DA.DENOMINAZIONE AS DENOMINAZIONE_AZIENDA,             \n"
        + "   DA.DATA_CESSAZIONE AS DATA_CESSAZIONE_AZIENDA,         \n"
        + "   DA.MOTIVO_CESSAZIONE,         						 \n"
        + "   B.ANNO_CAMPAGNA,                                       \n"
        + "   B.DATA_INIZIO AS DATA_INIZIO_BANDO,                    \n"
        + "   B.DENOMINAZIONE as DENOMINAZIONE_BANDO,                \n"
        + "   PA.EXT_ID_AMM_COMPETENZA AS ID_AMM_COMPETENZA,     	 \n"
        + "   AC.DESC_BREVE_TIPO_AMMINISTRAZ  AS DESC_BREVE_AMM_COMPETENZA, \n"
        + "   AC.DESCRIZIONE AS DESC_AMM_COMPETENZA,                 \n"
        + "   AC.DENOMINAZIONE_1,                 					 \n"
        + "   AC.DENOMINAZIONE_2,                 					 \n"
        + "   SO.DESCRIZIONE AS DESC_STATO_OGGETTO,                  \n"
        + "   L.CODICE AS COD_MISURA,						         \n"
        + "   L.CODICE || ' - ' || L.DESCRIZIONE AS MISURA,          \n"
        + "   UZ.DENOMINAZIONE AS DESC_UFFICIO_ZONA,                 \n"
        + "   T.COGNOME || ' ' || T.NOME AS DESCR_FUNZ,			   	 \n"
        + "   DECODE (LB.DATA_AMMISSIONE, NULL,NULL,' - Data Ammissione: ' || TO_CHAR(LB.DATA_AMMISSIONE, 'DD/MM/YYYY') ) AS DATA_AMMISSIONE          \n"
        + " FROM                                                     \n"
        + "   IUF_T_PROCEDIMENTO P,                                  \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA,                     \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PAZ,                        \n"
        + "   IUF_D_BANDO B,                                         \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI DA,                           \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA AC,                         \n"
        + "   DB_UFFICIO_ZONA UZ,                                	 \n"
        + "   DB_TECNICO T,		                              		 \n"
        + "   IUF_D_STATO_OGGETTO SO,                                \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO LB,                         \n"
        + "   IUF_D_LIVELLO L                                        \n"
        + " WHERE                                                    \n"
        + "   P.ID_PROCEDIMENTO     = :ID_PROCEDIMENTO               \n"
        + "   AND P.ID_BANDO        = B.ID_BANDO                     \n"
        + "   AND P.ID_PROCEDIMENTO = PAZ.ID_PROCEDIMENTO            \n"
        + "   AND PAZ.EXT_ID_AZIENDA = DA.ID_AZIENDA                 \n"
        + "   AND PAZ.DATA_FINE IS NULL                              \n"
        + "   AND DA.DATA_FINE_VALIDITA IS NULL                      \n"
        + "   AND P.ID_PROCEDIMENTO = PA.ID_PROCEDIMENTO(+)          \n"
        + "   AND PA.DATA_FINE     IS NULL                           \n"
        + "   AND PA.EXT_ID_AMM_COMPETENZA = AC.ID_AMM_COMPETENZA(+) \n"
        + "   AND P.ID_STATO_OGGETTO = SO.ID_STATO_OGGETTO           \n"
        + "   AND UZ.ID_UFFICIO_ZONA(+) = PA.EXT_ID_UFFICIO_ZONA  	 \n"
        + "   AND T.ID_TECNICO(+) = PA.EXT_ID_TECNICO			  	 \n"
        + "   AND P.ID_PROCEDIMENTO = LB.ID_PROCEDIMENTO             \n"
        + "   AND L.ID_LIVELLO = LB.ID_LIVELLO                       \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<TestataProcedimento>()
          {

            @Override
            public TestataProcedimento extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              TestataProcedimento result = null;
              while (rs.next())
              {
                if (result == null)
                {
                  result = new TestataProcedimento();
                  result.setIdAzienda(rs.getLong("ID_AZIENDA"));
                  result.setCuaa(rs.getString("CUAA"));
                  result.setDenominazioneAzienda(
                      rs.getString("DENOMINAZIONE_AZIENDA"));
                  result.setDataCessazioneAzienda(
                      rs.getTimestamp("DATA_CESSAZIONE_AZIENDA"));
                  result.setAnnoCampagna(getIntegerNull(rs, "ANNO_CAMPAGNA"));
                  result.setMotivoCessazione(rs.getString("MOTIVO_CESSAZIONE"));
                  result
                      .setDataInizioBando(rs.getTimestamp("DATA_INIZIO_BANDO"));
                  result.setDenominazioneBando(
                      rs.getString("DENOMINAZIONE_BANDO"));
                  result.setDescAmmCompetenza(
                      rs.getString("DESC_AMM_COMPETENZA"));
                  result
                      .setDescStatoOggetto(rs.getString("DESC_STATO_OGGETTO"));
                  result.setDescBreveAmmCompetenza(
                      rs.getString("DESC_BREVE_AMM_COMPETENZA"));
                  result.setDenominazioneAmmCompetenzaDue(
                      rs.getString("DENOMINAZIONE_2"));
                  result.setDenominazioneAmmCompetenzaUno(
                      rs.getString("DENOMINAZIONE_1"));
                  result.setIdAmmCompetenza(rs.getLong("ID_AMM_COMPETENZA"));
                  result.setMisure(new ArrayList<String>());
                  result.setCodMisure(new ArrayList<String>());
                  result.setDescUfficioZona(rs.getString("DESC_UFFICIO_ZONA"));
                  result
                      .setDescFunzionarioIstruttore(rs.getString("DESCR_FUNZ"));
                }
                String data = rs.getString("DATA_AMMISSIONE");
                if (data != null)
                {
                  result.getMisure().add(rs.getString("MISURA") + " " + data);
                }
                else
                {
                  result.getMisure().add(rs.getString("MISURA"));
                }
                result.getCodMisure().add(rs.getString("COD_MISURA"));
              }
              return result;
            }
          });

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long insertSelezioneInfo(long idProcedimentoOggetto,
      long idDettaglioInfo) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertSelezioneInfo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_SELEZIONE_INFO 	\n"
        + " (ID_SELEZIONE_INFO, 				\n"
        + "	 ID_PROCEDIMENTO_OGGETTO, 			\n"
        + "	 ID_DETTAGLIO_INFO) 				\n"
        + "VALUES 								\n"
        + " (:ID_SELEZIONE_INFO,		 		\n"
        + "  :ID_PROCEDIMENTO_OGGETTO, 			\n"
        + "  :ID_DETTAGLIO_INFO) 				\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idSelezioneInfo = 0;
    try
    {
      idSelezioneInfo = getNextSequenceValue("SEQ_IUF_T_SELEZIONE_INFO");
      mapParameterSource.addValue("ID_SELEZIONE_INFO", idSelezioneInfo,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_DETTAGLIO_INFO", idDettaglioInfo,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idDettaglioInfo", idDettaglioInfo),
              new LogParameter("idSelezioneInfo", idSelezioneInfo)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
    return idSelezioneInfo;
  }

  public void deleteValoriInseriti(long idProcedimentoOggetto,
      long idQuadroOggetto, long idBandoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteValoriInseriti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_VALORI_INSERITI                                     \n"
        + "        WHERE ID_SELEZIONE_INFO IN                                     \n"
        + "        (                                                              \n"
        + "             SELECT                                                    \n"
        + "              A.ID_SELEZIONE_INFO                                      \n"
        + "             FROM                                                      \n"
        + "              IUF_T_SELEZIONE_INFO A,                                  \n"
        + "              IUF_D_GRUPPO_INFO B,                                     \n"
        + "              IUF_D_DETTAGLIO_INFO C                                   \n"
        + "             WHERE                                                     \n"
        + "              B.ID_GRUPPO_INFO = C.ID_GRUPPO_INFO                      \n"
        + "              AND C.ID_DETTAGLIO_INFO = A.ID_DETTAGLIO_INFO            \n"
        + "              AND A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "              AND B.ID_QUADRO_OGGETTO = :ID_QUADRO_OGGETTO             \n"
        + "              AND B.ID_BANDO_OGGETTO  = :ID_BANDO_OGGETTO              \n"
        + "         )                                                             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO_OGGETTO", idBandoOggetto,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idQuadroOggetto", idQuadroOggetto),
              new LogParameter("idBandoOggetto", idBandoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteWProcedimentoOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteWProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_W_PROCEDIMENTO_OGGETT_CC    					\n"
        + " WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertWProcedimentoOggetto(long idProcedimentoOggetto,
      long idContoCorrente) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertWProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_W_PROCEDIMENTO_OGGETT_CC  \n"
        + " (ID_PROCEDIMENTO_OGGETTO, 				  \n"
        + "	 EXT_ID_CONTO_CORRENTE) 				  \n"
        + "VALUES 								      \n"
        + " (:ID_PROCEDIMENTO_OGGETTO,		 		  \n"
        + "  :EXT_ID_CONTO_CORRENTE) 				  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_CONTO_CORRENTE", idContoCorrente,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idContoCorrente", idContoCorrente)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteSelezioneInfo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteValoriInseriti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_SELEZIONE_INFO 			 			 \n"
        + " WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertValoriInseriti(long idSelezioneInfo, String valore,
      long posizione) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertValoriInseriti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_VALORI_INSERITI 	\n"
        + " (ID_VALORI_INSERITI, 				\n"
        + "	 ID_SELEZIONE_INFO, 				\n"
        + "	 VALORE,							\n"
        + "  POSIZIONE) 						\n"
        + "VALUES 								\n"
        + " (:ID_VALORI_INSERITI,		 		\n"
        + "  :ID_SELEZIONE_INFO, 				\n"
        + "  :VALORE, 							\n"
        + "  :POSIZIONE) 						\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idValoriInseriti = 0;
    try
    {
      idValoriInseriti = getNextSequenceValue("SEQ_IUF_T_VALORI_INSERITI");
      mapParameterSource.addValue("ID_VALORI_INSERITI", idValoriInseriti,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_SELEZIONE_INFO", idSelezioneInfo,
          Types.NUMERIC);
      mapParameterSource.addValue("VALORE", valore, Types.VARCHAR);
      mapParameterSource.addValue("POSIZIONE", posizione, Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idValoriInseriti", idValoriInseriti),
              new LogParameter("valore", valore),
              new LogParameter("posizione", posizione),
              new LogParameter("idSelezioneInfo", idSelezioneInfo)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ValoriInseritiDTO> getValoriInseriti(long idProcedimentoOggetto,
      long idDettaglioInfo) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getValoriInseriti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                       				\n"
        + "   B.ID_SELEZIONE_INFO,                                      \n"
        + "   B.VALORE,		                                            \n"
        + "   B.POSIZIONE                                               \n"
        + " FROM                                                        \n"
        + "   IUF_T_SELEZIONE_INFO A,                                   \n"
        + "   IUF_T_VALORI_INSERITI B                                   \n"
        + " WHERE                                                       \n"
        + "   A.ID_SELEZIONE_INFO = B.ID_SELEZIONE_INFO                 \n"
        + "   AND A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  \n"
        + "   AND A.ID_DETTAGLIO_INFO = :ID_DETTAGLIO_INFO              \n"
        + " ORDER BY B.POSIZIONE                                        \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_DETTAGLIO_INFO", idDettaglioInfo,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ValoriInseritiDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idQuadroOggetto", idDettaglioInfo),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<AziendaDTO> getAziendeProcedimentoList(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAziendeProcedimentoList]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                             					\n"
        + "   B.CUAA,                          					\n"
        + "   B.PARTITA_IVA,                   					\n"
        + "   B.DENOMINAZIONE,                 					\n"
        + "   B.DESCRIZIONE_FORMA_GIURIDICA,               					\n"
        + "   B.INDIRIZZO_SEDE_LEGALE,         					\n"
        + "   B.DATA_CESSAZIONE,               					\n"
        + "   A.DATA_INIZIO,                   					\n"
        + "   A.DATA_FINE,                   					    \n"
        + "   A.EXT_ID_UTENTE_AGGIORNAMENTO,   					\n"
        + "   A.NOTE                           					\n"
        + " FROM                               					\n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA A,    					\n"
        + "   SMRGAA_V_DATI_ANAGRAFICI B          					\n"
        + " WHERE                              					\n"
        + "   A.EXT_ID_AZIENDA = B.ID_AZIENDA  					\n"
        + "   AND B.DATA_FINE_VALIDITA IS NULL 					\n"
        + "   AND A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO      		\n"
        + " ORDER BY A.DATA_INIZIO            					\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);

      return queryForList(QUERY, mapParameterSource, AziendaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<AmmCompetenzaDTO> getAmmCompetenzaList(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAmmCompetenzaList]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                \n"
        + "    B.DESCRIZIONE,                                    \n"
        + "    B.DENOMINAZIONE_1 AS DESCR_AGGIUNTIVA,            \n"
        + "    A.DATA_INIZIO,                                    \n"
        + "    A.EXT_ID_UTENTE_AGGIORNAMENTO,                    \n"
        + "    A.NOTE,                                           \n"
        + "    U.DENOMINAZIONE AS UFF_DENOM,                     \n"
        + "    U.INDIRIZZO AS UFF_INDIRIZZO,                     \n"
        + "    DA.DESCRIZIONE_COMUNE AS UFF_COMUNE,              \n"
        + "    T.COGNOME || ' ' || T.NOME AS DESCRIZIONE_TECNICO \n"
        + " FROM                                                 \n"
        + "    IUF_T_PROCEDIM_AMMINISTRAZIO A,                 \n"
        + "    DB_UFFICIO_ZONA U,                 				 \n"
        + "    DB_TECNICO T,    	             				 \n"
        + "    SMRGAA_V_DATI_AMMINISTRATIVI DA,                  \n"
        + "    SMRCOMUNE_V_AMM_COMPETENZA B                      \n"
        + " WHERE                                                \n"
        + "    A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO              \n"
        + "    AND A.EXT_ID_AMM_COMPETENZA = B.ID_AMM_COMPETENZA \n"
        + "    AND A.EXT_ID_UFFICIO_ZONA = U.ID_UFFICIO_ZONA(+)  \n"
        + "    AND A.EXT_ID_TECNICO = T.ID_TECNICO(+)  			 \n"
        + "    AND DA.ISTAT_COMUNE(+) = U.EXT_COMUNE             \n"
        + " ORDER BY A.DATA_INIZIO                               \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);

      return queryForList(QUERY, mapParameterSource, AmmCompetenzaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimentoDTO getIterProcedimento(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIterProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                          \n"
        + "   A.ID_PROCEDIMENTO,                                           \n"
        + "   A.IDENTIFICATIVO,                                            \n"
        + "   G.DESCRIZIONE AS DESCR_STATO_OGGETTO_PROC,			       \n"
        + "   D.DESCRIZIONE AS DESCR_GRUPPO_OGGETTO,                       \n"
        + "   F.DESCRIZIONE AS DESCR_ITER,                                 \n"
        + "   DO.DESCRIZIONE AS DESCR_OGGETTO,                             \n"
        + "   DO.ID_OGGETTO,					                           \n"
        + "   DO.CODICE AS COD_OGGETTO,  		                           \n"
        + "   DO.FLAG_ISTANZA,			  		                           \n"
        + "   B.ID_PROCEDIMENTO_OGGETTO,                                   \n"
        + "   B.IDENTIFICATIVO AS IDENTIF_PROC_OGG,                        \n"
        + "   E.DATA_INIZIO AS ITER_DATA_INIZ,                             \n"
        + "   E.ID_ITER_PROCEDIMENTO_OGGETT,                               \n"
        + "   E.ID_STATO_OGGETTO AS ITER_ID_STATO_OGGETTO,                 \n"
        + "   E.EXT_ID_UTENTE_AGGIORNAMENTO  AS ITER_ID_UTENTE,            \n"
        + "   E.NOTE,														\n"
        + "   VD.DENOMINAZIONE AS DENOMINAZIONE_DELEGA           			\n"
        + " FROM                                                           \n"
        + "   IUF_T_PROCEDIMENTO A,                                        \n"
        + "   IUF_D_STATO_OGGETTO G,                                       \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO B,                                \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO C,                               \n"
        + "   IUF_D_GRUPPO_OGGETTO D,                                      \n"
        + "   IUF_D_OGGETTO DO,                                     	   \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE E,                            \n"
        + "   IUF_D_STATO_OGGETTO F,										\n"
        + "   SMRGAA_V_DATI_DELEGA VD,"
        + "    IUF_T_PROCEDIMENTO_AZIENDA PA                        	  \n"
        + " WHERE                                                          \n"
        + "   A.ID_PROCEDIMENTO = B.ID_PROCEDIMENTO                        \n"
        + "   AND B.ID_LEGAME_GRUPPO_OGGETTO = C.ID_LEGAME_GRUPPO_OGGETTO  \n"
        + "   AND C.ID_GRUPPO_OGGETTO = D.ID_GRUPPO_OGGETTO                \n"
        + "   AND B.ID_PROCEDIMENTO_OGGETTO = E.ID_PROCEDIMENTO_OGGETTO    \n"
        + "   AND DO.ID_OGGETTO = C.ID_OGGETTO    						   \n"
        + "   AND F.ID_STATO_OGGETTO = E.ID_STATO_OGGETTO                  \n"
        + "   AND A.ID_STATO_OGGETTO = G.ID_STATO_OGGETTO                  \n"
        + "   AND A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO						\n"
        + "	  AND VD.ID_AZIENDA(+) = PA.EXT_ID_AZIENDA 					\n"
        + "   AND PA.ID_PROCEDIMENTO (+)= A.ID_PROCEDIMENTO            	   \n"
        + "   AND VD.DATA_FINE_VALIDITA(+) IS NULL                   	   \n"
        + "    AND PA.DATA_FINE (+) IS NULL                                \n"
        + " ORDER BY B.ID_PROCEDIMENTO_OGGETTO, B.CODICE_RAGGRUPPAMENTO, D.ORDINE, C.ORDINE, B.DATA_INIZIO, E.DATA_INIZIO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<ProcedimentoDTO>()
          {

            @Override
            public ProcedimentoDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ProcedimentoDTO result = null;
              List<ProcedimentoOggettoDTO> lProcOggetto = new ArrayList<ProcedimentoOggettoDTO>();
              List<IterProcedimentoOggettoDTO> lIterProcOggetto = null;
              Long lastProcOggetto = null;
              while (rs.next())
              {
                if (result == null)
                {
                  result = new ProcedimentoDTO();
                  result.setDescrStatoOggetto(
                      rs.getString("DESCR_STATO_OGGETTO_PROC"));
                  result.setIdentificativo(rs.getString("IDENTIFICATIVO"));
                  result.setIdProcedimento(rs.getLong("ID_PROCEDIMENTO"));
                  result.setDenominazioneDelega(
                      rs.getString("DENOMINAZIONE_DELEGA"));
                  result.setProcedimentoOggetto(lProcOggetto);
                }

                long idProcOggetto = rs.getLong("ID_PROCEDIMENTO_OGGETTO");
                if (lastProcOggetto == null || lastProcOggetto != idProcOggetto)
                {
                  lastProcOggetto = idProcOggetto;
                  ProcedimentoOggettoDTO procedimentoOggettoDTO = new ProcedimentoOggettoDTO();
                  procedimentoOggettoDTO
                      .setIdentificativo(rs.getString("IDENTIF_PROC_OGG"));
                  procedimentoOggettoDTO
                      .setIdProcedimentoOggetto(idProcOggetto);
                  procedimentoOggettoDTO.setDescrGruppoOggetto(
                      rs.getString("DESCR_GRUPPO_OGGETTO"));
                  procedimentoOggettoDTO
                      .setDescrOggetto(rs.getString("DESCR_OGGETTO"));
                  procedimentoOggettoDTO
                      .setCodOggetto(rs.getString("COD_OGGETTO"));
                  procedimentoOggettoDTO
                      .setFlagIstanza(rs.getString("FLAG_ISTANZA"));
                  procedimentoOggettoDTO.setIdOggetto(rs.getLong("ID_OGGETTO"));
                  lIterProcOggetto = new ArrayList<IterProcedimentoOggettoDTO>();
                  procedimentoOggettoDTO
                      .setIterProcedimentoggetto(lIterProcOggetto);
                  lProcOggetto.add(procedimentoOggettoDTO);
                }

                IterProcedimentoOggettoDTO iter = new IterProcedimentoOggettoDTO();
                iter.setDescrizione(rs.getString("DESCR_ITER"));
                iter.setNote(rs.getString("NOTE"));
                iter.setExtIdUtenteAggiornamento(rs.getLong("ITER_ID_UTENTE"));
                iter.setIdIterProcedimentoOggett(
                    rs.getLong("ID_ITER_PROCEDIMENTO_OGGETT"));
                iter.setIdStatoOggetto(rs.getLong("ITER_ID_STATO_OGGETTO"));
                iter.setDataInizio(rs.getTimestamp("ITER_DATA_INIZ"));
                lIterProcOggetto.add(iter);
              }
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ContoCorrenteEstesoDTO getContoCorrente(long idProcedimentoOggeto,
      Date dataRiferimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getContoCorrente]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                                                                      		\n"
        + "   VCC.ID_CONTO_CORRENTE,                                                                                                                    		\n"
        + "   VCC.DENOMINAZIONE_BANCA,                                                                                                                  		\n"
        + "   VCC.DENOMINAZIONE_SPORTELLO,                                                                                                              		\n"
        + "   VCC.INDIRIZZO_SPORTELLO,                                                                                                                  		\n"
        + "   VCC.INTESTAZIONE,                                                                                                                         		\n"
        + "   VCC.IBAN                                                                                                                                 			\n"
        + " FROM                                                                                                                                        		\n"
        + "   SMRGAA_V_CONTO_CORRENTE  VCC                                                                                                                  	\n"
        + " WHERE                                                                                                                                       		\n"
        + "   VCC.ID_CONTO_CORRENTE = NVL(                                                                                                             			\n"
        + "                        (SELECT A.EXT_ID_CONTO_CORRENTE                                                                                      		\n"
        + "                          FROM IUF_W_PROCEDIMENTO_OGGETT_CC A                                                                               		\n"
        + "                          WHERE A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO),                                                       		\n"
        + "                        NVL(                                                                                                                     	\n"
        + "                             (SELECT                                                                                                              	\n"
        + "                                 A.EXT_ID_CONTO_CORRENTE                                                                                            	\n"
        + "                              FROM                                                                                                                 	\n"
        + "                          		IUF_T_PROCEDIMENTO_CONTO_COR A,                                                                                   	\n"
        + "                          		IUF_T_PROCEDIMENTO_OGGETTO B                                                                                       	\n"
        + "                        		 WHERE                                                                                                                 	\n"
        + "                          		A.ID_PROCEDIMENTO = B.ID_PROCEDIMENTO                                                                              	\n"
        + "                          		AND NVL(:DATA_RIFERIMENTO, SYSDATE) BETWEEN A.DATA_INIZIO AND NVL(A.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY')) 	\n"
        + "                          		AND B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO),                                                         	\n"
        + "                                                                                                                                             		\n"
        + "                          	-1)                                                                                                             		\n"
        + "  )                                                                                                                                          		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggeto, Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", dataRiferimento,
          Types.TIMESTAMP);

      return queryForObject(QUERY, mapParameterSource,
          ContoCorrenteEstesoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_OGGETTO", idProcedimentoOggeto),
              new LogParameter("DATA_RIFERIMENTO", dataRiferimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ContoCorrenteDTO> getContiCorrentiValidi(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getContoCorrente]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                         \n"
        + "   VCC.ID_CONTO_CORRENTE,                       \n"
        + "   VCC.DENOMINAZIONE_BANCA,                     \n"
        + "   VCC.DENOMINAZIONE_SPORTELLO,                 \n"
        + "   VCC.INDIRIZZO_SPORTELLO,                     \n"
        + "   VCC.INTESTAZIONE,                            \n"
        + "   VCC.IBAN                                     \n"
        + " FROM                                           \n"
        + "   SMRGAA_V_CONTO_CORRENTE VCC                     \n"
        + " WHERE                                          \n"
        + "   VCC.DATA_FINE_VALIDITA_BANCA IS NULL         \n"
        + "   AND VCC.DATA_FINE_VALIDITA_SPORTELLO IS NULL \n"
        + "   AND VCC.DATA_ESTINZIONE_CC IS NULL 			 \n"
        + "   AND VCC.DATA_FINE_VALIDITA_CC IS NULL        \n"
        + "   AND VCC.FLAG_VALIDATO = 'S'                  \n"
        + "   AND VCC.ID_AZIENDA = (                       \n"
        + "     SELECT                                     \n"
        + "       A.EXT_ID_AZIENDA                         \n"
        + "     FROM                                       \n"
        + "       IUF_T_PROCEDIMENTO_AZIENDA A             \n"
        + "     WHERE                                      \n"
        + "       A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO     \n"
        + "       AND A.DATA_FINE IS NULL                  \n"
        + "     )                                          \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);

      return queryForList(QUERY, mapParameterSource, ContoCorrenteDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<FonteControlloDTO> getControlliList(long idProcedimentoOggeto,
      Date dataRiferimento, boolean onlyFailed, boolean acceptWarning)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getControlliList]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                                                  \n"
        + "    DC.ID_CONTROLLO,                                                                                                     \n"
        + "    DC.CODICE,                                                                                                           \n"
        + "    DC.DESCRIZIONE,                                                                                                      \n"
        + "    DC.DESCRIZIONE_ESTESA,                                                                                               \n"
        + "    DC.ID_FONTE_CONTROLLO,                                                                                               \n"
        + "    FC.DESCRIZIONE AS DESCR_FONTE_CONTR,                                                                                 \n"
        + "    PO.Id_Procedimento_Oggetto,                                                                                          \n"

        + "    BOC.FLAG_GIUSTIFICABILE,	                                                                                            \n"

        + "    ESECUZIONE.ID_ESECUZIONE_CONTROLLI,                                                                                  \n"
        + "    ESECUZIONE.EXT_ID_UTENTE,                                                                                            \n"
        + "    ESECUZIONE.DATA_ESECUZIONE,                                                                                          \n"
        + "    ESECUZIONE.FLAG_ELABORAZIONE_IN_CORSO,                                                                               \n"
        + "    ANOMALIE.ID_ANOMALIE_CONTROLLI,                                                                                      \n"
        + "    ANOMALIE.DESCRIZIONE_ANOMALIA,                                                                                       \n"
        + "    ANOMALIE.ULTERIORI_INFORMAZIONI,                                                                                     \n"
        + "    ANOMALIE.GRAVITA,                                                                                                    \n"
        + "    SOLUZIONE_AN.ID_SOLUZIONE_ANOMALIA                                                                                   \n"

        + "  FROM                                                                                                                   \n"
        + "    IUF_T_PROCEDIMENTO P,                                                                                                \n"
        + "    IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                                       \n"
        + "    IUF_R_BANDO_OGGETTO BO,                                                                                              \n"
        + "    IUF_R_BANDO_OGGETTO_CONTROLL BOC,                                                                                   \n"
        + "    IUF_D_CONTROLLO DC,                                                                                                  \n"

        + "    IUF_T_SOLUZIONE_ANOMALIA SOLUZIONE_AN,                                                                               \n"

        + "    IUF_D_FONTE_CONTROLLO FC,                                                                                            \n"
        + "    (SELECT                                                                                                              \n"
        + "      EC.EXT_ID_UTENTE,                                                                                                  \n"
        + "      EC.DATA_ESECUZIONE,                                                                                                \n"
        + "      EC.FLAG_ELABORAZIONE_IN_CORSO,                                                                                     \n"
        + "      EC.ID_FONTE_CONTROLLO,                                                                                             \n"
        + "      EC.ID_ESECUZIONE_CONTROLLI                                                                                         \n"
        + "    FROM                                                                                                                 \n"
        + "     IUF_T_ESECUZIONE_CONTROLLI EC,                                                                                      \n"
        + "     IUF_T_PROCEDIMENTO_OGGETTO PO2                                                                                      \n"
        + "    WHERE                                                                                                                \n"
        + "     EC.ID_PROCEDIMENTO_OGGETTO = PO2.ID_PROCEDIMENTO_OGGETTO                                                            \n"
        + "     AND PO2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                          \n"
        + "    ) ESECUZIONE,                                                                                                        \n"
        + "    (SELECT                                                                                                              \n"
        + "      AC.ID_ANOMALIE_CONTROLLI,                                                                                          \n"
        + "      AC.DESCRIZIONE_ANOMALIA,                                                                                           \n"
        + "      AC.ULTERIORI_INFORMAZIONI,                                                                                         \n"
        + "      AC.GRAVITA,                                                                                                        \n"
        + "      PO2.ID_PROCEDIMENTO_OGGETTO,                                                                                       \n"
        + "      AC.ID_CONTROLLO                                                                                                    \n"
        + "    FROM                                                                                                                 \n"
        + "      IUF_T_PROCEDIMENTO_OGGETTO PO2,                                                                                    \n"
        + "      IUF_T_ANOMALIE_CONTROLLI AC                                                                                        \n"
        + "    WHERE                                                                                                                \n"
        + "      AC.ID_PROCEDIMENTO_OGGETTO = PO2.ID_PROCEDIMENTO_OGGETTO                                                           \n"
        + "      AND PO2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                         \n"

        + ((onlyFailed && !acceptWarning)
            ? " AND AC.GRAVITA IS NOT NULL AND AC.GRAVITA<>'W' "
            : "")

        + ((onlyFailed && acceptWarning) ? " AND AC.GRAVITA IS NOT NULL " : "")

        + "    )ANOMALIE                                                                                                            \n"
        + "  WHERE                                                                                                                  \n"
        + "    P.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO                                                                               \n"
        + "    AND P.ID_BANDO = BO.ID_BANDO                                                                                         \n"
        + "    AND PO.ID_LEGAME_GRUPPO_OGGETTO = BO.ID_LEGAME_GRUPPO_OGGETTO                                                        \n"
        + "    AND BO.ID_BANDO_OGGETTO = BOC.ID_BANDO_OGGETTO                                                                       \n"
        + "    AND BOC.ID_CONTROLLO = DC.ID_CONTROLLO                                                                               \n"
        + "    AND FC.ID_FONTE_CONTROLLO = DC.ID_FONTE_CONTROLLO                                                                    \n"
        + "    AND ANOMALIE.ID_CONTROLLO" + (onlyFailed ? "" : "(+)")
        + " = DC.ID_CONTROLLO                                               \n"
        + "    AND ESECUZIONE.ID_FONTE_CONTROLLO(+) = DC.ID_FONTE_CONTROLLO                                                         \n"
        + "    AND NVL(:DATA_RIFERIMENTO, SYSDATE) BETWEEN DC.DATA_INIZIO AND NVL(DC.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "    AND PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                            \n"

        + "    AND SOLUZIONE_AN.ID_PROCEDIMENTO_OGGETTO (+)= :ID_PROCEDIMENTO_OGGETTO                                               \n"
        + "    AND SOLUZIONE_AN.ID_CONTROLLO (+)= DC.ID_CONTROLLO		                                                            \n"

        + "  ORDER BY DC.ID_FONTE_CONTROLLO, DC.CODICE, DC.DESCRIZIONE                                                         		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggeto, Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", dataRiferimento,
          Types.TIMESTAMP);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<FonteControlloDTO>>()
          {

            @Override
            public List<FonteControlloDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              List<FonteControlloDTO> result = new ArrayList<FonteControlloDTO>();
              List<it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO> lcontrolli = null;
              Long lastIdFonteControllo = null;
              while (rs.next())
              {
                long idFonteControllo = rs.getLong("ID_FONTE_CONTROLLO");
                if (lastIdFonteControllo == null
                    || lastIdFonteControllo != idFonteControllo)
                {
                  lastIdFonteControllo = idFonteControllo;
                  FonteControlloDTO fonteControlloDTO = new FonteControlloDTO();
                  fonteControlloDTO
                      .setIdFonteControllo(rs.getLong("ID_FONTE_CONTROLLO"));
                  fonteControlloDTO
                      .setDescrizione(rs.getString("DESCR_FONTE_CONTR"));

                  lcontrolli = new ArrayList<it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO>();
                  fonteControlloDTO.setControlli(lcontrolli);
                  result.add(fonteControlloDTO);
                }

                it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO controlloDTO = new it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO();
                controlloDTO.setCodice(rs.getString("CODICE"));
                controlloDTO
                    .setDataEsecuzione(rs.getTimestamp("DATA_ESECUZIONE"));
                controlloDTO.setDescrizione(rs.getString("DESCRIZIONE"));
                controlloDTO.setDescrizioneAnomalia(
                    rs.getString("DESCRIZIONE_ANOMALIA"));
                controlloDTO
                    .setDescrizioneEstesa(rs.getString("DESCRIZIONE_ESTESA"));
                controlloDTO.setFlagElaborazioneInCorso(
                    rs.getString("FLAG_ELABORAZIONE_IN_CORSO"));
                controlloDTO.setGravita(rs.getString("GRAVITA"));
                controlloDTO.setIdAnomalieControllo(
                    rs.getLong("ID_ANOMALIE_CONTROLLI"));
                controlloDTO.setIdControllo(rs.getLong("ID_CONTROLLO"));
                controlloDTO.setIdEsecuzioneControllo(
                    rs.getLong("ID_ESECUZIONE_CONTROLLI"));
                controlloDTO.setIdUtenteEsecuzione(rs.getLong("EXT_ID_UTENTE"));
                controlloDTO.setUlterioriInformazioniAnomalia(
                    rs.getString("ULTERIORI_INFORMAZIONI"));
                controlloDTO.setIdSoluzioneAnomalia(
                    rs.getLong("ID_SOLUZIONE_ANOMALIA"));
                controlloDTO.setFlagAnomaliaGiustificabile(
                    rs.getString("FLAG_GIUSTIFICABILE"));
                lcontrolli.add(controlloDTO);
              }
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggeto", idProcedimentoOggeto),
              new LogParameter("dataRiferimento", dataRiferimento),
              new LogParameter("onlyFailed", onlyFailed)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public FonteControlloDTO getControlliListByIdFonteControllo(
      long idProcedimentoOggeto, long idFonteControllo, Date dataRiferimento,
      boolean onlyFailed) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getControlliListByIdFonteControllo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                                                  \n"
        + "    DC.ID_CONTROLLO,                                                                                                     \n"
        + "    DC.CODICE,                                                                                                           \n"
        + "    DC.DESCRIZIONE,                                                                                                      \n"
        + "    DC.DESCRIZIONE_ESTESA,                                                                                               \n"
        + "    DC.ID_FONTE_CONTROLLO,                                                                                               \n"
        + "    FC.DESCRIZIONE AS DESCR_FONTE_CONTR,                                                                                 \n"
        + "    PO.Id_Procedimento_Oggetto,                                                                                          \n"
        + "    ESECUZIONE.ID_ESECUZIONE_CONTROLLI,                                                                                  \n"
        + "    ESECUZIONE.EXT_ID_UTENTE,                                                                                            \n"
        + "    ESECUZIONE.DATA_ESECUZIONE,                                                                                          \n"
        + "    ESECUZIONE.FLAG_ELABORAZIONE_IN_CORSO,                                                                               \n"
        + "    ANOMALIE.ID_ANOMALIE_CONTROLLI,                                                                                      \n"
        + "    ANOMALIE.DESCRIZIONE_ANOMALIA,                                                                                       \n"
        + "    ANOMALIE.ULTERIORI_INFORMAZIONI,                                                                                     \n"
        + "    ANOMALIE.GRAVITA                                                                                                     \n"
        + "  FROM                                                                                                                   \n"
        + "    IUF_T_PROCEDIMENTO P,                                                                                                \n"
        + "    IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                                       \n"
        + "    IUF_R_BANDO_OGGETTO BO,                                                                                              \n"
        + "    IUF_R_BANDO_OGGETTO_CONTROLL BOC,                                                                                   \n"
        + "    IUF_D_CONTROLLO DC,                                                                                                  \n"
        + "    IUF_D_FONTE_CONTROLLO FC,                                                                                            \n"
        + "    (SELECT                                                                                                              \n"
        + "      EC.EXT_ID_UTENTE,                                                                                                  \n"
        + "      EC.DATA_ESECUZIONE,                                                                                                \n"
        + "      EC.FLAG_ELABORAZIONE_IN_CORSO,                                                                                     \n"
        + "      EC.ID_FONTE_CONTROLLO,                                                                                             \n"
        + "      EC.ID_ESECUZIONE_CONTROLLI                                                                                         \n"
        + "    FROM                                                                                                                 \n"
        + "     IUF_T_ESECUZIONE_CONTROLLI EC,                                                                                      \n"
        + "     IUF_T_PROCEDIMENTO_OGGETTO PO2                                                                                      \n"
        + "    WHERE                                                                                                                \n"
        + "     EC.ID_PROCEDIMENTO_OGGETTO = PO2.ID_PROCEDIMENTO_OGGETTO                                                            \n"
        + "     AND PO2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                          \n"
        + "    ) ESECUZIONE,                                                                                                        \n"
        + "    (SELECT                                                                                                              \n"
        + "      AC.ID_ANOMALIE_CONTROLLI,                                                                                          \n"
        + "      AC.DESCRIZIONE_ANOMALIA,                                                                                           \n"
        + "      AC.ULTERIORI_INFORMAZIONI,                                                                                         \n"
        + "      AC.GRAVITA,                                                                                                        \n"
        + "      PO2.ID_PROCEDIMENTO_OGGETTO,                                                                                       \n"
        + "      AC.ID_CONTROLLO                                                                                                    \n"
        + "    FROM                                                                                                                 \n"
        + "      IUF_T_PROCEDIMENTO_OGGETTO PO2,                                                                                    \n"
        + "      IUF_T_ANOMALIE_CONTROLLI AC                                                                                        \n"
        + "    WHERE                                                                                                                \n"
        + "      AC.ID_PROCEDIMENTO_OGGETTO = PO2.ID_PROCEDIMENTO_OGGETTO                                                           \n"
        + "      AND PO2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                         \n"
        + "    )ANOMALIE                                                                                                            \n"
        + "  WHERE                                                                                                                  \n"
        + "    P.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO                                                                               \n"
        + "    AND P.ID_BANDO = BO.ID_BANDO                                                                                         \n"
        + "    AND PO.ID_LEGAME_GRUPPO_OGGETTO = BO.ID_LEGAME_GRUPPO_OGGETTO                                                        \n"
        + "    AND BO.ID_BANDO_OGGETTO = BOC.ID_BANDO_OGGETTO                                                                       \n"
        + "    AND BOC.ID_CONTROLLO = DC.ID_CONTROLLO                                                                               \n"
        + "    AND FC.ID_FONTE_CONTROLLO = DC.ID_FONTE_CONTROLLO                                                                    \n"
        + "    AND FC.ID_FONTE_CONTROLLO = :ID_FONTE_CONTROLLO                                                                      \n"
        + "    AND ANOMALIE.ID_CONTROLLO" + (onlyFailed ? "" : "(+)")
        + " = DC.ID_CONTROLLO                                               \n"
        + "    AND ESECUZIONE.ID_FONTE_CONTROLLO(+) = DC.ID_FONTE_CONTROLLO                                                         \n"
        + "    AND NVL(:DATA_RIFERIMENTO, SYSDATE) BETWEEN DC.DATA_INIZIO AND NVL(DC.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "    AND PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                            \n"
        + "  ORDER BY DC.ID_FONTE_CONTROLLO, DC.CODICE, DC.DESCRIZIONE                                                         		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_FONTE_CONTROLLO", idFonteControllo,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggeto, Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", dataRiferimento,
          Types.TIMESTAMP);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<FonteControlloDTO>()
          {

            @Override
            public FonteControlloDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              FonteControlloDTO fonteControlloDTO = null;
              List<it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO> lcontrolli = null;
              Long lastIdFonteControllo = null;
              while (rs.next())
              {
                long idFonteControllo = rs.getLong("ID_FONTE_CONTROLLO");
                if (lastIdFonteControllo == null
                    || lastIdFonteControllo != idFonteControllo)
                {
                  lastIdFonteControllo = idFonteControllo;
                  fonteControlloDTO = new FonteControlloDTO();
                  fonteControlloDTO
                      .setIdFonteControllo(rs.getLong("ID_FONTE_CONTROLLO"));
                  fonteControlloDTO
                      .setDescrizione(rs.getString("DESCR_FONTE_CONTR"));

                  lcontrolli = new ArrayList<it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO>();
                  fonteControlloDTO.setControlli(lcontrolli);
                }

                it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO controlloDTO = new it.csi.iuffi.iuffiweb.dto.procedimentooggetto.controlli.ControlloDTO();
                controlloDTO.setCodice(rs.getString("CODICE"));
                controlloDTO
                    .setDataEsecuzione(rs.getTimestamp("DATA_ESECUZIONE"));
                controlloDTO.setDescrizione(rs.getString("DESCRIZIONE"));
                controlloDTO.setDescrizioneAnomalia(
                    rs.getString("DESCRIZIONE_ANOMALIA"));
                controlloDTO
                    .setDescrizioneEstesa(rs.getString("DESCRIZIONE_ESTESA"));
                controlloDTO.setFlagElaborazioneInCorso(
                    rs.getString("FLAG_ELABORAZIONE_IN_CORSO"));
                controlloDTO.setGravita(rs.getString("GRAVITA"));
                controlloDTO.setIdAnomalieControllo(
                    rs.getLong("ID_ANOMALIE_CONTROLLI"));
                controlloDTO.setIdControllo(rs.getLong("ID_CONTROLLO"));
                controlloDTO.setIdEsecuzioneControllo(
                    rs.getLong("ID_ESECUZIONE_CONTROLLI"));
                controlloDTO.setIdUtenteEsecuzione(rs.getLong("EXT_ID_UTENTE"));
                controlloDTO.setUlterioriInformazioniAnomalia(
                    rs.getString("ULTERIORI_INFORMAZIONI"));
                lcontrolli.add(controlloDTO);
              }
              return fonteControlloDTO;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggeto", idProcedimentoOggeto),
              new LogParameter("idFonteControllo", idFonteControllo),
              new LogParameter("dataRiferimento", dataRiferimento),
              new LogParameter("onlyFailed", onlyFailed)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public MainControlloDTO callMainControlli(long idBandoOggetto,
      long idProcedimentoOggetto, long idAzienda, long idUtenteLogin)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainControlli";
    StringBuffer CALL = new StringBuffer("PCK_IUF_CONTROLLI.MainControlli");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDBANDOOGGETTO", idBandoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PEXTIDAZIENDA", idAzienda, Types.NUMERIC);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_CONTROLLI")
              .withProcedureName("MainControlli")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDBANDOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDAZIENDA", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public Map<Long, List<FileAllegatiDTO>> getMapFileAllegati(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getMapFileAllegati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                      \n"
        + "   SI.ID_DETTAGLIO_INFO,                                     \n"
        + "   FA.ID_FILE_ALLEGATI,                                      \n"
        + "   FA.ID_SELEZIONE_INFO,                                     \n"
        + "   FA.EXT_ID_DOCUMENTO_INDEX,                                \n"
        + "   FA.NOME_LOGICO,                                           \n"
        + "   FA.NOME_FISICO,                                           \n"
        + "   DI.EXT_ID_TIPO_DOCUMENTO                                  \n"
        + " FROM                                                        \n"
        + "   IUF_T_SELEZIONE_INFO SI,                                  \n"
        + "   IUF_D_DETTAGLIO_INFO DI,                                  \n"
        + "   IUF_T_FILE_ALLEGATI FA                                    \n"
        + " WHERE                                                       \n"
        + "   SI.ID_SELEZIONE_INFO           = FA.ID_SELEZIONE_INFO     \n"
        + "   AND DI.ID_DETTAGLIO_INFO           = SI.ID_DETTAGLIO_INFO \n"
        + "   AND SI.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    final long finalID = idProcedimentoOggetto;
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Map<Long, List<FileAllegatiDTO>>>()
          {
            @Override
            public Map<Long, List<FileAllegatiDTO>> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              Map<Long, List<FileAllegatiDTO>> map = new HashMap<Long, List<FileAllegatiDTO>>();
              while (rs.next())
              {
                long idDettaglioInfo = rs.getLong("ID_DETTAGLIO_INFO");
                FileAllegatiDTO file = new FileAllegatiDTO();
                file.setIdDettaglioInfo(idDettaglioInfo);
                file.setIdFileAllegati(finalID);
                file.setExtIdDocumentoIndex(
                    getLongNull(rs, "EXT_ID_DOCUMENTO_INDEX"));
                file.setIdFileAllegati(rs.getLong("ID_FILE_ALLEGATI"));
                file.setIdSelezioneInfo(rs.getLong("ID_SELEZIONE_INFO"));
                file.setNomeFisico(rs.getString("NOME_FISICO"));
                file.setNomeLogico(rs.getString("NOME_LOGICO"));
                file.setExtIdTipoDocumento(
                    getLongNull(rs, "EXT_ID_TIPO_DOCUMENTO"));
                List<FileAllegatiDTO> list = map.get(idDettaglioInfo);
                if (list == null)
                {
                  list = new ArrayList<FileAllegatiDTO>();
                  map.put(idDettaglioInfo, list);
                }
                list.add(file);
              }
              return map;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public FileAllegatiDTO getFileAllegatiById(long idProcedimentoOggetto,
      long idFileAllegati) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getFileAllegatiById]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(
          THIS_METHOD + " idProcedimentoOggetto = " + idProcedimentoOggetto);
      logger.debug(THIS_METHOD + " idFileAllegati = " + idFileAllegati);
    }
    final String QUERY = " SELECT                                        \n"
        + "   SI.ID_PROCEDIMENTO_OGGETTO,                 \n"
        + "   SI.ID_DETTAGLIO_INFO,                       \n"
        + "   FA.ID_FILE_ALLEGATI,                        \n"
        + "   FA.ID_SELEZIONE_INFO,                       \n"
        + "   FA.EXT_ID_DOCUMENTO_INDEX,                  \n"
        + "   FA.NOME_LOGICO,                             \n"
        + "   FA.NOME_FISICO                              \n"
        + " FROM                                          \n"
        + "   IUF_T_SELEZIONE_INFO SI,                    \n"
        + "   IUF_T_FILE_ALLEGATI FA                      \n"
        + " WHERE                                         \n"
        + "   SI.ID_SELEZIONE_INFO = FA.ID_SELEZIONE_INFO \n"
        + "   AND SI.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND FA.ID_FILE_ALLEGATI = :ID_FILE_ALLEGATI \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_FILE_ALLEGATI", idFileAllegati,
          Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<FileAllegatiDTO>()
          {
            @Override
            public FileAllegatiDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                FileAllegatiDTO file = new FileAllegatiDTO();
                file.setIdDettaglioInfo(rs.getLong("ID_DETTAGLIO_INFO"));
                file.setIdProcedimentoOggetto(
                    rs.getLong("ID_PROCEDIMENTO_OGGETTO"));
                file.setExtIdDocumentoIndex(
                    getLongNull(rs, "EXT_ID_DOCUMENTO_INDEX"));
                file.setIdFileAllegati(rs.getLong("ID_FILE_ALLEGATI"));
                file.setIdSelezioneInfo(rs.getLong("ID_SELEZIONE_INFO"));
                file.setNomeFisico(rs.getString("NOME_FISICO"));
                file.setNomeLogico(rs.getString("NOME_LOGICO"));
                return file;
              }
              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFileAllegati", idFileAllegati)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<FileAllegatiDTO> getFileAllegatiByIdSelezioneInfo(
      long idProcedimentoOggetto, long idSelezioneInfo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getFileAllegatiByIdSelezioneInfo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(
          THIS_METHOD + " idProcedimentoOggetto = " + idProcedimentoOggetto);
      logger.debug(THIS_METHOD + " idSelezioneInfo = " + idSelezioneInfo);
    }
    final String QUERY = " SELECT                                        \n"
        + "   SI.ID_PROCEDIMENTO_OGGETTO,                 \n"
        + "   SI.ID_DETTAGLIO_INFO,                       \n"
        + "   FA.ID_FILE_ALLEGATI,                        \n"
        + "   FA.ID_SELEZIONE_INFO,                       \n"
        + "   FA.EXT_ID_DOCUMENTO_INDEX,                  \n"
        + "   FA.NOME_LOGICO,                             \n"
        + "   FA.NOME_FISICO                              \n"
        + " FROM                                          \n"
        + "   IUF_T_SELEZIONE_INFO SI,                    \n"
        + "   IUF_T_FILE_ALLEGATI FA                      \n"
        + " WHERE                                         \n"
        + "   SI.ID_SELEZIONE_INFO = FA.ID_SELEZIONE_INFO \n"
        + "   AND SI.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND SI.ID_SELEZIONE_INFO = :ID_SELEZIONE_INFO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_SELEZIONE_INFO", idSelezioneInfo,
          Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new RowMapper<FileAllegatiDTO>()
          {
            @Override
            public FileAllegatiDTO mapRow(ResultSet rs, int arg1)
                throws SQLException
            {
              FileAllegatiDTO file = new FileAllegatiDTO();
              file.setIdDettaglioInfo(rs.getLong("ID_DETTAGLIO_INFO"));
              file.setIdProcedimentoOggetto(
                  rs.getLong("ID_PROCEDIMENTO_OGGETTO"));
              file.setExtIdDocumentoIndex(
                  getLongNull(rs, "EXT_ID_DOCUMENTO_INDEX"));
              file.setIdFileAllegati(rs.getLong("ID_FILE_ALLEGATI"));
              file.setIdSelezioneInfo(rs.getLong("ID_SELEZIONE_INFO"));
              file.setNomeFisico(rs.getString("NOME_FISICO"));
              file.setNomeLogico(rs.getString("NOME_LOGICO"));
              return file;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idSelezioneInfo", idSelezioneInfo)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertFileAllegati(FileAllegatiDTO fileAllegatiDTO,
      byte[] fileContent)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertFileAllegati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      if (fileAllegatiDTO != null)
      {
        logger.debug(THIS_METHOD + " fileAllegatiDTO.getIdDettaglioInfo() = "
            + fileAllegatiDTO.getIdDettaglioInfo());
        logger.debug(THIS_METHOD + " fileAllegatiDTO.getIdFileAllegati() = "
            + fileAllegatiDTO.getIdFileAllegati());
        logger.debug(THIS_METHOD + " fileAllegatiDTO.getIdSelezioneInfo() = "
            + fileAllegatiDTO.getIdSelezioneInfo());
        logger.debug(THIS_METHOD + " fileAllegatiDTO.getNomeFisico() = "
            + fileAllegatiDTO.getNomeFisico());
        logger.debug(THIS_METHOD + " fileAllegatiDTO.getNomeLogico() = "
            + fileAllegatiDTO.getNomeLogico());
        logger
            .debug(THIS_METHOD + " fileAllegatiDTO.getExtIdDocumentoIndex() = "
                + fileAllegatiDTO.getExtIdDocumentoIndex());
        if (fileContent != null)
        {
          logger.debug(
              THIS_METHOD + " fileContent.length = " + fileContent.length);
        }
      }
    }
    if (fileContent == null)
    {
      logger.warn(THIS_METHOD + " fileContent is NULL! ");
    }

    if (fileAllegatiDTO == null)
    {
      logger.error(
          THIS_METHOD + " ATTENZIONE! ERRORE GRAVE: fileAllegatiDTO is NULL");
    }

    final String UPDATE = " INSERT                               \n"
        + " INTO                                 \n"
        + "   IUF_T_FILE_ALLEGATI                \n"
        + "   (                                  \n"
        + "     ID_FILE_ALLEGATI,                \n"
        + "     ID_SELEZIONE_INFO,               \n"
        + "     EXT_ID_DOCUMENTO_INDEX,          \n"
        + "     NOME_LOGICO,                     \n"
        + "     NOME_FISICO,                     \n"
        + "     FILE_ALLEGATO                    \n"
        + "   )                                  \n"
        + "   VALUES                             \n"
        + "   (                                  \n"
        + "     SEQ_IUF_T_FILE_ALLEGATI.NEXTVAL, \n"
        + "     :ID_SELEZIONE_INFO,              \n"
        + "     :EXT_ID_DOCUMENTO_INDEX,         \n"
        + "     :NOME_LOGICO,                    \n"
        + "     :NOME_FISICO,                    \n"
        + "     :FILE_ALLEGATO                   \n"
        + "   )                                  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_SELEZIONE_INFO",
          fileAllegatiDTO.getIdSelezioneInfo(), Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_DOCUMENTO_INDEX",
          fileAllegatiDTO.getExtIdDocumentoIndex(), Types.NUMERIC);
      mapParameterSource.addValue("NOME_LOGICO",
          fileAllegatiDTO.getNomeLogico(), Types.VARCHAR);
      mapParameterSource.addValue("NOME_FISICO",
          fileAllegatiDTO.getNomeFisico(), Types.VARCHAR);
      if (fileContent != null)
      {
        mapParameterSource.addValue("FILE_ALLEGATO",
            new SqlLobValue(fileContent), Types.BLOB);
      }
      else
      {
        mapParameterSource.addValue("FILE_ALLEGATO", null, Types.NULL);
      }
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("fileAllegatiDTO.getIdDettaglioInfo()",
                  fileAllegatiDTO.getIdDettaglioInfo()),
              new LogParameter("fileAllegatiDTO.getIdFileAllegati()",
                  fileAllegatiDTO.getIdFileAllegati()),
              new LogParameter("fileAllegatiDTO.getIdSelezioneInfo()",
                  fileAllegatiDTO.getIdSelezioneInfo()),
              new LogParameter("fileAllegatiDTO.getNomeFisico()",
                  fileAllegatiDTO.getNomeFisico()),
              new LogParameter("fileAllegatiDTO.getNomeLogico()",
                  fileAllegatiDTO.getNomeLogico()),
              new LogParameter("fileAllegatiDTO.getExtIdDocumentoIndex()",
                  fileAllegatiDTO.getExtIdDocumentoIndex()),
              new LogParameter("fileContent", fileContent)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public SelezioneInfoInserimentoAllegatiDTO getIdSelezioneInfo(
      long idProcedimentoOggetto, long idDettaglioInfo)
      throws InternalUnexpectedException
  {

    String THIS_METHOD = "[" + THIS_CLASS + "::getIdSelezioneInfo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                         \n"
        + "   SI.ID_SELEZIONE_INFO,                                        \n"
        + "   DI.FLAG_OBBLIGATORIO,                                        \n"
        + "   DI.FLAG_GESTIONE_FILE                                        \n"
        + " FROM                                                           \n"
        + "   IUF_T_SELEZIONE_INFO SI,                                     \n"
        + "   IUF_D_DETTAGLIO_INFO DI                                      \n"
        + " WHERE                                                          \n"
        + "   DI.ID_DETTAGLIO_INFO        = :ID_DETTAGLIO_INFO             \n"
        + "   AND SI.ID_PROCEDIMENTO_OGGETTO(+) = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND DI.ID_DETTAGLIO_INFO    = SI.ID_DETTAGLIO_INFO(+)        \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DETTAGLIO_INFO", idDettaglioInfo,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.queryForObject(QUERY,
          mapParameterSource,
          new RowMapper<SelezioneInfoInserimentoAllegatiDTO>()
          {

            @Override
            public SelezioneInfoInserimentoAllegatiDTO mapRow(ResultSet rs,
                int arg1) throws SQLException
            {
              SelezioneInfoInserimentoAllegatiDTO result = new SelezioneInfoInserimentoAllegatiDTO();
              result.setIdSelezioneInfo(getLongNull(rs, "ID_SELEZIONE_INFO"));
              result.setFlagGestioneFile(rs.getString("FLAG_GESTIONE_FILE"));
              result.setFlagObbligatorio(rs.getString("FLAG_OBBLIGATORIO"));
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idDettaglioInfo", idDettaglioInfo)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int deleteFileAllegati(long idFileAllegati)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteFileAllegati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(THIS_METHOD + " idFileAllegati = " + idFileAllegati);
    }

    final String DELETE = " DELETE                                 \n"
        + " FROM                                   \n"
        + "   IUF_T_FILE_ALLEGATI                  \n"
        + " WHERE                                  \n"
        + "   ID_FILE_ALLEGATI = :ID_FILE_ALLEGATI \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO", idFileAllegati,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_FILE_ALLEGATI", idFileAllegati,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFileAllegati", idFileAllegati)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int deleteSelezioneInfoIfUnused(long idSelezioneInfo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteSelezioneInfoIfUnused]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(THIS_METHOD + " idSelezioneInfo = " + idSelezioneInfo);
    }

    final String DELETE = " DELETE                                                \n"
        + " FROM                                                  \n"
        + "   IUF_T_SELEZIONE_INFO SI                             \n"
        + " WHERE                                                 \n"
        + "   SI.ID_SELEZIONE_INFO = :ID_SELEZIONE_INFO           \n"
        + "   AND NOT EXISTS                                      \n"
        + "   (                                                   \n"
        + "     SELECT                                            \n"
        + "       *                                               \n"
        + "     FROM                                              \n"
        + "       IUF_T_VALORI_INSERITI I                         \n"
        + "     WHERE                                             \n"
        + "       I.ID_SELEZIONE_INFO = SI.ID_SELEZIONE_INFO      \n"
        + "   )                                                   \n"
        + "   AND NOT EXISTS                                      \n"
        + "   (                                                   \n"
        + "     SELECT                                            \n"
        + "       *                                               \n"
        + "     FROM                                              \n"
        + "       IUF_T_FILE_ALLEGATI FA                          \n"
        + "     WHERE                                             \n"
        + "       FA.ID_SELEZIONE_INFO = SI.ID_SELEZIONE_INFO     \n"
        + "   )                                                   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_SELEZIONE_INFO", idSelezioneInfo,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idSelezioneInfo", idSelezioneInfo)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int deleteSelezioneInfoIfUnusedFileAllegati(long idSelezioneInfo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::deleteSelezioneInfoIfUnusedFileAllegati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(THIS_METHOD + " idSelezioneInfo = " + idSelezioneInfo);
    }

    final String DELETE = " DELETE                                                \n"
        + " FROM                                                  \n"
        + "   IUF_T_SELEZIONE_INFO SI                             \n"
        + " WHERE                                                 \n"
        + "   SI.ID_SELEZIONE_INFO = :ID_SELEZIONE_INFO           \n"
        + "   AND NOT EXISTS                                      \n"
        + "   (                                                   \n"
        + "     SELECT                                            \n"
        + "       *                                               \n"
        + "     FROM                                              \n"
        + "       IUF_T_VALORI_INSERITI I                         \n"
        + "     WHERE                                             \n"
        + "       I.ID_SELEZIONE_INFO = SI.ID_SELEZIONE_INFO      \n"
        + "   )                                                   \n"
        + "   AND NOT EXISTS                                      \n"
        + "   (                                                   \n"
        + "     SELECT                                            \n"
        + "       *                                               \n"
        + "     FROM                                              \n"
        + "       IUF_T_FILE_ALLEGATI FA                          \n"
        + "     WHERE                                             \n"
        + "       FA.ID_SELEZIONE_INFO = SI.ID_SELEZIONE_INFO     \n"
        + "   )                                                   \n"
        + "   AND EXISTS                                          \n"
        + "   (                                                   \n"
        + "     SELECT                                            \n"
        + "       *                                               \n"
        + "     FROM                                              \n"
        + "       IUF_D_DETTAGLIO_INFO DI                         \n"
        + "     WHERE                                             \n"
        + "       DI.ID_DETTAGLIO_INFO     = SI.ID_DETTAGLIO_INFO \n"
        + "       AND DI.FLAG_OBBLIGATORIO = 'S'                  \n"
        + "   )                                                   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_SELEZIONE_INFO", idSelezioneInfo,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idSelezioneInfo", idSelezioneInfo)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public byte[] getFileFisicoAllegato(long idProcedimentoOggetto,
      long idFileAllegati) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getFileFisicoAllegato]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(
          THIS_METHOD + " idProcedimentoOggetto = " + idProcedimentoOggetto);
      logger.debug(THIS_METHOD + " idFileAllegati = " + idFileAllegati);
    }
    final String QUERY = " SELECT                                                      \n"
        + "   FA.FILE_ALLEGATO                                          \n"
        + " FROM                                                        \n"
        + "   IUF_T_FILE_ALLEGATI FA,                                   \n"
        + "   IUF_T_SELEZIONE_INFO SI                                   \n"
        + " WHERE                                                       \n"
        + "   FA.ID_SELEZIONE_INFO           = SI.ID_SELEZIONE_INFO     \n"
        + "   AND SI.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND FA.ID_FILE_ALLEGATI        = :ID_FILE_ALLEGATI        \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_FILE_ALLEGATI", idFileAllegati,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<byte[]>()
          {
            @Override
            public byte[] extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return rs.getBytes("FILE_ALLEGATO");
              }
              else
              {
                return null;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idFileAllegati", idFileAllegati)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ElencoCduDTO> getElencoCdu()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoCdu]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                \n"
        + "   ID_ELENCO_CDU,      \n"
        + "   CODICE_CDU,         \n"
        + "   NOME_DOCUMENTO_CDU, \n"
        + "   EXT_COD_MACRO_CDU,  \n"
        + "   TIPO_AZIONE,        \n"
        + "   DECODE (LENGTH(HELP_CDU),NULL,'N','S') AS FLAG_HELP	          \n"
        + " FROM                  \n"
        + "   IUF_D_ELENCO_CDU    \n";
    try
    {
      return queryForList(QUERY, null, ElencoCduDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdAmmCompetenzaProcedimento(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdAmmCompetenzaProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                  \n"
        + "   PA.EXT_ID_AMM_COMPETENZA              \n"
        + " FROM                                    \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA     \n"
        + " WHERE                                   \n"
        + "   PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO \n"
        + "   AND DATA_FINE     IS NULL             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<StampaOggettoDTO> getElencoStampeOggetto(
      long idProcedimentoOggetto, Long idOggettoIcona)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoStampeOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    List<Integer> lDocumenti = new ArrayList<Integer>();
    lDocumenti.add(IuffiConstants.IUFFI.ID_TIPOLOGIA_DOC_IUF_SU_DOQUIAGRI);
    lDocumenti.add(IuffiConstants.IUFFI.ID_TIPOLOGIA_DOC_ALTRO_SU_DOQUIAGRI);

    String QUERY = " SELECT                                                          \n"
        + "   OI.ID_OGGETTO_ICONA,                                          \n"
        + "   ICO_STAMPA.ID_ICONA AS ID_ICONA_STAMPA,                       \n"
        + "   ICO_STAMPA.NOME_ICONA AS NOME_ICONA_STAMPA,                   \n"
        + "   ICO_STAMPA.TOOLTIP AS TOOLTIP_STAMPA,                         \n"
        + "   ICO_STATO.ID_ICONA AS ID_ICONA_STATO,                         \n"
        + "   ICO_STATO.NOME_ICONA AS NOME_ICONA_STATO,                     \n"
        + "   ICO_STATO.TOOLTIP AS TOOLTIP_STATO,                           \n"
        + "   OI.EXT_ID_TIPO_DOCUMENTO,                                     \n"
        + "   EC.ID_ELENCO_CDU,                                             \n"
        + "   EC.CODICE_CDU,                                                \n"
        + "   EC.EXT_COD_MACRO_CDU,                                         \n"
        + "   OI.FLAG_STAMPA_OGGETTO_APERTO,                                \n"
        + "   OI.FLAG_FIRMA_GRAFOMETRICA,                                   \n"
        + "   OI.FLAG_DA_FIRMARE,            		                        \n"
        + "   OI.FLAG_DA_PROTOCOLLARE,   	                                \n"
        + "   OI.FLAG_INVIA_MAIL,   	                               		\n"
        + "   OI.FLAG_VISIBILE_TUTTI,   	                                \n"
        + "   TDD.DESC_TIPO_DOCUMENTO,                                      \n"
        + "   POS.EXT_ID_UTENTE_AGGIORNAMENTO,                              \n"
        + "   POS.EXT_ID_DOCUMENTO_INDEX ,      	                        \n"
        + "   POS.DATA_ULTIMO_AGGIORNAMENTO,                                \n"
        + "   POS.DATA_FINE AS DATA_FINE_STAMPA,			                \n"
        + "   POS.ID_PROCEDIM_OGGETTO_STAMPA,                               \n"
        + "   POS.ID_STATO_STAMPA                                 			\n"
        + " FROM                                                            \n"
        + "   IUF_R_BANDO_OGGETTO_ICONA BOI,                                \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                \n"
        + "   IUF_T_PROCEDIMENTO P,                                         \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE IPO,                                                 \n"
        + "   IUF_R_BANDO_OGGETTO BO,                                       \n"
        + "   IUF_D_ICONA ICO_STAMPA,                                       \n"
        + "   IUF_D_OGGETTO DO,                                                                       \n"
        + "   IUF_D_ELENCO_CDU EC,                                          \n"
        + "   DOQUIAGRI_V_TIPO_DOC TDD,                                     \n"
        + "   IUF_R_OGGETTO_ICONA OI                                        \n"
        + " LEFT JOIN IUF_T_PROCEDIM_OGGETTO_STAMP POS                     \n"
        + " ON                                                              \n"
        + "   POS.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO        \n"
        + "   AND POS.ID_OGGETTO_ICONA = OI.ID_OGGETTO_ICONA                \n"
        + " LEFT JOIN IUF_D_STATO_STAMPA SS                                 \n"
        + " ON                                                              \n"
        + "   POS.ID_STATO_STAMPA = SS.ID_STATO_STAMPA                      \n"
        + "   AND POS.DATA_FINE IS NULL                                     \n"
        + " LEFT JOIN IUF_D_ICONA ICO_STATO                                 \n"
        + " ON                                                              \n"
        + "   SS.ID_ICONA = ICO_STATO.ID_ICONA                              \n"
        + " WHERE                                                           \n"
        + "   BOI.ID_OGGETTO_ICONA            = OI.ID_OGGETTO_ICONA         \n"
        + "   AND BOI.ID_BANDO_OGGETTO        = BO.ID_BANDO_OGGETTO         \n"
        + "   AND BO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND PO.ID_PROCEDIMENTO_OGGETTO  = :ID_PROCEDIMENTO_OGGETTO    \n"
        + "   AND OI.EXT_ID_TIPO_DOCUMENTO   IS NOT NULL                    \n"
        + "   AND POS.DATA_FINE IS NULL                                     \n"
        + "   AND OI.ID_ICONA = ICO_STAMPA.ID_ICONA                         \n"
        + "   AND OI.ID_ELENCO_CDU = EC.ID_ELENCO_CDU                       \n"
        + "   AND OI.EXT_ID_TIPO_DOCUMENTO = TDD.ID_TIPO_DOCUMENTO          \n"
        + getInCondition("TDD.ID_TIPOLOGIA_DOC", lDocumenti)
        + "   AND P.ID_PROCEDIMENTO           = PO.ID_PROCEDIMENTO          \n"
        + "   AND P.ID_BANDO                  = BO.ID_BANDO                 \n"
        + "    AND OI.ID_OGGETTO = DO.ID_OGGETTO                                                       \n"
        + "    AND IPO.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO                            \n"
        + "    AND IPO.DATA_FINE IS NULL                                                               \n"
        + "         AND ( (DO.FLAG_ISTANZA = 'N' AND (                                                 \n"
        + "                   (EC.CODICE_CDU = :CODICE_CDU AND                                         \n"
        + "                   POS.ID_PROCEDIMENTO_OGGETTO IS NOT NULL) OR                              \n"
        + "                   (EC.CODICE_CDU <> :INSERISCI_STAMPA_OGGETTO)))                           \n"
        + "               OR                                                                           \n"
        + "               (DO.FLAG_ISTANZA = 'S' AND (                                                 \n"
        + "                   (EC.CODICE_CDU = :CODICE_CDU_ISTANZA AND                                 \n"
        + "                   POS.ID_PROCEDIMENTO_OGGETTO IS NOT NULL) OR \n"
        + "                   (EC.CODICE_CDU <> :INSERISCI_STAMPA_OGGETTO_IST)))                       \n"
        + "                                                                                            \n"
        + "               )                                                                            \n";
    if (idOggettoIcona != null)
    {
      QUERY += " AND OI.ID_OGGETTO_ICONA = :ID_OGGETTO_ICONA \n";
    }
    QUERY += " ORDER BY                                                        \n"
        + "   OI.ORDINE ASC                                                 \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      mapParameterSource.addValue("CODICE_CDU",
          IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO,
          Types.VARCHAR);

      mapParameterSource.addValue("INSERISCI_STAMPA_OGGETTO",
          IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO,
          Types.VARCHAR);

      mapParameterSource.addValue("CODICE_CDU_ISTANZA", IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO_ISTANZA, Types.VARCHAR);
      mapParameterSource.addValue("INSERISCI_STAMPA_OGGETTO_IST", IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO_ISTANZA, Types.VARCHAR);
     
      return queryForList(QUERY, mapParameterSource, StampaOggettoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<StampaOggettoIconaDTO> getElencoDocumentiStampeDaAllegare(
      long idProcedimentoOggetto, Long extIdTipoDocumento, String cuRiferimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getElencoDocumentiStampeDaAllegare]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    StringBuilder queryBuff = new StringBuilder(
        " SELECT                                                            \n"
            + "   OI.ID_OGGETTO_ICONA,                                            \n"
            + "   OI.ID_ICONA AS ID_ICONA_STAMPA,                                 \n"
            + "   OI.EXT_ID_TIPO_DOCUMENTO,                                       \n"
            + "   TDD.DESC_TIPO_DOCUMENTO,                                        \n"
            + "   OI.ID_ELENCO_CDU,                                               \n"
            + "   OI.FLAG_STAMPA_OGGETTO_APERTO,                                  \n"
            + "   OI.FLAG_DA_PROTOCOLLARE,                                  	  \n"
            + "   OI.FLAG_DA_FIRMARE,                                  			  \n"
            + "   OI.FLAG_FIRMA_GRAFOMETRICA                                      \n"
            + " FROM                                                              \n"
            + "   IUF_R_BANDO_OGGETTO_ICONA BOI,                                  \n"
            + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                  \n"
            + "   IUF_R_BANDO_OGGETTO BO,                                         \n"
            + "   DOQUIAGRI_V_TIPO_DOC TDD,                                       \n"
            + "   IUF_D_ELENCO_CDU EC,                                            \n"
            + "   IUF_T_PROCEDIMENTO P,                                           \n"
            + "   IUF_R_OGGETTO_ICONA OI                                          \n"
            + " WHERE                                                             \n"
            + "   BOI.ID_OGGETTO_ICONA            = OI.ID_OGGETTO_ICONA           \n"
            + "   AND BOI.ID_BANDO_OGGETTO        = BO.ID_BANDO_OGGETTO           \n"
            + "   AND BO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO   \n"
            + "   AND PO.ID_PROCEDIMENTO_OGGETTO  = :ID_PROCEDIMENTO_OGGETTO      \n"
            + "   AND OI.EXT_ID_TIPO_DOCUMENTO   IS NOT NULL                      \n"
            + "   AND OI.ID_ELENCO_CDU            = EC.ID_ELENCO_CDU              \n"
            + "   AND EC.CODICE_CDU               = :INSERISCI_STAMPA_OGGETTO     \n"
            + "   AND OI.EXT_ID_TIPO_DOCUMENTO    = TDD.ID_TIPO_DOCUMENTO         \n"
            + "   AND TDD.ID_TIPOLOGIA_DOC        = :ID_TIPOLOGIA_DOC             \n"
            + "   AND P.ID_PROCEDIMENTO           = PO.ID_PROCEDIMENTO            \n"
            + "   AND P.ID_BANDO                  = BO.ID_BANDO                   \n"
            + "   AND NOT EXISTS                                                  \n"
            + "   (                                                               \n"
            + "     SELECT                                                        \n"
            + "       *                                                           \n"
            + "     FROM                                                          \n"
            + "       IUF_T_PROCEDIM_OGGETTO_STAMP POS                           \n"
            + "     WHERE                                                         \n"
            + "       POS.ID_PROCEDIMENTO_OGGETTO    = PO.ID_PROCEDIMENTO_OGGETTO \n"
            + "       AND POS.DATA_FINE             IS NULL                       \n"
            + "       AND POS.ID_OGGETTO_ICONA       = OI.ID_OGGETTO_ICONA        \n"
            + "   )                                                               \n");
    if (extIdTipoDocumento != null)
    {
      queryBuff.append(
          "       AND OI.EXT_ID_TIPO_DOCUMENTO = :ID_TIPO_DOCUMENTO           \n");
    }
    queryBuff.append(
        " ORDER BY TDD.DESC_TIPO_DOCUMENTO DESC                             \n");
    final String QUERY = queryBuff.toString();
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_TIPO_DOCUMENTO", extIdTipoDocumento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_TIPOLOGIA_DOC",
          IuffiConstants.IUFFI.ID_TIPOLOGIA_DOC_IUF_SU_DOQUIAGRI,
          Types.NUMERIC);
      
      
      if(cuRiferimento==null)
        mapParameterSource.addValue("INSERISCI_STAMPA_OGGETTO", IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO, Types.VARCHAR);
      else
        mapParameterSource.addValue("INSERISCI_STAMPA_OGGETTO", cuRiferimento, Types.VARCHAR);

      return queryForList(QUERY, mapParameterSource,
          StampaOggettoIconaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getIdentificativo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdentificativo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                       \n"
        + "   NVL(PO.IDENTIFICATIVO, P.IDENTIFICATIVO) AS IDENTIFICATIVO \n"
        + " FROM                                                         \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                             \n"
        + "   IUF_T_PROCEDIMENTO P                                       \n"
        + " WHERE                                                        \n"
        + "   PO.ID_PROCEDIMENTO             = P.ID_PROCEDIMENTO         \n"
        + "   AND PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getDescProduzione(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDescProduzione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select descrizione from IUF_D_REGIME_QUALITA where id_regime_qualita = (select id_regime_qualita from IUF_D_PRODUZIONE_CERTIFICATA where id_produzione_certificata = :ID_REGIME_QUALITA)";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_REGIME_QUALITA",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public String getDescUnitaMisura(long metodo, long specie)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDescUnitaMisura]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select m.descrizione from IUF_D_UNITA_MISURA m where m.id_unita_misura = "
        + "(select cs.id_unita_misura from IUF_R_METODO_CENS_SPECIE cs where cs.id_metodo_censimento = :METODO and cs.id_specie_ogur = :SPECIE)";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("METODO",
          metodo, Types.NUMERIC);
      mapParameterSource.addValue("SPECIE",
          specie, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("METODO", metodo),
              new LogParameter("SPECIE", specie)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public BigDecimal getValoreDa(long specie, long parametro)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDescUnitaMisura]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select valore_da from IUF_R_CONTROLLI_PIANO_OGUR where progressivo = :PARAMETRO"
        + " AND id_specie_ogur = :SPECIE";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("PARAMETRO",
          parametro, Types.NUMERIC);
      mapParameterSource.addValue("SPECIE",
          specie, Types.NUMERIC);
      return queryForBigDecimal(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("PARAMETRO", parametro),
              new LogParameter("SPECIE", specie)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  
  public BigDecimal getValoreA(long specie, long parametro)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDescUnitaMisura]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select valore_a from IUF_R_CONTROLLI_PIANO_OGUR where progressivo = :PARAMETRO"
        + " AND id_specie_ogur = :SPECIE";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("PARAMETRO",
          parametro, Types.NUMERIC);
      mapParameterSource.addValue("SPECIE",
          specie, Types.NUMERIC);
      return queryForBigDecimal(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("PARAMETRO", parametro),
              new LogParameter("SPECIE", specie)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  public long insertProcedimOggettoStampa(
      ProcedimOggettoStampaDTO procedimOggettoStampaDTO)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertProcedimOggettoStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP             \n"
        + "   (                                         \n"
        + "     ID_PROCEDIM_OGGETTO_STAMPA,             \n"
        + "     ID_PROCEDIMENTO_OGGETTO,                \n"
        + "     ID_BANDO_OGGETTO,                       \n"
        + "     ID_OGGETTO_ICONA,                       \n"
        + "     EXT_ID_DOCUMENTO_INDEX,                 \n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO,            \n"
        + "     DATA_ULTIMO_AGGIORNAMENTO,              \n"
        + "     DATA_INIZIO,                            \n"
        + "     DATA_FINE,                              \n"
        + "     ID_STATO_STAMPA,                        \n"
        + "     DESC_ANOMALIA                           \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_PROCEDIM_OGGETTO_STAMPA, 			\n"
        + "     :ID_PROCEDIMENTO_OGGETTO,               \n"
        + "     :ID_BANDO_OGGETTO,                      \n"
        + "     :ID_OGGETTO_ICONA,                      \n"
        + "     :EXT_ID_DOCUMENTO_INDEX,                \n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO,           \n"
        + "     SYSDATE,                                \n"
        + "     SYSDATE,                                \n"
        + "     NULL,                                   \n"
        + "     :ID_STATO_STAMPA,                       \n"
        + "     SUBSTR(:DESC_ANOMALIA,1, 4000)          \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idProcedimOggStampa;
    try
    {
      idProcedimOggStampa = getNextSequenceValue(
          "SEQ_IUF_T_PROCEDIM_OGGET_STA");
      mapParameterSource.addValue("ID_PROCEDIM_OGGETTO_STAMPA",
          idProcedimOggStampa, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          procedimOggettoStampaDTO.getIdProcedimentoOggetto(), Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO_OGGETTO",
          procedimOggettoStampaDTO.getIdBandoOggetto(), Types.NUMERIC);
      mapParameterSource.addValue("ID_OGGETTO_ICONA",
          procedimOggettoStampaDTO.getIdOggettoIcona(), Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_DOCUMENTO_INDEX",
          procedimOggettoStampaDTO.getExtIdDocumentoIndex(), Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          procedimOggettoStampaDTO.getExtIdUtenteAggiornamento(),
          Types.NUMERIC);
      mapParameterSource.addValue("ID_STATO_STAMPA",
          procedimOggettoStampaDTO.getIdStatoStampa(), Types.NUMERIC);
      mapParameterSource.addValue("DESC_ANOMALIA",
          procedimOggettoStampaDTO.getDescAnomalia(), Types.VARCHAR);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
      return idProcedimOggStampa;
    }
    catch (Throwable t)
    {
      if (procedimOggettoStampaDTO == null)
      {
        procedimOggettoStampaDTO = new ProcedimOggettoStampaDTO();
      }
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          procedimOggettoStampaDTO == null ? new LogParameter[]
          { new LogParameter("procedimOggettoStampaDTO",
              procedimOggettoStampaDTO) } : new LogParameter[]
          {
              new LogParameter(
                  "procedimOggettoStampaDTO.getIdProcedimentoOggetto()",
                  procedimOggettoStampaDTO.getIdProcedimentoOggetto()),
              new LogParameter("procedimOggettoStampaDTO.getIdBandoOggetto()",
                  procedimOggettoStampaDTO.getIdBandoOggetto()),
              new LogParameter("procedimOggettoStampaDTO.getIdOggettoIcona()",
                  procedimOggettoStampaDTO.getIdOggettoIcona()),
              new LogParameter(
                  "procedimOggettoStampaDTO.getExtIdDocumentoIndex()",
                  procedimOggettoStampaDTO.getExtIdDocumentoIndex()),
              new LogParameter(
                  "procedimOggettoStampaDTO.getExtIdUtenteAggiornamento()",
                  procedimOggettoStampaDTO.getExtIdUtenteAggiornamento()),
              new LogParameter("procedimOggettoStampaDTO.getIdStatoStampa()",
                  procedimOggettoStampaDTO.getIdStatoStampa()),
              new LogParameter("procedimOggettoStampaDTO.getDescAnomalia()",
                  procedimOggettoStampaDTO.getDescAnomalia())
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void lockOggettoIcona(long idOggettoIcona)
  {
    final String QUERY = " SELECT 1 FROM IUF_R_OGGETTO_ICONA WHERE ID_OGGETTO_ICONA = :ID_OGGETTO_ICONA FOR UPDATE ";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
        Types.NUMERIC);
    queryForLong(QUERY, mapParameterSource);
  }

  public long findIdUtenteAggiornamentoProcedimentoOggetto(
      long idProcedimentoOggetto)
  {
    final String QUERY = "SELECT EXT_ID_UTENTE_AGGIORNAMENTO FROM IUF_T_PROCEDIMENTO_OGGETTO WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO ";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    return namedParameterJdbcTemplate.queryForLong(QUERY, mapParameterSource);
  }

  public boolean canInsertProcedimentoOggettoStampa(long idOggettoIcona,
      long idProcedimentoOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::canInsertProcedimentoOggettoStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                               \n"
        + "   COUNT(*)                                           \n"
        + " FROM                                                 \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                      \n"
        + " WHERE                                                \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND ID_OGGETTO_ICONA    = :ID_OGGETTO_ICONA        \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) == 0; // Posso inserire se
                                                           // non c' gi il
                                                           // record presente
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimOggettoStampaDTO getProcedimOggettoStampaByIdOggetoIcona(
      long idProcedimentoOggetto, long idOggettoIcona)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimOggettoStampaByIdOggetoIcona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                             \n"
        + "   POS.ID_PROCEDIM_OGGETTO_STAMPA,                                  \n"
        + "   POS.ID_PROCEDIMENTO_OGGETTO,                                     \n"
        + "   POS.ID_BANDO_OGGETTO,                                            \n"
        + "   POS.ID_OGGETTO_ICONA,                                            \n"
        + "   POS.EXT_ID_DOCUMENTO_INDEX,                                      \n"
        + "   POS.EXT_ID_UTENTE_AGGIORNAMENTO,                                 \n"
        + "   POS.DATA_ULTIMO_AGGIORNAMENTO,                                   \n"
        + "   POS.DATA_INIZIO,                                                 \n"
        + "   POS.DATA_FINE,                                                   \n"
        + "   POS.ID_STATO_STAMPA,                                             \n"
        + "   POS.DESC_ANOMALIA                                                \n"
        + " FROM                                                               \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP POS,                               \n"
        + "   IUF_R_OGGETTO_ICONA OI                                           \n"
        + " WHERE                                                              \n"
        + "   POS.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO           \n"
        + "   AND POS.DATA_FINE IS NULL								           \n"
        + "   AND POS.ID_OGGETTO_ICONA = OI.ID_OGGETTO_ICONA                   \n"
        + "   AND OI.ID_OGGETTO_ICONA = :ID_OGGETTO_ICONA                      \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          ProcedimOggettoStampaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idOggettoIcona", idOggettoIcona)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProcedimOggettoStampaDTO> getProcedimOggettiStampa(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getProcedimOggettiStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                             \n"
        + "   POS.ID_PROCEDIM_OGGETTO_STAMPA,                                  \n"
        + "   POS.ID_PROCEDIMENTO_OGGETTO,                                     \n"
        + "   POS.ID_BANDO_OGGETTO,                                            \n"
        + "   POS.ID_OGGETTO_ICONA,                                            \n"
        + "   POS.EXT_ID_DOCUMENTO_INDEX,                                      \n"
        + "   POS.EXT_ID_UTENTE_AGGIORNAMENTO,                                 \n"
        + "   POS.DATA_ULTIMO_AGGIORNAMENTO,                                   \n"
        + "   POS.DATA_INIZIO,                                                 \n"
        + "   POS.DATA_FINE,                                                   \n"
        + "   POS.ID_STATO_STAMPA,                                             \n"
        + "   POS.DESC_ANOMALIA                                                \n"
        + " FROM                                                               \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP POS,                               \n"
        + "   IUF_R_OGGETTO_ICONA OI                                           \n"
        + " WHERE                                                              \n"
        + "   POS.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO           \n"
        + "   AND POS.ID_OGGETTO_ICONA = OI.ID_OGGETTO_ICONA                   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          ProcedimOggettoStampaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int deleteStampeOggetto(long idProcedimentoOggetto,
      long idProcedimOggettoStampa, boolean soloInserite)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteStampeOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " DELETE                                                             \n"
        + " FROM                                                               \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP POS                                \n"
        + " WHERE                                                              \n"
        + "   POS.ID_PROCEDIMENTO_OGGETTO        = :ID_PROCEDIMENTO_OGGETTO    \n"
        + "   AND POS.ID_PROCEDIM_OGGETTO_STAMPA = :ID_PROCEDIM_OGGETTO_STAMPA \n"
        + (soloInserite
            ? "   AND EXISTS                                                       \n"
                + "   (                                                                \n"
                + "     SELECT                                                         \n"
                + "       *                                                            \n"
                + "     FROM                                                           \n"
                + "       IUF_R_OGGETTO_ICONA OI,                                      \n"
                + "       IUF_D_ELENCO_CDU EC                                          \n"
                + "     WHERE                                                          \n"
                + "       OI.ID_OGGETTO_ICONA  = POS.ID_OGGETTO_ICONA                  \n"
                + "       AND OI.ID_ELENCO_CDU = EC.ID_ELENCO_CDU                      \n"
                + "       AND EC.CODICE_CDU    = :CODICE_CDU                           \n"
                + "   )                                                                \n"
            : "");
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIM_OGGETTO_STAMPA",
          idProcedimOggettoStampa, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("CODICE_CDU",
          IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO,
          Types.VARCHAR);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource); // Posso
                                                                            // inserire
                                                                            // se
                                                                            // non
                                                                            // c'
                                                                            // gi
                                                                            // il
                                                                            // record
                                                                            // presente
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idProcedimOggettoStampa",
                  idProcedimOggettoStampa),
              new LogParameter("soloInserite", soloInserite)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void lockProcedimOggettoStampaByIdOggetoIcona(
      long idProcedimentoOggetto, long idOggettoIcona)
      throws InternalUnexpectedException
  {
    final String QUERY = " SELECT                                               \n"
        + "   ID_PROCEDIMENTO_OGGETTO                            \n"
        + " FROM                                                 \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                      \n"
        + " WHERE                                                \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND ID_OGGETTO_ICONA    = :ID_OGGETTO_ICONA        \n"
        + " FOR UPDATE ";
    String THIS_METHOD = "[" + THIS_CLASS
        + "::lockProcedimOggettoStampaByIdOggetoIcona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idOggettoIcona", idOggettoIcona)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void ripristinaProcedimOggettoStampaByIdOggetoIcona(
      long idProcedimentoOggetto, long idOggettoIcona, long idUtenteLogin)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::ripristinaProcedimOggettoStampaByIdOggetoIcona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                                       \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                              \n"
        + " SET                                                          \n"
        + "   ID_STATO_STAMPA = :ID_STATO_STAMPA,                        \n"
        + "   DATA_INIZIO     = SYSDATE,                                 \n"
        + "   DESC_ANOMALIA   = NULL,                                    \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO = :EXT_ID_UTENTE_AGGIORNAMENTO,\n"
        + "   DATA_ULTIMO_AGGIORNAMENTO = SYSDATE                        \n"
        + " WHERE                                                        \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO         \n"
        + "   AND ID_OGGETTO_ICONA    = :ID_OGGETTO_ICONA                \n"
        + "   AND DATA_FINE IS NULL";
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO", idUtenteLogin,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_STATO_STAMPA",
          IuffiConstants.STATO.STAMPA.ID.GENERAZIONE_STAMPA_IN_CORSO,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idOggettoIcona", idOggettoIcona)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateProcedimOggettoStampaByIdOggetoIcona(
      long idProcedimentoOggetto, long idOggettoIcona, Long extIdDocumentoIndex,
      long idStatoStampa, String descAnomalia, long idUtenteLogin)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateProcedimOggettoStampaByIdOggetoIcona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                                       \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                               \n"
        + " SET                                                           \n"
        + "   ID_STATO_STAMPA = :ID_STATO_STAMPA,                         \n"
        + "   DATA_INIZIO     = SYSDATE,                                  \n"
        + "   DESC_ANOMALIA   = :DESC_ANOMALIA,            \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO = :EXT_ID_UTENTE_AGGIORNAMENTO, \n"
        + "   DATA_ULTIMO_AGGIORNAMENTO = SYSDATE,                        \n"
        + "   EXT_ID_DOCUMENTO_INDEX = :EXT_ID_DOCUMENTO_INDEX            \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n"
        + "   AND ID_OGGETTO_ICONA    = :ID_OGGETTO_ICONA                 \n"
        + "   AND DATA_FINE IS NULL";
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      short id = (short) idStatoStampa;
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO", idUtenteLogin,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_STATO_STAMPA", (short) id, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_DOCUMENTO_INDEX", extIdDocumentoIndex,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      if (descAnomalia != null && descAnomalia.length() > 3999)
      {
        descAnomalia = descAnomalia.substring(0, 3999);
      }
      mapParameterSource.addValue("DESC_ANOMALIA", descAnomalia, Types.VARCHAR);

      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idOggettoIcona", idOggettoIcona),
              new LogParameter("extIdDocumentoIndex", extIdDocumentoIndex),
              new LogParameter("idStatoStampa", idStatoStampa),
              new LogParameter("idUtenteLogin", idUtenteLogin),
              new LogParameter("descAnomalia", descAnomalia)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Map<String, OggettoIconaDTO> getIconeTestata(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIconeTestata]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                           \n"
        + "   OI.ID_OGGETTO,                                                 \n"
        + "   OI.ORDINE,                                                     \n"
        + "   OI.ID_OGGETTO_ICONA,                                           \n"
        + "   OI.EXT_ID_TIPO_DOCUMENTO,                                      \n"
        + "   OI.FLAG_FIRMA_GRAFOMETRICA,                                    \n"
        + "   OI.ID_ELENCO_CDU,                                              \n"
        + "   OI.FLAG_STAMPA_OGGETTO_APERTO,                                 \n"
        + "   I.ID_ICONA            AS ICO_ID_ICONA,                         \n"
        + "   I.DESCRIZIONE         AS ICO_DESCRIZIONE,                      \n"
        + "   I.NOME_ICONA          AS ICO_NOME_ICONA,                       \n"
        + "   I.TOOLTIP             AS ICO_TOOLTIP,                          \n"
        + "   EC.ID_ELENCO_CDU      AS CDU_ID_ELENCO_CDU,                    \n"
        + "   EC.CODICE_CDU         AS CDU_CODICE_CDU,                       \n"
        + "   EC.NOME_DOCUMENTO_CDU AS CDU_NOME_DOCUMENTO_CDU,               \n"
        + "   EC.EXT_COD_MACRO_CDU  AS CDU_EXT_COD_MACRO_CDU,                \n"
        + "   EC.TIPO_AZIONE        AS CDU_TIPO_AZIONE                       \n"
        + " FROM                                                             \n"
        + "   IUF_R_OGGETTO_ICONA OI,                                        \n"
        + "   IUF_R_BANDO_OGGETTO BO,                                        \n"
        + "   IUF_R_BANDO_OGGETTO_ICONA BOI,                                 \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                               \n"
        + "   IUF_D_ICONA I,                                                 \n"
        + "   IUF_D_ELENCO_CDU EC,                                           \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "   IUF_T_PROCEDIMENTO P                                           \n"
        + " WHERE                                                            \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO      = :ID_PROCEDIMENTO_OGGETTO     \n"
        + "   AND P.ID_PROCEDIMENTO           = PO.ID_PROCEDIMENTO   		\n"
        + "   AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND P.ID_BANDO                  = BO.ID_BANDO                  \n"
        + "   AND BO.ID_BANDO_OGGETTO         = BOI.ID_BANDO_OGGETTO         \n"
        + "   AND BOI.ID_OGGETTO_ICONA        = OI.ID_OGGETTO_ICONA          \n"
        + "   AND BO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND LGO.ID_OGGETTO              = OI.ID_OGGETTO                \n"
        + "   AND OI.ID_ICONA                 = I.ID_ICONA                   \n"
        + "   AND OI.ID_ELENCO_CDU            = EC.ID_ELENCO_CDU             \n"
        + "   AND EC.CODICE_CDU              IN ('CU-IUFFI-2002', 'CU-IUFFI-323','CU-IUFFI-322','CU-IUFFI-2001','CU-IUFFI-2001', 'CU-IUFFI-320', 'CU-IUFFI-313', 'CU-IUFFI-125', 'CU-IUFFI-130', 'CU-IUFFI-140', 'CU-IUFFI-164', 'CU-IUFFI-170', 'CU-IUFFI-232', 'CU-IUFFI-303','CU-IUFFI-304') \n"
        + " ORDER BY OI.ORDINE ASC                                           \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.VARCHAR);
    try
    {
      List<OggettoIconaDTO> list = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new RowMapper<OggettoIconaDTO>()
          {
            @Override
            public OggettoIconaDTO mapRow(ResultSet rs, int row)
                throws SQLException
            {
              OggettoIconaDTO oggettoIconaDTO = new OggettoIconaDTO();
              oggettoIconaDTO.setExtIdTipoDocumento(
                  getLongNull(rs, "EXT_ID_TIPO_DOCUMENTO"));
              oggettoIconaDTO.setFlagFirmaGrafometrica(
                  rs.getString("FLAG_FIRMA_GRAFOMETRICA"));
              oggettoIconaDTO.setFlagStampaOggettoAperto(
                  rs.getString("FLAG_STAMPA_OGGETTO_APERTO"));
              oggettoIconaDTO.setIdOggetto(rs.getInt("ID_OGGETTO"));
              oggettoIconaDTO.setIdOggettoIcona(rs.getInt("ID_OGGETTO_ICONA"));
              oggettoIconaDTO.setOrdine(rs.getInt("ORDINE"));
              IconaDTO icona = new IconaDTO();
              icona.setDescrizione(rs.getString("ICO_DESCRIZIONE"));
              icona.setIdIcona(rs.getInt("ICO_ID_ICONA"));
              icona.setNomeIcona(rs.getString("ICO_NOME_ICONA"));
              icona.setTooltip(rs.getString("ICO_TOOLTIP"));
              oggettoIconaDTO.setIcona(icona);
              ElencoCduDTO cdu = new ElencoCduDTO();
              cdu.setCodiceCdu(rs.getString("CDU_CODICE_CDU"));
              cdu.setIdElencoCdu(rs.getLong("CDU_ID_ELENCO_CDU"));
              cdu.setNomeDocumentoCdu(rs.getString("CDU_NOME_DOCUMENTO_CDU"));
              cdu.setTipoAzione(rs.getString("CDU_TIPO_AZIONE"));
              cdu.setExtCodMacroCdu(rs.getString("CDU_EXT_COD_MACRO_CDU"));
              oggettoIconaDTO.setCdu(cdu);
              return oggettoIconaDTO;
            }
          });
      if (list == null || list.isEmpty())
      {
        return null;
      }
      Map<String, OggettoIconaDTO> map = new HashMap<String, OggettoIconaDTO>();
      for (OggettoIconaDTO o : list)
      {
        map.put(o.getCdu().getCodiceCdu(), o);
      }
      return map;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DecodificaDTO<Integer> chiudiOggetto(long idProcedimentoOggetto,
      Long idEsito, String note, long idUtenteLogin)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "chiudiOggetto";
    final String PACKAGE = "PCK_IUF_GESTIONE_PROC_OGGETT";
    final String PROCEDURE = "MainChiusura";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PIDESITO", idEsito, Types.NUMERIC);
      parameterSource.addValue("PNOTE", note, Types.VARCHAR);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName(PACKAGE)
              .withProcedureName(PROCEDURE)
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDESITO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PNOTE", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      DecodificaDTO<Integer> dto = new DecodificaDTO<Integer>();
      dto.setId(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setDescrizione(
          safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          PACKAGE + "." + PROCEDURE);
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public void updateDocumentoIndexOnFileAllegati(long idFileAllegati,
      Long idDocumentoIndex) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateDocumentoIndexOnFileAllegati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                              \n"
        + "   IUF_T_FILE_ALLEGATI                               \n"
        + " SET                                                 \n"
        + "   EXT_ID_DOCUMENTO_INDEX = :EXT_ID_DOCUMENTO_INDEX, \n"
        + "   FILE_ALLEGATO          = NULL                     \n"
        + " WHERE                                               \n"
        + "   ID_FILE_ALLEGATI = :ID_FILE_ALLEGATI              \n";
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_FILE_ALLEGATI", idFileAllegati,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_DOCUMENTO_INDEX", idDocumentoIndex,
          Types.NUMERIC);

      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFileAllegati", idFileAllegati),
              new LogParameter("idDocumentoIndex", idDocumentoIndex)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void ripristinaDocumentoIndexOnFileAllegati(long idFileAllegati,
      byte[] contenutoFile) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::ripristinaDocumentoIndexOnFileAllegati]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                              		\n"
        + "   IUF_T_FILE_ALLEGATI                             \n"
        + " SET                                               \n"
        + "   EXT_ID_DOCUMENTO_INDEX = NULL,        					\n"
        + "   FILE_ALLEGATO = :FILE_ALLEGATO 				        	\n"
        + " WHERE                                             \n"
        + "   ID_FILE_ALLEGATI = :ID_FILE_ALLEGATI            \n";
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_FILE_ALLEGATI", idFileAllegati,
          Types.NUMERIC);
      mapParameterSource.addValue("FILE_ALLEGATO",
          new SqlLobValue(contenutoFile), Types.BLOB);
      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFileAllegati", idFileAllegati)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaInterventoDTO> getListInterventiByIdProcedimentoOggetto(
      long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getListInterventiByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                 \n"
        + "   DI.ID_DESCRIZIONE_INTERVENTO,                                        \n"
        + "   DI.DESCRIZIONE AS DESC_INTERVENTO,                                   \n"
        + "   TA.DESCRIZIONE AS DESC_AGGREGAZIONE_1L,                              \n"
        + "   LB.ID_LIVELLO                                                        \n"
        + " FROM                                                                   \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                       \n"
        + "   IUF_T_PROCEDIMENTO P,                                                \n"
        + "   IUF_R_LIVELLO_BANDO LB,                                              \n"
        + "   IUF_R_LIVELLO_INTERVENTO LI,                                         \n"
        + "   IUF_D_DESCRIZIONE_INTERVENTO DI,                                     \n"
        + "   IUF_R_AGGREGAZIONE_INTERVENT AI,                                    \n"
        + "   IUF_D_TIPO_AGGREGAZIONE TA                                           \n"
        + " WHERE                                                                  \n"
        + "   PO.ID_PROCEDIMENTO                    = P.ID_PROCEDIMENTO            \n"
        + "   AND P.ID_BANDO                        = LB.ID_BANDO                  \n"
        + "   AND PO.ID_PROCEDIMENTO_OGGETTO        = :ID_PROCEDIMENTO_OGGETTO     \n"
        + "   AND LI.ID_LIVELLO                     = LB.ID_LIVELLO                \n"
        + "   AND LI.ID_DESCRIZIONE_INTERVENTO      = DI.ID_DESCRIZIONE_INTERVENTO \n"
        + "   AND TRUNC(NVL(DI.DATA_CESSAZIONE,SYSDATE))   <= TRUNC(SYSDATE)       \n"
        + "   AND DI.ID_DESCRIZIONE_INTERVENTO      = AI.ID_DESCRIZIONE_INTERVENTO \n"
        + "   AND AI.ID_TIPO_AGGREGAZIONE_PRIMO_LIV = TA.ID_TIPO_AGGREGAZIONE      \n"
        + " ORDER BY                                                               \n"
        + "   DI.DESCRIZIONE                                                       \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return (List<DecodificaInterventoDTO>) namedParameterJdbcTemplate.query(
          QUERY, mapParameterSource, new RowMapper<DecodificaInterventoDTO>()
          {
            @Override
            public DecodificaInterventoDTO mapRow(ResultSet rs, int arg1)
                throws SQLException
            {
              DecodificaInterventoDTO decodificaInterventoDTO = new DecodificaInterventoDTO();
              decodificaInterventoDTO
                  .setId(rs.getLong("ID_DESCRIZIONE_INTERVENTO"));
              decodificaInterventoDTO
                  .setDescrizione(rs.getString("DESC_INTERVENTO"));
              decodificaInterventoDTO.setDescrizioneAggregazionePrimoLivello(
                  rs.getString("DESC_AGGREGAZIONE_1L"));
              decodificaInterventoDTO.setCodice(rs.getString("ID_LIVELLO"));
              return decodificaInterventoDTO;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean canDeleteProcedimentoOggetto(long idProcedimentoOggetto,
      long idBandoOggetto, boolean checkIstanza)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::canDeleteProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                  \n"
        + "   DO.ID_OGGETTO                                                                         \n"
        + " FROM                                                                                    \n"
        + "   IUF_R_BANDO_OGGETTO BO,                                                               \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                                                      \n"
        + "   IUF_D_OGGETTO DO,                                                                     \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO                                                         \n"
        + " WHERE                                                                                   \n"
        + "   BO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO                            \n"
        + "   AND LGO.ID_OGGETTO = DO.ID_OGGETTO                                                    \n"
        + "   AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO                        \n"
        + "   AND BO.ID_BANDO_OGGETTO = :ID_BANDO_OGGETTO                                           \n"
        + "   AND PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                             \n"
        + "   AND PO.DATA_FINE IS NULL                                                              \n"
        + "   AND DO.FLAG_ISTANZA = :FLAG_ISTANZA                                                   \n"
        + "   AND BO.FLAG_ATTIVO = 'S'                                                              \n"
        + "   AND SYSDATE BETWEEN BO.DATA_INIZIO AND NVL(BO.DATA_RITARDO,NVL(BO.DATA_FINE,SYSDATE)) \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO_OGGETTO", idBandoOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("FLAG_ISTANZA", (checkIstanza) ? "S" : "N",
          Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idBandoOggetto", idBandoOggetto),
              new LogParameter("FLAG_ISTANZA", (checkIstanza) ? "S" : "N")
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public MainControlloDTO callMainEliminazione(long idProcedimentoOggetto,
      long idUtenteLogin) throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainEliminazione";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_GESTIONE_PROC_OGGETT.MainEliminazione");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_GESTIONE_PROC_OGGETT")
              .withProcedureName("MainEliminazione")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));
      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      dto.setIdProcedimento((BigDecimal) results.get("RESULT"));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public MainControlloDTO callMainRiapertura(long idProcedimentoOggetto,
      String note, Long idUtenteLogin) throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainRiapertura";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_GESTIONE_PROC_OGGETT.MainRiapertura");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PNOTE", note, Types.VARCHAR);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_GESTIONE_PROC_OGGETT")
              .withProcedureName("MainRiapertura")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PNOTE", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));
      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      dto.setIdProcedimento((BigDecimal) results.get("RESULT"));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public void deleteOpCampoLocalizzazione(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteOpCampoLocalizzazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_OP_CAMPO_LOCALIZZAZIONE 			 					\n"
        + " WHERE ID_OPERAZIONI_CAMPO IN (									\n"
        + "		SELECT A.ID_OPERAZIONI_CAMPO 									\n"
        + "		FROM IUF_T_OPERAZIONI_CAMPO A 								\n"
        + "		WHERE A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO )\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteOpCampoLocalizzazioneById(long idOperazioniCampo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::deleteOpCampoLocalizzazioneById]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_OP_CAMPO_LOCALIZZAZIONE 	\n"
        + " WHERE ID_OPERAZIONI_CAMPO = :ID_OPERAZIONI_CAMPO 			\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_OPERAZIONI_CAMPO", idOperazioniCampo,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_OPERAZIONI_CAMPO", idOperazioniCampo)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteOperazioniCampo(long idOperazioniCampo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteOperazioniCampo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_OPERAZIONI_CAMPO 		  \n"
        + " WHERE ID_OPERAZIONI_CAMPO  = :ID_OPERAZIONI_CAMPO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_OPERAZIONI_CAMPO", idOperazioniCampo,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_OPERAZIONI_CAMPO", idOperazioniCampo)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DelegaAnagrafeVO getDettaglioDelega(long idAzienda,
      Date dataRiferimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDettaglioDelega]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = new String(
        " SELECT                                                                                       \n"
            + "   A.CODICE_FISCALE,                                                                          \n"
            + "   A.DESC_COMUNE_CAA,                                                                         \n"
            + "   A.ID_INTERMEDIARIO_ZONA,																   \n"
            + "   A.DENOMINAZIONE                                                                            \n"
            + " FROM                                                                                         \n"
            + "   SMRGAA_V_DATI_DELEGA A                                                                     \n"
            + " WHERE                                                                                        \n"
            + "   A.ID_AZIENDA = :ID_AZIENDA                                                                 \n"
            + "   AND NVL(:DATA_RIFERIMENTO,SYSDATE) BETWEEN A.DATA_INIZIO_VALIDITA AND NVL(A.DATA_FINE_VALIDITA,SYSDATE) \n");

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA", idAzienda, Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", dataRiferimento,
          Types.TIMESTAMP);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<DelegaAnagrafeVO>()
          {
            @Override
            public DelegaAnagrafeVO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              DelegaAnagrafeVO item = null;
              if (rs.next())
              {
                item = new DelegaAnagrafeVO();
                item.setCodiceFiscIntermediario(rs.getString("CODICE_FISCALE"));
                item.setDenominazione(rs.getString("DENOMINAZIONE"));
                item.setComuneUfficioZona(rs.getString("DESC_COMUNE_CAA"));
                item.setIdIntermediario(rs.getString("ID_INTERMEDIARIO_ZONA"));
              }
              return item;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idAzienda", idAzienda),
              new LogParameter("dataRiferimento", dataRiferimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Date updateDataFineIterProcedimentoOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateDataFineIterProcedimentoOggetto]";
    Date dataFine = new Date();
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                 	  \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE A                     	  \n"
        + " SET                                                    	  \n"
        + "   A.DATA_FINE = :DATA_FINE                               	  \n"
        + " WHERE                                                  	  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	  \n"
        + "   AND A.DATA_FINE IS NULL                              	  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("DATA_FINE", dataFine, Types.TIMESTAMP);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
      return dataFine;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("dataFine", dataFine),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateDataFineIterProcedimentoOggetto(long idProcedimentoOggetto,
      Date dataFine) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateDataFineIterProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                 	  \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE A                     	  \n"
        + " SET                                                    	  \n"
        + "   A.DATA_FINE = :DATA_FINE                               	  \n"
        + " WHERE                                                  	  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	  \n"
        + "   AND A.DATA_FINE IS NULL                              	  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("DATA_FINE", dataFine, Types.TIMESTAMP);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("dataFine", dataFine),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertIterProcedimOggetto(long idProcedimentoOggetto,
      int idStatoOggetto, Date dataInizio, Date dataFine, String note,
      long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertIterProcedimOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE            \n"
        + "   (                                         \n"
        + "     ID_ITER_PROCEDIMENTO_OGGETT,            \n"
        + "     ID_PROCEDIMENTO_OGGETTO,                \n"
        + "     ID_STATO_OGGETTO,                  		\n"
        + "     DATA_INIZIO,                            \n"
        + "     DATA_FINE,                            	\n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO,            \n"
        + "     NOTE                            		\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_ITER_PROCEDIMEN_OG.NEXTVAL, \n"
        + "     :ID_PROCEDIMENTO_OGGETTO,                \n"
        + "     :ID_STATO_OGGETTO,                  		\n"
        + "     :DATA_INIZIO,                            \n"
        + "     :DATA_FINE,                            	\n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO,            \n"
        + "     :NOTE                            		\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_STATO_OGGETTO", idStatoOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_INIZIO", dataInizio, Types.TIMESTAMP);
      mapParameterSource.addValue("DATA_FINE", dataFine, Types.TIMESTAMP);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idStatoOggetto", idStatoOggetto),
              new LogParameter("dataInizio", dataInizio),
              new LogParameter("dataFine", dataFine),
              new LogParameter("note", note),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateIdStatoStampa(long idProcedimentoOggettoStampa,
      long idStatoStampa) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateIdStatoStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                                     \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                            \n"
        + " SET                                                        \n"
        + "   ID_STATO_STAMPA = :ID_STATO_STAMPA                       \n"
        + " WHERE                                                      \n"
        + "   ID_PROCEDIM_OGGETTO_STAMPA = :ID_PROCEDIM_OGGETTO_STAMPA \n"
        + "   AND DATA_FINE IS NULL                                    \n";

    MapSqlParameterSource mapParameterSource = null;
    try
    {
      short id = (short) idStatoStampa;
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_STATO_STAMPA", (short) id, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIM_OGGETTO_STAMPA",
          idProcedimentoOggettoStampa, Types.NUMERIC);

      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggettoStampa",
                  idProcedimentoOggettoStampa),
              new LogParameter("idStatoStampa", idStatoStampa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void chiudiIterStampa(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateIdStatoStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                                        \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                               \n"
        + " SET                                                           \n"
        + "   DATA_FINE = SYSDATE				                          \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n"
        + "   AND DATA_FINE IS NULL";

    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimOggettoStampaDTO getLastProcedimOggettoStampa(
      long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getLastProcedimOggettoStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    StringBuilder queryBuff = new StringBuilder(
        " SELECT                      \n"
            + "       *                                                           \n"
            + "     FROM                                                          \n"
            + "       IUF_T_PROCEDIM_OGGETTO_STAMP POS                           \n"
            + "     WHERE                                                         \n"
            + "       POS.ID_PROCEDIMENTO_OGGETTO    = :ID_PROCEDIMENTO_OGGETTO \n"
            + "       AND POS.DATA_FINE             IS NULL                       \n");

    final String QUERY = queryBuff.toString();
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return queryForObject(QUERY, mapParameterSource,
          ProcedimOggettoStampaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteRDettaglioImpegnoByIdProcedimentoOggetto(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::deleteRDettaglioImpegnoByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_R_DETTAGLIO_IMPEGNO 			 	\n"
        + " WHERE ID_IMPEGNO_PROC_OGG IN (									\n"
        + "		SELECT A.ID_IMPEGNO_PROC_OGG 								\n"
        + "		FROM IUF_T_IMPEGNO_PROC_OGG A, IUF_T_DATI_PROCEDIMENTO B 	\n"
        + "		WHERE A.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO   	\n"
        + "     AND B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO )	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteTImpegnoByIdProcedimentoOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::deleteRDettaglioImpegnoByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_IMPEGNO_PROC_OGG 			 	\n"
        + " WHERE ID_IMPEGNO_PROC_OGG IN (									\n"
        + "		SELECT A.ID_IMPEGNO_PROC_OGG 								\n"
        + "		FROM IUF_T_IMPEGNO_PROC_OGG A, IUF_T_DATI_PROCEDIMENTO B 	\n"
        + "		WHERE A.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO   	\n"
        + "     AND B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO )	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertRdettaglioImpegno(long idImpegnoProcOgg, long idImpegno)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertRdettaglioImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      		\n"
        + " INTO                                        \n"
        + "   IUF_R_DETTAGLIO_IMPEGNO            		\n"
        + "   (                                         \n"
        + "     ID_IMPEGNO_PROC_OGG,            		\n"
        + "     ID_IMPEGNO                   			\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_IMPEGNO_PROC_OGG, 					\n"
        + "     :ID_IMPEGNO                 			\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_IMPEGNO_PROC_OGG", idImpegnoProcOgg,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO", idImpegno, Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idImpegno", idImpegno),
              new LogParameter("idImpegnoProcOgg", idImpegnoProcOgg)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteTParticellaPremio(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteTParticellaPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_PARTICELLA_PREMIO                            	\n"
        + "  WHERE ID_PARTICELLA_PREMIO IN (                               	\n"
        + "     SELECT                                                     	\n"
        + "      A.ID_PARTICELLA_PREMIO                                    	\n"
        + "     FROM                                                       	\n"
        + "       IUF_T_PARTICELLA_UTILIZZO C,                             	\n"
        + "       IUF_T_DATI_PROCEDIMENTO B,                               	\n"
        + "       IUF_T_PARTICELLA_PREMIO A                                	\n"
        + "     WHERE                                                      	\n"
        + "       C.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO          	\n"
        + "       AND A.ID_PARTICELLA_UTILIZZO = C.ID_PARTICELLA_UTILIZZO  	\n"
        + "       AND B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	\n"
        + "       AND NOT EXISTS (                                         	\n"
        + "           SELECT *                                             	\n"
        + "           FROM IUF_T_PARTICELLA_IMPEGNO B1,                       \n"
        + " 				 IUF_D_IMPEGNO B2									\n"
        + "           WHERE                                                	\n"
        + "             B1.ID_IMPEGNO = B2.ID_IMPEGNO   						\n"
        + "             AND B1.ID_PARTICELLA_UTILIZZO = C.ID_PARTICELLA_UTILIZZO 	\n"
        + "             AND B2.ID_LIVELLO = A.ID_LIVELLO                   	\n"
        + "       )                                                        	\n"
        + "     )                                                          	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteTParticellaImpegno(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteTParticellaImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_PARTICELLA_IMPEGNO                               \n"
        + "  WHERE ID_PARTICELLA_IMPEGNO IN (                                  \n"
        + "  SELECT                                                            \n"
        + "      A.ID_PARTICELLA_IMPEGNO                                       \n"
        + "     FROM                                                           \n"
        + "       IUF_T_PARTICELLA_UTILIZZO C,                                 \n"
        + "       IUF_T_DATI_PROCEDIMENTO B,                                   \n"
        + "       IUF_T_PARTICELLA_IMPEGNO A                                   \n"
        + "     WHERE                                                          \n"
        + "       C.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO              \n"
        + "       AND A.ID_PARTICELLA_UTILIZZO = C.ID_PARTICELLA_UTILIZZO      \n"
        + "       AND B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO     \n"
        + "       AND NOT EXISTS (                                             \n"
        + "           SELECT B1.ID_IMPEGNO                                     \n"
        + "           FROM                                                     \n"
        + "                IUF_T_IMPEGNO_PROC_OGG A1,                          \n"
        + "                IUF_R_DETTAGLIO_IMPEGNO B1                          \n"
        + "           WHERE                                                    \n"
        + "                A1.ID_DATI_PROCEDIMENTO = C.ID_DATI_PROCEDIMENTO    \n"
        + "                AND A1.ID_IMPEGNO_PROC_OGG = B1.ID_IMPEGNO_PROC_OGG \n"
        + "                AND B1.ID_IMPEGNO = A.ID_IMPEGNO                    \n"
        + "       )                                                            \n"
        + " )                                                                  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void resetSupImpegnoParticelle(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteTParticellaImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " UPDATE IUF_T_PARTICELLA_UTILIZZO V SET V.SUPERFICIE_IMPEGNO = NULL   \n"
        + "   WHERE V.ID_PARTICELLA_UTILIZZO IN (                                \n"
        + "   SELECT                                                             \n"
        + "       C.ID_PARTICELLA_UTILIZZO                                       \n"
        + "      FROM                                                            \n"
        + "        IUF_T_PARTICELLA_UTILIZZO C,                                  \n"
        + "        IUF_T_DATI_PROCEDIMENTO B                                     \n"
        + "      WHERE                                                           \n"
        + "        C.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO               \n"
        + "        AND B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO      \n"
        + "        AND C.SUPERFICIE_IMPEGNO IS NOT NULL                          \n"
        + "        AND NOT EXISTS (                                              \n"
        + "            SELECT B1.ID_PARTICELLA_UTILIZZO                          \n"
        + "            FROM                                                      \n"
        + "                 IUF_T_PARTICELLA_PREMIO B1                           \n"
        + "            WHERE                                                     \n"
        + "                 B1.ID_PARTICELLA_UTILIZZO = C.ID_PARTICELLA_UTILIZZO \n"
        + "        )                                                             \n"
        + " )                                                                    \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateSuperficieImpegno(long idParticellaUtilizzo,
      BigDecimal supImpegno) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateSuperficieImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                              \n"
        + "   IUF_T_PARTICELLA_UTILIZZO                         \n"
        + " SET                                                 \n"
        + "   SUPERFICIE_IMPEGNO = :SUPERFICIE_IMPEGNO          \n"
        + " WHERE                                               \n"
        + "   ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      mapParameterSource.addValue("SUPERFICIE_IMPEGNO",
          (supImpegno != null) ? supImpegno.setScale(4) : null, Types.DECIMAL);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo),
              new LogParameter("supImpegno", supImpegno)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertTParticellaPremio(long idLivello, long idParticellaUtilizzo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTParticellaPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      		\n"
        + " INTO                                        \n"
        + "   IUF_T_PARTICELLA_PREMIO            		\n"
        + "   (                                         \n"
        + "     ID_PARTICELLA_PREMIO,            		\n"
        + "     ID_LIVELLO,                   			\n"
        + "     ID_CLASSE_PREMIO,                   	\n"
        + "     SUPERFICIE_A_PREMIO,                   	\n"
        + "     ID_PARTICELLA_UTILIZZO         			\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     " + getNextSequenceValue("SEQ_IUF_T_PARTICELLA_PREMIO")
        + ", \n"
        + "     :ID_LIVELLO,                   			\n"
        + "     NULL,                   				\n"
        + "     NULL,                   				\n"
        + "     :ID_PARTICELLA_UTILIZZO         		\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idLivello", idLivello),
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertTParticellaImpegno(long idParticellaUtilizzo, long idImpegno,
      Long idImpegnoSpecifico) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTParticellaImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      							\n"
        + " INTO                                        					\n"
        + "   IUF_T_PARTICELLA_IMPEGNO            							\n"
        + "   (                                         					\n"
        + "     ID_PARTICELLA_IMPEGNO,            							\n"
        + "     ID_PARTICELLA_UTILIZZO,                   					\n"
        + "     ID_IMPEGNO,                   								\n"
        + "     ID_IMPEGNO_SPECIFICO                   						\n"
        + "   )                                         					\n"
        + "   VALUES                                    					\n"
        + "   (                                         					\n"
        + "     " + getNextSequenceValue("SEQ_IUF_T_PARTICELLA_IMPEGNO")
        + ", 	\n"
        + "     :ID_PARTICELLA_UTILIZZO,                   					\n"
        + "     :ID_IMPEGNO,                   								\n"
        + "     :ID_IMPEGNO_SPECIFICO                   					\n"
        + "   )                                         					\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO", idImpegno, Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO_SPECIFICO", idImpegnoSpecifico,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo),
              new LogParameter("idImpegno", idImpegno),
              new LogParameter("idImpegnoSpecifico", idImpegnoSpecifico)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdDatiProcedimento(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdDatiProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                      \n"
        + "   PA.ID_DATI_PROCEDIMENTO                                   \n"
        + " FROM                                                        \n"
        + "   IUF_T_DATI_PROCEDIMENTO PA                                \n"
        + " WHERE                                                       \n"
        + "   PA.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteTCaniGuardia(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteTCaniGuardia]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_CANI_GUARDIA_PASCOLO 							\n"
        + " WHERE ID_DATI_PROCEDIMENTO IN (									\n"
        + "		SELECT A.ID_DATI_PROCEDIMENTO 								\n"
        + "		FROM IUF_T_DATI_PROCEDIMENTO A 								\n"
        + "		WHERE A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO )\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<String>> getDecodificheRazze(
      long idCategoriaAnimale) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDecodificheRazze]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                               \n"
        + "   A.ID_RAZZA_PROTETTA,	                           \n"
        + "   A.CODICE,                                          \n"
        + "   A.DESCRIZIONE                                      \n"
        + " FROM                                                 \n"
        + "   IUF_D_RAZZA_PROTETTA A                             \n"
        + " WHERE                                                \n"
        + "   A.EXT_ID_CATEGORIA_ANIMALE = :ID_CATEGORIA_ANIMALE \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_CATEGORIA_ANIMALE", idCategoriaAnimale,
          Types.NUMERIC);
      return (List<DecodificaDTO<String>>) namedParameterJdbcTemplate.query(
          QUERY, mapParameterSource, new RowMapper<DecodificaDTO<String>>()
          {
            @Override
            public DecodificaDTO<String> mapRow(ResultSet rs, int arg1)
                throws SQLException
            {
              DecodificaDTO<String> dec = new DecodificaDTO<String>();
              dec.setId(rs.getString("ID_RAZZA_PROTETTA"));
              dec.setDescrizione(rs.getString("DESCRIZIONE"));
              dec.setCodice(rs.getString("CODICE"));
              return dec;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idCategoriaAnimale", idCategoriaAnimale)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Date getDataLimiteFirmaGrafomemetrica(long idProcedimentoOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getDataLimiteFirmaGrafomemetrica]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                          \n"
        + "   NVL(BO.DATA_RITARDO, BO.DATA_FINE) AS DATA                    \n"
        + " FROM                                                            \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                \n"
        + "   IUF_T_PROCEDIMENTO P,                                         \n"
        + "   IUF_R_BANDO_OGGETTO BO                                        \n"
        + " WHERE                                                           \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO      = :ID_PROCEDIMENTO_OGGETTO    \n"
        + "   AND PO.ID_PROCEDIMENTO          = P.ID_PROCEDIMENTO           \n"
        + "   AND PO.ID_LEGAME_GRUPPO_OGGETTO = BO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND P.ID_BANDO                  = BO.ID_BANDO                 \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.queryForObject(QUERY,
          mapParameterSource, java.sql.Timestamp.class);
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Date getDataLimiteRinunciaTotale(long idProcedimentoOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDataLimiteRinunciaTotale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                  \n"
        + "   B.DATA_FINE                                           \n"
        + " FROM                                                    \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                        \n"
        + "   IUF_T_PROCEDIMENTO P,                                 \n"
        + "   IUF_D_BANDO B                                         \n"
        + " WHERE                                                   \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND PO.ID_PROCEDIMENTO     = P.ID_PROCEDIMENTO        \n"
        + "   AND P.ID_BANDO             = B.ID_BANDO               \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.queryForObject(QUERY,
          mapParameterSource, java.sql.Timestamp.class);
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long insertTRazzeAllevate(long idAllevamento, long idRazzaProtetta,
      BigDecimal numeroCapi) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTRazzeAllevate]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_RAZZE_ALLEVATE 	\n"
        + " (ID_RAZZE_ALLEVATE, 				\n"
        + "	 ID_ALLEVAMENTO, 					\n"
        + "	 ID_RAZZA_PROTETTA, 				\n"
        + "	 NUMERO_CAPI 						\n"
        + ") 									\n"
        + "VALUES 								\n"
        + " (:ID_RAZZE_ALLEVATE, 				\n"
        + "	 :ID_ALLEVAMENTO, 					\n"
        + "	 :ID_RAZZA_PROTETTA, 				\n"
        + "	 :NUMERO_CAPI 						\n"
        + ") 									\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idRazzaAllevata = 0;
    try
    {
      idRazzaAllevata = getNextSequenceValue("SEQ_IUF_T_RAZZE_ALLEVATE");
      mapParameterSource.addValue("ID_RAZZE_ALLEVATE", idRazzaAllevata,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_ALLEVAMENTO", idAllevamento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_RAZZA_PROTETTA", idRazzaProtetta,
          Types.NUMERIC);
      mapParameterSource.addValue("NUMERO_CAPI", numeroCapi, Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idRazzaAllevata", idRazzaAllevata),
              new LogParameter("idAllevamento", idAllevamento),
              new LogParameter("idRazzaProtetta", idRazzaProtetta),
              new LogParameter("numeroCapi", numeroCapi)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
    return idRazzaAllevata;
  }

  public void insertTIdentificativoCapo(long idRazzeAllevate, String identif)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTIdentificativoCapo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_IDENTIFICATIVO_CAPO \n"
        + " (ID_RAZZE_ALLEVATE, 				\n"
        + "	 COD_IDENTIFICATIVO_INDIVIDUALE 	\n"
        + ") 									\n"
        + "VALUES 								\n"
        + " (:ID_RAZZE_ALLEVATE, 				\n"
        + "	 :COD_IDENTIFICATIVO_INDIVIDUALE 	\n"
        + ") 									\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_RAZZE_ALLEVATE", idRazzeAllevate,
          Types.NUMERIC);
      mapParameterSource.addValue("COD_IDENTIFICATIVO_INDIVIDUALE", identif,
          Types.VARCHAR);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idRazzeAllevate", idRazzeAllevate),
              new LogParameter("identif", identif)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteTIdentificativoCapo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteTIdentificativoCapo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_IDENTIFICATIVO_CAPO 							 \n"
        + " WHERE ID_RAZZE_ALLEVATE IN (									 \n"
        + "		SELECT C.ID_RAZZE_ALLEVATE 								     \n"
        + "		FROM IUF_T_DATI_PROCEDIMENTO A, 							 \n"
        + "			 IUF_T_ALLEVAMENTO B, 								     \n"
        + "			 IUF_T_RAZZE_ALLEVATE C 								 \n"
        + "		WHERE 														 \n"
        + "			A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	 \n"
        + "			AND A.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO 	 \n"
        + "			AND B.ID_ALLEVAMENTO = C.ID_ALLEVAMENTO                	)\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteTRazzeAllevate(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteTRazzeAllevate]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_RAZZE_ALLEVATE		 							 \n"
        + " WHERE ID_RAZZE_ALLEVATE IN (									 \n"
        + "		SELECT C.ID_RAZZE_ALLEVATE 								     \n"
        + "		FROM IUF_T_DATI_PROCEDIMENTO A, 							 \n"
        + "			 IUF_T_ALLEVAMENTO B, 								     \n"
        + "			 IUF_T_RAZZE_ALLEVATE C 								 \n"
        + "		WHERE 														 \n"
        + "			A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	 \n"
        + "			AND A.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO 	 \n"
        + "			AND B.ID_ALLEVAMENTO = C.ID_ALLEVAMENTO                	)\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateTPascolo(long idPascolo, long idZonaAltimetricaUba,
      Date dataInizio, Date dataFine) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateTPascolo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                  \n"
        + "   IUF_T_PASCOLO                                  		\n"
        + " SET                                                     \n"
        + "   ID_ZONA_ALTIMETRICA_UBA = :ID_ZONA_ALTIMETRICA_UBA,   \n"
        + "   DATA_INIZIO_PASCOLO     = :DATA_INIZIO_PASCOLO,       \n"
        + "   DATA_FINE_PASCOLO   	  = :DATA_FINE_PASCOLO          \n"
        + " WHERE                                                   \n"
        + "   ID_PASCOLO = :ID_PASCOLO          					\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PASCOLO", idPascolo, Types.NUMERIC);
      mapParameterSource.addValue("ID_ZONA_ALTIMETRICA_UBA",
          idZonaAltimetricaUba, Types.NUMERIC);
      mapParameterSource.addValue("DATA_INIZIO_PASCOLO", dataInizio,
          Types.DATE);
      mapParameterSource.addValue("DATA_FINE_PASCOLO", dataFine, Types.DATE);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idPascolo", idPascolo),
              new LogParameter("idZonaAltimetricaUba", idZonaAltimetricaUba),
              new LogParameter("dataInizio", dataInizio),
              new LogParameter("dataFine", dataFine),
              new LogParameter("dataFine", dataFine)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long insertTPascolo(long idProcedimentoOggetto,
      long idZonaAltimetricaUba, Date dataInizio, Date dataFine)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTPascolo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_PASCOLO 			\n"
        + " (ID_PASCOLO, 						\n"
        + "	 ID_DATI_PROCEDIMENTO, 				\n"
        + "	 ID_ZONA_ALTIMETRICA_UBA, 			\n"
        + "	 DATA_INIZIO_PASCOLO, 				\n"
        + "	 DATA_FINE_PASCOLO					\n"
        + ") 									\n"
        + "VALUES 								\n"
        + " (:ID_PASCOLO, 						\n"
        + "	 :ID_DATI_PROCEDIMENTO, 			\n"
        + "	 :ID_ZONA_ALTIMETRICA_UBA, 			\n"
        + "	 :DATA_INIZIO_PASCOLO, 				\n"
        + "	 :DATA_FINE_PASCOLO	)				\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idPascolo = 0;
    try
    {
      idPascolo = getNextSequenceValue("SEQ_IUF_T_PASCOLO");
      mapParameterSource.addValue("ID_PASCOLO", idPascolo, Types.NUMERIC);
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO",
          getIdDatiProcedimento(idProcedimentoOggetto), Types.NUMERIC);
      mapParameterSource.addValue("ID_ZONA_ALTIMETRICA_UBA",
          idZonaAltimetricaUba, Types.NUMERIC);
      mapParameterSource.addValue("DATA_INIZIO_PASCOLO", dataInizio,
          Types.DATE);
      mapParameterSource.addValue("DATA_FINE_PASCOLO", dataFine, Types.DATE);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idPascolo", idPascolo),
              new LogParameter("idZonaAltimetricaUba", idZonaAltimetricaUba),
              new LogParameter("dataInizio", dataInizio),
              new LogParameter("dataFine", dataFine)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
    return idPascolo;
  }

  public void insertRPascoloAllevamento(long idPascolo, long idAllevamento,
      long numCapi, BigDecimal ubaAlPascolo) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertRPascoloAllevamento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_R_PASCOLO_ALLEVAMENTO \n"
        + " (ID_PASCOLO, 						 \n"
        + "	 ID_ALLEVAMENTO, 				     \n"
        + "	 NUMERO_CAPI_AL_PASCOLO, 			 \n"
        + "	 UBA_AL_PASCOLO 				     \n"
        + ") 									 \n"
        + "VALUES 								 \n"
        + " (:ID_PASCOLO, 						 \n"
        + "	 :ID_ALLEVAMENTO, 				     \n"
        + "	 :NUMERO_CAPI_AL_PASCOLO, 			 \n"
        + "	 :UBA_AL_PASCOLO 				     \n"
        + ") 									 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PASCOLO", idPascolo, Types.NUMERIC);
      mapParameterSource.addValue("ID_ALLEVAMENTO", idAllevamento,
          Types.NUMERIC);
      mapParameterSource.addValue("NUMERO_CAPI_AL_PASCOLO", numCapi,
          Types.NUMERIC);
      mapParameterSource.addValue("UBA_AL_PASCOLO", ubaAlPascolo,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idPascolo", idPascolo),
              new LogParameter("idAllevamento", idAllevamento),
              new LogParameter("numCapi", numCapi),
              new LogParameter("ubaAlPascolo", ubaAlPascolo)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public BigDecimal getCoefficienteUba(long idCategoriaAnimale)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getCoefficienteUba]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT                                         \n"
        + "         COEFFICIENTE_UBA                                       \n"
        + "       FROM                                                     \n"
        + "         IUF_D_CATEGORIA_ANIMALE                                \n"
        + "       WHERE                                                    \n"
        + "         EXT_ID_CATEGORIA_ANIMALE      = :ID_CATEGORIA_ANIMALE  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_CATEGORIA_ANIMALE", idCategoriaAnimale,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<BigDecimal>()
          {

            @Override
            public BigDecimal extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              BigDecimal ret = null;
              if (rs.next())
              {
                ret = rs.getBigDecimal("COEFFICIENTE_UBA");
              }
              return ret;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idCategoriaAnimale", idCategoriaAnimale)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getCuaaAttualeAziendaFromIdProcedimento(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getCuaaAziendaFromIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                 \n"
        + "   CUAA                                                                 \n"
        + " FROM                                                                   \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PA,                                       \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI DA                                          \n"
        + " WHERE                                                                  \n"
        + "   PA.EXT_ID_AZIENDA = DA.ID_AZIENDA                                    \n"
        + "   AND SYSDATE BETWEEN PA.DATA_INIZIO                                   \n"
        + "     AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY'))          \n"
        + "   AND SYSDATE BETWEEN DA.DATA_INIZIO_VALIDITA                          \n"
        + "     AND NVL(DA.DATA_FINE_VALIDITA, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "   AND PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                            \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateSuperficieUtilizzata(long idParticellaUtilizzo,
      BigDecimal supUtilizzata) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateSuperficieImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                              \n"
        + "   IUF_T_PARTICELLA_UTILIZZO                         \n"
        + " SET                                                 \n"
        + "   SUPERFICIE_UTILIZZATA = :SUPERFICIE_UTILIZZATA    \n"
        + " WHERE                                               \n"
        + "   ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      mapParameterSource.addValue("SUPERFICIE_UTILIZZATA",
          (supUtilizzata != null) ? supUtilizzata.setScale(4) : null,
          Types.DECIMAL);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo),
              new LogParameter("supUtilizzata", supUtilizzata)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long inserisciTParticellaUtilizzo(long idParticellaUtilizzo,
      BigDecimal supUtilizzata) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTRazzeAllevate]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT INTO IUF_T_PARTICELLA_UTILIZZO                \n"
        + " (                                                    \n"
        + " ID_PARTICELLA_UTILIZZO,                              \n"
        + " ID_DATI_PROCEDIMENTO,                                \n"
        + " EXT_ID_CONDUZIONE_DICHIARATA,                        \n"
        + " EXT_ID_UTILIZZO_DICHIARATO,                          \n"
        + " SUPERFICIE_UTILIZZATA,                               \n"
        + " SUPERFICIE_IMPEGNO                                   \n"
        + " )                                                    \n"
        + " SELECT                                               \n"
        + "   SEQ_IUF_T_PARTICELLA_UTILIZZ.NEXTVAL,             \n"
        + "   A.ID_DATI_PROCEDIMENTO,                            \n"
        + "   A.EXT_ID_CONDUZIONE_DICHIARATA,                    \n"
        + "   A.EXT_ID_UTILIZZO_DICHIARATO,                      \n"
        + "   :SUPERFICIE_UTILIZZATA,                            \n"
        + "   A.SUPERFICIE_IMPEGNO                               \n"
        + " FROM                                                 \n"
        + "   IUF_T_PARTICELLA_UTILIZZO A                        \n"
        + " WHERE                                                \n"
        + "   A.ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idRazzaAllevata = 0;
    try
    {
      idRazzaAllevata = getNextSequenceValue("SEQ_IUF_T_RAZZE_ALLEVATE");
      mapParameterSource.addValue("SUPERFICIE_UTILIZZATA", supUtilizzata,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo),
              new LogParameter("supUtilizzata", supUtilizzata)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
    return idRazzaAllevata;
  }

  public String getCodiceLivello(long idLivello)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getCodiceLivello]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                            \n"
        + "   A.CODICE_LIVELLO                \n"
        + " FROM                              \n"
        + "   IUF_D_LIVELLO A                 \n"
        + " WHERE                    			\n"
        + "   A.ID_LIVELLO = :ID_LIVELLO      \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
    try
    {
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean existProduzioneIntegrata(String cuaa)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::existProduzioneIntegrata]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT           				\n"
        + "   COUNT(*)                      \n"
        + " FROM                            \n"
        + "   IUF_W_PRODUZIONE_INTEGRATA    \n"
        + " WHERE                           \n"
        + "   CUAA = :CUAA 					\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("CUAA", cuaa, Types.VARCHAR);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /* CU DI RIFERIMENTO: "160" */
  public List<RaggruppamentoLivelloCriterio> getCriteriPunteggio(
      final long idDatiProcedimentoPunti, final long idBando,
      final boolean isOggettoIstanza) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getCriteriPunteggio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final StringBuffer QUERY = new StringBuffer(
        " WITH PUNTI AS                                                                                                                                                       \n"
            + " (                                                                                                                                                                   \n"
            + "   SELECT                                                                                                                                                            \n"
            + "      PUNT.ID_BANDO_LIVELLO_CRITERIO,                                                                                                                                \n"
            + "      PUNT.PUNTEGGIO_CALCOLATO                                                                                                                                       \n"
            + "   FROM                                                                                                                                                              \n"
            + "      IUF_T_PUNTEGGIO_CALCOLATO PUNT,                                                                                                                                \n"
            + "      IUF_T_DATI_PROCEDIMENTO_PUNT DAT                                                                                                                              \n"
            + "   WHERE                                                                                                                                                             \n"
            + "      PUNT.ID_DATI_PROCEDIMENTO_PUNTI = DAT.ID_DATI_PROCEDIMENTO_PUNTI                                                                                               \n"
            + "      AND DAT.ID_DATI_PROCEDIMENTO_PUNTI =:ID_DATI_PROCEDIMENTO_PUNTI                                                                                                \n"
            + " )                                                                                                                                                                   \n"
            + " SELECT                                                                                                                                                              \n"
            + "   L.RAGGRUPPAMENTO,                                                                                                                                                 \n"
            + "   LIV.CODICE AS COD_LIVELLO,                                                                                                                                        \n"
            + "   LIV.DESCRIZIONE AS DESCRIZIONE_LIVELLO,                                                                                                                           \n"
            + "   C.ID_CRITERIO,                                                                                                                                                    \n"
            + "   C.ID_PRINCIPIO_SELEZIONE,                                                                                                                                         \n"
            + "   C.CODICE,                                                                                                                                                         \n"
            + "   C.CRITERIO_SELEZIONE,                                                                                                                                             \n"
            + "   C.SPECIFICHE,                                                                                                                                                     \n"
            + "   C.PUNTEGGIO_MIN,                                                                                                                                                  \n"
            + "   C.PUNTEGGIO_MAX,                                                                                                                                                  \n"
            + "   DECODE(C.PUNTEGGIO_MIN,C.PUNTEGGIO_MAX,NVL(TO_CHAR(C.PUNTEGGIO_MAX),'0'),NVL(TO_CHAR(C.PUNTEGGIO_MIN),'0')||'-'||NVL(TO_CHAR(C.PUNTEGGIO_MAX),'0')) AS PUNTEGGIO, \n"
            + "   C.FLAG_ELABORAZIONE,                                                                                                                                              \n"
            + "   PR.DESCRIZIONE AS DESC_PRINCIPIO_SELEZIONE,                                                                                                                       \n"
            + "   PUNTI.PUNTEGGIO_CALCOLATO,                                                                                                                                        \n");

    if (!isOggettoIstanza)
    {
      QUERY.append(
          "    (                                                               \n"
              + "     SELECT                                                            \n"
              + "       PI.PUNTEGGIO_ISTRUTTORIA                                        \n"
              + "     FROM                                                              \n"
              + "       IUF_T_PUNTEGGIO_ISTRUTTORIA PI                                  \n"
              + "     WHERE                                                             \n"
              + "       PI.ID_DATI_PROCEDIMENTO_PUNTI = :ID_DATI_PROCEDIMENTO_PUNTI     \n"
              + "       AND PI.ID_BANDO_LIVELLO_CRITERIO  = B.ID_BANDO_LIVELLO_CRITERIO \n"
              + "    ) AS PUNTEGGIO_ISTRUTTORIA,                                        \n");
    }

    QUERY.append(
        " B.ID_BANDO_LIVELLO_CRITERIO                                                                                                                              \n"
            + " FROM                                                                                                                                                                \n"
            + "   IUF_R_BANDO_LIVELLO_CRITERIO B,                                                                                                                                   \n"
            + "   IUF_R_LIVELLO_CRITERIO L,                                                                                                                                         \n"
            + "   IUF_D_LIVELLO LIV,                                                                                                                                                \n"
            + "   IUF_D_CRITERIO C,                                                                                                                                                 \n"
            + "   IUF_D_PRINCIPIO_SELEZIONE PR,                                                                                                                                     \n"
            + "   PUNTI                                                                                                                                                             \n"
            + " WHERE                                                                                                                                                               \n"
            + "   PUNTI.ID_BANDO_LIVELLO_CRITERIO = B.ID_BANDO_LIVELLO_CRITERIO                                                                                                     \n"
            + "   AND B.ID_BANDO = :ID_BANDO                                                                                                                                        \n"
            + "   AND L.ID_LIVELLO_CRITERIO = B.ID_LIVELLO_CRITERIO                                                                                                                 \n"
            + "   AND LIV.ID_LIVELLO = L.ID_LIVELLO                                                                                                                                 \n"
            + "   AND C.ID_CRITERIO = L.ID_CRITERIO                                                                                                                                 \n"
            + "   AND PR.ID_PRINCIPIO_SELEZIONE = C.ID_PRINCIPIO_SELEZIONE                                                                                                          \n");

    QUERY.append(
        " ORDER BY LIV.CODICE, LIV.DESCRIZIONE, L.RAGGRUPPAMENTO NULLS FIRST, PR.ORDINE, C.ORDINE                                                                             \n");

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO_PUNTI",
          idDatiProcedimentoPunti, Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO", idBando, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY.toString(),
          mapParameterSource,
          new ResultSetExtractor<List<RaggruppamentoLivelloCriterio>>()
          {

            @Override
            public List<RaggruppamentoLivelloCriterio> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<RaggruppamentoLivelloCriterio> list = new ArrayList<RaggruppamentoLivelloCriterio>();
              RaggruppamentoLivelloCriterio raggruppamentoLivello = null;
              String descrizione = null;
              String raggruppamento = null;
              while (rs.next())
              {
                String descrizioneCorrente = rs
                    .getString("DESCRIZIONE_LIVELLO");
                String raggruppamentoCorrente = IuffiUtils.STRING
                    .nvl(rs.getString("RAGGRUPPAMENTO"));
                if (!raggruppamentoCorrente.equals(raggruppamento)
                    || !descrizioneCorrente.equals(descrizione))
                {
                  raggruppamentoLivello = new RaggruppamentoLivelloCriterio();
                  raggruppamentoLivello.setCriteri(new ArrayList<CriterioVO>());
                  raggruppamentoLivello
                      .setTotalePunteggioCalcolato(BigDecimal.ZERO);
                  raggruppamentoLivello
                      .setTotalePunteggioIstruttoria(BigDecimal.ZERO);
                  list.add(raggruppamentoLivello);
                  raggruppamentoLivello.setDescrizioneLivello(
                      rs.getString("COD_LIVELLO") + " " + descrizioneCorrente);
                  raggruppamentoLivello
                      .setRaggruppamento(raggruppamentoCorrente);
                  descrizione = descrizioneCorrente;
                  raggruppamento = raggruppamentoCorrente;
                }
                CriterioVO nuovoCriterio = new CriterioVO();
                nuovoCriterio.setCodice(rs.getString("CODICE"));
                nuovoCriterio
                    .setCriterioSelezione(rs.getString("CRITERIO_SELEZIONE"));
                nuovoCriterio.setDescPrincipioSelezione(
                    rs.getString("DESC_PRINCIPIO_SELEZIONE"));
                nuovoCriterio
                    .setFlagElaborazione(rs.getString("FLAG_ELABORAZIONE"));
                nuovoCriterio.setIdCriterio(rs.getInt("ID_CRITERIO"));
                nuovoCriterio.setIdPrincipioSelezione(
                    rs.getInt("ID_PRINCIPIO_SELEZIONE"));
                nuovoCriterio
                    .setPunteggioMin(rs.getBigDecimal("PUNTEGGIO_MIN"));
                nuovoCriterio
                    .setPunteggioMax(rs.getBigDecimal("PUNTEGGIO_MAX"));

                if (rs.getBigDecimal("PUNTEGGIO_MIN") == null
                    && rs.getBigDecimal("PUNTEGGIO_MAX") == null)
                {
                  nuovoCriterio.setPunteggio(null);
                }
                else
                {
                  nuovoCriterio.setPunteggio(rs.getString("PUNTEGGIO"));
                }
                nuovoCriterio.setSpecifiche(rs.getString("SPECIFICHE"));
                nuovoCriterio.setIdBandoLivelloCriterio(
                    rs.getLong("ID_BANDO_LIVELLO_CRITERIO"));
                nuovoCriterio.setPunteggioCalcolato(IuffiUtils.NUMBERS
                    .nvl(rs.getBigDecimal("PUNTEGGIO_CALCOLATO")));

                if (!isOggettoIstanza)
                {
                  nuovoCriterio.setPunteggioIstruttoria(
                      rs.getBigDecimal("PUNTEGGIO_ISTRUTTORIA"));
                  if (nuovoCriterio.getPunteggioIstruttoria() != null
                      && nuovoCriterio.getPunteggioIstruttoria()
                          .compareTo(BigDecimal.ZERO) >= 0)
                  {
                    raggruppamentoLivello.setTotalePunteggioIstruttoria(
                        raggruppamentoLivello.getTotalePunteggioIstruttoria()
                            .add(IuffiUtils.NUMBERS
                                .nvl(nuovoCriterio.getPunteggioIstruttoria())));
                  }
                  else
                  {
                    raggruppamentoLivello.setTotalePunteggioIstruttoria(
                        raggruppamentoLivello.getTotalePunteggioIstruttoria()
                            .add(IuffiUtils.NUMBERS
                                .nvl(nuovoCriterio.getPunteggioCalcolato())));
                  }
                }

                raggruppamentoLivello.setTotalePunteggioCalcolato(
                    raggruppamentoLivello.getTotalePunteggioCalcolato()
                        .add(nuovoCriterio.getPunteggioCalcolato()));
                raggruppamentoLivello.getCriteri().add(nuovoCriterio);
              }
              return list;
            }
          });
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idDatiProcedimentoPunti",
              idDatiProcedimentoPunti), new LogParameter("idBando", idBando) },
          new LogVariable[]
          {}, QUERY.toString(), mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /* CU DI RIFERIMENTO: "161" */
  public Long getIdDatiProcedimentoPunti(final long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdDatiProcedimentoPunti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select PP.ID_DATI_PROCEDIMENTO_PUNTI \n"
        + "from IUF_T_DATI_PROCEDIMENTO_PUNT pp, IUF_T_PROCEDIMENTO_OGGETTO po \n"
        + "where po.ID_PROCEDIMENTO_OGGETTO =:ID_PROCEDIMENTO_OGGETTO AND "
        + "(po.ID_PROCEDIMENTO_OGGETTO = PP.ID_PROCEDIMENTO_OGGETTO OR PO.ID_PROCEDIMENTO = PP.ID_PROCEDIMENTO) \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdDatiProcedimentoPuntiByIdProcOgg(
      final long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getIdDatiProcedimentoPuntiByIdProcOgg]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select PP.ID_DATI_PROCEDIMENTO_PUNTI \n"
        + "from IUF_T_DATI_PROCEDIMENTO_PUNT pp, IUF_T_PROCEDIMENTO_OGGETTO po \n"
        + "where po.ID_PROCEDIMENTO_OGGETTO =:ID_PROCEDIMENTO_OGGETTO AND "
        + " po.ID_PROCEDIMENTO_OGGETTO = PP.ID_PROCEDIMENTO_OGGETTO  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdDatiProcedimentoPuntiByIdProcedimento(
      final long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getIdDatiProcedimentoPuntiByIdProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select PP.ID_DATI_PROCEDIMENTO_PUNTI \n"
        + "from IUF_T_DATI_PROCEDIMENTO_PUNT pp, IUF_T_PROCEDIMENTO_OGGETTO po \n"
        + "where po.ID_PROCEDIMENTO_OGGETTO =:ID_PROCEDIMENTO_OGGETTO AND "
        + " PO.ID_PROCEDIMENTO = PP.ID_PROCEDIMENTO \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /* CU DI RIFERIMENTO: "161" */
  public List<RaggruppamentoLivelloCriterio> getCriteriPunteggioManuali(
      final long idDatiProcedimento, long idBando)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getCriteriPunteggioManuali]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "with punti as ("
        + "select PUNT.ID_BANDO_LIVELLO_CRITERIO, PUNT.PUNTEGGIO_CALCOLATO \n"
        + "from IUF_T_PUNTEGGIO_CALCOLATO punt, IUF_T_DATI_PROCEDIMENTO_PUNT dat \n"
        + "where PUNT.ID_DATI_PROCEDIMENTO_PUNTI = DAT.ID_DATI_PROCEDIMENTO_PUNTI and DAT.ID_PROCEDIMENTO =:ID_PROCEDIMENTO and DAT.ID_PROCEDIMENTO_OGGETTO is null "
        + ") \n"
        + "select L.RAGGRUPPAMENTO, LIV.CODICE AS COD_LIVELLO, LIV.DESCRIZIONE as DESCRIZIONE_LIVELLO, C.ID_CRITERIO, C.ID_PRINCIPIO_SELEZIONE, C.CODICE, C.CRITERIO_SELEZIONE, C.SPECIFICHE, C.PUNTEGGIO_MIN, C.PUNTEGGIO_MAX, decode(C.PUNTEGGIO_MIN,C.PUNTEGGIO_MAX,nvl(to_char(C.PUNTEGGIO_MAX),'0'),nvl(to_char(C.PUNTEGGIO_MIN),'0')||'-'||nvl(to_char(C.PUNTEGGIO_MAX),'0')) as PUNTEGGIO, C.FLAG_ELABORAZIONE, PR.DESCRIZIONE as DESC_PRINCIPIO_SELEZIONE, punti.PUNTEGGIO_CALCOLATO, B.ID_BANDO_LIVELLO_CRITERIO \n"
        + "from IUF_R_BANDO_LIVELLO_CRITERIO b, IUF_R_LIVELLO_CRITERIO l, IUF_D_LIVELLO liv, IUF_d_criterio c, IUF_D_PRINCIPIO_SELEZIONE pr, punti	\n"
        + "where punti.ID_BANDO_LIVELLO_CRITERIO = B.ID_BANDO_LIVELLO_CRITERIO and B.ID_BANDO = :ID_BANDO and L.ID_LIVELLO_CRITERIO = B.ID_LIVELLO_CRITERIO and LIV.ID_LIVELLO = L.ID_LIVELLO and C.ID_CRITERIO = L.ID_CRITERIO and PR.ID_PRINCIPIO_SELEZIONE = C.ID_PRINCIPIO_SELEZIONE and C.FLAG_ELABORAZIONE = 'M' \n"
        + "order by LIV.CODICE,  LIV.DESCRIZIONE, L.RAGGRUPPAMENTO nulls first, PR.ORDINE, C.ORDINE \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idDatiProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO", idBando, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<RaggruppamentoLivelloCriterio>>()
          {

            @Override
            public List<RaggruppamentoLivelloCriterio> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<RaggruppamentoLivelloCriterio> list = new ArrayList<RaggruppamentoLivelloCriterio>();
              RaggruppamentoLivelloCriterio raggruppamentoLivello = null;
              String descrizione = null;
              String raggruppamento = null;
              while (rs.next())
              {
                String descrizioneCorrente = rs
                    .getString("DESCRIZIONE_LIVELLO");
                String raggruppamentoCorrente = IuffiUtils.STRING
                    .nvl(rs.getString("RAGGRUPPAMENTO"));
                if (!raggruppamentoCorrente.equals(raggruppamento)
                    || !descrizioneCorrente.equals(descrizione))
                {
                  raggruppamentoLivello = new RaggruppamentoLivelloCriterio();
                  raggruppamentoLivello.setCriteri(new ArrayList<CriterioVO>());
                  list.add(raggruppamentoLivello);
                  raggruppamentoLivello.setDescrizioneLivello(
                      rs.getString("COD_LIVELLO") + " " + descrizioneCorrente);
                  raggruppamentoLivello
                      .setRaggruppamento(raggruppamentoCorrente);
                  descrizione = descrizioneCorrente;
                  raggruppamento = raggruppamentoCorrente;
                }
                CriterioVO nuovoCriterio = new CriterioVO();
                nuovoCriterio.setCodice(rs.getString("CODICE"));
                nuovoCriterio
                    .setCriterioSelezione(rs.getString("CRITERIO_SELEZIONE"));
                nuovoCriterio.setDescPrincipioSelezione(
                    rs.getString("DESC_PRINCIPIO_SELEZIONE"));
                nuovoCriterio
                    .setFlagElaborazione(rs.getString("FLAG_ELABORAZIONE"));
                nuovoCriterio.setIdCriterio(rs.getInt("ID_CRITERIO"));
                nuovoCriterio.setIdPrincipioSelezione(
                    rs.getInt("ID_PRINCIPIO_SELEZIONE"));
                nuovoCriterio.setPunteggio(rs.getString("PUNTEGGIO"));
                nuovoCriterio
                    .setPunteggioMin(rs.getBigDecimal("PUNTEGGIO_MIN"));
                nuovoCriterio
                    .setPunteggioMax(rs.getBigDecimal("PUNTEGGIO_MAX"));
                nuovoCriterio.setSpecifiche(rs.getString("SPECIFICHE"));
                nuovoCriterio.setIdBandoLivelloCriterio(
                    rs.getLong("ID_BANDO_LIVELLO_CRITERIO"));
                nuovoCriterio.setPunteggioCalcolato(IuffiUtils.NUMBERS
                    .nvl(rs.getBigDecimal("PUNTEGGIO_CALCOLATO")));
                raggruppamentoLivello.getCriteri().add(nuovoCriterio);
              }
              return list;
            }
          });
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idDatiProcedimento", idDatiProcedimento),
              new LogParameter("idBando", idBando) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /* CU DI RIFERIMENTO: "161" */
  public void updateCriterioManuale(final long idBandoLivelloCriterio,
      final long idProcedimento, final boolean daAzzerare,
      BigDecimal punteggioInput) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateCriterioManuale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String UPDATE = "update IUF_T_PUNTEGGIO_CALCOLATO PC set PC.PUNTEGGIO_CALCOLATO \n";

    // nel caso in cui il criterio corrente  stato de-checkato..modificabile o
    // non, inserisco 0 come punteggio
    if (daAzzerare)
    {
      UPDATE += "= 0 \n";
    }
    else
    {
      // nel caso in cui il criterio checkato  NON modificabile (cio per il
      // quale punteggio_min == punteggio_max) prendo il punteggio da D_CRITERIO
      if (punteggioInput == null)
      {
        UPDATE += "= NVL((select C.PUNTEGGIO_MIN \n"
            + "from IUF_d_criterio c, IUF_r_livello_criterio lc, IUF_r_bando_livello_criterio blc \n"
            + "where BLC.ID_BANDO_LIVELLO_CRITERIO =:ID_BANDO_LIVELLO_CRITERIO and BLC.ID_LIVELLO_CRITERIO = LC.ID_LIVELLO_CRITERIO and LC.ID_CRITERIO = C.ID_CRITERIO ),0) \n";
      }
      else
      {
        // nel caso in cui in cui il criterio checkato  MODIFICABILE (min !=
        // max) prendo il punteggio dato in input dall'utente
        UPDATE += " =:PUNTEGGIO_INPUT \n";
      }
    }
    UPDATE += "where PC.ID_PUNTEGGIO_CALCOLATO = \n"
        + "(select PUNT.ID_PUNTEGGIO_CALCOLATO \n"
        + "from IUF_T_DATI_PROCEDIMENTO_PUNT dpp, IUF_T_PUNTEGGIO_CALCOLATO punt \n"
        + "where DPP.ID_PROCEDIMENTO =:ID_PROCEDIMENTO and DPP.ID_PROCEDIMENTO_OGGETTO is null and PUNT.ID_DATI_PROCEDIMENTO_PUNTI = DPP.ID_DATI_PROCEDIMENTO_PUNTI \n"
        + "and punt.ID_BANDO_LIVELLO_CRITERIO =:ID_BANDO_LIVELLO_CRITERIO ) \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_BANDO_LIVELLO_CRITERIO",
          idBandoLivelloCriterio, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      if (punteggioInput != null)
      {
        mapParameterSource.addValue("PUNTEGGIO_INPUT", punteggioInput,
            Types.NUMERIC);
      }
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idBandoLivelloCriterio", idBandoLivelloCriterio),
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("daAzzerare", daAzzerare),
              new LogParameter("punteggioInput", punteggioInput) },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /* CU DI RIFERIMENTO: "162" */
  public MainPunteggioDTO callMainCalcoloPunteggi(final long idProcedimento,
      final long idProcedimentoOggetto, final long idAzienda,
      final long idBando, final Long idLivello)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainCalcoloPunteggi";
    StringBuffer CALL = new StringBuffer("PCK_IUF_CALCOLO_PUNTEGGIO.Main");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PEXTIDAZIENDA", idAzienda, Types.NUMERIC);
      parameterSource.addValue("PIDBANDO", idBando, Types.NUMERIC);
      parameterSource.addValue("PIDLIVELLO", idLivello, Types.NUMERIC);
      parameterSource.addValue("PRAGGRUPPAMENTO", null, Types.VARCHAR);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_CALCOLO_PUNTEGGIO")
              .withProcedureName("Main").withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDAZIENDA", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDBANDO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDLIVELLO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PRAGGRUPPAMENTO", java.sql.Types.VARCHAR));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainPunteggioDTO dto = new MainPunteggioDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public List<ControlloAmministrativoDTO> getControlliAmministrativi(
      long idProcedimentoOggetto, String codiceQuadro, List<Long> ids)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getControlliAmministrativi]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    StringBuilder queryBuilder = new StringBuilder(
        "  WITH                                                                                                                      \n"
            + "    ESITI AS                                                                                                                \n"
            + "    (                                                                                                                       \n"
            + "      SELECT                                                                                                                \n"
            + "        ECA.ID_QUADRO_OGG_CONTROLLO_AMM,                                                                                    \n"
            + "        ECA.ID_ESITO,                                                                                                       \n"
            + "        ECA.ID_ESITO_CONTROLLI_AMM,                                                                                         \n"
            + "        ECA.NOTE,                                                                                                           \n"
            + "        E.CODICE      AS CODICE_ESITO,                                                                                      \n"
            + "        E.DESCRIZIONE AS DESC_ESITO                                                                                         \n"
            + "      FROM                                                                                                                  \n"
            + "        IUF_T_ESITO_CONTROLLI_AMM ECA,                                                                                      \n"
            + "        IUF_D_ESITO E                                                                                                       \n"
            + "      WHERE                                                                                                                 \n"
            + "        ECA.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                              \n"
            + "        AND ECA.ID_ESITO            = E.ID_ESITO                                                                            \n"
            + "    )                                                                                                                       \n"
            + "  SELECT                                                                                                                    \n"
            + "    DECODE(CA.ID_CONTROLLO_AMMINISTRAT_PADRE,NULL, CA.ORDINAMENTO*1000,CA_PADRE.ORDINAMENTO*1000+CA.ORDINAMENTO) AS ORDINE, \n"
            + "    CA.ID_CONTROLLO_AMMINISTRAT_PADRE,                                                                                      \n"
            + "    CA.CODICE,                                                                                                              \n"
            + "    CA.ID_CONTROLLO_AMMINISTRATIVO,                                                                                         \n"
            + "    CA.ID_CONTROLLO_AMMINISTRAT_PADRE,                                                                                      \n"
            + "    BOQCA.ID_QUADRO_OGG_CONTROLLO_AMM,                                                                                      \n"
            + "    CA.DESCRIZIONE,                                                                                                         \n"
            + "    E.ID_ESITO_CONTROLLI_AMM,                                                                                               \n"
            + "    E.ID_ESITO,                                                                                                             \n"
            + "    E.CODICE_ESITO,                                                                                                         \n"
            + "    E.DESC_ESITO,                                                                                                           \n"
            + "    E.NOTE                                                                                                                  \n"
            + "  FROM                                                                                                                      \n"
            + "    IUF_D_CONTROLLO_AMMINISTRATI CA                                                                                       \n"
            + "    LEFT JOIN                                                                                                               \n"
            + "    IUF_D_CONTROLLO_AMMINISTRATI CA_PADRE                                                                                 \n"
            + "    ON                                                                                                                      \n"
            + "    CA.ID_CONTROLLO_AMMINISTRAT_PADRE = CA_PADRE.ID_CONTROLLO_AMMINISTRATIVO,                                               \n"
            + "    IUF_R_BAND_OG_QUAD_CONTR_AMM BOQCA,                                                                                   \n"
            + "    IUF_R_QUADRO_OGG_CONTROL_AMM QOCA                                                                                     \n"
            + "  LEFT JOIN ESITI E                                                                                                         \n"
            + "  ON                                                                                                                        \n"
            + "    QOCA.ID_QUADRO_OGG_CONTROLLO_AMM = E.ID_QUADRO_OGG_CONTROLLO_AMM,                                                       \n"
            + "    IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                                          \n"
            + "    IUF_T_PROCEDIMENTO P,                                                                                                   \n"
            + "    IUF_R_BANDO_OGGETTO BO,                                                                                                 \n"
            + "    IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                                                                                        \n"
            + "    IUF_D_QUADRO Q,                                                                                                         \n"
            + "    IUF_R_QUADRO_OGGETTO QO                                                                                                 \n"
            + "  WHERE                                                                                                                     \n"
            + "    PO.ID_PROCEDIMENTO_OGGETTO           = :ID_PROCEDIMENTO_OGGETTO                                                         \n"
            + "    AND PO.ID_PROCEDIMENTO               = P.ID_PROCEDIMENTO                                                                \n"
            + "    AND PO.ID_LEGAME_GRUPPO_OGGETTO      = LGO.ID_LEGAME_GRUPPO_OGGETTO                                                     \n"
            + "    AND LGO.ID_LEGAME_GRUPPO_OGGETTO     = BO.ID_LEGAME_GRUPPO_OGGETTO                                                      \n"
            + "    AND P.ID_BANDO                       = BO.ID_BANDO                                                                      \n"
            + "    AND CA.ID_CONTROLLO_AMMINISTRATIVO   = QOCA.ID_CONTROLLO_AMMINISTRATIVO                                                 \n"
            + "    AND QOCA.ID_QUADRO_OGG_CONTROLLO_AMM = BOQCA.ID_QUADRO_OGG_CONTROLLO_AMM                                                \n"
            + "    AND BOQCA.ID_BANDO_OGGETTO           = BO.ID_BANDO_OGGETTO                                                              \n"
            + "    AND Q.CODICE                         = :CODICE_QUADRO                                                                   \n"
            + "    AND Q.ID_QUADRO                      = QO.ID_QUADRO                                                                     \n"
            + " AND                                                                                                                                           \n"
            + "     (                                                                                                                                         \n"
            + "         NOT EXISTS (SELECT K.ID_QUADRO_OGG_CONTROLLO_AMM FROM IUF_R_BAN_OG_QUA_CON_AMM_LIV K WHERE K.ID_BANDO_OGGETTO = BO.ID_BANDO_OGGETTO \n"
            + "                        AND K.ID_QUADRO_OGG_CONTROLLO_AMM = BOQCA.ID_QUADRO_OGG_CONTROLLO_AMM )                                                \n"
            + "         OR                                                                                                                                    \n"
            + "         EXISTS (SELECT K.ID_QUADRO_OGG_CONTROLLO_AMM FROM IUF_R_BAN_OG_QUA_CON_AMM_LIV K, IUF_R_PROCEDIMENTO_LIVELLO PL                     \n"
            + "                    WHERE                                                                                                                      \n"
            + "                    PL.ID_LIVELLO = K.ID_LIVELLO                                                                                               \n"
            + "                    AND PL.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                                                                                 \n"
            + "                    AND K.ID_BANDO_OGGETTO = BO.ID_BANDO_OGGETTO                                                                               \n"
            + "                    AND K.ID_QUADRO_OGG_CONTROLLO_AMM = BOQCA.ID_QUADRO_OGG_CONTROLLO_AMM )                                                    \n"
            + "     )                                                                                                                                         \n"

            + "    AND QO.ID_OGGETTO                    = LGO.ID_OGGETTO                                                                   \n"
            + "    AND QO.ID_QUADRO_OGGETTO             = QOCA.ID_QUADRO_OGGETTO                                                           \n");
    if (ids != null && !ids.isEmpty())
    {
      queryBuilder.append(" AND (");
      int idx = 1;
      for (Long id : ids)
      {
        if (idx > 1)
        {
          queryBuilder.append(" OR ");
        }
        String nameID = "ID_" + idx;
        queryBuilder.append(" BOQCA.ID_QUADRO_OGG_CONTROLLO_AMM = :")
            .append(nameID);
        mapParameterSource.addValue(nameID, id, Types.NUMERIC);
        ++idx;
      }
      queryBuilder.append(" )");
    }
    queryBuilder.append(
        " ORDER BY                                                                   \n"
            + "   ORDINE ASC                                                       \n");
    final String QUERY = queryBuilder.toString();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("CODICE_QUADRO", codiceQuadro, Types.VARCHAR);
      return queryForList(QUERY, mapParameterSource,
          ControlloAmministrativoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("codiceQuadro", codiceQuadro),
              new LogParameter("ids", ids)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DatiSpecificiDTO getDatiSpecifici(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDatiSpecifici]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    final String QUERY = " WITH                                                                                                                    \n"
        + "   ESTRAZIONE AS                                                                                                         \n"
        + "   (                                                                                                                     \n"
        + "     SELECT                                                                                                              \n"
        + "       PO2.ID_PROCEDIMENTO,                                                                                              \n"
        + "       PE.ID_PROCEDIMENTO_OGGETTO,                                                                                       \n"
        + "       EC.DATA_ESTRAZIONE,                                                                                               \n"
        + "       L.NUMERO_ESTRAZIONE,                                                                                               \n"

        + "       TE.DESCRIZIONE AS DESC_TIPO_ESTRAZIONE,                                                                           \n"
        + "       PE.FLAG_ESTRATTA                                                                                                  \n"
        + "     FROM                                                                                                                \n"
        + "       IUF_T_PROCEDIMENTO_ESTRATTO PE,                                                                                   \n"
        + "       IUF_T_ESTRAZIONE_CAMPIONE EC,                                                                                     \n"
        + "       IUF_D_TIPO_ESTRAZIONE TE,                                                                                         \n"
        + "       IUF_D_NUMERO_LOTTO L, 		                                                                                     \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                                    \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO2                                                                                    \n"
        + "     WHERE                                                                                                               \n"
        + "       PO.ID_PROCEDIMENTO_OGGETTO       =:ID_PROCEDIMENTO_OGGETTO                                                        \n"
        + "       AND PO.ID_PROCEDIMENTO           = PO2.ID_PROCEDIMENTO                                                            \n"
        + "       AND PO2.ID_PROCEDIMENTO_OGGETTO <> PO.ID_PROCEDIMENTO_OGGETTO                                                     \n"
        + "       AND PO.CODICE_RAGGRUPPAMENTO     = PO2.CODICE_RAGGRUPPAMENTO                                                      \n"
        + "       AND PE.ID_PROCEDIMENTO_OGGETTO   = PO2.ID_PROCEDIMENTO_OGGETTO                                                    \n"
        + "       AND EC.ID_ESTRAZIONE_CAMPIONE    = PE.ID_ESTRAZIONE_CAMPIONE                                                      \n"
        + "       AND EC.ID_TIPO_ESTRAZIONE        = TE.ID_TIPO_ESTRAZIONE                                                          \n"
        + "       AND EC.ID_NUMERO_LOTTO           = L.ID_NUMERO_LOTTO (+)                                                          \n"
        + "       AND EC.FLAG_APPROVATA            = 'S'                                                                            \n"
        + "       AND EC.DATA_ANNULLAMENTO IS NULL                                                                                  \n"
        + "   )                                                                                                                     \n"
        + " SELECT                                                                                                                  \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO,                                                                                           \n"
        + "   CILI.FLAG_PREAVVISO,                                                                                                  \n"
        + "   CILI.DATA_PREAVVISO,                                                                                                  \n"
        + "   CILI.ID_TIPOLOGIA_PREAVVISO,                                                                                          \n"
        + "   DECODE(CILI.ID_TIPOLOGIA_PREAVVISO, 1, CILI.DESCRIZIONE_ALTRO_PREAVVISO, TP.DESCRIZIONE) AS DESC_TIPOLOGIA_PREAVVISO, \n"
        + "   CILI.FLAG_CONTROLLO,                                                                                                  \n"
        + "   DECODE(E.ID_PROCEDIMENTO_OGGETTO,NULL,'N','S') AS FLAG_SOTTOPOSTA_ESTRAZIONE,                                         \n"
        + "   NVL(E.FLAG_ESTRATTA,'N')                       AS FLAG_ESTRATTA,                                                      \n"
        + "   E.DATA_ESTRAZIONE,                                                                                                    \n"
        + "   E.NUMERO_ESTRAZIONE,                                                                                                    \n"
        + "   E.DESC_TIPO_ESTRAZIONE                                                                                                \n"
        + " FROM                                                                                                                    \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO                                                                                         \n"
        + " LEFT OUTER JOIN IUF_T_CONTROLLO_IN_LOCO_INVE CILI                                                                     \n"
        + " ON                                                                                                                      \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = CILI.ID_PROCEDIMENTO_OGGETTO                                                             \n"
        + " LEFT OUTER JOIN IUF_D_TIPOLOGIA_PREAVVISO TP                                                                            \n"
        + " ON                                                                                                                      \n"
        + "   CILI.ID_TIPOLOGIA_PREAVVISO = TP.ID_TIPOLOGIA_PREAVVISO                                                               \n"
        + " LEFT OUTER JOIN ESTRAZIONE E                                                                                            \n"
        + " ON                                                                                                                      \n"
        + "   PO.ID_PROCEDIMENTO = E.ID_PROCEDIMENTO                                                                                \n"
        + " WHERE                                                                                                                   \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                                 \n";
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource, DatiSpecificiDTO.class);
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DatiSpecificiDTO getDatiSpecificiPremio(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDatiSpecifici]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    final String QUERY = " WITH                                                                                                                    \n"
        + "   ESTRAZIONE AS                                                                                                         \n"
        + "   (                                                                                                                     \n"
        + "     SELECT                                                                                                              \n"
        + "       PO.ID_PROCEDIMENTO,                                                                                              \n"
        + "       PE.ID_PROCEDIMENTO_OGGETTO,                                                                                       \n"
        + "       EC.DATA_ESTRAZIONE,                                                                                               \n"
        + "       TE.DESCRIZIONE AS DESC_TIPO_ESTRAZIONE,                                                                           \n"
        + "       PE.FLAG_ESTRATTA                                                                                                  \n"
        + "     FROM                                                                                                                \n"
        + "       IUF_T_PROCEDIMENTO_ESTRATTO PE,                                                                                   \n"
        + "       IUF_T_ESTRAZIONE_CAMPIONE EC,                                                                                     \n"
        + "       IUF_D_TIPO_ESTRAZIONE TE,                                                                                         \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO                                                                                    \n"
        + "     WHERE                                                                                                               \n"
        + "       PO.ID_PROCEDIMENTO_OGGETTO       =:ID_PROCEDIMENTO_OGGETTO                                                        \n"
        + "       AND PE.ID_PROCEDIMENTO   = PO.ID_PROCEDIMENTO                                                        				\n"
        + "       AND EC.ID_ESTRAZIONE_CAMPIONE    = PE.ID_ESTRAZIONE_CAMPIONE                                                      \n"
        + "       AND EC.ID_TIPO_ESTRAZIONE        = TE.ID_TIPO_ESTRAZIONE                                                          \n"
        + "       AND EC.FLAG_APPROVATA            = 'S'                                                                            \n"
        + "       AND EC.DATA_ANNULLAMENTO IS NULL                                                                                  \n"
        + "   )                                                                                                                     \n"
        + " SELECT                                                                                                                  \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO,                                                                                           \n"
        + "   CILI.FLAG_PREAVVISO,                                                                                                  \n"
        + "   CILI.DATA_PREAVVISO,                                                                                                  \n"
        + "   CILI.ID_TIPOLOGIA_PREAVVISO,                                                                                          \n"
        + "   DECODE(CILI.ID_TIPOLOGIA_PREAVVISO, 1, CILI.DESCRIZIONE_ALTRO_PREAVVISO, TP.DESCRIZIONE) AS DESC_TIPOLOGIA_PREAVVISO, \n"
        + "   CILI.FLAG_CONTROLLO,                                                                                                  \n"
        + "   DECODE(E.ID_PROCEDIMENTO,NULL,'N','S') AS FLAG_SOTTOPOSTA_ESTRAZIONE,                                         \n"
        + "   NVL(E.FLAG_ESTRATTA,'N')                       AS FLAG_ESTRATTA,                                                      \n"
        + "   E.DATA_ESTRAZIONE,                                                                                                    \n"
        + "   E.DESC_TIPO_ESTRAZIONE                                                                                                \n"
        + " FROM                                                                                                                    \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO                                                                                         \n"
        + " LEFT OUTER JOIN IUF_T_CONTROLLO_IN_LOCO_INVE CILI                                                                     \n"
        + " ON                                                                                                                      \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = CILI.ID_PROCEDIMENTO_OGGETTO                                                             \n"
        + " LEFT OUTER JOIN IUF_D_TIPOLOGIA_PREAVVISO TP                                                                            \n"
        + " ON                                                                                                                      \n"
        + "   CILI.ID_TIPOLOGIA_PREAVVISO = TP.ID_TIPOLOGIA_PREAVVISO                                                               \n"
        + " LEFT OUTER JOIN ESTRAZIONE E                                                                                            \n"
        + " ON                                                                                                                      \n"
        + "   PO.ID_PROCEDIMENTO = E.ID_PROCEDIMENTO                                                                                \n"
        + " WHERE                                                                                                                   \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                                 \n";
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource, DatiSpecificiDTO.class);
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getFlagEstratta(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getFlagEstratta]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    final String QUERY = " SELECT                                                           \n"
        + "   PE.FLAG_ESTRATTA                                               \n"
        + " FROM                                                             \n"
        + "   IUF_T_PROCEDIMENTO_ESTRATTO PE,                                \n"
        + "   IUF_T_ESTRAZIONE_CAMPIONE EC,                                  \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO2                                 \n"
        + " WHERE                                                            \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO       =:ID_PROCEDIMENTO_OGGETTO     \n"
        + "   AND PO.ID_PROCEDIMENTO           = PO2.ID_PROCEDIMENTO         \n"
        + "   AND PO2.ID_PROCEDIMENTO_OGGETTO <> PO.ID_PROCEDIMENTO_OGGETTO  \n"
        + "   AND PO.CODICE_RAGGRUPPAMENTO     = PO2.CODICE_RAGGRUPPAMENTO   \n"
        + "   AND PE.ID_PROCEDIMENTO_OGGETTO   = PO2.ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND EC.ID_ESTRAZIONE_CAMPIONE    = PE.ID_ESTRAZIONE_CAMPIONE   \n"
        + "   AND EC.FLAG_APPROVATA            = 'S'                         \n"
        + "   AND EC.DATA_ANNULLAMENTO        IS NULL                        \n";
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteEsitiControlliAmministrativi(long idProcedimentoOggetto,
      List<EsitoControlliAmmDTO> esitiControlliDaAggiornare)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::deleteEsitiControlliAmministrativi]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    MapSqlParameterSource mapSqlParameterSource = new MapSqlParameterSource();
    StringBuilder queryBuilder = new StringBuilder(
        " DELETE                                                   \n"
            + "   IUF_T_ESITO_CONTROLLI_AMM ECA                          \n"
            + " WHERE                                                    \n"
            + "   ECA.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
            + " AND (");
    int idx = 1;
    for (EsitoControlliAmmDTO esitoControlliAmmDTO : esitiControlliDaAggiornare)
    {
      if (idx > 1)
      {
        queryBuilder.append(" OR ");
      }
      String idxName = "IDX_" + idx;
      queryBuilder.append("ECA.ID_QUADRO_OGG_CONTROLLO_AMM = :")
          .append(idxName);
      mapSqlParameterSource.addValue(idxName,
          esitoControlliAmmDTO.getIdQuadroOggControlloAmm(), Types.NUMERIC);
      ++idx;
    }
    queryBuilder.append(")");
    final String DELETE = queryBuilder.toString();
    try
    {
      mapSqlParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapSqlParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("esitiControlliDaAggiornare",
                  esitiControlliDaAggiornare)
          },
          (LogVariable[]) null, DELETE, mapSqlParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertEsitiControlliAmministrativi(
      List<EsitoControlliAmmDTO> esitiControlliDaAggiornare)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::insertEsitiControlliAmministrativi]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT INTO                       \n"
        + "   IUF_T_ESITO_CONTROLLI_AMM       \n"
        + " (                                 \n"
        + "     ID_ESITO_CONTROLLI_AMM,       \n"
        + "     NOTE,                         \n"
        + "     ID_QUADRO_OGG_CONTROLLO_AMM,  \n"
        + "     ID_PROCEDIMENTO_OGGETTO,      \n"
        + "     ID_ESITO                      \n"
        + " )                                 \n"
        + " VALUES                            \n"
        + " (                                 \n"
        + "   SEQ_IUF_T_ESITO_CONTROLLI_AM.NEXTVAL , \n"
        + "   :NOTE ,                         \n"
        + "   :ID_QUADRO_OGG_CONTROLLO_AMM ,  \n"
        + "   :ID_PROCEDIMENTO_OGGETTO ,      \n"
        + "   :ID_ESITO                       \n"
        + " )                                 \n";

    int size = esitiControlliDaAggiornare.size();
    MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[size];
    try
    {
      int idx = 0;
      for (EsitoControlliAmmDTO esito : esitiControlliDaAggiornare)
      {
        MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
        mapParameterSource.addValue("NOTE", esito.getNote(), Types.VARCHAR);
        mapParameterSource.addValue("ID_QUADRO_OGG_CONTROLLO_AMM",
            esito.getIdQuadroOggControlloAmm(), Types.NUMERIC);
        mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
            esito.getIdProcedimentoOggetto(), Types.NUMERIC);
        mapParameterSource.addValue("ID_ESITO", esito.getIdEsito(),
            Types.NUMERIC);
        batchParameters[idx++] = mapParameterSource;
      }
      namedParameterJdbcTemplate.batchUpdate(INSERT, batchParameters);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("esitiControlliDaAggiornare",
                  esitiControlliDaAggiornare)
          },
          (LogVariable[]) null, INSERT, batchParameters);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getElencoTecniciDisponibili(
      long idProcedimentoOggetto, long idProcedimentoAgricolo,
      boolean singoloUfficioZona)
      throws InternalUnexpectedException
  {
    return getElencoTecniciDisponibili(idProcedimentoOggetto,
        idProcedimentoAgricolo, singoloUfficioZona, null);
  }

  public List<DecodificaDTO<Long>> getElencoTecniciDisponibili(
      long idProcedimentoOggetto, long idProcedimentoAgricolo)
      throws InternalUnexpectedException
  {
    return getElencoTecniciDisponibili(idProcedimentoOggetto,
        idProcedimentoAgricolo, true);
  }

  public List<DecodificaDTO<Long>> getElencoTecniciDisponibili(
      long idProcedimentoOggetto, long idProcedimentoAgricolo,
      boolean singoloUfficioZona, Long istruttoreGradoSup)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoTecniciDisponibili]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT DISTINCT                                                                                             \n"
        + "   T.ID_TECNICO AS ID,                                                                                       \n"
        + "   T.ID_TECNICO AS CODICE,                                                                                   \n"
        + "   T.COGNOME,                                                                                                \n"
        + "   T.NOME,                                                                                                   \n"
        + "   T.MATRICOLA,                                                                                              \n"
        + "   (T.COGNOME                                                                                                \n"
        + "   || ' '                                                                                                    \n"
        + "   || T.NOME) AS DESCRIZIONE                                                                                 \n"
        + " FROM                                                                                                        \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                            \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA,                                                                        \n"
        + "   SMRCOMUNE_V_TECNICO T                                                                                     \n"
        + " WHERE                                                                                                       \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                     \n"
        + "   AND PO.ID_PROCEDIMENTO     = PA.ID_PROCEDIMENTO                                                           \n"
        + "   AND SYSDATE BETWEEN NVL(PA.DATA_INIZIO,SYSDATE) AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY')) \n"
        + "   AND T.EXT_ID_PROCEDIMENTO    = " + idProcedimentoAgricolo
        + "	                                                                         \n"
        + "   AND PA.EXT_ID_AMM_COMPETENZA = T.ID_AMM_COMPETENZA                                                        \n";
    if (singoloUfficioZona)
    {
      QUERY = QUERY
          + "   AND PA.EXT_ID_UFFICIO_ZONA   = T.ID_UFFICIO_ZONA                                                          \n";
    }
    if (istruttoreGradoSup != null)
    {
      QUERY = QUERY
          + "   AND ID_TECNICO   = :ID_TECNICO                                                          \n";
    }
    QUERY = QUERY
        + " ORDER BY                                                                                                    \n"
        + "   T.COGNOME,                                                                                                \n"
        + "   T.NOME,                                                                                                   \n"
        + "   T.MATRICOLA                                                                                               \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_TECNICO", istruttoreGradoSup,
        Types.NUMERIC);
    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("singoloUfficioZona", singoloUfficioZona),
              new LogParameter("idTecnico", istruttoreGradoSup)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getElencoTecniciDisponibiliPerAmmCompetenza(
      long idProcedimentoOggetto, long idProcedimentoAgricolo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getElencoTecniciDisponibiliPerAmmCompetenza]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "SELECT                                                                                            			 	\r\n"
        +
        "    T.ID_TECNICO AS ID,                                                                                       	\r\n"
        +
        "    T.COGNOME,                                                                                                	\r\n"
        +
        "    T.NOME,                                                                                                   	\r\n"
        +
        "    T.MATRICOLA,                                                                                              	\r\n"
        +
        "    (T.COGNOME || ' ' || T.NOME) AS DESCRIZIONE,																\r\n"
        +
        "    DECODE(																									\r\n" +
        "        SUM(DECODE(PA.EXT_ID_UFFICIO_ZONA,T.ID_UFFICIO_ZONA, 1, 0)) ,											\r\n"
        +
        "        1,																										\r\n" +
        "        'STESSO_UFFICIO',																						\r\n"
        +
        "        NULL) AS CODICE																						\r\n"
        +
        "FROM                                                                                                        	\r\n"
        +
        "    IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                            	\r\n"
        +
        "    IUF_T_PROCEDIM_AMMINISTRAZIO PA,                                                                        	\r\n"
        +
        "    SMRCOMUNE_V_TECNICO T                                                                                     	\r\n"
        +
        "WHERE                                                                                                       	\r\n"
        +
        "    PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                                     	\r\n"
        +
        "    AND PO.ID_PROCEDIMENTO     = PA.ID_PROCEDIMENTO                                                           	\r\n"
        +
        "    AND SYSDATE BETWEEN NVL(PA.DATA_INIZIO,SYSDATE) AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY')) 	\r\n"
        +
        "    AND T.EXT_ID_PROCEDIMENTO    = :ID_PROCEDIMENTO_AGRICOLO													\r\n"
        +
        "    AND PA.EXT_ID_AMM_COMPETENZA = T.ID_AMM_COMPETENZA                                                        	\r\n"
        +
        "GROUP BY																										\r\n" +
        "    T.ID_TECNICO,																								\r\n"
        +
        "    T.COGNOME,                                                                                                	\r\n"
        +
        "    T.NOME,                                                                                                   	\r\n"
        +
        "    T.MATRICOLA																								\r\n" +
        "ORDER BY                                                                                                    	\r\n"
        +
        "    T.COGNOME,                                                                                                	\r\n"
        +
        "    T.NOME,                                                                                                  	\r\n"
        +
        "    T.MATRICOLA                                                                                               	\r\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_PROCEDIMENTO_AGRICOLO",
        idProcedimentoAgricolo, Types.NUMERIC);
    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public EsitoFinaleDTO getEsitoFinale(long idProcedimentoOggetto,
      long idQuadroOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getEsitoFinale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                        		                 \n"
        + "   A.ID_ESITO_TECNICO,                                            \n"
        + "   C.DESCRIZIONE,                                                 \n"
        + "   B.ID_ESITO_TECNICO AS ID_ESITO_ISTRUT,                         \n"
        + "   B.PRESCRIZIONI,                                                \n"
        + "   B.MOTIVAZIONE,                                				 \n"
        + "   A.EXT_ID_TECNICO,                                              \n"

        + "   TA.DESCRIZIONE AS TIPO_ATTO,                                   \n"
        + "   TA.FLAG_ALTRE_INFO AS FLAG_ALTRE_INFO_ATTO,                    \n"
        + "   A.DATA_AMMISSIONE AS DATA_ATTO,  		                     	 \n"
        + "   A.NUMERO_ATTO,                                              	 \n"
        + "   A.ID_TIPO_ATTO AS ID_TIPO_ATTO,  		                     	 \n"

        + "   A.ID_ESITO,                                                    \n"
        + "   A.EXT_ID_FUNZIONARIO_GRADO_SUP,                                \n"
        + "   A.DATA_AMMISSIONE,                               				 \n"
        + "   A.NOTE,                                                        \n"
        + "   T1.COGNOME                                                     \n"
        + "   || ' '                                                         \n"
        + "   || T1.NOME AS DESCR_TECNICO,                                   \n"
        + "   T2.COGNOME                                                     \n"
        + "   || ' '                                                         \n"
        + "   || T2.NOME AS DESCR_GRADO_SUP,                                 \n"
        + "   C.CODICE CODICE_ESITO                                          \n"
        + " FROM                                                             \n"
        + "   IUF_T_ESITO_TECNICO A,                                         \n"
        + "   IUF_D_ESITO C,                                                 \n"
        + "	  IUF_D_TIPO_ATTO TA,                                        	 \n"
        + "   IUF_T_ESITO_TECNICO_ISTRUT B,                                  \n"
        + "   DB_TECNICO T1,                                                 \n"
        + "   DB_TECNICO T2                                                  \n"
        + " WHERE                                                            \n"
        + "   A.ID_ESITO_TECNICO            = B.ID_ESITO_TECNICO(+)          \n"
        + "   AND C.ID_ESITO                = A.ID_ESITO                     \n"

        + "   AND A.ID_TIPO_ATTO            = TA.ID_TIPO_ATTO (+)		     \n"

        + "   AND T1.ID_TECNICO(+)          = A.EXT_ID_TECNICO               \n"
        + "   AND T2.ID_TECNICO(+)          = A.EXT_ID_FUNZIONARIO_GRADO_SUP \n"
        + "   AND A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO       \n"
        + "   AND A.ID_QUADRO_OGGETTO       = :ID_QUADRO_OGGETTO             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
        Types.NUMERIC);
    try
    {
      EsitoFinaleDTO ret = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<EsitoFinaleDTO>()
          {
            @Override
            public EsitoFinaleDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              Long idEsitoIstrut;
              long idEsitoIstrutLong;
              if (rs.next())
              {
                EsitoFinaleDTO esito = new EsitoFinaleDTO();
                esito.setIdEsitoTecnico(rs.getLong("ID_ESITO_TECNICO"));
                esito.setIdGradoSup(rs.getLong("EXT_ID_FUNZIONARIO_GRADO_SUP"));
                esito.setIdEsito(rs.getLong("ID_ESITO"));
                esito.setIdTecnico(rs.getLong("EXT_ID_TECNICO"));
                esito.setNote(rs.getString("NOTE"));
                esito.setMotivazione(rs.getString("MOTIVAZIONE"));
                esito.setPrescrizioni(rs.getString("PRESCRIZIONI"));
                esito.setDescrTecnico(rs.getString("DESCR_TECNICO"));
                esito.setDescrEsito(rs.getString("DESCRIZIONE"));
                esito.setDescrGradoSup(rs.getString("DESCR_GRADO_SUP"));
                esito.setCodiceEsito(rs.getString("CODICE_ESITO"));
                esito.setDataAmmissione(rs.getDate("DATA_AMMISSIONE"));
                esito.setIdTipoAtto(rs.getLong("ID_TIPO_ATTO"));
                esito.setTipoAtto(rs.getString("TIPO_ATTO"));
                esito.setDataAtto(rs.getDate("DATA_ATTO"));
                esito.setNumeroAtto(rs.getString("NUMERO_ATTO"));
                esito
                    .setFlagAltreInfoAtto(rs.getString("FLAG_ALTRE_INFO_ATTO"));
                idEsitoIstrut = null;
                idEsitoIstrutLong = rs.getLong("ID_ESITO_ISTRUT");
                if (idEsitoIstrutLong > 0)
                {
                  idEsitoIstrut = idEsitoIstrutLong;
                }
                esito.setIdEsitoIstrut(idEsitoIstrut);
                return esito;
              }
              return null;
            }
          });
      return ret;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idQuadroOggetto", idQuadroOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long insertTEsitoTecnico(long idProcedimentoOggetto,
      long idQuadroOggetto, long idTecnico, Long idGradoSup, String note,
      long idEsito, Long idTipoAtto, String numeroAtto, Date dataAtto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTEsitoTecnico]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_ESITO_TECNICO 		\n"
        + " (ID_ESITO_TECNICO, 					\n"
        + "	 ID_PROCEDIMENTO_OGGETTO, 			\n"
        + "	 EXT_ID_TECNICO, 					\n"
        + "	 EXT_ID_FUNZIONARIO_GRADO_SUP, 		\n"
        + "	 NOTE, 								\n"
        + "	 ID_QUADRO_OGGETTO, 				\n"

        + "	 ID_TIPO_ATTO, 						\n"
        + "	 NUMERO_ATTO, 						\n"
        + "	 DATA_AMMISSIONE, 					\n"

        + "	 ID_ESITO) 							\n"
        + "VALUES 								\n"
        + " (:ID_ESITO_TECNICO, 				\n"
        + "	 :ID_PROCEDIMENTO_OGGETTO, 			\n"
        + "	 :EXT_ID_TECNICO, 					\n"
        + "	 :EXT_ID_FUNZIONARIO_GRADO_SUP, 	\n"
        + "	 :NOTE, 							\n"
        + "	 :ID_QUADRO_OGGETTO, 				\n"

        + "	 :ID_TIPO_ATTO, 					\n"
        + "	 :NUMERO_ATTO, 						\n"
        + "	 :DATA_AMMISSIONE,	 				\n"

        + "	 :ID_ESITO) 						\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idEsitoTecnico = 0;
    try
    {
      idEsitoTecnico = getNextSequenceValue("SEQ_IUF_T_ESITO_TECNICO");
      mapParameterSource.addValue("ID_ESITO_TECNICO", idEsitoTecnico,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_TECNICO", idTecnico, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_FUNZIONARIO_GRADO_SUP", idGradoSup,
          Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      mapParameterSource.addValue("ID_ESITO", idEsito, Types.NUMERIC);

      mapParameterSource.addValue("ID_TIPO_ATTO", idTipoAtto, Types.NUMERIC);
      mapParameterSource.addValue("NUMERO_ATTO", numeroAtto, Types.VARCHAR);
      mapParameterSource.addValue("DATA_AMMISSIONE", dataAtto, Types.DATE);

      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idEsitoTecnico", idEsitoTecnico),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idTecnico", idTecnico),
              new LogParameter("idGradoSup", idGradoSup),
              new LogParameter("note", note),
              new LogParameter("idEsito", idEsito)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
    return idEsitoTecnico;
  }

  public void insertTEsitoTecnicoIstrut(long idEsitoTecnico,
      String prescrizioni, String motivazione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertTEsitoTecnicoIstrut]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_ESITO_TECNICO_ISTRUT 	\n"
        + " (ID_ESITO_TECNICO, 						\n"
        + "	 PRESCRIZIONI, 							\n"
        + "	 MOTIVAZIONE	 						\n"
        + "	  ) 									\n"
        + "VALUES 									\n"
        + " (:ID_ESITO_TECNICO,				 		\n"
        + "	 :PRESCRIZIONI, 						\n"
        + "	 :MOTIVAZIONE 							\n"
        + "	 ) 										\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("PRESCRIZIONI", prescrizioni, Types.VARCHAR);
      mapParameterSource.addValue("MOTIVAZIONE", motivazione, Types.VARCHAR);
      mapParameterSource.addValue("ID_ESITO_TECNICO", idEsitoTecnico,
          Types.NUMERIC);

      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idEsitoTecnico", idEsitoTecnico),
              new LogParameter("motivazione", motivazione),
              new LogParameter("prescrizioni", prescrizioni)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getElencoEsiti(String tipoEsito)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoEsiti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                     		\n"
        + "   A.ID_ESITO AS ID,     			\n"
        + "   A.CODICE AS CODICE, 			\n"
        + "   A.DESCRIZIONE					\n"
        + " FROM                       		\n"
        + "   IUF_D_ESITO A        			\n"
        + " WHERE                      		\n"
        + " A.TIPO_ESITO = :TIPO_ESITO 		\n"
        + " ORDER BY A.DESCRIZIONE 	  		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("TIPO_ESITO", tipoEsito, Types.VARCHAR);
    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {},
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<VisitaLuogoExtDTO> getVisiteLuogo(long idProcedimentoOggetto,
      long idQuadroOggetto, List<Long> ids) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getVisiteLuogo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                      \n"
        + "   VL.ID_VISITA_LUOGO,                                       \n"
        + "   VL.DATA_VISITA,                                           \n"
        + "   VL.EXT_ID_TECNICO,                                        \n"
        + "   T.COGNOME                                                 \n"
        + "   || ' '   ||                                               \n"
        + "   T.NOME AS DESC_TECNICO,                                   \n"
        + "   VL.ID_ESITO,                                              \n"
        + "   E.CODICE      AS CODICE_ESITO,                            \n"
        + "   E.DESCRIZIONE AS DESC_ESITO,                              \n"
        + "   VL.ID_PROCEDIMENTO_OGGETTO,                               \n"
        + "   VL.NOTE,                                                  \n"
        + "   VL.DATA_VERBALE,                                          \n"
        + "   VL.NUMERO_VERBALE                                         \n"
        + " FROM                                                        \n"
        + "   IUF_T_VISITA_LUOGO VL,                                    \n"
        + "   IUF_D_ESITO E,                                            \n"
        + "   DB_TECNICO T                                              \n"
        + " WHERE                                                       \n"
        + "   VL.EXT_ID_TECNICO              = T.ID_TECNICO             \n"
        + "   AND VL.ID_ESITO                = E.ID_ESITO               \n"
        + "   AND VL.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND VL.ID_QUADRO_OGGETTO       = :ID_QUADRO_OGGETTO       \n"
        + ((ids == null || ids.isEmpty()) ? ""
            : getInCondition("VL.ID_VISITA_LUOGO", ids))
        + " ORDER BY                                                    \n"
        + "   VL.DATA_VISITA DESC                                       \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
        Types.NUMERIC);
    try
    {
      return queryForList(QUERY, mapParameterSource, VisitaLuogoExtDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idQuadroOggetto", idQuadroOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertVisitaLuogo(VisitaLuogoDTO visitaLuogoDTO)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertVisitaLuogo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT INTO                        \n"
        + " IUF_T_VISITA_LUOGO                 \n"
        + " (                                  \n"
        + "    ID_VISITA_LUOGO,                \n"
        + "    NOTE,                           \n"
        + "    ID_PROCEDIMENTO_OGGETTO,        \n"
        + "    ID_ESITO,                       \n"
        + "    EXT_ID_TECNICO,                 \n"
        + "    DATA_VISITA,                    \n"
        + "    DATA_VERBALE,                   \n"
        + "    NUMERO_VERBALE,                 \n"
        + "    ID_QUADRO_OGGETTO               \n"
        + " )                                  \n"
        + " VALUES                             \n"
        + " (                                  \n"
        + "    SEQ_IUF_T_VISITA_LUOGO.NEXTVAL, \n"
        + "    :NOTE,                          \n"
        + "    :ID_PROCEDIMENTO_OGGETTO,       \n"
        + "    :ID_ESITO,                      \n"
        + "    :EXT_ID_TECNICO,                \n"
        + "    :DATA_VISITA,                   \n"
        + "    :DATA_VERBALE,                  \n"
        + "    :NUMERO_VERBALE,                \n"
        + "    :ID_QUADRO_OGGETTO              \n"
        + " )                                  \n";

    MapSqlParameterSource mapSqlParameterSource = new MapSqlParameterSource();
    try
    {
      mapSqlParameterSource.addValue("NOTE", visitaLuogoDTO.getNote(),
          Types.VARCHAR);
      mapSqlParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          visitaLuogoDTO.getIdProcedimentoOggetto(), Types.NUMERIC);
      mapSqlParameterSource.addValue("ID_ESITO", visitaLuogoDTO.getIdEsito(),
          Types.NUMERIC);
      mapSqlParameterSource.addValue("EXT_ID_TECNICO",
          visitaLuogoDTO.getExtIdTecnico(), Types.NUMERIC);
      mapSqlParameterSource.addValue("DATA_VISITA",
          visitaLuogoDTO.getDataVisita(), Types.DATE);
      mapSqlParameterSource.addValue("DATA_VERBALE",
          visitaLuogoDTO.getDataVerbale(), Types.DATE);
      mapSqlParameterSource.addValue("NUMERO_VERBALE",
          visitaLuogoDTO.getNumeroVerbale(), Types.VARCHAR);
      mapSqlParameterSource.addValue("ID_QUADRO_OGGETTO",
          visitaLuogoDTO.getIdQuadroOggetto(), Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapSqlParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("visitaLuogoDTO", visitaLuogoDTO)
          },
          (LogVariable[]) null, INSERT, mapSqlParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertRegimeAiuti(long idProcedimentoOggetto, long idRegime,
      Long idSportello, String pec, String email, String altroIstituto,
      long utente) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertRegimeAiuti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT INTO                        \n"
        + " IUF_T_REGIME_AIUTO_RICHIESTO                 \n"
        + " (                                  \n"
        + "    ID_REGIME_AIUTO_RICHIESTO,                \n"
        + "    ID_PROCEDIMENTO_OGGETTO,                           \n"
        + "    ID_REGIME_AIUTO_PREVISTO,        \n"
        + "    EXT_ID_SPORTELLO,                       \n"
        + "    ALTRO_ISTITUTO,                 \n"
        + "    PEC_ISTITUTO,                    \n"
        + "    EMAIL_ISTITUTO,                   \n"
        + "    DATA_AGGIORNAMENTO,                 \n"
        + "    EXT_ID_UTENTE_AGGIORNAMENTO               \n"
        + " )                                  \n"
        + " VALUES                             \n"
        + " (                                  \n"
        + "    SEQ_IUF_T_REGIME_AIUTO_RICHI.NEXTVAL, \n"
        + "    :ID_PROCEDIMENTO_OGGETTO,                          \n"
        + "    :ID_REGIME_AIUTO_PREVISTO,       \n"
        + "    :EXT_ID_SPORTELLO,                      \n"
        + "    :ALTRO_ISTITUTO,                \n"
        + "    :PEC_ISTITUTO,                   \n"
        + "    :EMAIL_ISTITUTO,                  \n"
        + "    SYSDATE,               \n"
        + "    :EXT_ID_UTENTE_AGGIORNAMENTO              \n"
        + " )                                  \n";

    MapSqlParameterSource mapSqlParameterSource = new MapSqlParameterSource();
    try
    {
      mapSqlParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto,
          Types.NUMERIC);
      mapSqlParameterSource.addValue("ID_REGIME_AIUTO_PREVISTO", idRegime,
          Types.NUMERIC);
      mapSqlParameterSource.addValue("EXT_ID_SPORTELLO", idSportello,
          Types.NUMERIC);
      mapSqlParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO", utente,
          Types.NUMERIC);
      mapSqlParameterSource.addValue("ALTRO_ISTITUTO", altroIstituto,
          Types.VARCHAR);
      mapSqlParameterSource.addValue("PEC_ISTITUTO", pec,
          Types.VARCHAR);
      mapSqlParameterSource.addValue("EMAIL_ISTITUTO", email,
          Types.VARCHAR);

      namedParameterJdbcTemplate.update(INSERT, mapSqlParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("", null)
          },
          (LogVariable[]) null, INSERT, mapSqlParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteRegimeAiuti(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertRegimeAiuti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "DELETE FROM IUF_T_REGIME_AIUTO_RICHIESTO WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO";
    MapSqlParameterSource mapSqlParameterSource = new MapSqlParameterSource();
    try
    {
      mapSqlParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapSqlParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("", null)
          },
          (LogVariable[]) null, INSERT, mapSqlParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean verificaCompatibilita(long impegnoPrincipale,
      long impegnoCompatibile)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::verificaCompatibilita]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                       \n"
        + "   COUNT(*)                                           		\n"
        + " FROM                                                 		\n"
        + "   IUF_R_MATRICE_IMPEGNI                      				\n"
        + " WHERE                                                		\n"
        + "   ID_IMPEGNO_PRINCIPALE = :ID_IMPEGNO_PRINCIPALE 			\n"
        + "   AND ID_IMPEGNO_COMPATIBILE    = :ID_IMPEGNO_COMPATIBILE 	\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_IMPEGNO_PRINCIPALE", impegnoPrincipale,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO_COMPATIBILE", impegnoCompatibile,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String findCriterioNumIdentificativo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::findCriterioNumIdentificativo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                           \n"
        + "   O.CRITERIO_NUM_IDENTIFICATIVO                                  \n"
        + " FROM                                                             \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                               \n"
        + "   IUF_D_OGGETTO O                                                \n"
        + " WHERE                                                            \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO      = :ID_PROCEDIMENTO_OGGETTO     \n"
        + "   AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND LGO.ID_OGGETTO              = O.ID_OGGETTO                 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.queryForObject(QUERY,
          mapParameterSource, String.class);
    }
    catch (Exception ex)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(ex,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateIdentificativoProcedimento(long idProcedimento,
      String identificativoProcOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::verificaCompatibilita]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                               \n"
        + "   IUF_T_PROCEDIMENTO                 \n"
        + " SET                                  \n"
        + "   IDENTIFICATIVO = :IDENTIFICATIVO   \n"
        + " WHERE                                \n"
        + "   ID_PROCEDIMENTO = :ID_PROCEDIMENTO \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("IDENTIFICATIVO", identificativoProcOggetto,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);

    }
    catch (Exception ex)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(ex,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("identificativoProcOggetto",
                  identificativoProcOggetto) },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateVisiteLuogoBatch(List<VisitaLuogoDTO> visiteDaAggiornare)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateVisiteLuogoBatch]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " UPDATE                                                   \n"
        + "   IUF_T_VISITA_LUOGO                                     \n"
        + " SET                                                      \n"
        + "   DATA_VISITA = :DATA_VISITA,                            \n"
        + "   EXT_ID_TECNICO = :EXT_ID_TECNICO,                      \n"
        + "   ID_ESITO = :ID_ESITO,                                  \n"
        + "   NOTE = :NOTE,                                          \n"
        + "   DATA_VERBALE = :DATA_VERBALE,                          \n"
        + "   NUMERO_VERBALE = UPPER(:NUMERO_VERBALE)                \n"
        + " WHERE                                                    \n"
        + "   ID_VISITA_LUOGO = :ID_VISITA_LUOGO                     \n"
        + "   AND ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n";

    int size = visiteDaAggiornare.size();
    MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[size];
    try
    {
      int idx = 0;
      for (VisitaLuogoDTO visitaLuogoDTO : visiteDaAggiornare)
      {
        MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
        mapParameterSource.addValue("ID_ESITO", visitaLuogoDTO.getIdEsito(),
            Types.NUMERIC);
        mapParameterSource.addValue("NOTE", visitaLuogoDTO.getNote(),
            Types.VARCHAR);
        mapParameterSource.addValue("DATA_VISITA",
            visitaLuogoDTO.getDataVisita(), Types.DATE);
        mapParameterSource.addValue("EXT_ID_TECNICO",
            visitaLuogoDTO.getExtIdTecnico(), Types.NUMERIC);
        mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
            visitaLuogoDTO.getIdProcedimentoOggetto(), Types.NUMERIC);
        mapParameterSource.addValue("ID_VISITA_LUOGO",
            visitaLuogoDTO.getIdVisitaLuogo(), Types.NUMERIC);
        mapParameterSource.addValue("DATA_VERBALE",
            visitaLuogoDTO.getDataVerbale(), Types.DATE);
        mapParameterSource.addValue("NUMERO_VERBALE",
            visitaLuogoDTO.getNumeroVerbale(), Types.VARCHAR);
        batchParameters[idx++] = mapParameterSource;
      }
      namedParameterJdbcTemplate.batchUpdate(INSERT, batchParameters);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("visiteDaAggiornare", visiteDaAggiornare)
          },
          (LogVariable[]) null, INSERT, batchParameters);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteVisitaLuogo(List<Long> ids, long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateVisiteLuogoBatch]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " DELETE                                               \n"
        + " FROM                                                 \n"
        + "   IUF_T_VISITA_LUOGO                                 \n"
        + " WHERE                                                \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND ID_VISITA_LUOGO = :ID_VISITA_LUOGO             \n";

    int size = ids.size();
    MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[size];
    try
    {
      int idx = 0;
      for (Long idVisitaLuogo : ids)
      {
        MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
        mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
            idProcedimentoOggetto, Types.NUMERIC);
        mapParameterSource.addValue("ID_VISITA_LUOGO", idVisitaLuogo,
            Types.NUMERIC);
        batchParameters[idx++] = mapParameterSource;
      }
      namedParameterJdbcTemplate.batchUpdate(INSERT, batchParameters);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ids", ids)
          },
          (LogVariable[]) null, INSERT, batchParameters);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public SportelloBancaDTO getSportelloBancaById(long idSportello)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getSportelloBancaById]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                                                              \n"
        + "   BS.ID_SPORTELLO,                                                                  \n"
        + "   BS.ABI,                                                                           \n"
        + "   BS.CAB,                                                                           \n"
        + "   BS.DENOMINAZIONE_BANCA,                                                           \n"
        + "   BS.DENOMINAZIONE_SPORTELLO,                                                       \n"
        + "   BS.INDIRIZZO AS INDIRIZZO_SPORTELLO,                                              \n"
        + "   BS.CAP AS CAP_SPORTELLO,                                                          \n"
        + "   BS.DESCRIZIONE_COMUNE_SPORTELLO,                                                  \n"
        + "   BS.SIGLA_PROVINCIA AS SIGLA_PROVINCIA_SPORTELLO                                   \n"
        + " FROM                                                                                \n"
        + "   SMRGAA_V_BANCA_SPORTELLO BS                                                       \n"
        + " WHERE                                                                               \n"
        + "   BS.ID_SPORTELLO = :ID_SPORTELLO                                                   \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_SPORTELLO", idSportello, Types.NUMERIC);
    try
    {
      return queryForObject(QUERY, mapParameterSource, SportelloBancaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idSportello", idSportello) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getDecodificheBanche()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDecodificheBanche]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                                     \n"
        + "   DISTINCT BS.ID_BANCA AS ID,                              \n"
        + "   BS.ABI AS CODICE,                                        \n"
        + "   BS.ABI || ' - ' || BS.DENOMINAZIONE_BANCA AS DESCRIZIONE,\n"
        + "   BS.DENOMINAZIONE_BANCA                                   \n"
        + " FROM                                                       \n"
        + "   SMRGAA_V_BANCA_SPORTELLO BS                              \n"
        + " WHERE                                                      \n"
        + "  BS.DATA_INIZIO_VALIDITA_BANCA <= SYSDATE                  \n"
        + "  AND NVL(BS.DATA_FINE_VALIDITA_BANCA, SYSDATE)>=SYSDATE    \n"
        + " ORDER BY                                                   \n"
        + "   BS.DENOMINAZIONE_BANCA                                   \n";

    try
    {
      return queryForDecodificaInteger(QUERY, null);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {},
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getDecodificheSportelli(int idBanca)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDecodificheSportelli]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                      \n"
        + "  BS.ID_SPORTELLO AS ID,                     \n"
        + "  BS.CAB AS CODICE,                          \n"
        + "  BS.DENOMINAZIONE_SPORTELLO AS DESCRIZIONE, \n"
        + "  BS.DENOMINAZIONE_SPORTELLO                 \n"
        + " FROM                                        \n"
        + "  SMRGAA_V_BANCA_SPORTELLO BS                \n"
        + " WHERE                                       \n"
        + "  BS.ID_BANCA = :ID_BANCA                    \n"
        + "  AND BS.DATA_INIZIO_VALIDITA_SPORTELLO <= SYSDATE \n"
        + "  AND NVL(BS.DATA_FINE_VALIDITA_SPORTELLO, SYSDATE)>=SYSDATE \n"
        + " ORDER BY                                    \n"
        + "  BS.DENOMINAZIONE_SPORTELLO                 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_BANCA", idBanca, Types.NUMERIC);
      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idBanca", idBanca) },
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateAnticipo(long idProcedimentoOggetto,
      DatiAnticipoModificaDTO updateDTO) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "updateAnticipo";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
          + " idProcedimentoOggetto = " + idProcedimentoOggetto);
      if (updateDTO != null)
      {
        logger.error("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO == NULL ==> Inevitabile NullPointerException in arrivo!!!!");
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getAltroIstituto() = "
            + updateDTO.getAltroIstituto());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getBeneficiarioFideiussione() = "
            + updateDTO.getBeneficiarioFideiussione());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getExtIstatComune() = "
            + updateDTO.getExtIstatComune());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getIdAnticipo() = " + updateDTO.getIdAnticipo());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getIndirizzoAltroIstituto() = "
            + updateDTO.getIndirizzoAltroIstituto());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getNumeroFideiussione() = "
            + updateDTO.getNumeroFideiussione());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getExtIdSportello() = "
            + updateDTO.getExtIdSportello());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getDataScadenza() = " + updateDTO.getDataScadenza());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getDataStipula() = " + updateDTO.getDataStipula());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getImportoAnticipo() = "
            + updateDTO.getImportoAnticipo());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getImportoFideiussione() = "
            + updateDTO.getImportoFideiussione());
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD
            + " updateDTO.getPercentualeAnticipo() = "
            + updateDTO.getPercentualeAnticipo());
      }
    }
    String UPDATE = " UPDATE                                                       \n"
        + "       IUF_T_ANTICIPO                                         \n"
        + " SET                                                          \n"
        + "   ALTRO_ISTITUTO            = :ALTRO_ISTITUTO,               \n"
        + "   BENEFICIARIO_FIDEIUSSIONE = :BENEFICIARIO_FIDEIUSSIONE,    \n"
        + "   DATA_SCADENZA             = :DATA_SCADENZA,                \n"
        + "   DATA_STIPULA              = :DATA_STIPULA,                 \n"
        + "   EXT_ID_SPORTELLO          = :EXT_ID_SPORTELLO,             \n"
        + "   EXT_ISTAT_COMUNE          = :EXT_ISTAT_COMUNE,             \n"
        + "   IMPORTO_ANTICIPO          = :IMPORTO_ANTICIPO,             \n"
        + "   IMPORTO_FIDEIUSSIONE      = :IMPORTO_FIDEIUSSIONE,         \n"
        + "   INDIRIZZO_ALTRO_ISTITUTO  = :INDIRIZZO_ALTRO_ISTITUTO,     \n"
        + "   NUMERO_FIDEIUSSIONE       = :NUMERO_FIDEIUSSIONE,          \n"
        + "   PERCENTUALE_ANTICIPO      = :PERCENTUALE_ANTICIPO          \n"
        + " WHERE                                                        \n"
        + "   ID_ANTICIPO =                                              \n"
        + "   (                                                          \n"
        + "     SELECT                                                   \n"
        + "       APO.ID_ANTICIPO                                        \n"
        + "     FROM                                                     \n"
        + "       IUF_R_ANTICIPO_PROC_OGG APO                            \n"
        + "     WHERE                                                    \n"
        + "       APO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   )                                                          \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ALTRO_ISTITUTO", updateDTO.getAltroIstituto(),
        Types.VARCHAR);
    mapParameterSource.addValue("BENEFICIARIO_FIDEIUSSIONE",
        updateDTO.getBeneficiarioFideiussione(), Types.VARCHAR);
    mapParameterSource.addValue("EXT_ISTAT_COMUNE",
        updateDTO.getExtIstatComune(), Types.VARCHAR);
    mapParameterSource.addValue("INDIRIZZO_ALTRO_ISTITUTO",
        updateDTO.getIndirizzoAltroIstituto(), Types.VARCHAR);
    mapParameterSource.addValue("NUMERO_FIDEIUSSIONE",
        updateDTO.getNumeroFideiussione(), Types.VARCHAR);
    mapParameterSource.addValue("EXT_ID_SPORTELLO",
        updateDTO.getExtIdSportello(), Types.NUMERIC);
    mapParameterSource.addValue("DATA_SCADENZA", updateDTO.getDataScadenza(),
        Types.DATE);
    mapParameterSource.addValue("DATA_STIPULA", updateDTO.getDataStipula(),
        Types.DATE);
    mapParameterSource.addValue("IMPORTO_ANTICIPO",
        updateDTO.getImportoAnticipo(), Types.NUMERIC);
    mapParameterSource.addValue("IMPORTO_FIDEIUSSIONE",
        updateDTO.getImportoFideiussione(), Types.NUMERIC);
    mapParameterSource.addValue("PERCENTUALE_ANTICIPO",
        updateDTO.getPercentualeAnticipo(), Types.NUMERIC);
    try
    {
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          // new LogParameter("idVariabile", idVariabile),
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public boolean isBeneficiarioAbilitatoATrasmettere(String codiceFiscale,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "isBeneficiarioAbilitatoATrasmettere";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                  \n"
        + "   COUNT(*) AS NUM                                       \n"
        + " FROM                                                    \n"
        + "   IUF_T_PROCEDIMENTO P,                                 \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                        \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PAZ,                       \n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC                        \n"
        + " WHERE                                                   \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND PO.ID_PROCEDIMENTO     = P.ID_PROCEDIMENTO        \n"
        + "   AND PAZ.ID_PROCEDIMENTO    = P.ID_PROCEDIMENTO        \n"
        + "   AND PAZ.DATA_FINE          IS NULL                    \n"
        + "   AND SC.ID_AZIENDA          = PAZ.EXT_ID_AZIENDA       \n"
        + "   AND SC.CODICE_FISCALE      = :CODICE_FISCALE          \n"
        + "   AND SC.DATA_FINE_RUOLO    IS NULL                     \n"
        + "   AND                                                   \n"
        + "   (                                                     \n"
        + "     SC.ID_CONTITOLARE = PO.EXT_ID_CONTITOLARE           \n"
        + "     OR SC.ID_RUOLO    = 1                               \n"
        + "   )                                                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("CODICE_FISCALE", codiceFiscale, Types.VARCHAR);
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return namedParameterJdbcTemplate.queryForLong(QUERY,
          mapParameterSource) > 0; // In teoria dovrebbe essere solo 0 o 1
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("codiceFiscale", codiceFiscale),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public PartecipanteDTO findPartecipanteInAnagrafe(String cuaa)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::findPartecipanteInAnagrafe]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                                                   \n"
        + "   VANAG.ID_AZIENDA AS EXT_ID_AZIENDA,                                                    \n"
        + "   VANAG.CUAA,                                                               			   \n"
        + "   VANAG.DENOMINAZIONE,                                             				       \n"
        + "   VANAG.INDIRIZZO_SEDE_LEGALE,                                    					   \n"
        + "   VA.DESCRIZIONE_COMUNE || ' (' || VA.SIGLA_PROVINCIA || ')' AS COMUNE_SEDE_LEGALE, 	   \n"
        + "   VA.CAP AS CAP_SEDE_LEGALE,                                                             \n"
        + "   NVL(VANAG.PEC, VANAG.MAIL) AS MAIL                                                     \n"
        + " FROM                                                                                     \n"
        + "   SMRGAA_V_DATI_AMMINISTRATIVI VA,                                                       \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI VANAG                                                         \n"
        + " WHERE                                                                                    \n"
        + "   VANAG.ISTAT_COMUNE_SEDE_LEGALE(+) = VA.ISTAT_COMUNE                                    \n"
        + "   AND VANAG.DATA_FINE_VALIDITA IS NULL                                                   \n"
        + "   AND VANAG.DATA_CESSAZIONE IS NULL                                                      \n"
        + "   AND VANAG.CUAA = :CUAA                                                                 \n";

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("CUAA", cuaa, Types.VARCHAR);
      return queryForObject(QUERY, mapParameterSource, PartecipanteDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<LivelloDTO> getLivelliProcOggetto(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getLivelliProcOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                 							\n"
        + "   L.ID_LIVELLO,L.DESCRIZIONE,L.CODICE,L.CODICE_LIVELLO,			\n"
        + "   PL.DATA_AMMISSIONE,PL.SPESA_AMMESSA,PL.CONTRIBUTO_CONCESSO			\n"
        + " FROM                                   							\n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO PL,IUF_d_LIVELLO L 					\n"
        + " WHERE                                  							\n"
        + "   ID_PROCEDIMENTO = :ID_PROCEDIMENTO 								\n"
        + "AND 																\n"
        + "  L.ID_LIVELLO = PL.ID_LIVELLO										\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    try
    {
      List<LivelloDTO> dati = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<List<LivelloDTO>>()
          {
            @Override
            public List<LivelloDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<LivelloDTO> result = null;
              LivelloDTO livello;

              while (rs.next())
              {
                if (result == null)
                {
                  result = new ArrayList<LivelloDTO>();
                }
                livello = new LivelloDTO();
                livello.setIdLivello(rs.getLong("ID_LIVELLO"));
                livello.setDescrizione(rs.getString("DESCRIZIONE"));
                livello.setCodice(rs.getString("CODICE"));
                livello.setCodiceLivello(rs.getString("CODICE_LIVELLO"));
                livello.setDataAmmissione(rs.getDate("DATA_AMMISSIONE"));
                livello.setSpesaAmmessa(rs.getBigDecimal("SPESA_AMMESSA"));
                livello.setContributoConcesso(
                    rs.getBigDecimal("CONTRIBUTO_CONCESSO"));
                result.add(livello);
              }
              return result;
            }
          });
      return dati;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String findIstatComune(String comune)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::findIstatComune]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                       \n"
        + "   A.ISTAT_COMUNE                             \n"
        + " FROM                                         \n"
        + "   SMRGAA_V_DATI_AMMINISTRATIVI A             \n"
        + " WHERE                                        \n"
        + "   A.DESCRIZIONE_COMUNE = :DESCRIZIONE_COMUNE \n"
        + "   AND A.FLAG_ESTERO = 'N'                    \n"
        + "   AND A.FLAG_ESTINTO = 'N'                   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("DESCRIZIONE_COMUNE", comune, Types.VARCHAR);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("comune", comune)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<SettoriDiProduzioneDTO> getSettoriDiProduzioneProcedimentoOggetto(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {

    String THIS_METHOD = "[" + THIS_CLASS
        + "::getSettoriDiProduzioneProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT DISTINCT                                     	\n"
        + "   SP.DESCRIZIONE DESCRIZIONE,							\n"
        + "	SP.DATA_INIZIO DATA_INIZIO,							\n"
        + "	SP.DATA_FINE   DATA_FINE,							\n"
        + "   SP.ID_SETTORE_PRODUZIONE ID_SETTORE                 \n"
        + " FROM                                         			\n"
        + "  IUF_D_SETTORE_PRODUZIONE SP,  			 			\n"
        + "  IUF_R_LIVELLO_SETTORE_PROD LS,   	     			\n"
        + "  IUF_R_PROCEDIMENTO_LIVELLO PL,  		 	 			\n"
        + "  IUF_T_PROCEDIMENTO_OGGETTO PO           	 			\n"
        + " WHERE                                        			\n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	\n"
        + "	AND"
        + "	PL.ID_LIVELLO = LS.ID_LIVELLO                    	\n"
        + "   AND													\n"
        + "	PL.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO	"
        + "	AND  												\n"
        + "	SP.ID_SETTORE_PRODUZIONE = LS.ID_SETTORE_PRODUZIONE			\n"
        + " ORDER BY DESCRIZIONE            						 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      List<SettoriDiProduzioneDTO> dati = namedParameterJdbcTemplate.query(
          QUERY, mapParameterSource,
          new ResultSetExtractor<List<SettoriDiProduzioneDTO>>()
          {
            @Override
            public List<SettoriDiProduzioneDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<SettoriDiProduzioneDTO> result = null;
              SettoriDiProduzioneDTO settore;

              while (rs.next())
              {
                if (result == null)
                {
                  result = new ArrayList<SettoriDiProduzioneDTO>();
                }
                settore = new SettoriDiProduzioneDTO();
                settore.setDescrizione(rs.getString("DESCRIZIONE"));
                settore.setDataInizio(rs.getDate("DATA_INIZIO"));
                settore.setDataFine(rs.getDate("DATA_FINE"));
                settore.setIdSettore(rs.getLong("ID_SETTORE"));

                result.add(settore);
              }
              return result;
            }
          });
      return dati;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateIdSettoreDiProduzione(long idProcedimentoOggetto,
      long idSettore) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateIdSettoreDiProduzioneInProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO                                  \n"
        + " SET                                                           \n"
        + "   ID_SETTORE_PRODUZIONE   = :ID_SETTORE                       \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_SETTORE", idSettore, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idSettore", idSettore),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<SettoriDiProduzioneDTO> getSettoriDiProduzioneInLivelliBandi(
      long idProcedimentoOggetto, long idBando)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getSettoriDiProduzioneInLivelliBandi]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT 		                                     	\n"
        + "   SP.DESCRIZIONE DESCRIZIONE,							\n"
        + "	SP.DATA_INIZIO DATA_INIZIO,							\n"
        + "	SP.DATA_FINE   DATA_FINE,							\n"
        + "   SP.ID_SETTORE_PRODUZIONE ID_SETTORE                 \n"
        + " FROM                                         			\n"
        + "  IUF_D_SETTORE_PRODUZIONE SP,  			 			\n"
        + "  IUF_R_LIVELLO_SETTORE_PROD LS,   	     			\n"
        + "  IUF_r_livello_bando lb		          	 			\n"
        + " WHERE                                        			\n"
        + "   LB.ID_BANDO = :ID_BANDO	\n"
        + "	AND"
        + "	LS.ID_LIVELLO = LB.ID_LIVELLO                    	\n"
        + "   AND													\n"
        + "	SP.ID_SETTORE_PRODUZIONE = LS.ID_SETTORE_PRODUZIONE			\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_BANDO", idBando, Types.NUMERIC);

    try
    {
      List<SettoriDiProduzioneDTO> dati = namedParameterJdbcTemplate.query(
          QUERY, mapParameterSource,
          new ResultSetExtractor<List<SettoriDiProduzioneDTO>>()
          {
            @Override
            public List<SettoriDiProduzioneDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<SettoriDiProduzioneDTO> result = null;
              SettoriDiProduzioneDTO settore;

              while (rs.next())
              {
                if (result == null)
                {
                  result = new ArrayList<SettoriDiProduzioneDTO>();
                }
                settore = new SettoriDiProduzioneDTO();
                settore.setDescrizione(rs.getString("DESCRIZIONE"));
                settore.setDataInizio(rs.getDate("DATA_INIZIO"));
                settore.setDataFine(rs.getDate("DATA_FINE"));
                settore.setIdSettore(rs.getLong("ID_SETTORE"));

                result.add(settore);
              }
              return result;
            }
          });
      return dati;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idBando", idBando)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateCodiceCup(long idProcedimento, String cup)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateCodiceCup]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        \n"
        + "   IUF_T_PROCEDIMENTO                                 \n"
        + " SET                                                           \n"
        + "   CODICE_CUP   = :CUP                      \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO  = :ID_PROCEDIMENTO       \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CUP", cup, Types.VARCHAR);
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("cup", cup),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isOggettoIstanza(long idOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isOggettoIstanza]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT               				\n"
        + "   COUNT(*)                          \n"
        + " FROM                                \n"
        + "   IUF_D_OGGETTO				        \n"
        + " WHERE                               \n"
        + "   ID_OGGETTO = :ID_OGGETTO 			\n"
        + "   AND FLAG_ISTANZA = 'S' 			\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_OGGETTO", idOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isOggettoIstanzaByIdOggettoIcona(long idOggettoIcona)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::isOggettoIstanzaByIdOggettoIcona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                        \n"
        + "   COUNT(*)                                    \n"
        + " FROM                                          \n"
        + "   IUF_R_OGGETTO_ICONA OI,                     \n"
        + "   IUF_D_OGGETTO O                             \n"
        + " WHERE                                         \n"
        + "   OI.ID_OGGETTO           = O.ID_OGGETTO      \n"
        + "   AND O.FLAG_ISTANZA      = 'S'               \n"
        + "   AND OI.ID_OGGETTO_ICONA = :ID_OGGETTO_ICONA \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_OGGETTO_ICONA", idOggettoIcona,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isOggettoIstanzaByProcOggetto(long idProcedimentoOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isOggettoIstanzaByProcOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT               											\n"
        + "   COUNT(*)                          							\n"
        + " FROM                                							\n"
        + "   IUF_t_procedimento_oggetto a,     							\n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO B,								\n"
        + "	  IUF_D_OGGETTO C				        						\n"
        + " WHERE                               							\n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 			\n"
        + "	  AND A.ID_LEGAME_GRUPPO_OGGETTO = B.ID_LEGAME_GRUPPO_OGGETTO	\n"
        + "   AND B.ID_OGGETTO = C.ID_OGGETTO								\n"
        + "   AND C.FLAG_ISTANZA = 'S' 										\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deletePunteggioIstruttoria(long idDatiProcedimentoPunti)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deletePunteggioIstruttoria]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE                                               		 \n"
        + " FROM                                                 		 \n"
        + "   IUF_T_PUNTEGGIO_ISTRUTTORIA                        		 \n"
        + " WHERE                                                		 \n"
        + "   ID_DATI_PROCEDIMENTO_PUNTI = :ID_DATI_PROCEDIMENTO_PUNTI   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO_PUNTI",
          idDatiProcedimentoPunti, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO_PUNTI",
                  idDatiProcedimentoPunti)
          },
          (LogVariable[]) null, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updatePunteggioIstruttoria(long idBandoLivelloCriterio,
      long idDatiProcedimentoPunti, BigDecimal punteggioIstruttoria)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updatePunteggioIstruttoria]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " UPDATE                                               		 \n"
        + "   IUF_T_PUNTEGGIO_ISTRUTTORIA                        		 \n"
        + " SET PUNTEGGIO_ISTRUTTORIA = :PUNTEGGIO_ISTRUTTORIA     		 \n"
        + " WHERE                                                		 \n"
        + "   ID_DATI_PROCEDIMENTO_PUNTI = :ID_DATI_PROCEDIMENTO_PUNTI   \n"
        + "   AND ID_BANDO_LIVELLO_CRITERIO = :ID_BANDO_LIVELLO_CRITERIO \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO_PUNTI",
          idDatiProcedimentoPunti, Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO_LIVELLO_CRITERIO",
          idBandoLivelloCriterio, Types.NUMERIC);
      mapParameterSource.addValue("PUNTEGGIO_ISTRUTTORIA", punteggioIstruttoria,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_DATI_PROCEDIMENTO_PUNTI",
                  idDatiProcedimentoPunti),
              new LogParameter("ID_BANDO_LIVELLO_CRITERIO",
                  idBandoLivelloCriterio),
              new LogParameter("PUNTEGGIO_ISTRUTTORIA", punteggioIstruttoria)
          },
          (LogVariable[]) null, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD + "");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<GraduatoriaDTO> getGraduatorieByIdProcedimento(
      long idProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getGraduatorieByIdProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT 		                                        \n"
        + "   G.ID_GRADUATORIA ID_GRADUATORIA,					\n"
        + "	G.DESCRIZIONE DESCRIZIONE,							\n"
        + "	G.ORDINAMENTO1 ORDINAMENTO1,						\n"
        + "	G.ORDINAMENTO2 ORDINAMENTO2,						\n"
        + "	G.ORDINAMENTO3 ORDINAMENTO3,						\n"
        + "	G.ORDINAMENTO4 ORDINAMENTO4,						\n"
        + "	G.ORDINAMENTO5 ORDINAMENTO5,						\n"
        + "	G.DATA_APPROVAZIONE DATA_APPROVAZIONE,				\n"
        + "	PG.ORDINAMENTO1_VALORE ORDINAMENTO1_VALORE,			\n"
        + "	PG.ORDINAMENTO2_VALORE ORDINAMENTO2_VALORE,			\n"
        + "	PG.ORDINAMENTO3_VALORE ORDINAMENTO3_VALORE,			\n"
        + "	PG.ORDINAMENTO4_VALORE ORDINAMENTO4_VALORE,			\n"
        + "	PG.ORDINAMENTO5_VALORE ORDINAMENTO5_VALORE,			\n"
        + "   PG.POSIZIONE POSIZIONE,								\n"
        + "	PG.RAGGRUPPAMENTO RAGGRUPPAMENTO,					\n"
        + "   PG.FLAG_ISTRUTTORIA FLAG_ISTRUTTORIA,				\n"
        + "   PG.NOTE												\n"
        + " FROM                                         			\n"
        + "  IUF_T_PROCEDIMENTO P,  			 				    \n"
        + "  IUF_T_POSIZIONE_GRADUATORIA PG,   	     			\n"
        + "  IUF_T_GRADUATORIA G,									\n"
        + "  IUF_D_LIVELLO L,										\n"
        + "  IUF_R_LIVELLO_BANDO LB,		          	 			\n"
        + "  IUF_R_LIV_BANDO_GRADUATORIA LBG						\n"
        + " WHERE                                        			\n"
        + "   P.ID_PROCEDIMENTO = :ID_PROCEDIMENTO				\n"
        + "	AND													\n"
        + "	PG.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO              \n"
        + "   AND													\n"
        + "	PG.ID_GRADUATORIA = G.ID_GRADUATORIA	 			\n"
        + "   AND 												\n"
        + "	G.FLAG_APPROVATA = 'S'								\n"
        + "	AND													\n"
        + "   P.ID_BANDO = LBG.ID_BANDO							\n"
        + "	AND													\n"
        + "	G.ID_GRADUATORIA = LBG.ID_GRADUATORIA               \n"
        + "   AND													\n"
        + "	L.ID_LIVELLO = LBG.ID_LIVELLO			 			\n"
        + "   AND 												\n"
        + "   LB.ID_BANDO = LBG.ID_BANDO							\n"
        + "	AND													\n"
        + " 	LB.ID_LIVELLO = LBG.ID_LIVELLO						\n"
        + " ORDER BY L.ORDINAMENTO, DESCRIZIONE, RAGGRUPPAMENTO, PG.POSIZIONE	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);

    try
    {
      List<GraduatoriaDTO> dati = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<List<GraduatoriaDTO>>()
          {
            @Override
            public List<GraduatoriaDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<GraduatoriaDTO> result = null;
              GraduatoriaDTO grad;

              while (rs.next())
              {
                if (result == null)
                {
                  result = new ArrayList<GraduatoriaDTO>();
                }
                grad = new GraduatoriaDTO();
                grad.setIdGraduatoria(rs.getLong("ID_GRADUATORIA"));
                grad.setDescrizione(rs.getString("DESCRIZIONE"));
                grad.setDataApprovazione(rs.getDate("DATA_APPROVAZIONE"));
                grad.setPosizione(rs.getLong("POSIZIONE"));
                grad.setRaggruppamento(rs.getString("RAGGRUPPAMENTO"));
                grad.setOrdinamento1(rs.getString("ORDINAMENTO1"));
                grad.setOrdinamento2(rs.getString("ORDINAMENTO2"));
                grad.setOrdinamento3(rs.getString("ORDINAMENTO3"));
                grad.setOrdinamento4(rs.getString("ORDINAMENTO4"));
                grad.setOrdinamento5(rs.getString("ORDINAMENTO5"));
                grad.setOrd1Val(rs.getBigDecimal("ORDINAMENTO1_VALORE"));
                grad.setOrd2Val(rs.getBigDecimal("ORDINAMENTO2_VALORE"));
                grad.setOrd3Val(rs.getBigDecimal("ORDINAMENTO3_VALORE"));
                grad.setOrd4Val(rs.getBigDecimal("ORDINAMENTO4_VALORE"));
                grad.setOrd5Val(rs.getBigDecimal("ORDINAMENTO5_VALORE"));
                grad.setFlagIstruttoria(rs.getString("FLAG_ISTRUTTORIA"));
                grad.setNote(rs.getString("NOTE"));

                result.add(grad);
              }
              return result;
            }
          });
      return dati;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento),
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isCalcoloPuntiEseguito(long idProcedimento)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isCalcoloPuntiEseguito]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT               						\n"
        + "   COUNT(*)                          		\n"
        + " FROM                                		\n"
        + "   IUF_T_DATI_PROCEDIMENTO_PUNT				\n"
        + " WHERE                               		\n"
        + "   ID_PROCEDIMENTO_OGGETTO IS NULL 			\n"
        + "   AND ID_PROCEDIMENTO = :ID_PROCEDIMENTO	\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertPunteggioIstruttoria(long idBandoLivelloCriterio,
      long idDatiProcPunti, BigDecimal punteggioIstruttoria)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertPunteggioIstruttoria]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                            \n"
        + " INTO                                        \n"
        + "   IUF_T_PUNTEGGIO_ISTRUTTORIA               \n"
        + "   (                                         \n"
        + "     ID_PUNTEGGIO_ISTRUTTORIA,            	\n"
        + "     ID_DATI_PROCEDIMENTO_PUNTI,             \n"
        + "     ID_BANDO_LIVELLO_CRITERIO,              \n"
        + "     PUNTEGGIO_ISTRUTTORIA                   \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_PUNTEGGIO_ISTRUTTO.NEXTVAL, \n"
        + "     :ID_DATI_PROCEDIMENTO_PUNTI,            \n"
        + "     :ID_BANDO_LIVELLO_CRITERIO,             \n"
        + "     :PUNTEGGIO_ISTRUTTORIA                  \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DATI_PROCEDIMENTO_PUNTI", idDatiProcPunti,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO_LIVELLO_CRITERIO",
          idBandoLivelloCriterio, Types.NUMERIC);
      mapParameterSource.addValue("PUNTEGGIO_ISTRUTTORIA", punteggioIstruttoria,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDatiProcPunti", idDatiProcPunti),
              new LogParameter("idBandoLivelloCriterio",
                  idBandoLivelloCriterio),
              new LogParameter("punteggioIstruttoria", punteggioIstruttoria)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdEsitoEquivalente(Long idEsito, String tipoEsito)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getIdEsitoEquivalente";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                    \n"
        + "   E_EQUIV.ID_ESITO                        \n"
        + " FROM                                      \n"
        + "   IUF_D_ESITO E,                          \n"
        + "   IUF_D_ESITO E_EQUIV                     \n"
        + " WHERE                                     \n"
        + "   E.ID_ESITO             = :ID_ESITO      \n"
        + "   AND E.CODICE           = E_EQUIV.CODICE \n"
        + "   AND E_EQUIV.TIPO_ESITO = :TIPO_ESITO    \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_ESITO", idEsito, Types.NUMERIC);
    mapParameterSource.addValue("TIPO_ESITO", tipoEsito, Types.VARCHAR);
    try
    {
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idEsito", idEsito),
              new LogParameter("tipoEsito", tipoEsito)
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public String getCodiceOggettoDelProcedimentoOggetto(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getIdEsitoEquivalente";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                           \n"
        + "   O.CODICE                                                       \n"
        + " FROM                                                             \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                               \n"
        + "   IUF_D_OGGETTO O                                                \n"
        + " WHERE                                                            \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO      = :ID_PROCEDIMENTO_OGGETTO     \n"
        + "   AND PO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND LGO.ID_OGGETTO              = O.ID_OGGETTO                 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return queryForString(QUERY, mapParameterSource);

      // return queryForObject(QUERY, mapParameterSource, String.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public List<SospensioneAnticipoDTO> getElencoSospensioniAnticipo(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getElencoSospensioniAnticipo";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                 \n"
        + "   A.ID_SOSPENSIONE_ANTICIPO,                           \n"
        + "   A.ID_LIVELLO,                                        \n"
        + "   A.FLAG_SOSPENSIONE,                                  \n"
        + "   A.MOTIVAZIONE,                                       \n"
        + "   B.CODICE_LIVELLO AS CODICE_LIVELLO,                  \n"
        + "   B.DESCRIZIONE AS DESCRIZIONE_LIVELLO                 \n"
        + " FROM                                                   \n"
        + "   IUF_T_SOSPENSIONE_ANTICIPO A,                        \n"
        + "   IUF_D_LIVELLO B                                      \n"
        + " WHERE                                                  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND B.ID_LIVELLO = A.ID_LIVELLO                      \n"
        + " ORDER BY B.ORDINAMENTO                      			 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return queryForList(QUERY, mapParameterSource,
          SospensioneAnticipoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public List<SospensioneAnticipoDTO> getElencoSospensioniAnticipoDisponibili(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getElencoSospensioniAnticipoDisponibili";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                           \n"
        + "   LI.CODICE_LIVELLO AS CODICE_LIVELLO,                           \n"
        + "   LI.DESCRIZIONE AS DESCRIZIONE_LIVELLO,                         \n"
        + "   SA.ID_SOSPENSIONE_ANTICIPO,                                    \n"
        + "   PL.ID_LIVELLO,                                                 \n"
        + "   NVL(SA.FLAG_SOSPENSIONE, 'S') AS FLAG_SOSPENSIONE,             \n"
        + "   SA.MOTIVAZIONE                                                 \n"
        + " FROM                                                             \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                 \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO PL,                                 \n"
        + "   IUF_T_SOSPENSIONE_ANTICIPO SA,                                 \n"
        + "   IUF_D_LIVELLO LI                                               \n"
        + " WHERE                                                            \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n"
        + "   AND PO.ID_PROCEDIMENTO = PL.ID_PROCEDIMENTO                    \n"
        + "   AND SA.ID_PROCEDIMENTO_OGGETTO(+) = PO.ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND (SA.ID_LIVELLO IS NULL OR SA.ID_LIVELLO = PL.ID_LIVELLO)   \n"
        + "   AND LI.ID_LIVELLO = PL.ID_LIVELLO                              \n"
        + " ORDER BY LI.ORDINAMENTO                                          \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return queryForList(QUERY, mapParameterSource,
          SospensioneAnticipoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public void insertSospensioneAnticipo(long idProcedimentoOggetto,
      long idLivello, String flagSospensione, String motivazione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertSospensioneAnticipo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_SOSPENSIONE_ANTICIPO            	\n"
        + "   (                                         \n"
        + "     ID_SOSPENSIONE_ANTICIPO,            	\n"
        + "     ID_LIVELLO,                        		\n"
        + "     FLAG_SOSPENSIONE,                  		\n"
        + "     MOTIVAZIONE,                            \n"
        + "     ID_PROCEDIMENTO_OGGETTO             	\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_SOSPENSIONE_ANTICI.NEXTVAL, \n"
        + "     :ID_LIVELLO,                       		\n"
        + "     :FLAG_SOSPENSIONE,                 		\n"
        + "     :MOTIVAZIONE,                           \n"
        + "     :ID_PROCEDIMENTO_OGGETTO            	\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("MOTIVAZIONE", motivazione, Types.VARCHAR);
      mapParameterSource.addValue("FLAG_SOSPENSIONE",
          (("S".equals(flagSospensione)) ? "S" : "N"), Types.VARCHAR);
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("motivazione", motivazione),
              new LogParameter("flagSospensione", flagSospensione),
              new LogParameter("idLivello", idLivello),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimentoEstrattoVO getProcedimentoEstratto(long idProcedimento,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getProcedimentoEstratto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " select ID_PROCEDIMENTO_ESTRATTO, ep.DATA_ESTRAZIONE, FLAG_ESTRATTA   					\n"
        + " from IUF_t_procedimento_estratto pe,							\n"
        + " IUF_t_estrazione_campione ep								\n"
        + "  where (pe.ID_PROCEDIMENTO = :ID_PROCEDIMENTO					\n"
        + " or pe.ID_PROCEDIMENTO_OGGETTO=:ID_PROCEDIMENTO_OGGETTO)		\n"
        + "and	pe.id_estrazione_campione = ep.id_estrazione_campione \n"
        + "  and ep.FLAG_APPROVATA = 'S'";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);

    try
    {
      ProcedimentoEstrattoVO dati = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<ProcedimentoEstrattoVO>()
          {
            @Override
            public ProcedimentoEstrattoVO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ProcedimentoEstrattoVO result = null;
              Date data;
              String flag;

              while (rs.next())
              {
                if (result == null)
                {
                  result = new ProcedimentoEstrattoVO();
                }
                flag = rs.getString("FLAG_ESTRATTA");
                data = rs.getTimestamp("DATA_ESTRAZIONE");

                result.setDataEstrazione(data);
                result.setFlagEstrazione(flag);
                result.setIdProcedimentoEstratto(
                    rs.getLong("ID_PROCEDIMENTO_ESTRATTO"));
              }
              return result;
            }
          });
      return dati;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public LinkedList<LivelloDTO> getLivelliControlloInLoco(long idProcedimento,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getLivelliControlloInLoco]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = "select l.id_livello,l.codice,l.descrizione,l.codice_livello,			\n"
        + "cil.DATA_INIZIO_CONTROLLO,cil.FLAG_CONTROLLO,cil.DATA_SOPRALLUOGO,	\n"
        + "cil.NUMERO_VERBALE,cil.EXT_ID_TECNICO,								\n"
        + "flag_inademp_condizionata, note_inademp_condizionata,			 	\n"
        + "flag_inademp_vincolata, note_inademp_vincolata,MOTIVAZIONE		 	\n"
        + " from IUF_R_PROCEDIMENTO_LIVELLO PL,IUF_D_LIVELLO L,				\n"
        + "IUF_t_controllo_in_loco cil											\n"
        + "where																\n"
        + "cil.ID_PROCEDIMENTO_OGGETTO=:ID_PROCEDIMENTO_OGGETTO				\n"
        + "and																	\n"
        + "cil.ID_LIVELLO = L.ID_LIVELLO										\n"
        + "and																	\n"
        + "L.ID_LIVELLO = PL.ID_LIVELLO										\n"
        + "and 																\n"
        + "PL.ID_PROCEDIMENTO= :ID_PROCEDIMENTO                                \n"
        + "order by l.codice";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);

    try
    {
      LinkedList<LivelloDTO> dati = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<LinkedList<LivelloDTO>>()
          {
            @Override
            public LinkedList<LivelloDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              LinkedList<LivelloDTO> result = null;
              LivelloDTO livello;

              while (rs.next())
              {
                if (result == null)
                {
                  result = new LinkedList<LivelloDTO>();
                }
                livello = new LivelloDTO();
                livello.setIdLivello(rs.getLong("ID_LIVELLO"));
                livello.setFlagControllo(rs.getString("FLAG_CONTROLLO"));
                livello.setCodice(rs.getString("CODICE"));
                livello.setCodiceLivello(rs.getString("CODICE_LIVELLO"));
                livello.setDescrizione(rs.getString("DESCRIZIONE"));
                livello.setDataInizioControllo(
                    rs.getTimestamp("DATA_INIZIO_CONTROLLO"));
                livello.setDataSopralluogo(rs.getTimestamp("DATA_SOPRALLUOGO"));
                livello.setNumeroVerbale(rs.getString("NUMERO_VERBALE"));
                livello.setExtIdTecnico(rs.getLong("EXT_ID_TECNICO"));
                livello.setFlagInadempCondizionata(
                    rs.getString("FLAG_INADEMP_CONDIZIONATA"));
                livello.setFlagInadempVincolata(
                    rs.getString("FLAG_INADEMP_VINCOLATA"));
                livello.setNoteInadempCondizionata(
                    rs.getString("NOTE_INADEMP_CONDIZIONATA"));
                livello.setNoteInadempVincolata(
                    rs.getString("NOTE_INADEMP_VINCOLATA"));
                livello.setMotivazione(rs.getString("MOTIVAZIONE"));

                result.add(livello);
              }
              return result;
            }
          });
      return dati;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaControlloInLoco(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaControlloInLoco]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_CONTROLLO_IN_LOCO                                 \n"
        + "        WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciRecordControlloInLoco(LivelloDTO livello,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciRecordControlloInLoco]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "INSERT INTO IUF_T_CONTROLLO_IN_LOCO		\n"
        + " (ID_CONTROLLO_IN_LOCO,ID_LIVELLO, 	    				\n"
        + "	 ID_PROCEDIMENTO_OGGETTO, 								\n"
        + "	 FLAG_CONTROLLO,DATA_INIZIO_CONTROLLO,					\n"
        + "	 DATA_SOPRALLUOGO,NUMERO_VERBALE,						\n"
        + "  EXT_ID_TECNICO,										\n"
        + "	 FLAG_INADEMP_VINCOLATA, NOTE_INADEMP_VINCOLATA,		\n"
        + "  FLAG_INADEMP_CONDIZIONATA,NOTE_INADEMP_CONDIZIONATA,	\n"
        + "	 MOTIVAZIONE) 											\n"
        + "VALUES 													\n"
        + " (:ID_CONTROLLO_IN_LOCO,	:ID_LIVELLO,					\n"
        + "  :ID_PROCEDIMENTO_OGGETTO,								\n"
        + "	  :FLAG_CONTROLLO,:DATA_INIZIO_CONTROLLO,				\n"
        + "  :DATA_SOPRALLUOGO,:NUMERO_VERBALE,						\n"
        + "  :EXT_ID_TECNICO,										\n"
        + "	 :FLAG_INADEMP_VINCOLATA, :NOTE_INADEMP_VINCOLATA,		\n"
        + "  :FLAG_INADEMP_CONDIZIONATA,:NOTE_INADEMP_CONDIZIONATA,	\n"
        + "	 :MOTIVAZIONE) \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idControlloInLoco = 0;
    try
    {
      idControlloInLoco = getNextSequenceValue("SEQ_IUF_T_CONTROLLO_IN_LOCO");
      mapParameterSource.addValue("ID_CONTROLLO_IN_LOCO", idControlloInLoco,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_LIVELLO", livello.getIdLivello(),
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("FLAG_CONTROLLO", livello.getFlagControllo(),
          Types.VARCHAR);
      mapParameterSource.addValue("DATA_INIZIO_CONTROLLO",
          livello.getDataInizioControllo(), Types.TIMESTAMP);
      mapParameterSource.addValue("DATA_SOPRALLUOGO",
          livello.getDataSopralluogo(), Types.DATE);
      mapParameterSource.addValue("NUMERO_VERBALE", livello.getNumeroVerbale(),
          Types.VARCHAR);
      mapParameterSource.addValue("EXT_ID_TECNICO", livello.getExtIdTecnico(),
          Types.NUMERIC);

      if (livello.getFlagInadempVincolata().equals("")
          || livello.getFlagControllo().equals("N"))
        mapParameterSource.addValue("FLAG_INADEMP_VINCOLATA", null,
            Types.VARCHAR);
      else
        mapParameterSource.addValue("FLAG_INADEMP_VINCOLATA",
            livello.getFlagInadempVincolata(), Types.VARCHAR);

      mapParameterSource.addValue("NOTE_INADEMP_VINCOLATA",
          livello.getNoteInadempVincolata(), Types.VARCHAR);

      if (livello.getFlagInadempCondizionata().equals("")
          || livello.getFlagControllo().equals("N"))
        mapParameterSource.addValue("FLAG_INADEMP_CONDIZIONATA", null,
            Types.VARCHAR);
      else
        mapParameterSource.addValue("FLAG_INADEMP_CONDIZIONATA",
            livello.getFlagInadempCondizionata(), Types.VARCHAR);

      mapParameterSource.addValue("NOTE_INADEMP_CONDIZIONATA",
          livello.getNoteInadempCondizionata(), Types.VARCHAR);
      mapParameterSource.addValue("MOTIVAZIONE", livello.getMotivazione(),
          Types.VARCHAR);

      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idLivello", livello.getIdLivello()),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("flagControllo", livello.getFlagControllo()),
              new LogParameter("dataInizioControllo",
                  livello.getDataInizioControllo()),
              new LogParameter("dataSopralluogo", livello.getDataSopralluogo()),
              new LogParameter("numeroVerbale", livello.getNumeroVerbale()),
              new LogParameter("extIdTecnico", livello.getExtIdTecnico()),
              new LogParameter("motivazione", livello.getMotivazione()),
              new LogParameter("flagInadempVincolata",
                  livello.getFlagInadempVincolata()),
              new LogParameter("noteInadempVincolata",
                  livello.getNoteInadempVincolata()),
              new LogParameter("flagInadempCondizionata",
                  livello.getFlagInadempCondizionata()),
              new LogParameter("noteInadempCondizionatazione",
                  livello.getNoteInadempCondizionata())
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateFlagEstrazione(long idProcedimentoEstratto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateFlagEstrazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        	  \n"
        + "   IUF_T_PROCEDIMENTO_ESTRATTO								  \n"
        + " SET                                                           \n"
        + "   FLAG_ESTRATTA = 'M' 						                  \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_ESTRATTO = :ID_PROCEDIMENTO_ESTRATTO        \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_ESTRATTO",
          idProcedimentoEstratto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoEstratto",
                  idProcedimentoEstratto),

          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaSospensioneAnticipo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaSospensioneAnticipo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_SOSPENSIONE_ANTICIPO 			 			 \n"
        + " WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }

  }

  public boolean checkExtension(String extension)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::checkExtension]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                \n"
        + "   COUNT(*)                                           \n"
        + " FROM                                                 \n"
        + "   DB_D_ESTENSIONE_MIME_TYPE		                     \n"
        + " WHERE                                                \n"
        + "   ESTENSIONE   = :EXTENSION					         \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("EXTENSION", extension.trim().toLowerCase(),
          Types.VARCHAR);
      return queryForLong(QUERY, mapParameterSource) != 0; // Posso inserire se
                                                           // non c' gi il
                                                           // record presente
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkNotifiche(long idProcedimento, Long idGravita,
      String attore)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::checkNotifiche]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "";
    if (idGravita.longValue() == IuffiConstants.FLAG_NOTIFICA.WARNING)
    {
      QUERY = " SELECT                                  \n"
          + "    COUNT(*)                             \n"
          + "  FROM                                   \n"
          + "    IUF_T_NOTIFICA N,                      \n"
          + "    IUF_R_VISIBILITA_ATTORE VA           \n"
          + "  WHERE                                  \n"
          + "    N.ID_PROCEDIMENTO   = :ID_PROCEDIMENTO \n"
          + "  AND                                    \n"
          + "   N.ID_GRAVITA_NOTIFICA=:GRAVITA          \n"
          + "   AND N.DATA_FINE IS NULL                 \n"
          + "   AND N.ID_VISIBILITA=VA.ID_VISIBILITA	\n"
          + "   AND VA.EXT_COD_ATTORE =:ATTORE        \n";
    }
    else
    {
      QUERY = " SELECT                                \n"
          + "   COUNT(*)                                           \n"
          + " FROM                                                 \n"
          + "   IUF_T_NOTIFICA		                  		     \n"
          + " WHERE                                                \n"
          + "   ID_PROCEDIMENTO   = :ID_PROCEDIMENTO				 \n"
          + " AND 												 \n"
          + "   ID_GRAVITA_NOTIFICA=:GRAVITA						 \n"
          + " AND													 \n"
          + " DATA_FINE IS NULL									 \n";
    }

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.VARCHAR);
      mapParameterSource.addValue("GRAVITA", idGravita, Types.NUMERIC);
      if (idGravita.longValue() == IuffiConstants.FLAG_NOTIFICA.WARNING)
      {
        mapParameterSource.addValue("ATTORE", attore, Types.VARCHAR);
      }
      return queryForLong(QUERY, mapParameterSource) != 0; // Posso inserire se
                                                           // non c' gi il
                                                           // record presente
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public SiapCommWsDatiProtocolloVO getDatiProtocolloVO(long idProcedimento,
      Date dataRifermento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                     \n"
        + "     VA.DESCRIZIONE_COMUNE || ' (' || VA.DESCRIZIONE_PROVINCIA || ')' AS COMUNE_SEDE_LGALE, \n"
        + "     VANAG.CUAA,                                                                            \n"
        + "     VANAG.DENOMINAZIONE,                                                                   \n"
        + "     VANAG.INDIRIZZO_SEDE_LEGALE,                                                           \n"
        + "     VANAG.ISTAT_COMUNE_SEDE_LEGALE,                                                        \n"
        + "     VA.CAP AS CAP_SEDE_LEGALE,                                                             \n"
        + "     NVL(VANAG.PEC, VANAG.MAIL) AS MAIL                                                     \n"
        + "  FROM                                                                                      \n"
        + "     IUF_T_PROCEDIMENTO_AZIENDA PA,                                                         \n"
        + "     SMRGAA_V_DATI_AMMINISTRATIVI VA,                                                       \n"
        + "     SMRGAA_V_DATI_ANAGRAFICI VANAG                                                         \n"
        + "  WHERE                                                                                     \n"
        + "     VANAG.ISTAT_COMUNE_SEDE_LEGALE = VA.ISTAT_COMUNE                                       \n"
        + "     AND PA.EXT_ID_AZIENDA = VANAG.ID_AZIENDA                                               \n"
        + "     AND NVL(:DATA_RIFERIMENTO, SYSDATE)                                                    \n"
        + "      BETWEEN PA.DATA_INIZIO                                                                \n"
        + "      AND NVL(PA.DATA_FINE, TO_DATE('31/12/9999','DD/MM/YYYY'))                             \n"
        + "    AND NVL(:DATA_RIFERIMENTO, SYSDATE)                                                     \n"
        + "      BETWEEN VANAG.DATA_INIZIO_VALIDITA                                                    \n"
        + "      AND NVL(VANAG.DATA_FINE_VALIDITA, TO_DATE('31/12/9999','DD/MM/YYYY'))                 \n"
        + "    AND PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                                               \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_RIFERIMENTO", dataRifermento,
          Types.TIMESTAMP);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<SiapCommWsDatiProtocolloVO>()
          {
            @Override
            public SiapCommWsDatiProtocolloVO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              SiapCommWsDatiProtocolloVO result = null;
              while (rs.next())
              {
                if (result == null)
                {
                  result = new SiapCommWsDatiProtocolloVO();
                }
                result.setDenominazioneMittenteDestinatario(
                    rs.getString("DENOMINAZIONE"));
                result.setEmailMittenteDestinatario(rs.getString("MAIL"));
                result.setCittaMittenteDestinatario(
                    rs.getString("COMUNE_SEDE_LGALE"));
                result.setIndirizzoMittenteDestinatario(
                    rs.getString("INDIRIZZO_SEDE_LEGALE"));
                result.setTipoProtocollo(
                    IuffiConstants.SIAPCOMMWS.DATI_PROTOCOLLO.TIPO_PROTOCOLLO.INGRESSO);
              }
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("dataRifermento", dataRifermento),
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  /*
   * public void aggiornaDatiProtocollazione(long idProcedimentoOggetto, Date
   * dataProtocolloDocumento, String numeroProtocolloDocumento, Date
   * dataProtocolloEmergenza, String numeroProtocolloEmergenza)throws
   * InternalUnexpectedException { String THIS_METHOD = "[" + THIS_CLASS +
   * "::aggiornaDatiProtocollazione]"; if (logger.isDebugEnabled()) {
   * logger.debug(THIS_METHOD + " BEGIN."); } final String UPDATE =
   * " UPDATE                                                        			\n" +
   * "   IUF_T_PROCEDIMENTO_OGGETTO                                  		\n" +
   * " SET                                                           		\n" +
   * "   DATA_PROTOCOLLO               = :DATA_PROTOCOLLO,                 \n" +
   * "   NUMERO_PROTOCOLLO 			= :NUMERO_PROTOCOLLO, 				\n" +
   * "   DATA_PROTOCOLLO_EMERGENZA   	= :DATA_PROTOCOLLO_EMERGENZA,       \n" +
   * "   NUMERO_PROTOCOLLO_EMERGENZA   = :NUMERO_PROTOCOLLO_EMERGENZA      \n" +
   * " WHERE                                                         		\n" +
   * "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          		\n";
   * MapSqlParameterSource mapParameterSource = new MapSqlParameterSource(); try
   * { mapParameterSource.addValue("DATA_PROTOCOLLO", dataProtocolloDocumento,
   * Types.DATE); mapParameterSource.addValue("NUMERO_PROTOCOLLO",
   * numeroProtocolloDocumento, Types.VARCHAR);
   * mapParameterSource.addValue("DATA_PROTOCOLLO_EMERGENZA",
   * dataProtocolloEmergenza, Types.DATE);
   * mapParameterSource.addValue("NUMERO_PROTOCOLLO_EMERGENZA",
   * numeroProtocolloEmergenza, Types.VARCHAR);
   * mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
   * idProcedimentoOggetto, Types.NUMERIC);
   * namedParameterJdbcTemplate.update(UPDATE, mapParameterSource); } catch
   * (Throwable t) { InternalUnexpectedException e = new
   * InternalUnexpectedException(t, new LogParameter[] { new
   * LogParameter("idProcedimentoOggetto", idProcedimentoOggetto), new
   * LogParameter("dataProtocolloDocumento", dataProtocolloDocumento), new
   * LogParameter("numeroProtocolloDocumento", numeroProtocolloDocumento), new
   * LogParameter("numeroProtocolloDocumento", numeroProtocolloEmergenza), new
   * LogParameter("numeroProtocolloDocumento", dataProtocolloEmergenza) }, new
   * LogVariable[] {}, UPDATE, mapParameterSource);
   * logInternalUnexpectedException(e, THIS_METHOD); throw e; } finally { if
   * (logger.isDebugEnabled()) { logger.debug(THIS_METHOD + " END."); } }
   * 
   * }
   */

  public List<RigaRendicontazioneSpese> getElencoRendicontazioneSpese(
      long idProcedimentoOggetto, List<Long> ids)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoRendicontazioneSpese]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " WITH                                                                                          \n"
        + "   REN_PREC AS                                                                                 \n"
        + "   (                                                                                           \n"
        + "     SELECT                                                                                    \n"
        + "       RS.*                                                                                    \n"
        + "     FROM                                                                                      \n"
        + "       IUF_T_RENDICONTAZIONE_SPESE RS,                                                         \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO_ORIG,                                                     \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO,                                                          \n"
        + "       IUF_T_ITER_PROCEDIMENTO_OGGE IPO                                                      \n"
        + "     WHERE                                                                                     \n"
        + "       PO_ORIG.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                              \n"
        + "       AND PO_ORIG.ID_PROCEDIMENTO     = PO.ID_PROCEDIMENTO                                    \n"
        + "       AND RS.ID_PROCEDIMENTO_OGGETTO  = PO.ID_PROCEDIMENTO_OGGETTO                            \n"
        + "       AND PO.CODICE_RAGGRUPPAMENTO    < PO_ORIG.CODICE_RAGGRUPPAMENTO                         \n"
        + "       AND PO.ID_PROCEDIMENTO_OGGETTO  = IPO.ID_PROCEDIMENTO_OGGETTO                           \n"
        + "       AND IPO.ID_STATO_OGGETTO BETWEEN 10 AND 90                                              \n"
        + "   )                                                                                           \n"
        + "   ,                                                                                           \n"
        + "   ACC_PREC AS                                                                                 \n"
        + "   (                                                                                           \n"
        + "     SELECT                                                                                    \n"
        + "       TAS.*                                                                                   \n"
        + "     FROM                                                                                      \n"
        + "       IUF_T_ACCERTAMENTO_SPESE TAS ,                                                          \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO_ORIG,                                                     \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO                                                           \n"
        + "     WHERE                                                                                     \n"
        + "       PO_ORIG.ID_PROCEDIMENTO_OGGETTO  = :ID_PROCEDIMENTO_OGGETTO                             \n"
        + "       AND PO_ORIG.ID_PROCEDIMENTO      = PO.ID_PROCEDIMENTO                                   \n"
        + "       AND TAS.ID_PROCEDIMENTO_OGGETTO  = PO.ID_PROCEDIMENTO_OGGETTO                           \n"
        + "       AND TAS.ID_PROCEDIMENTO_OGGETTO <> PO_ORIG.ID_PROCEDIMENTO_OGGETTO                      \n"
        + "       AND PO.DATA_FINE                 < NVL(PO_ORIG.DATA_FINE,SYSDATE)                       \n"
        + "   )                                                                                           \n"
        + "   ,                                                                                           \n"
        + "   RENDICONTAZIONE_CORRENTE AS                                                                 \n"
        + "   (                                                                                           \n"
        + "     SELECT                                                                                    \n"
        + "       *                                                                                       \n"
        + "     FROM                                                                                      \n"
        + "       IUF_T_RENDICONTAZIONE_SPESE                                                             \n"
        + "     WHERE                                                                                     \n"
        + "       ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                      \n"
        + "   )                                                                                           \n"
        + " SELECT                                                                                        \n"
        + "   I.ID_INTERVENTO,                                                                            \n"
        + "   DI.ID_DETTAGLIO_INTERVENTO,                                                                 \n"
        + "   DI.PROGRESSIVO,                                                                             \n"
        + "   TA.DESCRIZIONE      AS DESC_TIPO_INTERVENTO,                                                \n"
        + "   DESCINT.DESCRIZIONE AS DESC_INTERVENTO,                                                     \n"
        + "   DI.ULTERIORI_INFORMAZIONI,                                                                  \n"
        + "   NVL(DI.IMPORTO_AMMESSO,0)        AS SPESA_AMMESSA,                                          \n"
        + "   NVL(DI.PERCENTUALE_CONTRIBUTO,0) AS PERCENTUALE_CONTRIBUTO,                                 \n"
        + "   NVL(DI.IMPORTO_CONTRIBUTO,0)     AS IMPORTO_CONTRIBUTO,                                     \n"
        + "   (                                                                                           \n"
        + "     SELECT                                                                                    \n"
        + "       NVL(SUM(NVL(REN_PREC.IMPORTO_SPESA,0)),0)                                               \n"
        + "     FROM                                                                                      \n"
        + "       REN_PREC                                                                                \n"
        + "   ) AS SPESE_SOSTENUTE,                                                                       \n"
        + "   (                                                                                           \n"
        + "     SELECT                                                                                    \n"
        + "       NVL(SUM(NVL(ACC_PREC.IMPORTO_ACCERTATO,0) +NVL(ACC_PREC.IMPORTO_NON_RICONOSCIUTO,0)),0) \n"
        + "     FROM                                                                                      \n"
        + "       ACC_PREC                                                                                \n"
        + "   )                       AS SPESE_ACCERTATE,                                                 \n"
        + "   NVL(RS.IMPORTO_SPESA,0) AS IMPORTO_SPESA,                                                   \n"
        + "   NVL(DI.IMPORTO_AMMESSO,0) - NVL(RS.IMPORTO_SPESA,0) -                                       \n"
        + "   (                                                                                           \n"
        + "     SELECT                                                                                    \n"
        + "       NVL(SUM(NVL(ACC_PREC.IMPORTO_ACCERTATO,0) +NVL(ACC_PREC.IMPORTO_NON_RICONOSCIUTO,0)),0) \n"
        + "     FROM                                                                                      \n"
        + "       ACC_PREC                                                                                \n"
        + "   )                              AS SPESE_DA_RENDICONTARE,                                    \n"
        + "   NVL(RS.CONTRIBUTO_RICHIESTO,0) AS CONTRIBUTO_RICHIESTO,                                     \n"
        + "   RS.FLAG_INTERVENTO_COMPLETATO,                                                              \n"
        + "   RS.NOTE                                                                                     \n"
        + " FROM                                                                                          \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                                              \n"
        + "   IUF_T_INTERVENTO I,                                                                         \n"
        + "   IUF_D_DESCRIZIONE_INTERVENTO DESCINT,                                                       \n"
        + "   IUF_T_DETTAGLIO_INTERVENTO DI,                                                              \n"
        + "   IUF_D_TIPO_CLASSIFICAZIONE TC,                                                              \n"
        + "   IUF_R_AGGREGAZIONE_INTERVENT AI,                                                           \n"
        + "   IUF_D_TIPO_AGGREGAZIONE TA,                                                                 \n"
        + "   IUF_D_CATEGORIA_INTERVENTO CI,                                                              \n"
        + "   RENDICONTAZIONE_CORRENTE RS                                                                 \n"
        + " WHERE                                                                                         \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                                       \n"
        + "   AND I.ID_PROCEDIMENTO      = PO.ID_PROCEDIMENTO                                             \n"
        + "   AND NVL(PO.DATA_FINE,SYSDATE) BETWEEN DI.DATA_INIZIO AND NVL(DI.DATA_FINE, SYSDATE)         \n"
        + "   AND I.ID_INTERVENTO                   = DI.ID_INTERVENTO                                    \n"
        + "   AND I.ID_DESCRIZIONE_INTERVENTO       = DESCINT.ID_DESCRIZIONE_INTERVENTO                   \n"
        + "   AND DESCINT.ID_TIPO_CLASSIFICAZIONE   = TC.ID_TIPO_CLASSIFICAZIONE                          \n"
        + "   AND DESCINT.ID_CATEGORIA_INTERVENTO   = CI.ID_CATEGORIA_INTERVENTO(+)                       \n"
        + "   AND NVL(CI.FLAG_ESCLUDI_CATALOGO,'N') = :FLAG_ESCLUDI_CATALOGO                              \n"
        + "   AND I.ID_DESCRIZIONE_INTERVENTO       = AI.ID_DESCRIZIONE_INTERVENTO                        \n"
        + "   AND AI.ID_TIPO_AGGREGAZIONE_PRIMO_LIV = TA.ID_TIPO_AGGREGAZIONE                             \n"
        + "   AND DI.FLAG_TIPO_OPERAZIONE          <> :TIPO_OPERAZIONE_ELIMINAZIONE                       \n"
        + "   AND I.ID_INTERVENTO                   = RS.ID_INTERVENTO(+)                                 \n"
        + ((ids != null && !ids.isEmpty())
            ? getInCondition("I.ID_INTERVENTO", ids)
            : "")
        + " ORDER BY                                                                                      \n"
        + "   DI.PROGRESSIVO ASC                                                                          \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("TIPO_OPERAZIONE_ELIMINAZIONE",
        IuffiConstants.INTERVENTI.TIPO_OPERAZIONE_ELIMINAZIONE,
        Types.VARCHAR);
    mapParameterSource.addValue("FLAG_ESCLUDI_CATALOGO",
        IuffiConstants.FLAGS.NO, Types.VARCHAR);
    try
    {
      return queryForList(QUERY, mapParameterSource,
          RigaRendicontazioneSpese.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void clearEsclusioneTParticellaImpegno(long idParticellaUtilizzo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::clearEsclusioneTParticellaImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " UPDATE IUF_T_PARTICELLA_IMPEGNO 						 \n"
        + " SET FLAG_ESCLUSIONE = 'N', 						     \n"
        + "	  ID_MOTIVO_ESCLUSIONE = NULL, 						 \n"
        + "	  NOTE = NULL		 								 \n"
        + " WHERE ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateEsclusioneTParticellaImpegno(long idParticellaUtilizzo,
      long idImpegno, Long idImpegnoSpecifico,
      String flagEsclusione, long idMotivoEsclusione, String noteEsclusione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateEsclusioneTParticellaImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final StringBuffer DELETE = new StringBuffer(
        " UPDATE IUF_T_PARTICELLA_IMPEGNO 						\n"
            + " SET 													\n"
            + "	  FLAG_ESCLUSIONE = :FLAG_ESCLUSIONE, 				\n");

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      if (idMotivoEsclusione != 0)
      {
        DELETE.append("	  ID_MOTIVO_ESCLUSIONE = :ID_MOTIVO_ESCLUSIONE, \n");
      }
      else
      {
        DELETE.append("	  ID_MOTIVO_ESCLUSIONE = NULL, \n");
      }

      DELETE.append("	  NOTE = :NOTE		 								    \n"
          + " WHERE 												\n"
          + "	ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO 	\n"
          + "	AND ID_IMPEGNO =  :ID_IMPEGNO  						\n");

      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      mapParameterSource.addValue("FLAG_ESCLUSIONE", flagEsclusione,
          Types.VARCHAR);
      if (idMotivoEsclusione != 0)
      {
        mapParameterSource.addValue("ID_MOTIVO_ESCLUSIONE", idMotivoEsclusione,
            Types.NUMERIC);
      }
      mapParameterSource.addValue("ID_IMPEGNO", idImpegno, Types.NUMERIC);
      mapParameterSource.addValue("NOTE", noteEsclusione, Types.VARCHAR);

      namedParameterJdbcTemplate.update(DELETE.toString(), mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo),
              new LogParameter("flagEsclusione", flagEsclusione),
              new LogParameter("idMotivoEsclusione", idMotivoEsclusione),
              new LogParameter("idImpegno", idImpegno),
              new LogParameter("noteEsclusione", noteEsclusione),
              new LogParameter("idImpegnoSpecifico", idImpegnoSpecifico)
          },
          new LogVariable[]
          {}, DELETE.toString(), mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Map<String, List<String>> getTestiStampeIstruttoria(String codiceCdu,
      long idBandoOggetto)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getTestiStampeIstruttoria";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                     \n"
        + "   GTV.TIPO_COLLOCAZIONE_TESTO,                             \n"
        + "   TV.DESCRIZIONE                                           \n"
        + " FROM                                                       \n"
        + "   IUF_D_GRUPPO_TESTO_VERBALE GTV,                          \n"
        + "   IUF_D_TESTO_VERBALE TV,                                  \n"
        + "   IUF_D_ELENCO_CDU EC                                      \n"
        + " WHERE                                                      \n"
        + "   GTV.ID_GRUPPO_TESTO_VERBALE = TV.ID_GRUPPO_TESTO_VERBALE \n"
        + "   AND GTV.ID_ELENCO_CDU = EC.ID_ELENCO_CDU                 \n"
        + "   AND EC.CODICE_CDU = :CODICE_CDU                          \n"
        + "   AND GTV.ID_BANDO_OGGETTO = :ID_BANDO_OGGETTO             \n"
        + " ORDER BY                                                   \n"
        + "   GTV.TIPO_COLLOCAZIONE_TESTO,                             \n"
        + "   TV.ORDINE ASC                                            \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("CODICE_CDU", codiceCdu, Types.VARCHAR);
    mapParameterSource.addValue("ID_BANDO_OGGETTO", idBandoOggetto,
        Types.NUMERIC);
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Map<String, List<String>>>()
          {
            @Override
            public Map<String, List<String>> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              Map<String, List<String>> result = new HashMap<String, List<String>>();
              while (rs.next())
              {
                final String tipoCollocazioneTesto = rs
                    .getString("TIPO_COLLOCAZIONE_TESTO");
                List<String> list = result.get(tipoCollocazioneTesto);
                if (list == null)
                {
                  list = new ArrayList<String>();
                  result.put(tipoCollocazioneTesto, list);
                }
                list.add(rs.getString("DESCRIZIONE"));
              }
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("codiceCdu", codiceCdu),
              new LogParameter("idBandoOggetto", idBandoOggetto)
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public DecodificaDTO<String> findDatiInvioPec(long idBandoOggetto)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "findDatiInvioPec";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                   \n"
        + "   B.OGGETTO_RICEVUTA AS DESCRIZIONE,                    \n"
        + "   B.CORPO_RICEVUTA  AS CODICE_DESCRIZIONE                       \n"
        + " FROM                                     \n"
        + "   IUF_R_BANDO_OGGETTO B                  \n"
        + " WHERE                                    \n"
        + "   B.ID_BANDO_OGGETTO = :ID_BANDO_OGGETTO \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_BANDO_OGGETTO", idBandoOggetto,
        Types.VARCHAR);
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<DecodificaDTO<String>>()
          {
            @Override
            public DecodificaDTO<String> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              DecodificaDTO<String> list = new DecodificaDTO<String>();
              if (rs.next())
              {
                DecodificaDTO<String> d = new DecodificaDTO<String>();
                d.setDescrizione(rs.getString("DESCRIZIONE"));
                d.setCodiceDescrizione(rs.getString("CODICE_DESCRIZIONE"));
                return d;
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idBandoOggetto", idBandoOggetto)
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public List<ImportoLiquidatoDTO> getElencoImportiLiquidazione(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoImportiLiquidazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT 													  \n"
        + " il.IMPORTO_COMPLESSIVO,				  							  	  \n"
        + " il.IMPORTO_LIQUIDATO, 				  							  	  \n"
        + " il.ID_IMPORTI_LIQUIDATI, 											  \n"
        + " ll.EXT_ID_TECNICO_LIQUIDATORE, 				  						  \n"
        + " ll.NUMERO_LISTA, 					  								  \n"
        + " ll.DATA_CREAZIONE, 				  							  		  \n"
        + " ll.FLAG_STATO_LISTA,								 				  \n"
        + " ll.NOTE as NOTELL, 				  							  	 	  \n"
        + " ll.DATA_APPROVAZIONE, 				  							  	  \n"
        + " ll.FLAG_INVIO_SIGOP,		  										  \n"
        + " ll.DATA_INVIO_SIGOP, 				  							  	  \n"
        + " ll.FLAG_AMM_COMPETENZA, 						  					  \n"
        + "	ll.ID_LISTA_LIQUIDAZIONE,											  \n"
        + " lil.FLAG_ESITO_LIQUIDAZIONE, 				  						  \n"
        + " lil.DATA_ULTIMO_AGGIORNAMENTO,			  							  \n"
        + " lil.NOTE as MOTIVO_RESP,		  									  \n"
        + " lil.IMPORTO, 				  							  			  \n"
        + " lil.IMPORTO_REC, 				  							  		  \n"
        + " lil.ID_LISTA_LIQUIDAZ_IMP_LIQ,		  								  \n"
        + " lil.CODICE_FONDO, 				  							 		  \n"
        + " lil.NUMERO_MANDATO, 				  							  	  \n"
        + " lil.ANNO_ESERCIZIO, 			  									  \n"
        + " lil.CODICE_PAGAMENTO, 				  							  	  \n"
        + " lil.NUMERO_PAGAMENTO,					  							  \n"
        + " lil.NUMERO_DECRETO, 				  							      \n"
        + " lil.NUMERO_PROGRESSIVO, 					  						  \n"
        + " lil.DATA_CREAZIONE_DECRETO, 				  						  \n"
        + " lil.DATA_CREAZIONE_MANDATO,				  							  \n"
        + " lil.DATA_EFFETUAZIONE,												  \n"
        + "	liv.CODICE, 														  \n"
        + "	liv.DESCRIZIONE, 													  \n"
        + "	ll.EXT_ID_AMM_COMPETENZA AS EXT_ID_AMM_COMPETENZA,					  \n"
        + "	f.ext_id_documento_index AS ext_id_documento_index,					  \n"
        + "	v.nome || ' ' || v.cognome  as DECODIFICA_TECNICO,     				  \n"
        + "	F.NUMERO_PROTOCOLLO,										    	  \n"
        + "	F.DATA_PROTOCOLLO												   	  \n"
        + "   FROM 	                                                              \n"
        + "     IUF_t_importi_liquidati il,  									  \n"
        + " 	IUF_R_LISTA_LIQUIDAZ_IMP_LIQ lil,  								  \n"
        + " 	IUF_T_LISTA_LIQUIDAZIONE ll, 									  \n"
        + " 	IUF_D_LIVELLO liv,												  \n"
        + " 	IUF_T_FILE_LISTA_LIQUIDAZION f,								  \n"
        + " 	DB_TECNICO v	   								  				  \n"
        + "   WHERE                                                         	  \n"
        + "         il.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO    	  \n"
        + "         AND liv.ID_LIVELLO = il.ID_LIVELLO          				  \n"
        + "         AND ll.ID_LISTA_LIQUIDAZIONE (+)= lil.ID_LISTA_LIQUIDAZIONE	  \n"
        + "         AND  lil.ID_IMPORTI_LIQUIDATI (+)= il.ID_IMPORTI_LIQUIDATI    \n"
        + " 		AND v.ID_TECNICO (+) = ll.EXT_ID_TECNICO_LIQUIDATORE		  \n"
        + " 		AND f.ID_LISTA_LIQUIDAZIONE (+)= lil.ID_LISTA_LIQUIDAZIONE	  \n"
        + "	ORDER BY CODICE														  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<ImportoLiquidatoDTO>>()
          {

            @Override
            public List<ImportoLiquidatoDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<ImportoLiquidatoDTO> list = new ArrayList<ImportoLiquidatoDTO>();
              while (rs.next())
              {

                ImportoLiquidatoDTO importoLiquidatoDTO = null;
                importoLiquidatoDTO = new ImportoLiquidatoDTO();
                importoLiquidatoDTO
                    .setIdProcedimentoOggetto(idProcedimentoOggetto);
                importoLiquidatoDTO.setCodiceLivello(rs.getString("CODICE"));
                importoLiquidatoDTO
                    .setDescrizioneLivello(rs.getString("DESCRIZIONE"));
                importoLiquidatoDTO.setImportoComplessivo(
                    rs.getBigDecimal("IMPORTO_COMPLESSIVO"));
                importoLiquidatoDTO
                    .setImportoLiquidato(rs.getBigDecimal("IMPORTO_LIQUIDATO"));

                importoLiquidatoDTO.setExtIdTecnicoLiquidatore(
                    rs.getLong("EXT_ID_TECNICO_LIQUIDATORE"));
                importoLiquidatoDTO.setFlagEsitoLiquidazione(
                    rs.getString("FLAG_ESITO_LIQUIDAZIONE"));
                importoLiquidatoDTO.setDataUltimoAggiornamento(
                    rs.getDate("DATA_ULTIMO_AGGIORNAMENTO"));
                importoLiquidatoDTO
                    .setExtIdAmmCompetenza(rs.getLong("ext_id_amm_competenza"));
                importoLiquidatoDTO.setNumeroLista(rs.getLong("NUMERO_LISTA"));
                importoLiquidatoDTO
                    .setDataCreazione(rs.getDate("DATA_CREAZIONE"));
                importoLiquidatoDTO
                    .setFlagStatoLista(rs.getString("FLAG_STATO_LISTA"));
                importoLiquidatoDTO.setNote(rs.getString("NOTELL"));
                importoLiquidatoDTO
                    .setDataApprovazione(rs.getDate("DATA_APPROVAZIONE"));
                importoLiquidatoDTO
                    .setFlagInvioSigop(rs.getString("FLAG_INVIO_SIGOP"));
                importoLiquidatoDTO
                    .setDataInvioSigop(rs.getDate("DATA_INVIO_SIGOP"));

                importoLiquidatoDTO
                    .setTecnico(rs.getString("DECODIFICA_TECNICO"));

                importoLiquidatoDTO
                    .setFlagAmmCompetenza(rs.getString("FLAG_AMM_COMPETENZA"));

                importoLiquidatoDTO.setIdListaLiquidazione(
                    rs.getLong("ID_LISTA_LIQUIDAZIONE"));
                importoLiquidatoDTO
                    .setIdImportoLiquidato(rs.getLong("ID_IMPORTI_LIQUIDATI"));
                importoLiquidatoDTO.setIdListaLiquidazImpLiq(
                    rs.getLong("ID_LISTA_LIQUIDAZ_IMP_LIQ"));

                // pagamento
                importoLiquidatoDTO
                    .setCodiceFondo(rs.getString("CODICE_FONDO"));
                importoLiquidatoDTO
                    .setNumeroMandato(rs.getLong("NUMERO_MANDATO"));
                importoLiquidatoDTO
                    .setAnnoEsercizio(rs.getLong("ANNO_ESERCIZIO"));
                importoLiquidatoDTO
                    .setCodicePagamento(rs.getString("CODICE_PAGAMENTO"));
                importoLiquidatoDTO
                    .setNumeroPagamento(rs.getLong("NUMERO_PAGAMENTO"));
                importoLiquidatoDTO
                    .setNumeroDecreto(rs.getLong("NUMERO_DECRETO"));
                importoLiquidatoDTO
                    .setNumeroProgressivo(rs.getLong("NUMERO_PROGRESSIVO"));
                importoLiquidatoDTO.setDataCreazioneDecreto(
                    rs.getDate("DATA_CREAZIONE_DECRETO"));
                importoLiquidatoDTO.setDataCreazioneMandato(
                    rs.getDate("DATA_CREAZIONE_MANDATO"));
                importoLiquidatoDTO.setDataEffettuazionePagamento(
                    rs.getDate("DATA_EFFETUAZIONE"));
                importoLiquidatoDTO
                    .setImportoRecupero(rs.getBigDecimal("IMPORTO_REC"));
                importoLiquidatoDTO
                    .setImportoPagato(rs.getBigDecimal("IMPORTO"));
                importoLiquidatoDTO.setMotivoResp(rs.getString("MOTIVO_RESP"));

                importoLiquidatoDTO.setExtIdDocumentoIndex(
                    rs.getLong("ext_id_documento_index"));

                importoLiquidatoDTO
                    .setNumProtocollo(rs.getString("NUMERO_PROTOCOLLO"));
                importoLiquidatoDTO
                    .setDataProtocollo(rs.getDate("DATA_PROTOCOLLO"));
                list.add(importoLiquidatoDTO);

              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<String> getListaTipoAttivita(
      Long idListaLiquidazione) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getListaTipoAttivita]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT AZ.ID_CATEGORIA_ATTIVITA \r\n" + 
        ",AZ.DESC_CATEGORIA_ATTIVITA \r\n" + 
        " FROM ABIO.ABIO_V_AZIENDE_BIOLOGICHE AZ \r\n" + 
        ",ABIO.ABIO_V_CATEGORIE_ATTIVITA_BIO C, IUF_T_PROCEDIMENTO_OGGETTO PO \r\n" + 
        "WHERE C.EXT_ID_AZIENDA=AZ.EXT_ID_AZIENDA \r\n" + 
        "AND AZ.ID_CATEGORIA_ATTIVITA=C.ID_CATEGORIA_ATTIVITA\r\n" + 
        "AND C.DT_FINE_ATT_BIO IS NULL\r\n" + 
        "AND C.DT_FINE_VAL_POS IS NULL\r\n" + 
        "AND AZ.DATA_FINE_POSIZIONE_ATTUALE IS NULL\r\n" + 
        "AND AZ.FLAG_GIA_IDONEA='S'\r\n" + 
        "AND AZ.FLAG_PRESENZA_DOC_GIUSTIFICAT='S'\r\n" + 
        "AND (AZ.ID_STATO_ATTIVITA IN (1, 6) OR (AZ.ID_STATO_ATTIVITA = 7 AND AZ.DATA_FINE_DOC_GIUST > TRUNC(SYSDATE)))\r\n" + 
        "AND AZ.EXT_ID_AZIENDA =(SELECT EXT_ID_AZIENDA FROM IUF_T_PROCEDIMENTO_AZIENDA PA WHERE PA.ID_PROCEDIMENTO = :ID_LISTA_LIQUIDAZIONE)\r\n" + 
        "AND (PO.DATA_FINE IS NULL or PO.DATA_FINE BETWEEN TO_DATE(az.data_inizio_posizione_attuale, 'DD/MM/YYYY')\r\n" + 
        "AND TO_DATE(az.data_fine_posizione_attuale, 'DD/MM/YYYY'))";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<String>>()
          {

            @Override
            public List<String> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<String> list = new ArrayList<String>();
              String s = null;
              while (rs.next())
              {

                if (s == null)
                {
                  s = rs.getString("DESC_CATEGORIA_ATTIVITA");
                }
                else
                {
                  s = s + ", " + rs.getString("DESC_CATEGORIA_ATTIVITA");
                }

                list.add(s);

              }
              list.add(s);
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idListaLiquidazione", idListaLiquidazione) },
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaListaMetodiAttivi(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaAnalisiDocumentale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_r_azienda_bio_metodo_col                                     \n"
        + " WHERE ID_AZIENDA_BIO = :ID_AZIENDA_BIO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA_BIO",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA_BIO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaListaMultiAttivi(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaListaMultiAttivi]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_R_AZIENDA_BIO_MULTIFUNZ                                     \n"
        + " WHERE ID_AZIENDA_BIO = :ID_AZIENDA_BIO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA_BIO",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA_BIO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaListaFiliereAttivi(long azienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaListaFiliereAttivi]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_R_AZIENDA_BIO_FILIERA_PR                                     \n"
        + " WHERE ID_AZIENDA_BIO = :ID_AZIENDA_BIO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA_BIO",
          azienda, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA_BIO", azienda)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getListaMetodiAttivi(long idAzienda)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "select dmc.id_metodo_coltivazione as id, dmc.id_metodo_coltivazione as codice, dmc.DESCRIZIONE from IUF_d_metodo_coltivazione dmc \r\n"
        +
        "left join IUF_r_azienda_bio_metodo_col abmc on abmc.id_metodo_coltivazione = dmc.id_metodo_coltivazione \r\n"
        +
        "left join IUF_t_azienda_bio ab on ab.id_azienda_bio = abmc.id_azienda_bio \r\n"
        +
        "where ab.id_azienda_bio = :ID_AZIENDA";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA", idAzienda,
          Types.NUMERIC);
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA", idAzienda)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public List<DecodificaDTO<Long>> getListaCanaliDiVenditaAttivi(long idContatto)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "select cv.id_canale_vendita as id, cv.id_canale_vendita as codice, cv.descrizione \r\n" + 
        "from IUF_d_canale_vendita cv\r\n" + 
        "where cv.id_canale_vendita in (select ccv.id_canale_vendita from IUF_R_CONTATTI_CANALE_VENDIT ccv where ccv.id_contatti = :ID_CONTATTI)\r\n" + 
        "order by ordinamento";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_CONTATTI", idContatto,
          Types.NUMERIC);
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA", idContatto)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getListaCanaliDiVendita()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "select id_canale_vendita as id, id_canale_vendita as codice, descrizione from IUF_d_canale_vendita " + 
        "where data_fine_validita is null order by ordinamento";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
     
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          null, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getListaMultiAttivi(long idAzienda)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "select dmc.ID_MULTIFUNZIONALITA as id, dmc.ID_MULTIFUNZIONALITA as codice, dmc.DESCRIZIONE from IUF_D_MULTIFUNZIONALITA dmc\r\n"
        +
        "left join IUF_R_AZIENDA_BIO_MULTIFUNZ abmc on abmc.ID_MULTIFUNZIONALITA = dmc.ID_MULTIFUNZIONALITA\r\n"
        +
        "left join IUF_t_azienda_bio ab on ab.id_azienda_bio = abmc.id_azienda_bio\r\n"
        +
        "where ab.id_azienda_bio = :ID_AZIENDA";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA", idAzienda,
          Types.NUMERIC);
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA", idAzienda)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getListaFilieraAttiva(long idAzienda)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "select dmc.ID_FILIERA_PRODUTTIVA as id, dmc.ID_FILIERA_PRODUTTIVA as codice, dmc.DESCRIZIONE from IUF_D_FILIERA_PRODUTTIVA dmc \r\n"
        +
        "left join IUF_R_AZIENDA_BIO_FILIERA_PR abmc on abmc.ID_FILIERA_PRODUTTIVA = dmc.ID_FILIERA_PRODUTTIVA \r\n"
        +
        "left join IUF_t_azienda_bio ab on ab.id_azienda_bio = abmc.id_azienda_bio \r\n"
        +
        "where ab.id_azienda_bio = :ID_AZIENDA";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AZIENDA", idAzienda,
          Types.NUMERIC);
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_AZIENDA", idAzienda)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaMetodiColtivazione()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_metodo_coltivazione as id, id_metodo_coltivazione as codice, descrizione \r\n"
        +
        "FROM IUF_D_METODO_COLTIVAZIONE \r\n" +
        "WHERE data_fine IS NULL";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaProdotti()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_prodotto as id, id_prodotto as codice, descrizione \r\n"
        +
        "        FROM IUF_D_PRODOTTO  \r\n" +
        "        WHERE DATA_FINE_VALIDITA IS NULL ORDER BY ORDINAMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaTipiProduzionePerCertificate()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_tipo_produzione as id, id_tipo_produzione as codice, descrizione FROM IUF_D_TIPO_PRODUZIONE\r\n"
        +
        " WHERE DATA_FINE_VALIDITA IS NULL and id_tipo_produzione in (select id_tipo_produzione from  IUF_d_produzione_certificata) ORDER BY ORDINAMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaTipiProduzionePerTradizionali()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_tipo_produzione as id, id_tipo_produzione as codice, descrizione FROM IUF_D_TIPO_PRODUZIONE\r\n"
        +
        " WHERE DATA_FINE_VALIDITA IS NULL and id_tipo_produzione in (select id_tipo_produzione from  IUF_d_produzione_tradizional) ORDER BY ORDINAMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaTipiProduzioneCertificata(
      long idProduzione)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_produzione_certificata as id, id_regime_qualita as codice, descrizione \r\n"
        +
        "        FROM IUF_D_PRODUZIONE_CERTIFICATA   \r\n" +
        "        WHERE DATA_FINE_VALIDITA IS NULL AND ID_TIPO_PRODUZIONE = :ID_TIPO_PRODUZIONE ORDER BY ORDINAMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_TIPO_PRODUZIONE", idProduzione,
          Types.NUMERIC);
      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaTipiProduzioneTradizionale(
      long idProduzione)
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_produzione_tradizionale as id, id_produzione_tradizionale as codice, descrizione \r\n"
        +
        "        FROM IUF_D_PRODUZIONE_TRADIZIONAL   \r\n" +
        "        WHERE DATA_FINE_VALIDITA IS NULL AND ID_TIPO_PRODUZIONE = :ID_TIPO_PRODUZIONE ORDER BY ORDINAMENTO";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_TIPO_PRODUZIONE", idProduzione,
          Types.NUMERIC);
      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaFiliere()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT id_filiera_produttiva as id, id_filiera_produttiva as codice, descrizione \r\n"
        +
        "FROM IUF_D_FILIERA_PRODUTTIVA \r\n" +
        "WHERE data_fine IS NULL";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Integer>> getListaMultifunzionalita()
      throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "SELECT ID_MULTIFUNZIONALITA as id, ID_MULTIFUNZIONALITA as codice, descrizione \r\n"
        +
        "FROM IUF_D_MULTIFUNZIONALITA \r\n" +
        "WHERE data_fine IS NULL";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      return queryForDecodificaInteger(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_CATEGORIA_ANIMALE", null)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<String> getAmmCompetenzaListaLiquidazione(
      Long idListaLiquidazione) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getAmmCompetenzaListaLiquidazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT descrizione                \n"
        + "FROM SMRCOMUNE_V_AMM_COMPETENZA v,             \n"
        + "   IUF_T_LISTA_LIQUIDAZIONE l                \n"
        + " WHERE   l.ID_LISTA_LIQUIDAZIONE = :ID_LISTA_LIQUIDAZIONE  \n"
        + "     and l.EXT_ID_AMM_COMPETENZA=v.ID_AMM_COMPETENZA   \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<String>>()
          {

            @Override
            public List<String> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<String> list = new ArrayList<String>();
              while (rs.next())
              {

                String s = null;
                s = rs.getString("DESCRIZIONE");
                list.add(s);

              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idListaLiquidazione", idListaLiquidazione) },
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RipartizioneImportoDTO> getRipartizioneImporto(
      long idListaLiquidazImpLiq) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getRipartizioneImporto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT 													\n"
        + "		V.DESCRIZIONE, 													\n"
        + "		IR.PERCENTUALE_RIPARTIZIONE, 									\n"
        + "		IR.IMPORTO_RIPARTITO											\n"
        + " FROM																\n"
        + "	 	IUF_R_IMPORTI_RIPARTITI IR,										\n"
        + "  	IUF_D_VOCE_RIPARTIZIONE V,										\n"
        + "  	IUF_R_LISTA_LIQUIDAZ_IMP_LIQ LIQ								\n"
        + "	WHERE  																\n"
        + "		IR.ID_LISTA_LIQUIDAZ_IMP_LIQ = :ID_LISTA_LIQUIDAZ_IMP_LIQ		\n"
        + " 	AND IR.ID_VOCE_RIPARTIZIONE= V.ID_VOCE_RIPARTIZIONE				\n"
        + " 	AND LIQ.ID_LISTA_LIQUIDAZ_IMP_LIQ = :ID_LISTA_LIQUIDAZ_IMP_LIQ	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_LISTA_LIQUIDAZ_IMP_LIQ",
          idListaLiquidazImpLiq, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<RipartizioneImportoDTO>>()
          {

            @Override
            public List<RipartizioneImportoDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<RipartizioneImportoDTO> list = new ArrayList<RipartizioneImportoDTO>();
              while (rs.next())
              {

                RipartizioneImportoDTO r = new RipartizioneImportoDTO();
                r.setVoceRipartizione(rs.getString("DESCRIZIONE"));
                r.setPercentualeRipartizione(
                    rs.getBigDecimal("PERCENTUALE_RIPARTIZIONE"));
                r.setImportoRipartito(rs.getBigDecimal("IMPORTO_RIPARTITO"));
                list.add(r);

              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { null},
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public List<ImmaginiCanaliDiVendita> getListaImmagini(
      ) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getListaImmagini]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "select id_img_agriq as id, descrizione, immagine from IUF_d_img_agriq";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
     
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<ImmaginiCanaliDiVendita>>()
          {

            @Override
            public List<ImmaginiCanaliDiVendita> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<ImmaginiCanaliDiVendita> list = new ArrayList<ImmaginiCanaliDiVendita>();
              while (rs.next())
              {

                ImmaginiCanaliDiVendita r = new ImmaginiCanaliDiVendita();
                r.setDescrizione(rs.getString("DESCRIZIONE"));
                r.setId(rs.getLong("id"));
                r.setImmagine(rs.getBytes("IMMAGINE"));
                list.add(r);

              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { null },
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ImportoLiquidatoDTO getElencoImportiLiquidazioneByIdImportoLiquidato(
      long idImportoLiquidato) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoImportiLiquidazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  select il.* ,ll.*, lil.*, liv.CODICE, liv.DESCRIZIONE, v.nome || ' ' || v.cognome  as DECODIFICA_TECNICO      \n"
        + "   FROM                                                            		\n"
        + "     IUF_t_importi_liquidati il,  									    \n"
        + " 	IUF_R_LISTA_LIQUIDAZ_IMP_LIQ lil,  									\n"
        + " 	IUF_T_LISTA_LIQUIDAZIONE ll, 										\n"
        + " 	IUF_D_LIVELLO liv,													\n"
        + " 	DB_TECNICO v   														\n"
        + "   WHERE                                                             	\n"
        + "         il.ID_IMPORTI_LIQUIDATI = :ID_IMPORTI_LIQUIDATI		  		    \n"
        + "         AND liv.ID_LIVELLO = il.ID_LIVELLO          			        \n"
        + "         and ll.ID_LISTA_LIQUIDAZIONE = lil.ID_LISTA_LIQUIDAZIONE		\n"
        + "        	and  lil.ID_IMPORTI_LIQUIDATI = il.ID_IMPORTI_LIQUIDATI         \n"
        + " 		and v.ID_TECNICO (+) = ll.EXT_ID_TECNICO_LIQUIDATORE			\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_IMPORTI_LIQUIDATI", idImportoLiquidato,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<ImportoLiquidatoDTO>()
          {

            @Override
            public ImportoLiquidatoDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ImportoLiquidatoDTO importoLiquidatoDTO = null;
              while (rs.next())
              {

                importoLiquidatoDTO = new ImportoLiquidatoDTO();

                // servono solo i dati del pagamento
                importoLiquidatoDTO
                    .setCodiceFondo(rs.getString("CODICE_FONDO"));
                importoLiquidatoDTO
                    .setNumeroMandato(rs.getLong("NUMERO_MANDATO"));
                importoLiquidatoDTO
                    .setAnnoEsercizio(rs.getLong("ANNO_ESERCIZIO"));
                importoLiquidatoDTO
                    .setCodicePagamento(rs.getString("CODICE_PAGAMENTO"));
                importoLiquidatoDTO
                    .setNumeroPagamento(rs.getLong("NUMERO_PAGAMENTO"));
                importoLiquidatoDTO
                    .setNumeroDecreto(rs.getLong("NUMERO_DECRETO"));
                importoLiquidatoDTO
                    .setNumeroProgressivo(rs.getLong("NUMERO_PROGRESSIVO"));
                importoLiquidatoDTO.setDataCreazioneDecreto(
                    rs.getDate("DATA_CREAZIONE_DECRETO"));
                importoLiquidatoDTO.setDataCreazioneMandato(
                    rs.getDate("DATA_CREAZIONE_MANDATO"));
                importoLiquidatoDTO.setDataEffettuazionePagamento(
                    rs.getDate("DATA_EFFETUAZIONE"));
                importoLiquidatoDTO
                    .setImportoRecupero(rs.getBigDecimal("IMPORTO_REC"));
                importoLiquidatoDTO
                    .setImportoPagato(rs.getBigDecimal("IMPORTO"));
                return importoLiquidatoDTO;

              }
              return importoLiquidatoDTO;

            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idImportoLiquidato", idImportoLiquidato) },
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RiduzioniSanzioniDTO> getElencoRiduzioniSanzioni(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoRiduzioniSanzioni]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT													\n"
        + " POS.ID_PROC_OGGETTO_SANZIONE as ID_PROC_OGG_SANZIONE,				\n"
        + "	TS.DESCRIZIONE AS TIPOLOGIA, 										\n"
        + "	L.CODICE AS OPERAZIONE, 											\n"
        + "	SI.DESCRIZIONE AS DESCRIZIONE, 										\n"
        + "	POS.NOTE AS NOTE, 													\n"
        + "	POS.IMPORTO AS IMPORTO_CURRENT,										\n"

        + "	(  SELECT 															\n"
        + "			SUM (IMPORTO) 												\n"
        + "		FROM 															\n"
        + "			IUF_T_PROC_OGGETTO_SANZIONE POS2 ,							\n"
        + "			 IUF_D_SANZIONE_INVESTIMENTO SI2						    \n"
        + "		WHERE 															\n"
        + "			POS2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO		\n"
        + "			AND POS2.ID_SANZIONE_INVESTIMENTO = SI2.ID_SANZIONE_INVESTIMENTO \n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = TS.ID_TIPOLOGIA_SANZIONE 	\n"

        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = 3							\n"
        + "			AND pos2.id_livello= pos.id_livello							\n"

        + "			) AS IMPORTO_TOT,											\n"
        + "	(  SELECT 															\n"
        + "			COUNT (*) 													\n"
        + "		FROM 															\n"
        + "			IUF_T_PROC_OGGETTO_SANZIONE POS2, 							\n"
        + "			 IUF_D_SANZIONE_INVESTIMENTO SI2							\n"
        + "		WHERE 															\n"
        + "			POS2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	\n"
        + "			AND POS2.ID_SANZIONE_INVESTIMENTO = SI2.ID_SANZIONE_INVESTIMENTO \n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = 3							\n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = TS.ID_TIPOLOGIA_SANZIONE 	\n"
        + "			AND pos2.id_livello= pos.id_livello							\n"

        + "			) AS SPLITTED,												\n"
        + "	SI.ID_SANZIONE_INVESTIMENTO AS ID_DESCRIZIONE,						\n"
        + "	TS.ID_TIPOLOGIA_SANZIONE AS ID_TIPOLOGIA,							\n"
        + "	L.ID_LIVELLO AS ID_OPERAZIONE,										\n"
        + "   (                                                                   \n"
        + "     SELECT                                                            \n"
        + "       NVL("
        + "           SUM("
        + "               (ASP.IMPORTO_NON_RICONOSCIUTO * "
        + "               DI.PERCENTUALE_CONTRIBUTO)/100"
        + "               )"
        + "           ,0"
        + "           ) \n"
        + "     FROM                                                              \n"
        + "       IUF_T_INTERVENTO I,                                             \n"
        + "       IUF_T_ACCERTAMENTO_SPESE ASP,                                   \n"
        + "       IUF_T_DETTAGLIO_INTERVENTO DI,                                  \n"
        + "       IUF_T_PROCEDIMENTO_OGGETTO PO,                                  \n"
        + "       IUF_T_PROCEDIMENTO P,                                           \n"
        + "       IUF_R_LIV_BANDO_INTERVENTO LBI                                  \n"
        + "     WHERE                                                             \n"
        + "       PO.ID_PROCEDIMENTO              = I.ID_PROCEDIMENTO             \n"
        + "       AND PO.ID_PROCEDIMENTO_OGGETTO  = :ID_PROCEDIMENTO_OGGETTO      \n"

        + "       AND I.ID_INTERVENTO = ASP.ID_INTERVENTO                         \n"
        + "       AND PO.ID_PROCEDIMENTO_OGGETTO = ASP.ID_PROCEDIMENTO_OGGETTO    \n"

        + "       AND I.ID_INTERVENTO             = DI.ID_INTERVENTO              \n"
        + "       AND I.ID_DESCRIZIONE_INTERVENTO = LBI.ID_DESCRIZIONE_INTERVENTO \n"
        + "       AND P.ID_PROCEDIMENTO           = PO.ID_PROCEDIMENTO            \n"
        + "       AND LBI.ID_BANDO                = P.ID_BANDO                    \n"
        + "       AND DI.FLAG_TIPO_OPERAZIONE    <> 'D'                           \n"
        + "       AND NVL(PO.DATA_FINE,SYSDATE)                                   \n"
        + "             BETWEEN DI.DATA_INIZIO AND NVL(DI.DATA_FINE,SYSDATE)      \n"
        + "       AND LBI.ID_LIVELLO              = POS.ID_LIVELLO                \n"
        + "   ) AS IMPORTO_CALCOLATO                                              \n"
        + "FROM     															\n"
        + "	 IUF_T_PROC_OGGETTO_SANZIONE POS, 									\n"
        + "	 IUF_D_SANZIONE_INVESTIMENTO SI,									\n"
        + "  IUF_D_LIVELLO L, 													\n"
        + "  IUF_D_TIPOLOGIA_SANZIONE TS    									\n"
        + "WHERE         														\n"
        + "  POS.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 			\n"
        + "  AND L.ID_LIVELLO=POS.ID_LIVELLO									\n"
        + "  AND POS.ID_SANZIONE_INVESTIMENTO = SI.ID_SANZIONE_INVESTIMENTO 	\n"
        + "  AND TS.ID_TIPOLOGIA_SANZIONE = SI.ID_TIPOLOGIA_SANZIONE          	\n"
        + " ORDER BY L.CODICE, TS.ID_TIPOLOGIA_SANZIONE							\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<RiduzioniSanzioniDTO>>()
          {

            @Override
            public List<RiduzioniSanzioniDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<RiduzioniSanzioniDTO> list = new ArrayList<RiduzioniSanzioniDTO>();
              RiduzioniSanzioniDTO riduzione = null;
              long idTipologia = 0l;
              long idTipologiaOld = -1l;
              long idOperazione = 0l;
              long idOperazioneOld = -1l;
              while (rs.next())
              {
                idTipologia = rs.getLong("ID_TIPOLOGIA");
                idOperazione = rs.getLong("ID_OPERAZIONE");

                if (idOperazione != idOperazioneOld
                    || idTipologiaOld != idTipologia)
                {
                  riduzione = new RiduzioniSanzioniDTO();

                  riduzione = new RiduzioniSanzioniDTO();
                  riduzione
                      .setIdProcOggSanzione(rs.getLong("ID_PROC_OGG_SANZIONE"));
                  riduzione.setDescrizione(rs.getString("DESCRIZIONE"));
                  riduzione.setImporto(rs.getBigDecimal("IMPORTO_TOT"));
                  riduzione.setImportoFirstRecord(
                      rs.getBigDecimal("IMPORTO_CURRENT"));
                  riduzione.setNote(rs.getString("NOTE"));
                  riduzione.setTipologia(rs.getString("TIPOLOGIA"));
                  riduzione.setOperazione(rs.getString("OPERAZIONE"));
                  riduzione.setIdDescrizione(rs.getLong("ID_DESCRIZIONE"));
                  riduzione.setIdTipologia(rs.getLong("ID_TIPOLOGIA"));
                  riduzione.setIdOperazione(rs.getLong("ID_OPERAZIONE"));
                  BigDecimal importoCalcolato = rs
                      .getBigDecimal("IMPORTO_CALCOLATO");
                  if (importoCalcolato == null)
                  {
                    importoCalcolato = BigDecimal.ZERO;
                  }
                  else
                  {
                    importoCalcolato = importoCalcolato.setScale(2,
                        RoundingMode.HALF_UP);
                  }
                  riduzione.setImportoCalcolato(importoCalcolato);
                  int splitted = rs.getInt("SPLITTED");
                  if (splitted <= 1)
                    riduzione.setSplitted(false);
                  else
                    riduzione.setSplitted(true);

                  list.add(riduzione);
                  idTipologiaOld = idTipologia;
                  idOperazioneOld = idOperazione;
                }
                else
                  if (idOperazione == idOperazioneOld && idTipologia == 3)
                  {
                    riduzione.setImportoSecondRecordAfterSplit(
                        rs.getBigDecimal("IMPORTO_CURRENT"));
                    riduzione.setDescrizioneSecondRecordAfterSplit(
                        rs.getString("DESCRIZIONE"));
                    riduzione.setNoteB(rs.getString("NOTE"));
                    riduzione.setIdProcOggSanzioneSecondRecordAfterSplit(
                        rs.getLong("ID_PROC_OGG_SANZIONE"));
                    riduzione.setIdDescrizioneSecondRecordAfterSplit(
                        rs.getLong("ID_DESCRIZIONE"));
                  }
                  else
                    list.add(riduzione);

              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<String>> getTipologieSanzioni(
      long idProcedimentoOggetto, boolean soloAutomatiche)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getTipologieSanzioni]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "SELECT TS.DESCRIZIONE || ' - ' || SI.DESCRIZIONE as DESCR_COMPLETA, 	\n"
        + " TS.ID_TIPOLOGIA_SANZIONE  ||'-'|| 	SI.ID_SANZIONE_INVESTIMENTO  as ID_COMPLETO	\n"
        + "FROM     																		\n"
        + "  IUF_D_TIPOLOGIA_SANZIONE TS, IUF_D_SANZIONE_INVESTIMENTO SI					\n"
        + "WHERE SI.ID_TIPOLOGIA_SANZIONE = TS.ID_TIPOLOGIA_SANZIONE						\n"
        + "	AND NVL(SI.DATA_FINE,sysdate) >= sysdate										\n";

    if (!soloAutomatiche)
      QUERY += "	AND TS.ID_TIPOLOGIA_SANZIONE <> 3									\n";
    else
      QUERY += "	AND TS.ID_TIPOLOGIA_SANZIONE = 3									\n";

    QUERY += " ORDER BY TS.DESCRIZIONE, SI.DESCRIZIONE								    ";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      // mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
      // idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<DecodificaDTO<String>>>()
          {

            @Override
            public List<DecodificaDTO<String>> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<DecodificaDTO<String>> list = new ArrayList<DecodificaDTO<String>>();
              DecodificaDTO<String> riduzione = null;
              while (rs.next())
              {
                riduzione = new DecodificaDTO<String>();
                riduzione.setId(rs.getString("ID_COMPLETO"));
                riduzione.setDescrizione(rs.getString("DESCR_COMPLETA"));
                riduzione.setCodice(rs.getString("DESCR_COMPLETA"));
                list.add(riduzione);
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getSanzioniInvestimento(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getSanzioniInvestimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT													\n"
        + " SI.ID_SANZIONE_INVESTIMENTO AS ID_SANZIONE_INVESTIMENTO,			\n"
        + "	SI.DESCRIZIONE AS DESCRIZIONE										\n"
        + "FROM     															\n"
        + "	 IUF_D_SANZIONE_INVESTIMENTO SI	 									\n"
        + "WHERE         														\n"
        + "  NVL(DATA_FINE,sysdate) >= sysdate        							\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      // mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
      // idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<DecodificaDTO<Long>>>()
          {

            @Override
            public List<DecodificaDTO<Long>> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<DecodificaDTO<Long>> list = new ArrayList<DecodificaDTO<Long>>();
              DecodificaDTO<Long> riduzione = null;
              while (rs.next())
              {
                riduzione = new DecodificaDTO<Long>();
                riduzione.setId(rs.getLong("ID_SANZIONE_INVESTIMENTO"));
                riduzione.setDescrizione(rs.getString("DESCRIZIONE"));
                riduzione.setCodice(rs.getString("DESCRIZIONE"));
                list.add(riduzione);
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciSanzioneRiduzione(Long idTipologia, Long idOperazione,
      Long idDescrizione, String note, BigDecimal importo,
      Long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::insertAmmCompetenzaByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                     		\n"
        + " INTO                                        \n"
        + "   IUF_T_PROC_OGGETTO_SANZIONE               \n"
        + "   (                                         \n"
        + "     ID_PROC_OGGETTO_SANZIONE,               \n"
        + "     ID_SANZIONE_INVESTIMENTO,               \n"
        + "     NOTE,               				    \n"
        + "     IMPORTO,                     	        \n"
        + "     ID_LIVELLO,								\n"
        + "		ID_PROCEDIMENTO_OGGETTO	                \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_PROC_OGGETTO_SANZI.NEXTVAL, \n"
        + "     :ID_SANZIONE_INVESTIMENTO,              \n"
        + "     :NOTE,              				    \n"
        + "     :IMPORTO,                               \n"
        + "     :ID_LIVELLO,      					    \n"
        + "     :ID_PROCEDIMENTO_OGGETTO	            \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_TIPOLOGIA_SANZIONE", idTipologia,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_LIVELLO", idOperazione, Types.NUMERIC);
      mapParameterSource.addValue("ID_SANZIONE_INVESTIMENTO", idDescrizione,
          Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      mapParameterSource.addValue("IMPORTO", importo, Types.NUMERIC);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimentoOggetto),
              new LogParameter("importo", importo),
              new LogParameter("idTipologia", idTipologia),
              new LogParameter("idTipologia", idDescrizione),
              new LogParameter("note", note),
              new LogParameter("idOperazione", idOperazione)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void eliminaRiduzioneSanzione(long idProcOggSanzione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::eliminaAnalisiDocumentale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE FROM IUF_T_PROC_OGGETTO_SANZIONE	                                    \n"
        + " WHERE ID_PROC_OGGETTO_SANZIONE = :ID_PROCEDIMENTO_OGGETTO_SANZ		    \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO_SANZ",
          idProcOggSanzione, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcOggSanzione", idProcOggSanzione)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int updateControlliInLocoInvest(
      ControlliInLocoInvestDTO controlliInLocoInvestDTO)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateControlliInLocoInvest]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        \n"
        + "   IUF_T_CONTROLLO_IN_LOCO_INVE                              \n"
        + " SET                                                           \n"
        + "   DATA_PREAVVISO              = :DATA_PREAVVISO,              \n"
        + "   DESCRIZIONE_ALTRO_PREAVVISO = :DESCRIZIONE_ALTRO_PREAVVISO, \n"
        + "   FLAG_CONTROLLO              = :FLAG_CONTROLLO,              \n"
        + "   FLAG_PREAVVISO              = :FLAG_PREAVVISO,              \n"
        + "   ID_TIPOLOGIA_PREAVVISO      = :ID_TIPOLOGIA_PREAVVISO       \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO          \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("DATA_PREAVVISO",
          controlliInLocoInvestDTO.getDataPreavviso(), Types.DATE);
      mapParameterSource.addValue("DESCRIZIONE_ALTRO_PREAVVISO",
          controlliInLocoInvestDTO.getDescTipologiaPreavviso(), Types.VARCHAR);
      mapParameterSource.addValue("FLAG_CONTROLLO",
          controlliInLocoInvestDTO.getFlagControllo(), Types.VARCHAR);
      mapParameterSource.addValue("FLAG_PREAVVISO",
          controlliInLocoInvestDTO.getFlagPreavviso(), Types.VARCHAR);
      mapParameterSource.addValue("ID_TIPOLOGIA_PREAVVISO",
          controlliInLocoInvestDTO.getIdTipologiaPreavviso(), Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          controlliInLocoInvestDTO.getIdProcedimentoOggetto(), Types.NUMERIC);

      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("controlliInLocoInvestDTO",
                  controlliInLocoInvestDTO),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertControlliInLocoInvest(
      ControlliInLocoInvestDTO controlliInLocoInvestDTO)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertControlliInLocoInvest]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                          \n"
        + " INTO                                            \n"
        + "   IUF_T_CONTROLLO_IN_LOCO_INVE                \n"
        + "   (                                             \n"
        + "     ID_CONTROLLO_IN_LOCO_INVEST,                \n"
        + "     DATA_PREAVVISO,                             \n"
        + "     DESCRIZIONE_ALTRO_PREAVVISO,                \n"
        + "     FLAG_CONTROLLO,                             \n"
        + "     FLAG_PREAVVISO,                             \n"
        + "     ID_PROCEDIMENTO_OGGETTO,                    \n"
        + "     ID_TIPOLOGIA_PREAVVISO                      \n"
        + "   )                                             \n"
        + "   VALUES                                        \n"
        + "   (                                             \n"
        + "     SEQ_IUF_T_CONTROL_IN_LOCO_IN.NEXTVAL,     \n"
        + "     :DATA_PREAVVISO,                            \n"
        + "     :DESCRIZIONE_ALTRO_PREAVVISO,               \n"
        + "     :FLAG_CONTROLLO,                            \n"
        + "     :FLAG_PREAVVISO,                            \n"
        + "     :ID_PROCEDIMENTO_OGGETTO,                   \n"
        + "     :ID_TIPOLOGIA_PREAVVISO                     \n"
        + "   )                                             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("DATA_PREAVVISO",
          controlliInLocoInvestDTO.getDataPreavviso(), Types.DATE);
      mapParameterSource.addValue("DESCRIZIONE_ALTRO_PREAVVISO",
          controlliInLocoInvestDTO.getDescTipologiaPreavviso(), Types.VARCHAR);
      mapParameterSource.addValue("FLAG_CONTROLLO",
          controlliInLocoInvestDTO.getFlagControllo(), Types.VARCHAR);
      mapParameterSource.addValue("FLAG_PREAVVISO",
          controlliInLocoInvestDTO.getFlagPreavviso(), Types.VARCHAR);
      mapParameterSource.addValue("ID_TIPOLOGIA_PREAVVISO",
          controlliInLocoInvestDTO.getIdTipologiaPreavviso(), Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          controlliInLocoInvestDTO.getIdProcedimentoOggetto(), Types.NUMERIC);

      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("controlliInLocoInvestDTO",
                  controlliInLocoInvestDTO),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public EstrazioneCampioneDTO callEseguiSimulazioneEstrazCampione(
      long idTipoEstrazione) throws InternalUnexpectedException
  {
    String THIS_METHOD = "callEseguiSimulazioneEstrazCampione";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_ESTRAZ_CAMPIONE_DP.EseguiSimulazione");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PARIDTIPOESTRAZIONE", idTipoEstrazione,
          Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("IUFFI.PCK_IUF_ESTRAZ_CAMPIONE_DP")
              .withFunctionName("EseguiSimulazione")
              .withoutProcedureColumnMetaDataAccess();
      call.addDeclaredParameter(
          new SqlOutParameter("RESULT", java.sql.Types.ARRAY,
              "IUFFI.LIST_ID_PROC_OGG", new ListIdProcOggHandler()));
      call.addDeclaredParameter(
          new SqlParameter("PARIDTIPOESTRAZIONE", java.sql.Types.NUMERIC));
      Map<String, Object> results = call.execute(parameterSource);

      EstrazioneCampioneDTO dto = new EstrazioneCampioneDTO();
      dto.setIdProcedimentoOggetto((Long[]) results.get("RESULT"));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public class ListIdProcOggHandler implements SqlReturnType
  {
    // struct data from jdbc
    public Object getTypeValue(CallableStatement cs, int paramIndex,
        int sqlType, String typeName)
        throws SQLException
    {
      Array arrayObj = cs.getArray(1);
      if (arrayObj == null)
      {
        return null;
      }
      Object array = arrayObj.getArray();
      List<Long> ids = new ArrayList<Long>();
      if (array != null)
      {
        for (BigDecimal elemento : (BigDecimal[]) array)
        {
          ids.add(elemento.longValue());
        }
      }
      if (ids.size() > 0)
      {
        return ids.toArray(new Long[ids.size()]);
      }
      else
      {
        return null;
      }
    }
  }

  public List<EstrazioneACampioneDTO> getElencoEstrazioniACampione(
      boolean isUtenteGal) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoEstrazioniACampione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT 													\n"
        + "		EC.ID_ESTRAZIONE_CAMPIONE,									\n"
        + "		EC.DATA_ESTRAZIONE,											\n"
        + "		EC.DATA_ANNULLAMENTO,										\n"
        + "		EC.DESCRIZIONE,												\n"
        + "		NL.NUMERO_ESTRAZIONE,										\n"
        + "		TE.DESCRIZIONE as DESCRIZIONE_TIPOLOGIA,					\n"
        + "		TE.ID_TIPO_ESTRAZIONE as ID_TIPO_ESTRAZIONE					\n"
        + " FROM															\n"
        + "		IUF_T_ESTRAZIONE_CAMPIONE EC,								\n"
        + "		IUF_D_NUMERO_LOTTO NL,										\n"
        + "		IUF_D_TIPO_ESTRAZIONE TE									\n"
        + " WHERE 															\n"
        + "		 EC.ID_TIPO_ESTRAZIONE = TE.ID_TIPO_ESTRAZIONE				\n"
        + "		 AND EC.FLAG_APPROVATA = 'S'								\n"
        + "		 AND NL.ID_NUMERO_LOTTO (+)= EC.ID_NUMERO_LOTTO				\n";
    if (isUtenteGal)
      QUERY += " AND EC.ID_TIPO_ESTRAZIONE <> 2							\n";
    QUERY += "	ORDER BY  EC.ID_ESTRAZIONE_CAMPIONE                		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForList(QUERY, mapParameterSource,
          EstrazioneACampioneDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkEstrazione(Long idEstrazioneCampione, String flag)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoRendicontazioneSpese]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "WITH A AS (SELECT 	count(*) C									\n"
        + " FROM																\n"
        + "		IUF_T_ESTRAZIONE_CAMPIONE EC,									\n"
        + "		IUF_T_PROCEDIMENTO_ESTRATTO PE									\n"
        + " WHERE 																\n"
        + "		 EC.ID_ESTRAZIONE_CAMPIONE = PE.ID_ESTRAZIONE_CAMPIONE			\n"
        + "		 AND PE.FLAG_ESTRATTA <> 'N'           			    			\n";
    if (flag == "D")
    {
      QUERY += "		 AND PE.FLAG_ESTRATTA <> 'D'               		\n";
    }
    QUERY += " 	 AND EC.ID_ESTRAZIONE_CAMPIONE = :ID_ESTRAZIONE),		\n";

    QUERY += " B AS (SELECT 	count(*) C									\n"
        + " FROM															\n"
        + "		IUF_T_ESTRAZIONE_CAMPIONE EC,								\n"
        + "		IUF_T_PROCEDIMENTO_ESTRATTO PE								\n"
        + " WHERE 															\n"
        + "		 EC.ID_ESTRAZIONE_CAMPIONE = PE.ID_ESTRAZIONE_CAMPIONE		\n"
        + "		 AND PE.FLAG_ESTRATTA <> 'N'           			    		\n";
    if (flag == "D")
    {
      QUERY += "		 AND PE.FLAG_ESTRATTA <> 'D'               	\n";
    }
    QUERY += " 	 AND EC.ID_ESTRAZIONE_CAMPIONE = :ID_ESTRAZIONE)	\n";

    QUERY += " 	SELECT GREATEST (A.C, B.C) FROM A,B						\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_ESTRAZIONE", idEstrazioneCampione,
        Types.NUMERIC);

    try
    {
      return queryForLong(QUERY, mapParameterSource) != 0;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<NumeroLottoDTO> getElencoNumeroLotti()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoNumeroLotti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                              \n"
        + "   A.ID_NUMERO_LOTTO,                                \n"
        + "   A.DATA_ELABORAZIONE,                              \n"
        + "   A.DESCRIZIONE,                                    \n"
        + "   A.ID_TIPO_ESTRAZIONE,                             \n"
        + "   B.DESCRIZIONE AS DESCR_TIPO_ESTRAZIONE,           \n"
        + "   A.ID_STATO_ESTRAZIONE,                            \n"
        + "   C.DESCRIZIONE AS DESCR_STATO_ESTRAZIONE,          \n"
        + "   A.IMPORTO_RICHIESTO_COMPLESSIVO,                  \n"
        + "   A.NUMERO_ESTRAZIONE,			                  \n"
        + "   A.IMPORTO_RICHIESTO_ESTRAZIONE                    \n"
        + " FROM                                                \n"
        + "   IUF_D_NUMERO_LOTTO A,                             \n"
        + "   IUF_D_TIPO_ESTRAZIONE B,                          \n"
        + "   IUF_D_STATO_ESTRAZIONE C                          \n"
        + " WHERE                                               \n"
        + "   A.ID_TIPO_ESTRAZIONE = B.ID_TIPO_ESTRAZIONE       \n"
        + "   AND A.ID_STATO_ESTRAZIONE = C.ID_STATO_ESTRAZIONE \n"
        + "   AND A.ID_TIPO_ESTRAZIONE IS NOT NULL              \n"
        + "   AND B.CODICE IS NOT NULL     					  \n"
        + " ORDER BY A.DATA_ELABORAZIONE DESC                   \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForList(QUERY, mapParameterSource, NumeroLottoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RigaFiltroDTO> getFiltroElencoTipoEstrazioniCampione()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getFiltroElencoTipoEstrazioniCampione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                            \n"
        + "   A.ID_TIPO_ESTRAZIONE AS ID,                     \n"
        + "   A.DESCRIZIONE AS LABEL                          \n"
        + " FROM                                              \n"
        + "   IUF_D_TIPO_ESTRAZIONE A                         \n"
        + " WHERE                                             \n"
        + "   EXISTS (                                        \n"
        + "      SELECT                                       \n"
        + "        B.ID_NUMERO_LOTTO                          \n"
        + "      FROM                                         \n"
        + "       IUF_D_NUMERO_LOTTO B,                       \n"
        + "	    IUF_D_TIPO_ESTRAZIONE C                     \n"
        + "      WHERE                                        \n"
        + "       B.ID_TIPO_ESTRAZIONE = A.ID_TIPO_ESTRAZIONE \n"
        + "	    AND C.ID_TIPO_ESTRAZIONE = B.ID_TIPO_ESTRAZIONE \n"
        + "	    AND C.CODICE IS NOT NULL 					\n"
        + "   )                                               \n"
        + " ORDER BY A.DESCRIZIONE ASC                        \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForList(QUERY, mapParameterSource, RigaFiltroDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RigaFiltroDTO> getFiltroElencoStatoEstrazioniCampione()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getFiltroElencoStatoEstrazioniCampione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                              \n"
        + "   A.ID_STATO_ESTRAZIONE AS ID,                      \n"
        + "   A.DESCRIZIONE AS LABEL                            \n"
        + " FROM                                                \n"
        + "   IUF_D_STATO_ESTRAZIONE A                          \n"
        + " WHERE                                               \n"
        + "   EXISTS (                                          \n"
        + "    SELECT                                           \n"
        + "     B.ID_NUMERO_LOTTO                            	  \n"
        + "    FROM                                             \n"
        + "     IUF_D_NUMERO_LOTTO B, 						  \n"
        + "	  IUF_D_TIPO_ESTRAZIONE C                         \n"
        + "    WHERE                                            \n"
        + "     B.ID_STATO_ESTRAZIONE = A.ID_STATO_ESTRAZIONE   \n"
        + "	  AND C.ID_TIPO_ESTRAZIONE = B.ID_TIPO_ESTRAZIONE \n"
        + "	  AND C.CODICE IS NOT NULL 						  \n"
        + "   )                                                 \n"
        + " ORDER BY A.DESCRIZIONE ASC                          \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForList(QUERY, mapParameterSource, RigaFiltroDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public BigDecimal calcolaImportoMaxRiduzioneSanzione(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::calcolaImportoMaxRiduzioneSanzione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT                                          \n"
        + "         SUM(CONTRIBUTO_CALCOLATO) as IMPORTO_MAX                \n"
        + "       FROM                                                      \n"
        + "         IUF_T_ACCERTAMENTO_SPESE                                \n"
        + "       WHERE                                                     \n"
        + "         ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<BigDecimal>()
          {
            @Override
            public BigDecimal extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              BigDecimal ret = null;
              if (rs.next())
              {
                ret = rs.getBigDecimal("IMPORTO_MAX");
              }
              return ret;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RigaSimulazioneEstrazioneDTO> getElencoRisultatiSimulazione(
      Long[] idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getFiltroElencoStatoEstrazioniCampione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                             \n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO,                                      \n"
        + "   VAC.DESCRIZIONE AS DESCR_ENTE_DELEGATO,                          \n"
        + "   DL.CODICE AS COD_LIVELLO,                                        \n"
        + "   DL.ID_LIVELLO,                                        			 \n"
        + "   PO.IDENTIFICATIVO,                                               \n"
        + "   DO.DESCRIZIONE AS DESCR_TIPO_DOMANDA,                            \n"
        + "   DSO.DESCRIZIONE AS DESCR_STATO,                                  \n"
        + "   VDA.CUAA AS CUAA_AZIE,                                           \n"
        + "   VDA.DENOMINAZIONE AS DENOMIZIONE_AZIE                            \n"
        + " FROM                                                               \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                   \n"
        + "   IUF_T_PROCEDIMENTO P,                                            \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA,                               \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA VAC,                                  \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO PL,                                   \n"
        + "   IUF_D_LIVELLO DL,                                                \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                                 \n"
        + "   IUF_D_OGGETTO DO,                                                \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE IPO,                              \n"
        + "   IUF_D_STATO_OGGETTO DSO,                                         \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI VDA,                                    \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PAZ                                   \n"
        + " WHERE                                                              \n"
        + "   PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                           \n"
        + "   AND PA.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                       \n"
        + "   AND VAC.ID_AMM_COMPETENZA = PA.EXT_ID_AMM_COMPETENZA             \n"
        + "   AND PL.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO --ROTTURA DI CODICE!! \n"
        + "   AND LGO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO   \n"
        + "   AND IPO.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO     \n"
        + "   AND PAZ.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                      \n"
        + "   AND PAZ.DATA_FINE IS NULL                                        \n"
        + "   AND VDA.ID_AZIENDA = PAZ.EXT_ID_AZIENDA                          \n"
        + "   AND VDA.DATA_FINE_VALIDITA IS NULL		                         \n"
        + "   AND DSO.ID_STATO_OGGETTO = IPO.ID_STATO_OGGETTO                  \n"
        + "   AND IPO.DATA_FINE IS NULL                                        \n"
        + "   AND DO.ID_OGGETTO = LGO.ID_OGGETTO                               \n"
        + "   AND DL.ID_LIVELLO = PL.ID_LIVELLO                                \n"
        + "   AND PA.DATA_FINE IS NULL                                         \n"
        + " "
        + getInCondition("PO.ID_PROCEDIMENTO_OGGETTO",
            Arrays.asList(idProcedimentoOggetto))
        + " ORDER BY PO.IDENTIFICATIVO, PO.ID_PROCEDIMENTO_OGGETTO,DL.ORDINAMENTO    \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<RigaSimulazioneEstrazioneDTO>>()
          {

            @Override
            public List<RigaSimulazioneEstrazioneDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<RigaSimulazioneEstrazioneDTO> list = new ArrayList<RigaSimulazioneEstrazioneDTO>();
              Long lastKey = null;
              List<LivelloDTO> livelli = null;
              while (rs.next())
              {
                long idProcOggetto = rs.getLong("ID_PROCEDIMENTO_OGGETTO");
                if (lastKey == null || lastKey != idProcOggetto)
                {
                  lastKey = idProcOggetto;
                  RigaSimulazioneEstrazioneDTO riga = new RigaSimulazioneEstrazioneDTO();
                  riga.setCuaAzie(rs.getString("CUAA_AZIE"));
                  riga.setDenominazioneAzie(rs.getString("DENOMIZIONE_AZIE"));
                  riga.setDescrEnteDelegato(
                      rs.getString("DESCR_ENTE_DELEGATO"));
                  riga.setDescrStato(rs.getString("DESCR_STATO"));
                  riga.setDescrTipoDomanda(rs.getString("DESCR_TIPO_DOMANDA"));
                  riga.setIdentificativo(rs.getString("IDENTIFICATIVO"));
                  riga.setIdProcedimentoOggetto(
                      rs.getLong("ID_PROCEDIMENTO_OGGETTO"));

                  livelli = new ArrayList<>();
                  riga.setListLivelli(livelli);
                  list.add(riga);
                }
                LivelloDTO livello = new LivelloDTO();
                livello.setCodice(rs.getString("COD_LIVELLO"));
                livello.setIdLivello(rs.getLong("ID_LIVELLO"));
                livelli.add(livello);
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, null, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getValoreSegnaposto(SegnapostoDTO segnapostoDTO,
      long idProcedimento, long idProcedimentoOggetto)
      throws ApplicationException, InternalUnexpectedException
  {
    final String THIS_METHOD = "getValoreSegnaposto";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = segnapostoDTO.getIstruzioneSql();
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      String result[] = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource,
          new ResultSetExtractor<String[]>()
          {
            @Override
            public String[] extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              StringBuilder resultBuffer = new StringBuilder();
              String lastSeparator = null;
              int colCount = rs.getMetaData().getColumnCount();
              while (rs.next())
              {
                if (resultBuffer.length() > 0)
                {
                  if (lastSeparator == null)
                  {
                    // Separatore non forntito ==> C' qualche cosa che non va,
                    // sto ricevendo pi di un valore e non mi viene fornito un
                    // separatore per
                    // concatenare il tutto ==> E' probabile che la query sia
                    // stata pensata per tornare un solo valore ma che ci sia
                    // qualche errore =>
                    // segnalo
                    // il problema
                    return new String[]
                    { null,
                        "Si  verificato un errore nel reperimento dei segnaposto della stampa. Contattare l'assistenza tecnica comunicando la tipologia di stampa richiesta e il seguente errore: Trovati pi valori per il segnaposto a singolo valore con nome =\""
                            + segnapostoDTO.getNome() + "\"" };
                  }
                  resultBuffer.append(lastSeparator);
                }
                resultBuffer.append(rs.getString(1));
                if (colCount > 1)
                {
                  lastSeparator = IuffiUtils.STRING.nvl(rs.getString(2));
                }
              }
              return new String[]
              { resultBuffer.toString(), null };
            }
          });
      // In result ho in posizione 0 il valore, in posizione 1 l'eventuale
      // errore applicativo da cui generare un'eccezione
      if (result[1] == null)
      {
        // Non ci sono errori ==> restituisco il valore del placeholder
        return result[0];
      }
      else
      {
        // Errore applicativo ==> rilancio eccezione
        throw new ApplicationException(result[1]);
      }
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          // new LogParameter("idVariabile", idVariabile),
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public List<SegnapostoDTO> getSegnapostiStampe()
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getSegnapostiStampe";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT             \n"
        + "   ID_SEGNAPOSTO,   \n"
        + "   NOME,            \n"
        + "   DESCRIZIONE,     \n"
        + "   ISTRUZIONE_SQL   \n"
        + " FROM               \n"
        + "   IUF_D_SEGNAPOSTO \n"
        + " ORDER BY           \n"
        + "   DESCRIZIONE      \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<SegnapostoDTO>>()
          {
            @Override
            public List<SegnapostoDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              List<SegnapostoDTO> result = new ArrayList<SegnapostoDTO>();
              SegnapostoDTO segnapostoDTO = null;
              while (rs.next())
              {
                segnapostoDTO = new SegnapostoDTO();
                result.add(segnapostoDTO);
                segnapostoDTO.setIdSegnaposto(rs.getInt("ID_SEGNAPOSTO"));
                segnapostoDTO.setNome(rs.getString("NOME"));
                segnapostoDTO.setDescrizione(rs.getString("DESCRIZIONE"));
                segnapostoDTO.setIstruzioneSql(rs.getString("ISTRUZIONE_SQL"));
              }
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          // new LogParameter("idVariabile", idVariabile),
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public void updateParticellaGISSupIstruttoria(long idParticellaUtilizzo,
      long idLivello, BigDecimal supIstruttoria)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::updateParticellaGISSupIstruttoria]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                    \n"
        + "   IUF_T_PARTICELLA_GIS                              \n"
        + " SET                                                 \n"
        + "   SUPE_AMMI_ISTRUTTORIA   = :SUPE_AMMI_ISTRUTTORIA  \n"
        + " WHERE                                               \n"
        + "   ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO	\n"
        + "	  AND ID_LIVELLO = :ID_LIVELLO          			\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
      mapParameterSource.addValue("SUPE_AMMI_ISTRUTTORIA", supIstruttoria,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("supIstruttoria", supIstruttoria),
              new LogParameter("idLivello", idLivello),
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateRDettaglioImpegno(long idImpegno, long idImpegnoProcOgg,
      long idImpegnoNew) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateRDettaglioImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                          \n"
        + "   IUF_R_DETTAGLIO_IMPEGNO                                		\n"
        + " SET                                                             \n"
        + "   ID_IMPEGNO       = :ID_IMPEGNO_NUOVO            		    	\n"
        + " WHERE                                                           \n"
        + "   ID_IMPEGNO=     :ID_IMPEGNO                  					\n"
        + "	AND																\n"
        + "	   ID_IMPEGNO_PROC_OGG=:ID_IMPEGNO_PROC_OGG                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_IMPEGNO", idImpegno, Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO_PROC_OGG", idImpegnoProcOgg,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO_NUOVO", idImpegnoNew,
          Types.NUMERIC);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idImpegno", idImpegno),
              new LogParameter("idImpegnoNew", idImpegnoNew),
              new LogParameter("idImpegnoProcedimentoOggetto",
                  idImpegnoProcOgg),
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateTParticellaImpegno(long idImpegno,
      long idProcedimentoOggetto, long idImpegnoNew)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateTParticellaImpegno]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                          		\n"
        + "   IUF_T_PARTICELLA_IMPEGNO A                                			\n"
        + " SET                                                             		\n"
        + "   A.ID_IMPEGNO       = :ID_IMPEGNO_NEW            		    			\n"
        + " WHERE                                                           		\n"
        + "   A.ID_IMPEGNO =     :ID_IMPEGNO                  			    		\n"
        + "   AND A.ID_PARTICELLA_UTILIZZO IN  (   									\n"
        + "        SELECT  I.ID_PARTICELLA_UTILIZZO 								\n"
        + "		   FROM IUF_T_DATI_PROCEDIMENTO A1, 								\n"
        + "				IUF_T_PARTICELLA_UTILIZZO U, 								\n"
        + "				IUF_T_PARTICELLA_IMPEGNO I 									\n"
        + "		  WHERE 															\n"
        + "				A1.ID_DATI_PROCEDIMENTO = U.ID_DATI_PROCEDIMENTO 			\n"
        + "				AND U.ID_PARTICELLA_UTILIZZO = I.ID_PARTICELLA_UTILIZZO 	\n"
        + "				AND A1.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO	\n"
        + ")                  			    										\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_IMPEGNO", idImpegno, Types.NUMERIC);
      mapParameterSource.addValue("ID_IMPEGNO_NEW", idImpegnoNew,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idImpegno", idImpegno),
              new LogParameter("idImpegnoNew", idImpegnoNew),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public BigDecimal calcolaImportoParzialeRiduzioneSanzione(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::calcolaImportoParzialeRiduzioneSanzione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT                                          \n"
        + "         SUM(IMPORTO) as IMPORTO_PARZ               				\n"
        + "       FROM                                                      \n"
        + "         IUF_T_PROC_OGGETTO_SANZIONE                             \n"
        + "       WHERE                                                     \n"
        + "         ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<BigDecimal>()
          {
            @Override
            public BigDecimal extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              BigDecimal ret = null;

              while (rs.next())
              {
                ret = rs.getBigDecimal("IMPORTO_PARZ");
              }
              return ret;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void lockListaLiquidazione(long idListaLiquidazione)
  {
    final String QUERY = " SELECT 1 FROM IUF_D_BANDO WHERE ID_BANDO = (SELECT ID_BANDO FROM IUF_T_LISTA_LIQUIDAZIONE WHERE ID_LISTA_LIQUIDAZIONE=:ID_LISTA_LIQUIDAZIONE) FOR UPDATE ";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione,
        Types.NUMERIC);
    queryForLong(QUERY, mapParameterSource);
  }

  public void updateFileListaLiquidazione(long idListaLiquidazione,
      int stampaFallita, String string) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateFileListaLiquidazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                      		  \n"
        + "   IUF_T_FILE_LISTA_LIQUIDAZION                               \n"
        + " SET                                                           \n"
        + "   ID_STATO_STAMPA = :ID_STATO_STAMPA,                         \n"
        + "   DESC_ANOMALIA = :ANOMALIA,  			                      \n"
        + "   DATA_ULTIMO_AGGIORNAMENTO = SYSDATE	                      \n"
        + " WHERE                                                         \n"
        + "   ID_LISTA_LIQUIDAZIONE = :ID_LISTA_LIQUIDAZIONE          	  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ANOMALIA", string, Types.VARCHAR);
      mapParameterSource.addValue("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_STATO_STAMPA", stampaFallita,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione),
              new LogParameter("ANOMALIA", string),
              new LogParameter("ID_STATO_STAMPA", stampaFallita)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void caricaFileListaLiquidazione(Long idListaLiquidazione, byte[] pdf,
      int statoStampa) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::caricaFileListaLiquidazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                      		  \n"
        + "   IUF_T_FILE_LISTA_LIQUIDAZION                               \n"
        + " SET                                                           \n"
        + "   FILE_ALLEGATO = :CONTENUTOFILE, 							  \n"
        + "	  ID_STATO_STAMPA=:STATO_STAMPA,   	  						  \n"
        + "   DATA_ULTIMO_AGGIORNAMENTO = SYSDATE	                      \n"
        + " WHERE                                                         \n"
        + "   ID_LISTA_LIQUIDAZIONE = :ID_LISTA_LIQUIDAZIONE          	  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CONTENUTOFILE", new SqlLobValue(pdf),
          Types.BLOB);
      mapParameterSource.addValue("STATO_STAMPA", statoStampa, Types.NUMERIC);
      mapParameterSource.addValue("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_LISTA_LIQUIDAZIONE", idListaLiquidazione),
              new LogParameter("STATO_STAMPA", statoStampa),
              new LogParameter("CONTENUTOFILE", pdf)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<StampaOggettoIconaDTO> getElencoDocumentiStampeDaVerificare(
      long idProcedimentoOggetto, Long extIdTipoDocumento, Long idCategoriaDoc)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getElencoDocumentiStampeDaVerificare]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    StringBuilder queryBuff = new StringBuilder(
        " SELECT                                                            \n"
            + "   OI.ID_OGGETTO_ICONA,                                            \n"
            + "   OI.ID_ICONA AS ID_ICONA_STAMPA,                                 \n"
            + "   OI.EXT_ID_TIPO_DOCUMENTO,                                       \n"
            + "   TDD.DESC_TIPO_DOCUMENTO,                                        \n"
            + "   OI.ID_ELENCO_CDU,                                               \n"
            + "   OI.FLAG_STAMPA_OGGETTO_APERTO,                                  \n"
            + "   OI.FLAG_DA_PROTOCOLLARE,                                  	  \n"
            + "   OI.FLAG_DA_FIRMARE,                                  			  \n"
            + "   OI.FLAG_FIRMA_GRAFOMETRICA                                      \n"
            + " FROM                                                              \n"
            + "   IUF_R_BANDO_OGGETTO_ICONA BOI,                                  \n"
            + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                  \n"
            + "   IUF_R_BANDO_OGGETTO BO,                                         \n"
            + "   DOQUIAGRI_V_TIPO_DOC TDD,                                       \n"
            + "   IUF_D_ELENCO_CDU EC,                                            \n"
            + "   IUF_T_PROCEDIMENTO P,                                           \n"
            + "   IUF_R_OGGETTO_ICONA OI                                          \n"
            + " WHERE                                                             \n"
            + "   BOI.ID_OGGETTO_ICONA            = OI.ID_OGGETTO_ICONA           \n"
            + "   AND BOI.ID_BANDO_OGGETTO        = BO.ID_BANDO_OGGETTO           \n"
            + "   AND BO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO   \n"
            + "   AND PO.ID_PROCEDIMENTO_OGGETTO  = :ID_PROCEDIMENTO_OGGETTO      \n"
            + "   AND OI.EXT_ID_TIPO_DOCUMENTO   IS NOT NULL                      \n"
            + "   AND OI.ID_ELENCO_CDU            = EC.ID_ELENCO_CDU              \n"
            + "   AND EC.CODICE_CDU               = :INSERISCI_STAMPA_OGGETTO     \n"
            + "   AND OI.EXT_ID_TIPO_DOCUMENTO    = TDD.ID_TIPO_DOCUMENTO         \n"
            + "   AND TDD.ID_TIPOLOGIA_DOC        = :ID_TIPOLOGIA_DOC             \n");

    if (idCategoriaDoc != null)
    {
      queryBuff.append(
          "   AND TDD.ID_CATEGORIA_DOC        = :ID_CATEGORIA_DOC             \n");
    }

    queryBuff.append(
        "   AND P.ID_PROCEDIMENTO           = PO.ID_PROCEDIMENTO            \n"
            + "   AND P.ID_BANDO                  = BO.ID_BANDO                   \n");
    if (extIdTipoDocumento != null)
    {
      queryBuff.append(
          "       AND OI.EXT_ID_TIPO_DOCUMENTO = :ID_TIPO_DOCUMENTO           \n");
    }
    queryBuff.append(
        " ORDER BY TDD.DESC_TIPO_DOCUMENTO DESC                             \n");
    final String QUERY = queryBuff.toString();
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_TIPO_DOCUMENTO", extIdTipoDocumento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_TIPOLOGIA_DOC",
          IuffiConstants.IUFFI.ID_TIPOLOGIA_DOC_IUF_SU_DOQUIAGRI,
          Types.NUMERIC);
      mapParameterSource.addValue("INSERISCI_STAMPA_OGGETTO",
          IuffiConstants.USECASE.STAMPE_OGGETTO.INSERISCI_STAMPA_OGGETTO,
          Types.VARCHAR);
      if (idCategoriaDoc != null)
      {
        mapParameterSource.addValue("ID_CATEGORIA_DOC", idCategoriaDoc,
            Types.NUMERIC);
      }
      return queryForList(QUERY, mapParameterSource,
          StampaOggettoIconaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void cancellaStampa(long idProcedimentoOggettoStampa)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateIdStatoStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                      	             \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                            \n"
        + " SET                                                        \n"
        + "   DATA_FINE = SYSDATE					                     \n"
        + " WHERE                                                      \n"
        + "   ID_PROCEDIM_OGGETTO_STAMPA = :ID_PROCEDIM_OGGETTO_STAMPA \n"
        + "   AND DATA_FINE IS NULL                                    \n";

    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIM_OGGETTO_STAMPA",
          idProcedimentoOggettoStampa, Types.NUMERIC);

      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggettoStampa",
                  idProcedimentoOggettoStampa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DataFineLavoriDTO> getElencoDateFineLavori(long idProcedimento,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoDateFineLavori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    StringBuilder queryBuff = new StringBuilder(
        " SELECT                                                       \n"
            + "   A.ID_FINE_LAVORI,                                          \n"
            + "   A.ID_PROCEDIMENTO_OGGETTO,                                 \n"
            + "   A.DATA_FINE_LAVORI,                                        \n"
            + "   A.DATA_TERMINE_RENDICONTAZIONE,                            \n"
            + "   A.DATA_PROROGA,                                            \n"
            + "   A.NOTE,                                                    \n"
            + "   (                                                          \n"
            + "   SELECT                                                     \n"
            + "    D.DESCRIZIONE                                             \n"
            + "   FROM                                                       \n"
            + "    IUF_R_LEGAME_GRUPPO_OGGETTO G,                            \n"
            + "    IUF_D_OGGETTO D                                           \n"
            + "   WHERE                                                      \n"
            + "    G.ID_LEGAME_GRUPPO_OGGETTO = B.ID_LEGAME_GRUPPO_OGGETTO   \n"
            + "    AND G.ID_OGGETTO = D.ID_OGGETTO                           \n"
            + "   ) AS DESCR_PROCEDIMENTO_OGGETTO                            \n"
            + "  FROM                                                        \n"
            + "   IUF_T_FINE_LAVORI A,                                       \n"
            + "   IUF_T_PROCEDIMENTO_OGGETTO B                               \n"
            + "  WHERE                                                       \n"
            + "   B.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                       \n"
            + "   AND  B.ID_PROCEDIMENTO_OGGETTO <= :ID_PROCEDIMENTO_OGGETTO \n"
            + "   AND A.ID_PROCEDIMENTO_OGGETTO = B.ID_PROCEDIMENTO_OGGETTO  \n"
            + "                                                              \n"
            + "  ORDER BY A.ID_FINE_LAVORI DESC                              \n");
    final String QUERY = queryBuff.toString();
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return queryForList(QUERY, mapParameterSource, DataFineLavoriDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void aggiornaDataFineLavori(long idDataFineLavori,
      DataFineLavoriDTO dataFineLavoriDTO) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaDataFineLavori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        		\n"
        + "   IUF_T_FINE_LAVORI                                  				\n"
        + " SET                                                           		\n"
        + "   NOTE                        = :NOTE,                        		\n"
        + "   DATA_FINE_LAVORI = :DATA_FINE_LAVORI, 						    \n"
        + "   DATA_TERMINE_RENDICONTAZIONE   = :DATA_TERMINE_RENDICONTAZIONE,   \n"
        + "   DATA_PROROGA   = :DATA_PROROGA                       				\n"
        + " WHERE                                                         		\n"
        + "   ID_FINE_LAVORI = :ID_FINE_LAVORI          						\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_FINE_LAVORI", idDataFineLavori,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_FINE_LAVORI",
          dataFineLavoriDTO.getDataFineLavori(), Types.DATE);
      mapParameterSource.addValue("DATA_TERMINE_RENDICONTAZIONE",
          dataFineLavoriDTO.getDataTermineRendicontazione(), Types.DATE);
      mapParameterSource.addValue("DATA_PROROGA",
          dataFineLavoriDTO.getDataProroga(), Types.DATE);
      mapParameterSource.addValue("NOTE", dataFineLavoriDTO.getNote(),
          Types.VARCHAR);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDataFineLavori", idDataFineLavori),
              new LogParameter("note", dataFineLavoriDTO.getNote()),
              new LogParameter("DATA_FINE_LAVORI",
                  dataFineLavoriDTO.getDataFineLavori()),
              new LogParameter("DATA_TERMINE_RENDICONTAZIONE",
                  dataFineLavoriDTO.getDataTermineRendicontazione()),
              new LogParameter("DATA_PROROGA",
                  dataFineLavoriDTO.getDataProroga())
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciDataFineLavori(DataFineLavoriDTO dataFineLavoriDTO)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciDataFineLavori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT INTO                        \n"
        + "   IUF_T_FINE_LAVORI                \n"
        + "   (                                \n"
        + "     ID_FINE_LAVORI,                \n"
        + "     ID_PROCEDIMENTO_OGGETTO,       \n"
        + "     DATA_FINE_LAVORI,              \n"
        + "     DATA_TERMINE_RENDICONTAZIONE,  \n"
        + "     DATA_PROROGA,                  \n"
        + "     NOTE                           \n"
        + "   )                                \n"
        + " VALUES                             \n"
        + "   (                                \n"
        + "     SEQ_IUF_T_FINE_LAVORI.NEXTVAL, \n"
        + "     :ID_PROCEDIMENTO_OGGETTO,      \n"
        + "     :DATA_FINE_LAVORI,             \n"
        + "     :DATA_TERMINE_RENDICONTAZIONE, \n"
        + "     :DATA_PROROGA,                 \n"
        + "     :NOTE                          \n"
        + "   )                                \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          dataFineLavoriDTO.getIdProcedimentoOggetto(), Types.NUMERIC);
      mapParameterSource.addValue("DATA_FINE_LAVORI",
          dataFineLavoriDTO.getDataFineLavori(), Types.DATE);
      mapParameterSource.addValue("DATA_TERMINE_RENDICONTAZIONE",
          dataFineLavoriDTO.getDataTermineRendicontazione(), Types.DATE);
      mapParameterSource.addValue("DATA_PROROGA",
          dataFineLavoriDTO.getDataProroga(), Types.DATE);
      mapParameterSource.addValue("NOTE", dataFineLavoriDTO.getNote(),
          Types.VARCHAR);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_OGGETTO",
                  dataFineLavoriDTO.getIdProcedimentoOggetto()),
              new LogParameter("note", dataFineLavoriDTO.getNote()),
              new LogParameter("DATA_FINE_LAVORI",
                  dataFineLavoriDTO.getDataFineLavori()),
              new LogParameter("DATA_TERMINE_RENDICONTAZIONE",
                  dataFineLavoriDTO.getDataTermineRendicontazione()),
              new LogParameter("DATA_PROROGA",
                  dataFineLavoriDTO.getDataProroga())
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteDataFineLavori(long idFineLavori)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteDataFineLavori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_T_FINE_LAVORI    					\n"
        + " WHERE ID_FINE_LAVORI = :ID_FINE_LAVORI 		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_FINE_LAVORI", idFineLavori,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFineLavori", idFineLavori)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DataFineLavoriDTO getLastDataFineLavori(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getLastDataFineLavori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    StringBuilder queryBuff = new StringBuilder(
        " SELECT                                                       \n"
            + "   A.ID_FINE_LAVORI,                                          \n"
            + "   A.ID_PROCEDIMENTO_OGGETTO,                                 \n"
            + "   A.DATA_FINE_LAVORI,                                        \n"
            + "   A.DATA_TERMINE_RENDICONTAZIONE,                            \n"
            + "   A.DATA_PROROGA,                                            \n"
            + "   A.NOTE,                                                    \n"
            + "   (                                                          \n"
            + "   SELECT                                                     \n"
            + "    D.DESCRIZIONE                                             \n"
            + "   FROM                                                       \n"
            + "    IUF_R_LEGAME_GRUPPO_OGGETTO G,                            \n"
            + "    IUF_D_OGGETTO D                                           \n"
            + "   WHERE                                                      \n"
            + "    G.ID_LEGAME_GRUPPO_OGGETTO = B.ID_LEGAME_GRUPPO_OGGETTO   \n"
            + "    AND G.ID_OGGETTO = D.ID_OGGETTO                           \n"
            + "   ) AS DESCR_PROCEDIMENTO_OGGETTO                            \n"
            + "  FROM                                                        \n"
            + "   IUF_T_FINE_LAVORI A,                                       \n"
            + "   IUF_T_PROCEDIMENTO_OGGETTO B                               \n"
            + "  WHERE                                                       \n"
            + "   B.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                       \n"
            + "   AND A.ID_PROCEDIMENTO_OGGETTO = B.ID_PROCEDIMENTO_OGGETTO  \n"
            + "                                                              \n"
            + "  ORDER BY A.ID_FINE_LAVORI DESC                              \n");
    final String QUERY = queryBuff.toString();
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);

      DataFineLavoriDTO res = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<DataFineLavoriDTO>()
          {
            @Override
            public DataFineLavoriDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              // Creo un array delle particelle trovate e vedo se ci sono tutte
              // quelle passate in input
              DataFineLavoriDTO dto = null;
              if (rs.next())
              {
                dto = new DataFineLavoriDTO();
                dto.setDataFineLavori(rs.getDate("DATA_FINE_LAVORI"));
                dto.setDataProroga(rs.getDate("DATA_PROROGA"));
                dto.setDataTermineRendicontazione(
                    rs.getDate("DATA_TERMINE_RENDICONTAZIONE"));
                dto.setDescrProcedimentoOggetto(
                    rs.getString("DESCR_PROCEDIMENTO_OGGETTO"));
                dto.setIdFineLavori(rs.getLong("ID_FINE_LAVORI"));
                dto.setIdProcedimentoOggetto(
                    rs.getLong("ID_PROCEDIMENTO_OGGETTO"));
                dto.setNote(rs.getString("NOTE"));
              }

              return dto;
            }
          });
      return res;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<LivelloDTO> getLivelliImpegnoProcOggetto(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getLivelliImpegnoProcOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                                 \n"
        + "   L.ID_LIVELLO,                                        \n"
        + "   L.CODICE_LIVELLO,                                    \n"
        + "   L.DESCRIZIONE,                                       \n"
        + "   L.CODICE                                             \n"
        + " FROM                                                   \n"
        + "   IUF_T_DATI_PROCEDIMENTO A,                           \n"
        + "   IUF_T_IMPEGNO_PROC_OGG B,                            \n"
        + "   IUF_D_LIVELLO L                                      \n"
        + " WHERE                                                  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND A.ID_DATI_PROCEDIMENTO = B.ID_DATI_PROCEDIMENTO  \n"
        + "   AND L.ID_LIVELLO = B.ID_LIVELLO                      \n"
        + " ORDER BY L.ORDINAMENTO                                 \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    return queryForList(QUERY, mapParameterSource, LivelloDTO.class);
  }

  public Date getMinDataProroga(long idProcedimento)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getMinDataProroga]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                        \n"
        + "   NVL(MAX(A.DATA_FINE_LAVORI), TRUNC(SYSDATE)) AS DATA_LIMITE \n"
        + " FROM                                                          \n"
        + "   IUF_T_FINE_LAVORI A,                                        \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO B                                \n"
        + " WHERE                                                         \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = B.ID_PROCEDIMENTO_OGGETTO       \n"
        + "   AND B.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                    \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.queryForObject(QUERY,
          mapParameterSource, java.sql.Timestamp.class);
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public GiustificazioneAnomaliaDTO getGiustificazioneAnomalia(long idControllo,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getDatiAziendaAgricolaProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                         \n"
        + "   SA.ID_SOLUZIONE_ANOMALIA as ID_SOLUZIONE_ANOMALIA,     \n"
        + "   SA.ID_TIPO_SOLUZIONE as ID_TIPO_SOLUZIONE,             \n"
        + "   SA.PROVINCIA_PREFETTURA,             					 \n"
        + "   SA.EXT_ID_UTENTE_AGGIORNAMENTO,	 					 \n"
        + "   SA.DATA_PROTOCOLLO,             						 \n"
        + "   SA.NUMERO_PROTOCOLLO,            						 \n"
        + "   SA.DATA_DOCUMENTO,           							 \n"
        + "   TS.DESCRIZIONE AS TIPO_SOLUZIONE,    			         \n"
        + "   NOTE,                                                  \n"
        + "   FILE_ALLEGATO,                                         \n"
        + "   FLAG_NOTE_OBBLIGATORIE,                                \n"
        + "   FLAG_FILE_OBBLIGATORIO,                                \n"
        + "   NOME_LOGICO,                                           \n"
        + "   NOME_FISICO                                            \n"
        + " FROM		                                             \n"
        + "   IUF_T_SOLUZIONE_ANOMALIA SA,							 \n"
        + "   IUF_D_TIPO_SOLUZIONE TS                              	 \n"
        + " WHERE		                                             \n"
        + "   ID_PROCEDIMENTO_OGGETTO=:ID_PROCEDIMENTO_OGGETTO       \n"
        + "   AND ID_CONTROLLO = :ID_CONTROLLO                       \n"
        + "   AND TS.ID_TIPO_SOLUZIONE (+)= SA.ID_TIPO_SOLUZIONE     \n"

    ;
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_CONTROLLO", idControllo, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<GiustificazioneAnomaliaDTO>()
          {

            @Override
            public GiustificazioneAnomaliaDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                GiustificazioneAnomaliaDTO giustificazione = new GiustificazioneAnomaliaDTO();
                giustificazione.setIdSoluzioneAnomalia(
                    rs.getLong("ID_SOLUZIONE_ANOMALIA"));
                giustificazione
                    .setIdTipoRisoluzione(rs.getLong("ID_TIPO_SOLUZIONE"));
                giustificazione
                    .setTipoRisoluzione(rs.getString("TIPO_SOLUZIONE"));
                giustificazione.setNote(rs.getString("NOTE"));
                giustificazione.setFlagNoteObbligatorie(
                    rs.getString("FLAG_NOTE_OBBLIGATORIE"));
                giustificazione.setFlagFileAllegatoObbligatorio(
                    rs.getString("FLAG_FILE_OBBLIGATORIO"));
                giustificazione
                    .setProvPrefettura(rs.getString("PROVINCIA_PREFETTURA"));
                giustificazione.setDataDocumento(rs.getDate("DATA_DOCUMENTO"));
                giustificazione
                    .setDataProtocollo(rs.getDate("DATA_PROTOCOLLO"));
                giustificazione
                    .setNumProtocollo(rs.getString("NUMERO_PROTOCOLLO"));
                giustificazione.setExtIdUtenteAggiornamento(
                    rs.getLong("EXT_ID_UTENTE_AGGIORNAMENTO"));
                FileAllegatiDTO file = new FileAllegatiDTO();
                file.setNomeLogico(rs.getString("NOME_LOGICO"));
                file.setNomeFisico(rs.getString("NOME_FISICO"));

                giustificazione.setAllegato(file);
                return giustificazione;
              }
              else
              {
                return null;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idControllo", idControllo)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ControlloDTO getControllo(long idControllo, long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getControllo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                         	\n"
        + "   C.DESCRIZIONE,                                         	\n"
        + "   C.CODICE,   				                             	\n"
        + "   A.ID_ANOMALIE_CONTROLLI,                                	\n"
        + "   A.DESCRIZIONE_ANOMALIA                                   	\n"
        + " FROM		                                             	\n"
        + "   IUF_D_CONTROLLO C,									 	\n"
        + "   IUF_T_ANOMALIE_CONTROLLI A                             	\n"
        + " WHERE		                                             	\n"
        + "   C.ID_CONTROLLO = :ID_CONTROLLO                     		\n"
        + "   AND A.ID_CONTROLLO = :ID_CONTROLLO				     	\n"
        + "   AND A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO	\n"

    ;
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_CONTROLLO", idControllo, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<ControlloDTO>()
          {

            @Override
            public ControlloDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                ControlloDTO controllo = new ControlloDTO();
                controllo.setCodice(rs.getString("CODICE"));
                controllo.setDescrizione(rs.getString("DESCRIZIONE"));
                controllo.setDescrizioneAnomalia(
                    rs.getString("DESCRIZIONE_ANOMALIA"));
                controllo.setIdAnomalieControllo(
                    rs.getLong("ID_ANOMALIE_CONTROLLI"));
                return controllo;
              }
              else
              {
                return null;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idControllo", idControllo)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getTipiRisoluzioneControlli(long idControllo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getTipiRisoluzioneControlli]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT 																					\n"
        + " TS.ID_TIPO_SOLUZIONE AS ID, 																				\n"
        + " TS.DESCRIZIONE, 																							\n"
        + " DESCRIZIONE AS CODICE                       																\n"
        + " FROM                                                                                                        \n"
        + "   IUF_D_TIPO_SOLUZIONE TS,  																				\n"
        + "	  IUF_R_SOLUZIONE_CONTROLLO SC                                                    	                       	\n"
        + " WHERE                                                                                                       \n"
        + "   TS.ID_TIPO_SOLUZIONE = SC.ID_TIPO_SOLUZIONE                      						                    \n"
        + "   AND SC.ID_CONTROLLO = :ID_CONTROLLO                      							                        \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_CONTROLLO", idControllo, Types.NUMERIC);
    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idControllo", idControllo) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getFlagObbligatorieta(Long idTipoRisoluzione, String val)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getFlagObbligatorieta]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                       		\n";
    if (val.equals("file"))
      QUERY += " FLAG_FILE_OBBLIGATORIO 							 \n";
    else
      if (val.equals("note"))
        QUERY += " FLAG_NOTE_OBBLIGATORIE 						 \n";
    QUERY += " FROM                                                   \n"
        + "   IUF_D_TIPO_SOLUZIONE                                       \n"
        + " WHERE                                                        \n"
        + "   ID_TIPO_SOLUZIONE             = :ID_TIPO_SOLUZIONE    	 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_TIPO_SOLUZIONE", idTipoRisoluzione,
          Types.NUMERIC);

      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idTipoRisoluzione", idTipoRisoluzione)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciGiustificazioneAnomaliaControllo(long idControllo,
      long idProcedimentoOggetto, Long idTipoRisoluzione, String note,
      byte[] bs, String nomeLogico, String nomeFisico, Long idUtenteLogin,
      String prov, Date dataProtocollo, Date dataDocumento,
      String numProtocollo) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::inserisciGiustificazioneAnomaliaControllo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      		\n"
        + " INTO                                        \n"
        + "   IUF_T_SOLUZIONE_ANOMALIA          		\n"
        + "   (                                         \n"
        + "     ID_SOLUZIONE_ANOMALIA,           		\n"
        + "     ID_PROCEDIMENTO_OGGETTO,                \n"
        + "     ID_CONTROLLO,                 			\n"
        + "     NOTE,                 					\n"
        + "     NOME_FISICO,                 			\n"
        + "     NOME_LOGICO,                 			\n"
        + "     FILE_ALLEGATO,							\n"
        + "     ID_TIPO_SOLUZIONE,                      \n"
        + "     PROVINCIA_PREFETTURA,                   \n"
        + "     DATA_PROTOCOLLO,                        \n"
        + "     NUMERO_PROTOCOLLO,                      \n"
        + "     DATA_DOCUMENTO,                         \n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO             \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_SOLUZIONE_ANOMALIA,					\n"
        + "     :ID_PROCEDIMENTO_OGGETTO,               \n"
        + "     :ID_CONTROLLO,                 			\n"
        + "     :NOTE,           		      			\n"
        + "     :NOME_FISICO,                 			\n"
        + "     :NOME_LOGICO,                 			\n"
        + "     :FILE_ALLEGATO,                 		\n"
        + "     :ID_TIPO_SOLUZIONE,                     \n"
        + "     :PROVINCIA_PREFETTURA,                  \n"
        + "     :DATA_PROTOCOLLO,                       \n"
        + "     :NUMERO_PROTOCOLLO,                     \n"
        + "     :DATA_DOCUMENTO,                        \n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO            \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    Long idSoluzioneAnomalia = null;
    try
    {
      idSoluzioneAnomalia = getNextSequenceValue(
          "SEQ_IUF_T_SOLUZIONE_ANOMALIA");
      mapParameterSource.addValue("ID_SOLUZIONE_ANOMALIA", idSoluzioneAnomalia,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_CONTROLLO", idControllo, Types.NUMERIC);
      mapParameterSource.addValue("ID_TIPO_SOLUZIONE", idTipoRisoluzione,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO", idUtenteLogin,
          Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      mapParameterSource.addValue("NOME_FISICO", nomeFisico, Types.VARCHAR);
      mapParameterSource.addValue("NOME_LOGICO", nomeLogico, Types.VARCHAR);
      mapParameterSource.addValue("FILE_ALLEGATO",
          ((bs != null) ? new SqlLobValue(bs) : null), Types.BLOB);

      mapParameterSource.addValue("PROVINCIA_PREFETTURA", prov, Types.VARCHAR);
      mapParameterSource.addValue("DATA_PROTOCOLLO", dataProtocollo,
          Types.DATE);
      mapParameterSource.addValue("NUMERO_PROTOCOLLO", numProtocollo,
          Types.VARCHAR);
      mapParameterSource.addValue("DATA_DOCUMENTO", dataDocumento, Types.DATE);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idControllo", idControllo),
              new LogParameter("idTipoRisoluzione", idTipoRisoluzione),
              new LogParameter("extIdUtenteAggiornamento", idUtenteLogin)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public FileAllegatoDTO getAllegatoGiustificazione(long idSoluzioneAnomalia)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAllegatoGiustificazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger
          .debug(THIS_METHOD + " idSoluzioneAnomalia = " + idSoluzioneAnomalia);
    }
    final String QUERY = " SELECT                                        			\n"
        + "   FILE_ALLEGATO,                             		\n"
        + "   NOME_FISICO                          	    		\n"
        + " FROM                                          		\n"
        + "   IUF_T_SOLUZIONE_ANOMALIA                    		\n"
        + " WHERE                                         		\n"
        + "   ID_SOLUZIONE_ANOMALIA = :ID_SOLUZIONE_ANOMALIA 	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_SOLUZIONE_ANOMALIA", idSoluzioneAnomalia,
          Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<FileAllegatoDTO>()
          {
            @Override
            public FileAllegatoDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                FileAllegatoDTO file = new FileAllegatoDTO();
                file.setNomeFile(rs.getString("NOME_FISICO"));
                file.setFileAllegato(rs.getBytes("FILE_ALLEGATO"));
                return file;
              }
              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idSoluzioneAnomalia", idSoluzioneAnomalia)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public EsitoFinaleDTO getEsitoFinale(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getEsitoFinale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                \n"
        + "  A.EXT_ID_FUNZIONARIO_ISTRUTTORE,                     \n"
        + "  A.ID_ESITO AS  ID_ESITO_LONG,                        \n"
        + "  A.ID_ESITO ,                        					\n"
        + "  B.DESCRIZIONE,                                       \n"
        + "  B.CODICE,                                            \n"
        + "  C.COGNOME || ' ' || C.NOME AS DESCR_TECNICO ,        \n"
        + "  D.COGNOME || ' ' || D.NOME AS DESCR_GRADO_SUP        \n"
        + " FROM                                                  \n"
        + "  IUF_T_ESITO_FINALE A,                                \n"
        + "  IUF_D_ESITO B,                                       \n"
        + "  DB_TECNICO C,                                        \n"
        + "  DB_TECNICO D                                         \n"
        + " WHERE                                                 \n"
        + "  A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "  AND B.ID_ESITO (+)= A.ID_ESITO                       \n"
        + "  AND C.ID_TECNICO(+)= A.EXT_ID_FUNZIONARIO_ISTRUTTORE \n"
        + "  AND D.ID_TECNICO (+) = A.EXT_ID_FUNZIONARIO_GRADO_SUP   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY.toString(),
          mapParameterSource, new ResultSetExtractor<EsitoFinaleDTO>()
          {
            @Override
            public EsitoFinaleDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              EsitoFinaleDTO esito = null;
              while (rs.next())
              {
                esito = new EsitoFinaleDTO();
                esito.setIdEsito(rs.getLong("ID_ESITO"));
                esito.setIdEsitoLong(rs.getLong("ID_ESITO_LONG"));
                esito.setExtIdFunzionarioIstruttore(
                    rs.getLong("EXT_ID_FUNZIONARIO_ISTRUTTORE"));
                esito.setDescrEsito(rs.getString("DESCRIZIONE"));
                esito.setCodiceEsito(rs.getString("CODICE"));
                esito.setDescrTecnico(rs.getString("DESCR_TECNICO"));
                esito.setDescrGradoSup(rs.getString("DESCR_GRADO_SUP"));
              }
              return esito;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY.toString(), mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void aggiornaEsitoFinale(long idProcedimentoOggetto, long idEsito,
      long extIdFunzionarioIstruttore) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaEsitoFinale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "UPDATE IUF_T_ESITO_FINALE "
        + " SET EXT_ID_FUNZIONARIO_ISTRUTTORE = :EXT_ID_FUNZIONARIO_ISTRUTTORE,"
        + " ID_ESITO = :ID_ESITO"
        + " WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_FUNZIONARIO_ISTRUTTORE",
          extIdFunzionarioIstruttore, Types.NUMERIC);
      mapParameterSource.addValue("ID_ESITO", idEsito, Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("extIdFunzionarioIstruttore",
                  extIdFunzionarioIstruttore),
              new LogParameter("idEsito", idEsito)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean findOggettoByIdProcedimento(long idProcedimento,
      String codiceOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::findOggettoByIdProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                                                         \n"
        + "   B.ID_PROCEDIMENTO_OGGETTO                                                                \n"
        + " FROM                                                                                       \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO B,                                                            \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO C                                                            \n"
        + " WHERE                                                                                      \n"
        + "   B.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                                                     \n"
        + "   AND B.ID_LEGAME_GRUPPO_OGGETTO = C.ID_LEGAME_GRUPPO_OGGETTO                              \n"
        + "   AND C.ID_OGGETTO = (SELECT ID_OGGETTO FROM IUF_D_OGGETTO WHERE CODICE = :CODICE_OGGETTO) \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("CODICE_OGGETTO", codiceOggetto,
          Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getValoreParametroFunzSupEsitoVerbale()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdentificativo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");

    }

    final String QUERY = " SELECT                            	                             \n"
        + "   VALORE 												     \n"
        + " FROM                                                         \n"
        + "   IUF_D_PARAMETRO					 						 \n"
        + " WHERE                                                        \n"
        + "   CODICE = 'FUNZ_SUP_ESITO_VERB'       						 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getTipoPagamentoSigopOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getTipoPagamentoSigopOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                      			\n"
        + "   O.TIPO_PAGAMENTO_SIGOP										\n"
        + " FROM                                                         	\n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                             	\n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO L,							 	\n"
        + "	  IUF_D_OGGETTO	O		                                     	\n"
        + " WHERE                                                        	\n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  	 	\n"
        + " AND PO.ID_LEGAME_GRUPPO_OGGETTO = L.ID_LEGAME_GRUPPO_OGGETTO 	\n"
        + " AND O.ID_OGGETTO = L.ID_OGGETTO								 	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateAnticipoLivello(List<ImportoAnticipoLivelloDTO> list)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaEsitoFinale]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                 \n"
        + "   IUF_R_ANTICIPO_LIVELLO               \n"
        + " SET                                    \n"
        + "   IMPORTO_ANTICIPO = :IMPORTO_ANTICIPO \n"
        + " WHERE                                  \n"
        + "   ID_ANTICIPO    = :ID_ANTICIPO        \n"
        + "   AND ID_LIVELLO = :ID_LIVELLO         \n";
    int size = list.size();
    MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[size];
    try
    {
      int idx = 0;
      for (ImportoAnticipoLivelloDTO anticipoLivelloDTO : list)
      {
        MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
        mapParameterSource.addValue("IMPORTO_ANTICIPO",
            anticipoLivelloDTO.getImportoAnticipo(), Types.NUMERIC);
        mapParameterSource.addValue("ID_ANTICIPO",
            anticipoLivelloDTO.getIdAnticipo(), Types.NUMERIC);
        mapParameterSource.addValue("ID_LIVELLO",
            anticipoLivelloDTO.getIdLivello(), Types.NUMERIC);
        batchParameters[idx++] = mapParameterSource;
      }
      namedParameterJdbcTemplate.batchUpdate(UPDATE, batchParameters);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("list", list)
          },
          new LogVariable[]
          {}, UPDATE, batchParameters);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getValoreParametroDichiarazioneByCodice(
      long idProcedimentoOggetto, String codiceInfo)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getValoreParametroDichiarazioneByCodice";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                 \n"
        + "   C.VALORE                                             \n"
        + " FROM                                                   \n"
        + "   IUF_T_SELEZIONE_INFO A,                              \n"
        + "   IUF_D_DETTAGLIO_INFO B,                              \n"
        + "   IUF_T_VALORI_INSERITI C                              \n"
        + " WHERE                                                  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND A.ID_DETTAGLIO_INFO = B.ID_DETTAGLIO_INFO        \n"
        + "   AND C.ID_SELEZIONE_INFO = A.ID_SELEZIONE_INFO        \n"
        + "   AND B.CODICE_INFO = :CODICE_INFO                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("CODICE_INFO", codiceInfo, Types.VARCHAR);
    try
    {
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("codiceInfo", codiceInfo)
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public Long getLastIstanzaWithPremio(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getLastIstanzaWithPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                        \n"
        + "   MAX(A.ID_PROCEDIMENTO_OGGETTO) AS ID_PROCEDIMENTO_OGGETTO   \n"
        + " FROM                                                          \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO A,                               \n"
        + "   IUF_T_DATI_PROCEDIMENTO B,                                  \n"
        + "   IUF_T_PREMIO_COMPLESSIVO C,                                 \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE D,                           \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO E,                              \n"
        + "   IUF_D_OGGETTO F                                             \n"
        + " WHERE                                                         \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = B.ID_PROCEDIMENTO_OGGETTO       \n"
        + "   AND B.ID_DATI_PROCEDIMENTO = C.ID_DATI_PROCEDIMENTO         \n"
        + "   AND A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                    \n"
        + "   AND A.ID_PROCEDIMENTO_OGGETTO = D.ID_PROCEDIMENTO_OGGETTO   \n"
        + "   AND D.DATA_FINE IS NULL                                     \n"
        + "   AND D.ID_STATO_OGGETTO BETWEEN 10 AND 90                    \n"
        + "   AND E.ID_LEGAME_GRUPPO_OGGETTO = A.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND F.ID_OGGETTO = E.ID_OGGETTO                             \n"
        + "   AND F.FLAG_ISTANZA = 'S'                                    \n"
        + "                                                               \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getResponsabileProcedimento(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getResponsabileProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                          \n"
        + "   B.RESPONSABILE                                \n"
        + " FROM                                            \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO A,             \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA B                  \n"
        + " WHERE                                           \n"
        + "   A.EXT_ID_AMM_COMPETENZA = B.ID_AMM_COMPETENZA \n"
        + "   AND A.DATA_FINE IS NULL                       \n"
        + "   AND A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO      \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isTipoGiustificazioneAntimafia(long idTipoSoluzione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isTipoGiustificazioneAntimafia]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                     \n"
        + "   A.ID_TIPO_SOLUZIONE                      \n"
        + " FROM                                       \n"
        + "   IUF_D_TIPO_SOLUZIONE A                   \n"
        + " WHERE                                      \n"
        + "   A.ID_TIPO_SOLUZIONE = :ID_TIPO_SOLUZIONE \n"
        + "   AND A.CODICE_IDENTIFICATIVO = 'AMF'      \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    mapParameterSource.addValue("ID_TIPO_SOLUZIONE", idTipoSoluzione,
        Types.NUMERIC);
    return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
        new ResultSetExtractor<Boolean>()
        {
          @Override
          public Boolean extractData(ResultSet rs)
              throws SQLException, DataAccessException
          {
            if (!rs.next())
            {
              return Boolean.FALSE;
            }
            else
            {
              return Boolean.TRUE;
            }
          }
        });
  }

  public boolean isIstruttoriaInCorsoMisuraPremio(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::isIstruttoriaInCorsoMisuraPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                      \n"
        + "   A.ID_PROCEDIMENTO                         \n"
        + " FROM                                        \n"
        + "   IUF_T_PROCEDIMENTO A,                     \n"
        + "   IUF_D_TIPO_LIVELLO C,                      \n"
        + "   IUF_D_BANDO B                             \n"
        + " WHERE                                       \n"
        + "   A.ID_BANDO = B.ID_BANDO                   \n"
        + "   AND B.ID_TIPO_LIVELLO = C.ID_TIPO_LIVELLO \n"
        + "   AND C.CODICE = 'P'                        \n"
        + "   AND A.ID_STATO_OGGETTO = 14               \n"
        + "   AND A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
        Types.NUMERIC);
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getInfoAziendaByCuaa(String cuaa)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getInfoAziendaByCuaa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                 	   \n"
        + "   DENOMINAZIONE || '&&&' || INDIRIZZO_SEDE_LEGALE                      \n"
        + " FROM                                                                   \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI 		                                       \n"
        + " WHERE                                                                  \n"
        + "   CUAA=:CUAA						                                   \n"
        + "   AND DATA_FINE_VALIDITA IS NULL 									   \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CUAA", cuaa, Types.VARCHAR);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Exception t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("cuaa", cuaa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void chiudiIterAzienda(long idProcedimento, String note)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::chiudiIterAzienda]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                                        \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA                                \n"
        + " SET                                                         \n"
        + "   DATA_FINE = SYSDATE,				                      \n"
        + "   NOTE = :NOTE				                          	  \n"
        + " WHERE                                                       \n"
        + "   ID_PROCEDIMENTO = :ID_PROCEDIMENTO          			  \n"
        + "   AND DATA_FINE IS NULL									  \n";

    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertIterAzienda(long idProcedimento, long idAzienda,
      long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertIterAzienda]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA            	\n"
        + "   (                                         \n"
        + "     ID_PROCEDIMENTO_AZIENDA,            	\n"
        + "     ID_PROCEDIMENTO,               			\n"
        + "     EXT_ID_AZIENDA,                  		\n"
        + "     DATA_INIZIO,                            \n"
        + "     DATA_FINE,                            	\n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO,            \n"
        + "     NOTE                            		\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_PROCEDIMENTO_AZIEN.NEXTVAL, \n"
        + "     :ID_PROCEDIMENTO,                		\n"
        + "     :EXT_ID_AZIENDA,                  		\n"
        + "     SYSDATE,                            	\n"
        + "     NULL,                            		\n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO,           \n"
        + "     NULL                            		\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AZIENDA", idAzienda, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idAzienda", idAzienda),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean existWProcedimentoOggAzienda(long idProcedimentoOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::existWProcedimentoOggAzienda]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT           				\n"
        + "   COUNT(*)                      \n"
        + " FROM                            \n"
        + "   IUF_W_PROCEDIMENTO_OGG_AZIEN    \n"
        + " WHERE                           \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 					\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciVoltura(Long idAzienda, long idProcedimentoOggetto,
      String note) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciVoltura]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_W_PROCEDIMENTO_OGG_AZIEN            \n"
        + "   (                                         \n"
        + "     ID_PROCEDIMENTO_OGGETTO,                \n"
        + "     EXT_ID_AZIENDA,                  		\n"
        + "     NOTE			                  		\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_PROCEDIMENTO_OGGETTO,               \n"
        + "     :EXT_ID_AZIENDA,                  		\n"
        + "     :NOTE			                  		\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AZIENDA", idAzienda, Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);

      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idAzienda", idAzienda)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public VolturaDTO getVoltura(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getVoltura]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                  		       	     		       			\n"
        + "   POA.EXT_ID_AZIENDA AS ID_AZIENDA,				           			\n"
        + "   POA.NOTE,										           			\n"
        + "   A.DENOMINAZIONE AS DENOMINAZIONE_AZIENDA,		           			\n"
        + "   A.CUAA,															\n"
        + "   A.INDIRIZZO_SEDE_LEGALE AS SEDE_LEGALE,                 			\n"
        + "   SC.CODICE_FISCALE || ' - ' || SC.COGNOME || ' ' || SC.NOME AS RAPPRESENTANTE_LEGALE     				\n"
        + " FROM                                                       			\n"
        + "   IUF_W_PROCEDIMENTO_OGG_AZIEN  POA,		              			\n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC,                                   \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI A		                       			\n"
        + " WHERE                                            	       			\n"
        + "   POA.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO		 	\n"
        + "   AND A.ID_AZIENDA (+)= POA.EXT_ID_AZIENDA		         		    \n"
        + "   AND SC.ID_AZIENDA=A.ID_AZIENDA				         		    \n"
        + "   AND SC.ID_RUOLO = 1							         		    \n"
        + "   AND SC.DATA_FINE_RUOLO IS NULL				         		    \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource, VolturaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<AziendaDTO> getInfoAziendaByDenominazione(
      String denominazioneAzienda) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getInfoAziendaByDenominazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                                                                                              		\n"
        + "    VANAG.ID_AZIENDA,                                                                                                                    		\n"
        + "    VANAG.CUAA,                                                                                                                              	\n"
        + "    VANAG.DENOMINAZIONE,                                                                                                                     	\n"
        + "    VANAG.INTESTAZIONE_PARTITA_IVA AS DENOMINAZIONE_INTESTAZIONE,                                                                           	\n"
        + "    VANAG.INDIRIZZO_SEDE_LEGALE AS SEDE_LEGALE,                                                                                               	\n"
        + "   SC.CODICE_FISCALE || ' - ' || SC.COGNOME || ' ' || SC.NOME AS RAPPRESENTANTE_LEGALE     													\n"
        + " FROM                                                                                                                                        	\n"
        + "    SMRGAA_V_SOGGETTI_COLLEGATI SC,                                   																			\n"
        + "    SMRGAA_V_DATI_ANAGRAFICI VANAG                                                                                                           	\n"
        + " WHERE                                                                                                                                       	\n"
        + "    UPPER(VANAG.DENOMINAZIONE)  LIKE UPPER(:denominazioneAzienda)                                                                            	\n"
        + "   AND VANAG.ID_AZIENDA (+)= SC.ID_AZIENDA		         		    																			\n"
        + "   AND VANAG.DATA_FINE_VALIDITA IS NULL				         		    																	\n"
        + "   AND VANAG.DATA_CESSAZIONE IS NULL					         		    																	\n"
        + "   AND VANAG.CUAA IS NOT NULL							         		    																	\n"
        + "   AND SC.ID_AZIENDA=VANAG.ID_AZIENDA				         		    																		\n"
        + "   AND SC.ID_RUOLO = 1							         		    																			\n"
        + "   AND SC.DATA_FINE_RUOLO IS NULL				         		    																			\n"
        + " ORDER BY VANAG.DENOMINAZIONE																													\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("denominazioneAzienda",
          "%" + denominazioneAzienda + "%", Types.VARCHAR);

      return queryForList(QUERY, mapParameterSource, AziendaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<AziendaDTO> getAziendeByCuaa(String cuaa)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAziendeByCuaa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "SELECT                                                                                                                              	  \n"
        + "    VANAG.ID_AZIENDA,                                                                                                                    	  \n"
        + "    VANAG.CUAA,                                                                                                                              \n"
        + "    VANAG.DENOMINAZIONE,                                                                                                                     \n"
        + "    VANAG.INTESTAZIONE_PARTITA_IVA AS DENOMINAZIONE_INTESTAZIONE,                                                                            \n"
        + "    VANAG.INDIRIZZO_SEDE_LEGALE AS SEDE_LEGALE,                                                                                              \n"
        + "   SC.CODICE_FISCALE || ' - ' || SC.COGNOME || ' ' || SC.NOME AS RAPPRESENTANTE_LEGALE     												  \n"
        + " FROM                                                                                                                                        \n"
        + "    SMRGAA_V_DATI_ANAGRAFICI VANAG,                                                                                                          \n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC                                  																		  \n"
        + " WHERE                                                                                                                                       \n"
        + "    VANAG.CUAA = :CUAA                                                                          											  \n"
        + "   AND VANAG.DATA_FINE_VALIDITA IS NULL 									  																  \n"
        + "   AND VANAG.DATA_CESSAZIONE IS NULL 									  																	  \n"
        // + " AND VANAG.ID_AZIENDA (+)= SC.ID_AZIENDA \n"
        + "   AND SC.ID_AZIENDA=VANAG.ID_AZIENDA				         		    																	  \n"
        + "   AND SC.ID_RUOLO = 1							         		    																		  \n"
        + "   AND SC.DATA_FINE_RUOLO IS NULL				         		    																		  \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("CUAA", cuaa, Types.VARCHAR);

      return queryForList(QUERY, mapParameterSource, AziendaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciVoltura(long idAzienda, long idProcedimentoOggetto,
      String note) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciVoltura]";

    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_W_PROCEDIMENTO_OGG_AZIEN            \n"
        + "   (                                         \n"
        + "     ID_PROCEDIMENTO_OGGETTO,                \n"
        + "     EXT_ID_AZIENDA,                  		\n"
        + "     NOTE			                  		\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_PROCEDIMENTO_OGGETTO,               \n"
        + "     :EXT_ID_AZIENDA                  		\n"
        + "     :NOTE			                  		\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AZIENDA", idAzienda, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AZIENDA", note, Types.VARCHAR);

      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idAzienda", idAzienda)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public AziendaDTO getAziendaById(long idAzienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAziendaById]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "SELECT                                                                                                                              	  \n"
        + "    VANAG.ID_AZIENDA,                                                                                                                    	  \n"
        + "    VANAG.CUAA,                                                                                                                              \n"
        + "    VANAG.DENOMINAZIONE,                                                                                                                     \n"
        + "    VANAG.INDIRIZZO_SEDE_LEGALE AS SEDE_LEGALE,                                                                                              \n"
        + "   SC.CODICE_FISCALE || ' - ' || SC.COGNOME || ' ' || SC.NOME AS RAPPRESENTANTE_LEGALE     											  	  \n"
        + " FROM                                                                                                                                        \n"
        + "    SMRGAA_V_DATI_ANAGRAFICI VANAG,                                                                                                          \n"
        + "   SMRGAA_V_SOGGETTI_COLLEGATI SC                                  																	 	  \n"
        + " WHERE                                                                                                                                       \n"
        + "    VANAG.ID_AZIENDA = :ID_AZIENDA                                                                          								  \n"
        + "   AND VANAG.DATA_FINE_VALIDITA IS NULL 									  																  \n"
        + "   AND VANAG.DATA_CESSAZIONE IS NULL 										  																  \n"
        + "   AND VANAG.ID_AZIENDA (+)= SC.ID_AZIENDA		         		    																  	  	  \n"
        + "   AND SC.ID_AZIENDA=VANAG.ID_AZIENDA				         		    																	  \n"
        + "   AND SC.ID_RUOLO = 1							         		    																		  \n"
        + "   AND SC.DATA_FINE_RUOLO IS NULL				         		    																		  \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_AZIENDA", idAzienda, Types.NUMERIC);

      return queryForObject(QUERY, mapParameterSource, AziendaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          (LogParameter[]) null,
          new LogVariable[]
          {}, QUERY, (MapSqlParameterSource) null);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isQuadroAttestazioneVisible(long idOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isQuadroAttestazioneVisible]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                          \n"
        + "   OI.ID_OGGETTO_ICONA                           \n"
        + " FROM                                            \n"
        + "   IUF_R_OGGETTO_ICONA OI,                       \n"
        + "   IUF_D_ELENCO_CDU EC                           \n"
        + " WHERE                                           \n"
        + "   OI.ID_OGGETTO = :ID_OGGETTO				  	  \n"
        + "   AND OI.ID_ELENCO_CDU = EC.ID_ELENCO_CDU       \n"
        + "   AND EC.CODICE_CDU = :CODICE_CDU               \n"
        + "   AND OI.FLAG_ATTESTAZIONE_CAA = 'S'            \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_OGGETTO", idOggetto, Types.NUMERIC);
      mapParameterSource.addValue("CODICE_CDU",
          IuffiConstants.USECASE.STAMPE_OGGETTO.GENERA_STAMPA_PRATICA,
          Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return Boolean.TRUE;
              }
              else
              {
                return Boolean.FALSE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idOggetto", idOggetto),
              new LogParameter("CODICE_CDU",
                  IuffiConstants.USECASE.STAMPE_OGGETTO.GENERA_STAMPA_PRATICA)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isUtenteConflitto(String codiceFiscale, String cuaaAzienda)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isUtenteConflitto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                             \n"
        + "   A.ID_UTENTE_IN_CONFLITTO                         \n"
        + " FROM                                               \n"
        + "   SMRGAA_V_UTENTE_CONFLITTO A                      \n"
        + " WHERE                                              \n"
        + "   A.CODICE_FISCALE_UTENTE = :CODICE_FISCALE_UTENTE \n"
        + "   AND A.CUAA_AZIENDA = :CUAA_AZIENDA               \n"
        + "   AND A.DATA_FINE_CONFLITTO IS NULL                \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CODICE_FISCALE_UTENTE", codiceFiscale,
          Types.VARCHAR);
      mapParameterSource.addValue("CUAA_AZIENDA", cuaaAzienda, Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return Boolean.TRUE;
              }
              else
              {
                return Boolean.FALSE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("codiceFiscale", codiceFiscale),
              new LogParameter("cuaaAzienda", cuaaAzienda)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ResponsabileDTO getResponsabileCAA(long idIntermediarioCAA,
      int idProcedimentoAgricolo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getResponsabileCAA]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                            \n"
        + "   A.RESPONSABILE AS DESCRIZIONE,       			\n"
        + "   A.CF_RESPONSABILE AS CODICE_FISCALE             \n"
        + " from                                              \n"
        + "   DB_RESPONSABILE_INTERMEDIARIO A                 \n"
        + " WHERE                                             \n"
        + "   A.ID_PROCEDIMENTO = " + idProcedimentoAgricolo
        + "	                          \n"
        + "   AND A.ID_INTERMEDIARIO = :ID_INTERMEDIARIO_ZONA \n"
        + "   AND A.DATA_FINE IS NULL                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_INTERMEDIARIO_ZONA", idIntermediarioCAA,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource, ResponsabileDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idIntermediarioCAA", idIntermediarioCAA)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public OrganismoDelegatoDTO getOrganismoDelegato(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getOrganismoDelegato]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                              \n"
        + "   A.ID_PROCEDIMENTO,                                \n"
        + "   A.EXT_ID_AMM_COMPETENZA,                          \n"
        + "   A.ID_PROCEDIM_AMMINISTRAZIONE,                          \n"
        + "   A.EXT_ID_UTENTE_AGGIORNAMENTO,                    \n"
        + "   A.EXT_ID_UFFICIO_ZONA AS ID_UFFICIO_ZONA,         \n"
        + "   A.EXT_ID_TECNICO,		                          \n"
        + "   B.DESCRIZIONE AS DESCRIZIONE_AMM,                 \n"
        + "   B.DENOMINAZIONE_1 AS DETTAGLIO_AMM,               \n"
        + "   B.RESPONSABILE,						              \n"
        + "   C.DENOMINAZIONE AS DESCR_UFF_ZONA,                \n"
        + "   T.COGNOME || ' ' || T.NOME AS DESCR_TECNICO       \n"

        + " FROM                                                \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO A,                 \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA B,                     \n"
        + "   DB_UFFICIO_ZONA C,                                \n"
        + "   DB_TECNICO T		                              \n"
        + " WHERE                                               \n"
        + "   A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO              \n"
        + "   AND A.EXT_ID_AMM_COMPETENZA = B.ID_AMM_COMPETENZA \n"
        + "   AND C.ID_UFFICIO_ZONA(+) = A.EXT_ID_UFFICIO_ZONA  \n"
        + "   AND T.ID_TECNICO(+) = A.EXT_ID_TECNICO			  \n"
        + "   AND A.DATA_FINE IS NULL                           \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          OrganismoDelegatoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<String>> getElencoUfficiZona(long idAmmCompetenza)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoUfficiZona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                      \n"
        + "   C.ID_UFFICIO_ZONA AS ID,                  \n"
        + "   C.ID_UFFICIO_ZONA AS CODICE,              \n"
        + "   C.DENOMINAZIONE AS DESCRIZIONE            \n"
        + " FROM                                        \n"
        + "   DB_UFFICIO_ZONA C                         \n"
        + " WHERE                                       \n"
        + "    C.ID_AMM_COMPETENZA = :ID_AMM_COMPETENZA \n"
        + " ORDER BY C.DENOMINAZIONE                       \n"
        + "                                             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_AMM_COMPETENZA", idAmmCompetenza,
        Types.NUMERIC);
    try
    {
      return queryForDecodificaString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idAmmCompetenza", idAmmCompetenza)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertOrganismoDelegato(long idProcedimento, long idAmmCompetenza,
      Long idUfficioZona, long extIdUtenteAggiornamento, String note,
      Long extIdTecnico)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertOrganismoDelegato]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO            \n"
        + "   (                                         \n"
        + "     ID_PROCEDIM_AMMINISTRAZIONE,            \n"
        + "     ID_PROCEDIMENTO,                        \n"
        + "     EXT_ID_AMM_COMPETENZA,                  \n"
        + "     DATA_INIZIO,                            \n"
        + "     EXT_ID_UFFICIO_ZONA,                    \n"
        + "     NOTE,                           		\n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO,            \n"
        + "     EXT_ID_TECNICO				            \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_PROCEDIM_AMMINISTR.NEXTVAL, \n"
        + "     :ID_PROCEDIMENTO,                       \n"
        + "     :EXT_ID_AMM_COMPETENZA,                 \n"
        + "     SYSDATE,                                \n"
        + "     :EXT_ID_UFFICIO_ZONA,                   \n"
        + "     :NOTE,                 					\n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO,           \n"
        + "     :EXT_ID_TECNICO            				\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AMM_COMPETENZA", idAmmCompetenza,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UFFICIO_ZONA", idUfficioZona,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_TECNICO", extIdTecnico,
          Types.NUMERIC);
      mapParameterSource.addValue("NOTE", note, Types.VARCHAR);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idAmmCompetenza", idAmmCompetenza),
              new LogParameter("idUfficioZona", idUfficioZona),
              new LogParameter("extIdTecnico", extIdTecnico),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean chiudiAmministrazioneProcedimento(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::chiudiAmministrazioneProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                      \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO            \n"
        + " SET                                         \n"
        + "   DATA_FINE       = SYSDATE                 \n"
        + " WHERE                                       \n"
        + "   ID_PROCEDIMENTO = :ID_PROCEDIMENTO        \n"
        + "   AND DATA_FINE IS NULL                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource) > 0;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RigaAnticipoLivello> getListAnticipoLivello(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "getListAnticipoLivello";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                   \n"
        + "   L.CODICE_LIVELLO,                                      \n"
        + "   AL.ID_ANTICIPO,                                        \n"
        + "   L.FLAG_ANTICIPO,                                       \n"
        + "   SUM(AL.IMPORTO_AMMESSO) AS IMPORTO_AMMESSO,            \n"
        + "   SUM(AL.IMPORTO_ANTICIPO) AS IMPORTO_ANTICIPO,          \n"
        + "   SUM(AL.IMPORTO_CONTRIBUTO) AS IMPORTO_CONTRIBUTO,      \n"
        + "   SUM(AL.IMPORTO_INVESTIMENTO) AS IMPORTO_INVESTIMENTO   \n"
        + " FROM                                                     \n"
        + "   IUF_R_ANTICIPO_LIVELLO AL,                             \n"
        + "   IUF_R_ANTICIPO_PROC_OGG APO,                           \n"
        + "   IUF_D_LIVELLO L                                        \n"
        + " WHERE                                                    \n"
        + "   APO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND APO.ID_ANTICIPO         = AL.ID_ANTICIPO           \n"
        + "   AND AL.ID_LIVELLO = L.ID_LIVELLO                       \n"
        + " GROUP BY                                                 \n"
        + "   L.CODICE_LIVELLO,                                      \n"
        + "   AL.ID_ANTICIPO,                                        \n"
        + "   L.FLAG_ANTICIPO                                        \n"
        + " ORDER BY                                                 \n"
        + "   MIN(L.ORDINAMENTO) ASC                                 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return queryForList(QUERY, mapParameterSource, RigaAnticipoLivello.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {
          // new LogParameter("idVariabile", idVariabile),
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public String getFlagControllo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getFlagControllo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                       		 \n"
        + "   FLAG_CONTROLLO											 \n"
        + " FROM                                                         \n"
        + "   IUF_T_CONTROLLO_IN_LOCO_INVE                             \n"
        + " WHERE                                                        \n"
        + "    ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO     	 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteRiduzioneUnsplit(String flag, long idProcedimentoOggetto,
      long idLivello) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteRiduzioneUnsplit]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String DELETE = " DELETE FROM IUF_T_PROC_OGGETTO_SANZIONE   POS                                 \n"
        + "        WHERE ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO		 		\n"
        + "		 AND ID_LIVELLO = :ID_LIVELLO										  	\n";

    if (flag != null && flag.compareTo("S") == 0)
      DELETE += "	AND  ID_SANZIONE_INVESTIMENTO = (SELECT  ID_SANZIONE_INVESTIMENTO FROM  IUF_D_SANZIONE_INVESTIMENTO WHERE CODICE_IDENTIFICATIVO = 'S01' )     \n";
    else
      DELETE += "	AND  ID_SANZIONE_INVESTIMENTO = (SELECT  ID_SANZIONE_INVESTIMENTO FROM  IUF_D_SANZIONE_INVESTIMENTO WHERE CODICE_IDENTIFICATIVO = 'S02' )     \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);

      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idLivello", idLivello)

          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public RiduzioniSanzioniDTO getRiduzioneSanzione(long idProcOggSanzione,
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getRiduzioneSanzione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "SELECT													\n"
        + " POS.ID_PROC_OGGETTO_SANZIONE as ID_PROC_OGG_SANZIONE,				\n"
        + "	TS.DESCRIZIONE AS TIPOLOGIA, 										\n"
        + "	L.CODICE AS OPERAZIONE, 											\n"
        + "	SI.DESCRIZIONE AS DESCRIZIONE, 										\n"
        + "	POS.NOTE AS NOTE, 													\n"
        + "	POS.IMPORTO AS IMPORTO_CURRENT,										\n"

        + "	(  SELECT 															\n"
        + "			SUM (IMPORTO) 												\n"
        + "		FROM 															\n"
        + "			IUF_T_PROC_OGGETTO_SANZIONE POS2,IUF_D_SANZIONE_INVESTIMENTO SI2	 							\n"
        + "		WHERE 															\n"
        + "			POS2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	 \n"
        + "			AND POS2.ID_SANZIONE_INVESTIMENTO = SI2.ID_SANZIONE_INVESTIMENTO 	 	 \n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = 3							 \n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = TS.ID_TIPOLOGIA_SANZIONE 	\n"
        + "			AND pos2.id_livello= pos.id_livello							\n"

        + "			) AS IMPORTO_TOT,											\n"
        + "	(  SELECT 															\n"
        + "			COUNT (*) 													\n"
        + "		FROM 															\n"
        + "			IUF_T_PROC_OGGETTO_SANZIONE POS2,IUF_D_SANZIONE_INVESTIMENTO SI2	 							\n"
        + "		WHERE 															\n"
        + "			POS2.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	 \n"
        + "			AND POS2.ID_SANZIONE_INVESTIMENTO = SI2.ID_SANZIONE_INVESTIMENTO 	 	 \n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = 3							 \n"
        + "			AND SI2.ID_TIPOLOGIA_SANZIONE = TS.ID_TIPOLOGIA_SANZIONE 	\n"
        + "			AND pos2.id_livello= pos.id_livello							\n"

        + "			) AS SPLITTED,												\n"
        + "	SI.ID_SANZIONE_INVESTIMENTO AS ID_DESCRIZIONE,						\n"
        + "	TS.ID_TIPOLOGIA_SANZIONE AS ID_TIPOLOGIA,							\n"
        + "	L.ID_LIVELLO AS ID_OPERAZIONE										\n"
        + "FROM     															\n"
        + "	 IUF_T_PROC_OGGETTO_SANZIONE POS, 									\n"
        + "	 IUF_D_SANZIONE_INVESTIMENTO SI,									\n"
        + "  IUF_D_LIVELLO L, 													\n"
        + "  IUF_D_TIPOLOGIA_SANZIONE TS    									\n"
        + "WHERE         														\n"
        + "  POS.ID_PROC_OGGETTO_SANZIONE = :ID_PROC_OGG_SANZIONE 			    \n"
        + "  AND L.ID_LIVELLO=POS.ID_LIVELLO									\n"
        + "  AND POS.ID_SANZIONE_INVESTIMENTO = SI.ID_SANZIONE_INVESTIMENTO 	\n"
        + "  AND TS.ID_TIPOLOGIA_SANZIONE = SI.ID_TIPOLOGIA_SANZIONE          	\n"
        + " ORDER BY POS.ID_PROC_OGGETTO_SANZIONE								\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROC_OGG_SANZIONE", idProcOggSanzione,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<RiduzioniSanzioniDTO>()
          {

            @Override
            public RiduzioniSanzioniDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              RiduzioniSanzioniDTO riduzione = new RiduzioniSanzioniDTO();

              while (rs.next())
              {
                riduzione
                    .setIdProcOggSanzione(rs.getLong("ID_PROC_OGG_SANZIONE"));
                riduzione.setDescrizione(rs.getString("DESCRIZIONE"));
                riduzione.setImporto(rs.getBigDecimal("IMPORTO_TOT"));
                riduzione
                    .setImportoFirstRecord(rs.getBigDecimal("IMPORTO_CURRENT"));
                riduzione.setNote(rs.getString("NOTE"));
                riduzione.setTipologia(rs.getString("TIPOLOGIA"));
                riduzione.setOperazione(rs.getString("OPERAZIONE"));
                riduzione.setIdDescrizione(rs.getLong("ID_DESCRIZIONE"));
                riduzione.setIdTipologia(rs.getLong("ID_TIPOLOGIA"));
                riduzione.setIdOperazione(rs.getLong("ID_OPERAZIONE"));
                return riduzione;

              }

              return riduzione;
            }

          });
    }

    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcOggSanzione", idProcOggSanzione),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getDescrizioneSanzioneSplit(String codice)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDescrizioneSanzioneSplit]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                       		 \n"
        + "   TS.DESCRIZIONE || ' - ' || SI.DESCRIZIONE					 \n"
        + " FROM                                                         \n"
        + "   IUF_D_TIPOLOGIA_SANZIONE TS,  				 	 		 \n"
        + "   IUF_D_SANZIONE_INVESTIMENTO SI  							 \n"
        + " WHERE                                                        \n"
        + "    SI.CODICE_IDENTIFICATIVO = :CODICE					     \n"
        + "	AND SI.ID_TIPOLOGIA_SANZIONE = TS.ID_TIPOLOGIA_SANZIONE		 \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CODICE", codice, Types.VARCHAR);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("codice", codice)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdDescrizioneSanzione(String codice)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdDescrizioneSanzione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                       		 \n"
        + "   ID_SANZIONE_INVESTIMENTO									 \n"
        + " FROM                                                         \n"
        + "   IUF_D_SANZIONE_INVESTIMENTO SI  							 \n"
        + " WHERE                                                        \n"
        + "    SI.CODICE_IDENTIFICATIVO = :CODICE					     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CODICE", codice, Types.VARCHAR);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("codice", codice)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isPraticheTrasmissibili(
      final List<String> vIdProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isPraticheTrasmissibili]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                                                                                                                                                                        \n"
        + "   PO.ID_PROCEDIMENTO                                                                                                                                                                                         \n"
        + " FROM                                                                                                                                                                                                          \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                                                                                                                                                                              \n"
        + "   IUF_T_PROCEDIMENTO P,                                                                                                                                                                                       \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO,                                                                                                                                                                            \n"
        + "   IUF_D_OGGETTO DO,                                                                                                                                                                                           \n"
        + "   SMRGAA_V_DATI_DELEGA DD,                                                                                                                                                                                    \n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PA,                                                                                                                                                                              \n"
        + "   IUF_D_ESITO DE,                                                                                                                                                                                             \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE IPO,                                                                                                                                                                         \n"
        + "   IUF_R_BANDO_OGGETTO BO,                                                                                                                                                                                     \n"
        + "   IUF_T_ELAB_MASSIVA EM,                                                                                                                                                                                      \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA AC,                                                                                                                                                                              \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PAM,                                                                                                                                                                         \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO PL,                                                                                                                                                                              \n"
        + "   IUF_D_LIVELLO DL,                                                                                                                                                                                           \n"
        + "   SMRGAA_V_DATI_ANAGRAFICI VDA,                                                                                                                                                                               \n"
        + "   SMRGAA_V_DATI_DELEGA VDE                                                                                                                                                                                    \n"
        + " WHERE                                                                                                                                                                                                         \n"
        + "   PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                                                                                                                                                                      \n";
    Vector<String> vIds = new Vector<String>(vIdProcedimentoOggetto);
    QUERY += " "
        + getInCondition("PO.ID_PROCEDIMENTO_OGGETTO",
            IuffiUtils.ARRAY.toVectorLong(vIds), true)
        + " ";
    QUERY += "   AND LGO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO                                                                                                                                              \n"
        + "   AND LGO.ID_OGGETTO = DO.ID_OGGETTO                                                                                                                                                                          \n"
        + "   AND DO.FLAG_ISTANZA = 'S'                                                                                                                                                                                   \n"
        + "   AND DO.CRITERIO_NUM_IDENTIFICATIVO IN ('##','**')                                                                                                                                                           \n"
        + "   AND PA.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                                                                                                                                                                  \n"
        + "   AND PA.DATA_FINE IS NULL                                                                                                                                                                                    \n"
        + "   AND PA.EXT_ID_AZIENDA = DD.ID_AZIENDA                                                                                                                                                                       \n"
        + "   AND DD.DATA_FINE_VALIDITA IS NULL                                                                                                                                                                           \n"
        + "   AND PO.DATA_FINE IS NOT NULL                                                                                                                                                                                \n"
        + "   AND PO.ID_ESITO = DE.ID_ESITO                                                                                                                                                                               \n"
        + "   AND DE.CODICE = 'P'                                                                                                                                                                                         \n"
        + "   AND IPO.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO                                                                                                                                                \n"
        + "   AND IPO.DATA_FINE IS NULL                                                                                                                                                                                   \n"
        + "   AND IPO.ID_STATO_OGGETTO < 10                                                                                                                                                                               \n"
        + "   AND BO.ID_BANDO = P.ID_BANDO                                                                                                                                                                                \n"
        + "   AND BO.FLAG_ATTIVO = 'S'                                                                                                                                                                                    \n"
        + "   AND BO.ID_LEGAME_GRUPPO_OGGETTO = LGO.ID_LEGAME_GRUPPO_OGGETTO                                                                                                                                              \n"
        + "   AND SYSDATE BETWEEN BO.DATA_INIZIO AND NVL(BO.DATA_RITARDO, NVL(BO.DATA_FINE, SYSDATE))                                                                                                                     \n"
        + "   AND NOT EXISTS (                                                                                                                                                                                            \n"
        + "       SELECT POS.ID_PROCEDIM_OGGETTO_STAMPA FROM IUF_T_PROCEDIM_OGGETTO_STAMP POS WHERE POS.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO AND POS.DATA_FINE IS NULL AND POS.ID_STATO_STAMPA IN (1, 8) \n"
        + "   )                                                                                                                                                                                                           \n"
        + "   AND EM.ID_PROCEDIMENTO_OGGETTO (+) = PO.ID_PROCEDIMENTO_OGGETTO                                                                                                                                             \n"
        + "   AND ( EM.TIPO_ELABORAZIONE IS NULL OR EM.TIPO_ELABORAZIONE = 'TRMAS' )                                                                                                                                                                         \n"
        + "   AND PAM.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                                                                                                                                                                 \n"
        + "   AND PAM.DATA_FINE IS NULL                                                                                                                                                                                   \n"
        + "   AND AC.ID_AMM_COMPETENZA (+) = PAM.EXT_ID_AMM_COMPETENZA                                                                                                                                                    \n"
        + "   AND PL.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                                                                                                                                                                  \n"
        + "   AND PL.ID_LIVELLO = DL.ID_LIVELLO                                                                                                                                                                           \n"
        + "   AND VDA.ID_AZIENDA = PA.EXT_ID_AZIENDA                                                                                                                                                                      \n"
        + "   AND VDA.DATA_FINE_VALIDITA IS NULL                                                                                                                                                                          \n"
        + "   AND VDE.ID_AZIENDA(+) = PA.EXT_ID_AZIENDA                                                                                                                                                                   \n"
        + "   AND VDE.DATA_FINE_VALIDITA IS NULL                                                                                                                                                                          \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              int count = 0;
              while (rs.next())
              {
                ++count;
              }

              if (count == vIdProcedimentoOggetto.size())
                return Boolean.TRUE;
              else
                return Boolean.FALSE;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isCodiceLivelloInvestimentoEsistente(long idProcedimento,
      String codiceLivello)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::isCodiceLivelloInvestimentoEsistente]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                      \n"
        + "   A.ID_PROCEDIMENTO                         \n"
        + " FROM                                        \n"
        + "   IUF_T_PROCEDIMENTO A,                     \n"
        + "   IUF_D_BANDO B,                            \n"
        + "   IUF_D_TIPO_LIVELLO C ,                    \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO D,             \n"
        + "   IUF_D_LIVELLO E                           \n"
        + " WHERE                                       \n"
        + "   A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO      \n"
        + "   AND A.ID_BANDO = B.ID_BANDO               \n"
        + "   AND B.ID_TIPO_LIVELLO = C.ID_TIPO_LIVELLO \n"
        + "   AND C.CODICE = 'I'                        \n"
        + "   AND D.ID_PROCEDIMENTO = A.ID_PROCEDIMENTO \n"
        + "   AND D.ID_LIVELLO = E.ID_LIVELLO           \n"
        + "   AND E.CODICE_LIVELLO = :CODICE_LIVELLO    \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("CODICE_LIVELLO", codiceLivello,
          Types.VARCHAR);

      Long l = queryForLong(QUERY, mapParameterSource);
      return l != null && l.longValue() > 0 ? true : false;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getAziendaRichiestaVoltura(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getAziendaRichiestaVoltura]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                  \n"
        + "   A.EXT_ID_AZIENDA                                      \n"
        + " FROM                                                    \n"
        + "   IUF_W_PROCEDIMENTO_OGG_AZIEN A                      \n"
        + " WHERE                                                   \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ProspettoEconomicoDTO> getProspettoEconomico(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getProspettoEconomico]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "WITH DOMANDE AS (" + getQueryDomanda(idProcedimento)
        + " ), 			\n";
    QUERY +=

        "   DOMANDA AS                                                             \n"
            + "   (                                                                      \n"
            + "     SELECT                                                               \n"
            + "       *                                                                  \n"
            + "     FROM                                                                 \n"
            + "       DOMANDE DOM                                                        \n"
            + "     WHERE                                                                \n"
            + "       DOM.ID_PROCEDIMENTO_OGGETTO IN                                     \n"
            + "       (                                                                  \n"
            + "         SELECT                                                           \n"
            + "           MAX(ID_PROCEDIMENTO_OGGETTO)                                   \n"
            + "         FROM                                                             \n"
            + "           (                                                              \n"
            + "             SELECT                                                       \n"
            + "                DOM2.ID_PROCEDIMENTO_OGGETTO,                              \n"
            + "                DOM2.CODICE_RAGGRUPPAMENTO                                 \n"
            + "              FROM                                                         \n"
            + "                DOMANDE DOM2,                                              \n"
            + "                IUF_T_RENDICONTAZIONE_SPESE RS                             \n"
            + "              WHERE                                                        \n"
            + "                DOM2.ID_PROCEDIMENTO_OGGETTO = RS.ID_PROCEDIMENTO_OGGETTO  \n"
            + "              UNION                                                        \n"
            + "              SELECT                                                       \n"
            + "                DOM2.ID_PROCEDIMENTO_OGGETTO,                              \n"
            + "                DOM2.CODICE_RAGGRUPPAMENTO                                 \n"
            + "              FROM                                                         \n"
            + "                DOMANDE DOM2,                                              \n"
            + "                IUF_R_ANTICIPO_PROC_OGG APO                                \n"
            + "              WHERE                                                        \n"
            + "                DOM2.ID_PROCEDIMENTO_OGGETTO = APO.ID_PROCEDIMENTO_OGGETTO \n"
            + "            )                                                              \n"
            + "            GROUP BY CODICE_RAGGRUPPAMENTO                                 \n"
            + "       )                                                                  \n"
            + "   )                                                                      \n"
            + " SELECT DISTINCT                                     					\n"
            + "   L.ID_LIVELLO,                                  							\n"
            + "	  L.ORDINAMENTO,                                  							\n"
            + "   L.CODICE || ' - ' || L.DESCRIZIONE AS OPERAZIONE,             			\n"
            + "   PL.CONTRIBUTO_CONCESSO,                                    				\n"
            + "   PO.CODICE_RAGGRUPPAMENTO,                                    				\n"
            + "   O.CAUSALE_PAGAMENTO AS TIPOLOGIA_DOMANDA_DI_PAGAMENTO,    				\n"
            + "   O.TIPO_PAGAMENTO_SIGOP,    												\n"
            + "   NVL(D.DATA_PRESENTAZIONE,  (	                          					\n"
            + "			SELECT                                            					\n"
            + "				DATA_INIZIO                                             		\n"
            + "			FROM                                             					\n"
            + "				IUF_T_ITER_PROCEDIMENTO_OGGE ITER                            	\n"
            + "			WHERE                                             					\n"
            + "				ITER.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO       \n"
            + "				AND ITER.DATA_FINE IS NULL                           		\n"
            + "			))AS DATA_PRESENTAZIONE,                                    		\n"
            + "     (	SELECT SOMMA FROM 													\n"
            + "			( SELECT                                           					\n"
            + "				L2.ID_LIVELLO AS LIV,		      								\n"
            + "				PO2.ID_PROCEDIMENTO_OGGETTO AS PROGG,     						\n"
            + "				SUM(POS.SANZIONI) AS SOMMA  		      						\n"
            + "			FROM                                             					\n"
            + "				IUF_R_PROCEDIMENTO_OGG_LIVEL POS,                         	\n"
            + "	  			IUF_T_PROCEDIMENTO_OGGETTO PO2,                         		\n"
            + "	  			IUF_T_procedimento P2,                         					\n"
            + "				IUF_R_PROCEDIMENTO_LIVELLO PL2,                          		\n"
            + "	  			IUF_D_LIVELLO L2		                                        \n"
            + "			WHERE                                             					\n"
            + "				PL2.ID_PROCEDIMENTO = P2.ID_PROCEDIMENTO       					\n"
            + "             AND PL2.ID_LIVELLO = L2.ID_LIVELLO       						\n"
            + "             AND P2.ID_PROCEDIMENTO = PO2.ID_PROCEDIMENTO       				\n"
            + "             AND POS.ID_PROCEDIMENTO_OGGETTO=PO2.ID_PROCEDIMENTO_OGGETTO		\n"
            + "             AND POS.ID_LIVELLO=L2.ID_LIVELLO								\n"
            + "			GROUP BY L2.ID_LIVELLO,PO2.ID_PROCEDIMENTO_OGGETTO                  \n"
            + "			)                   												\n"
            + "			WHERE                    											\n"
            + "				LIV = L.ID_LIVELLO  				                  			\n"
            + "				AND PROGG = PO.ID_PROCEDIMENTO_OGGETTO                 			\n"
            + "			)AS IMPORTO_RIDUZIONI_SANZIONI,		                    			\n"

            + "     (	SELECT SOMMA FROM 													\n"
            + "			( SELECT                                           					\n"
            + "				L2.ID_LIVELLO AS LIV,          									\n"
            + "				PO2.ID_PROCEDIMENTO_OGGETTO AS PROGG,  							\n"
            + "				SUM(IL.IMPORTO_LIQUIDATO) AS SOMMA          					\n"
            + "			FROM                                             					\n"
            + "				IUF_T_IMPORTI_LIQUIDATI IL,	         	                		\n"
            + "	  			IUF_T_PROCEDIMENTO_OGGETTO PO2,                         		\n"
            + "	  			IUF_T_PROCEDIMENTO P2,                         					\n"
            + "				IUF_R_PROCEDIMENTO_LIVELLO PL2,                          		\n"
            + "	  			IUF_D_LIVELLO L2		                                        \n"
            + "			WHERE                                             					\n"
            + "				PL2.ID_PROCEDIMENTO = P2.ID_PROCEDIMENTO       					\n"
            + "             AND PL2.ID_LIVELLO = L2.ID_LIVELLO       						\n"
            + "             AND P2.ID_PROCEDIMENTO = PO2.ID_PROCEDIMENTO       				\n"
            + "             AND IL.ID_PROCEDIMENTO_OGGETTO=PO2.ID_PROCEDIMENTO_OGGETTO		\n"
            + "             AND IL.ID_LIVELLO=L2.ID_LIVELLO									\n"
            + "			GROUP BY L2.ID_LIVELLO,PO2.ID_PROCEDIMENTO_OGGETTO                  \n"
            + "			)                   												\n"
            + "			WHERE                    											\n"
            + "				LIV = L.ID_LIVELLO  				                  			\n"
            + "				AND PROGG = PO.ID_PROCEDIMENTO_OGGETTO                 			\n"
            + "			)AS IMPORTO_LIQUIDATO,     					               			\n"

            + "     (	SELECT SOMMA FROM 													\n"
            + "			( SELECT                                           					\n"
            + "				L2.ID_LIVELLO AS LIV,   										\n"
            + "				PO2.ID_PROCEDIMENTO_OGGETTO AS PROGG,							\n"
            + "				SUM(POL.CONTRIBUTO_NON_EROGABILE) AS SOMMA   					\n"
            + "			FROM                                             					\n"
            + "				IUF_R_PROCEDIMENTO_OGG_LIVEL POL,                        		\n"
            + "	  			IUF_T_PROCEDIMENTO_OGGETTO PO2,                         		\n"
            + "	  			IUF_T_procedimento P2,                         					\n"
            + "				IUF_R_PROCEDIMENTO_LIVELLO PL2,                          		\n"
            + "	  			IUF_D_LIVELLO L2		                                        \n"
            + "			WHERE                                             					\n"
            + "				PL2.ID_PROCEDIMENTO = P2.ID_PROCEDIMENTO       					\n"
            + "             AND PL2.ID_LIVELLO = L2.ID_LIVELLO       						\n"
            + "             AND P2.ID_PROCEDIMENTO = PO2.ID_PROCEDIMENTO       				\n"
            + "             AND POL.ID_PROCEDIMENTO_OGGETTO=PO2.ID_PROCEDIMENTO_OGGETTO		\n"
            + "             AND POL.ID_LIVELLO=L2.ID_LIVELLO								\n"
            + "			GROUP BY L2.ID_LIVELLO,PO2.ID_PROCEDIMENTO_OGGETTO     				\n"
            + "			)                   												\n"
            + "			WHERE                    											\n"
            + "				LIV = L.ID_LIVELLO  				                  			\n"
            + "				AND PROGG = PO.ID_PROCEDIMENTO_OGGETTO                 			\n"
            + "			)AS ECONOMIA,						                    			\n"

            + "			(SELECT                    											\n"
            + "				CONTRIBUTO_RISPENDIBILE	                   						\n"
            + "			 FROM                    											\n"
            + "				IUF_R_PROCEDIMENTO_OGG_LIVEL POL2                    			\n"
            + "			 WHERE                    											\n"
            + "				POL2.ID_LIVELLO = L.ID_LIVELLO						            \n"
            + "				AND POL2.ID_PROCEDIMENTO_OGGETTO  = PO.ID_PROCEDIMENTO_OGGETTO	\n"
            + "			)AS CONTR_NON_RICH,					                    			\n"
            + "     (SELECT                                         \n"
            + "       CONTRIBUTO_SANZIONABILE                               \n"
            + "      FROM                                         \n"
            + "       IUF_R_PROCEDIMENTO_OGG_LIVEL POL2                         \n"
            + "      WHERE                                          \n"
            + "       POL2.ID_LIVELLO = L.ID_LIVELLO                        \n"
            + "       AND POL2.ID_PROCEDIMENTO_OGGETTO  = PO.ID_PROCEDIMENTO_OGGETTO  \n"
            + "     )AS CONTR_SANZ,                                   \n"

            + "			D.CONTRIBUTO_RICHIESTO_ANTICIPO AS CONTRIBUTO_RICHIESTO,   			\n"
            + "			D.CONTR_RICHIESTO_ACCONTO_SALDO	AS CONTRIBUTO_RENDICONTATO 			\n"
            + " FROM                                               							\n"
            + "     IUF_T_PROCEDIMENTO_OGGETTO PO,                  						\n"
            + "		IUF_R_LEGAME_GRUPPO_OGGETTO LGO,           								\n"
            + "		IUF_T_PROCEDIMENTO P,                   								\n"
            + " 	IUF_D_OGGETTO O,               											\n"
            + "		IUF_D_LIVELLO L,                  										\n"
            + "		DOMANDA D,		                  										\n"
            + "		IUF_R_PROCEDIMENTO_LIVELLO PL                   						\n"
            + " WHERE                                               						\n"
            + "     PO.ID_PROCEDIMENTO_OGGETTO IN ("
            + " SELECT                                                      \n"
            + "   POG.ID_PROCEDIMENTO_OGGETTO                      \n"
            + " FROM                                 \n"
            + "  IUF_D_GRUPPO_OGGETTO GOG,                       \n"
            + "  IUF_R_LEGAME_GRUPPO_OGGETTO LGOG,                 \n"
            + "  IUF_D_OGGETTO OG,                           \n"
            + "  IUF_T_PROCEDIMENTO PG,                        \n"
            + "  IUF_T_PROCEDIMENTO_OGGETTO POG,                   \n"
            + "  IUF_D_ESITO EG                            \n"
            + "WHERE                                   \n"
            + "  GOG.ID_GRUPPO_OGGETTO = LGOG.ID_GRUPPO_OGGETTO            \n"
            + "  AND LGOG.ID_OGGETTO = OG.ID_OGGETTO                 \n"
            + "  AND LGOG.ID_LEGAME_GRUPPO_OGGETTO = POG.ID_LEGAME_GRUPPO_OGGETTO  \n"
            + "  AND POG.ID_PROCEDIMENTO = PG.ID_PROCEDIMENTO            \n"
            + "  AND PG.ID_PROCEDIMENTO = :ID_PROCEDIMENTO             \n"
            + "  AND OG.TIPO_PAGAMENTO_SIGOP IS NOT NULL               \n"
            + "  AND POG.ID_ESITO = EG.ID_ESITO                    \n"
            + "  AND EG.CODICE = 'APP-P'                 \n"
            + "  AND EG.TIPO_ESITO = 'O'                                     \n"
            + ")					\n"
            + "   	AND LGO.ID_OGGETTO = O.ID_OGGETTO                    					\n"
            + "   	AND LGO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO          \n"
            + "   	AND O.FLAG_ISTANZA = 'N'		            							\n"
            + "   	AND PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                  			\n"
            + "   	AND P.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                				\n"
            + "   	AND PL.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                   			\n"
            + "   	AND L.ID_LIVELLO = PL.ID_LIVELLO                   						\n"
            + " 	AND O.TIPO_PAGAMENTO_SIGOP IS NOT NULL									\n"
            + " 	AND D.CODICE_RAGGRUPPAMENTO (+) = PO.CODICE_RAGGRUPPAMENTO				\n"
            + " 	AND (D.ID_LIVELLO IS NULL OR D.ID_LIVELLO = L.ID_LIVELLO)				\n"
            + " ORDER BY 							             							\n"
            + "   L.ORDINAMENTO ASC, DATA_PRESENTAZIONE										\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<ProspettoEconomicoDTO>>()
          {

            @Override
            public List<ProspettoEconomicoDTO> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<ProspettoEconomicoDTO> list = new ArrayList<ProspettoEconomicoDTO>();
              Long lastKey = null;
              List<DomandaPagamentoProspettoEconomicoDTO> records = null;
              while (rs.next())
              {
                long idLivello = rs.getLong("ID_LIVELLO");
                if (lastKey == null || lastKey != idLivello)
                {
                  ProspettoEconomicoDTO prospetto = null;
                  prospetto = new ProspettoEconomicoDTO();
                  prospetto.setIdLivello(idLivello);
                  prospetto.setOperazione(rs.getString("OPERAZIONE"));

                  records = new ArrayList<>();
                  prospetto.setRecords(records);
                  list.add(prospetto);
                  lastKey = idLivello;
                }

                DomandaPagamentoProspettoEconomicoDTO domanda = new DomandaPagamentoProspettoEconomicoDTO();

                domanda.setTipologiaDomandaDiPagamento(
                    rs.getString("TIPOLOGIA_DOMANDA_DI_PAGAMENTO"));
                domanda.setTipoPagamentoSigop(
                    rs.getString("TIPO_PAGAMENTO_SIGOP"));
                domanda.setContributoConcesso(
                    rs.getBigDecimal("CONTRIBUTO_CONCESSO"));
                domanda
                    .setImportoLiquidato(rs.getBigDecimal("IMPORTO_LIQUIDATO"));
                domanda.setImportoRiduzioniSanzioni(
                    rs.getBigDecimal("IMPORTO_RIDUZIONI_SANZIONI"));
                domanda.setEconomia(rs.getBigDecimal("ECONOMIA"));
                domanda.setDataPresentazione(rs.getDate("DATA_PRESENTAZIONE"));
                domanda.setContributoRichiesto(
                    rs.getBigDecimal("CONTRIBUTO_RICHIESTO"));
                domanda.setContributoRendicontato(
                    rs.getBigDecimal("CONTRIBUTO_RENDICONTATO"));
                domanda.setContributoNonRiconosciutoNonSanzionabile(
                    rs.getBigDecimal("CONTR_NON_RICH"));
                domanda
                    .setContributoSanzionabile(rs.getBigDecimal("CONTR_SANZ"));

                records.add(domanda);
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  private String getQueryDomanda(long idProcedimento)
  {

    String codiciRaggruppamento = getInnerQueryCodiciRaggruppamento(
        idProcedimento);

    String QUERY = " SELECT DISTINCT                                     					\n"
        + "	  PO.ID_PROCEDIMENTO_OGGETTO ,                                  				\n"
        + "	  L.ID_LIVELLO ,                                               				\n"
        + "   L.CODICE || ' - ' || L.DESCRIZIONE AS OPERAZIONE,             			\n"
        + "   PL.CONTRIBUTO_CONCESSO,                                    				\n"
        + "   PO.CODICE_RAGGRUPPAMENTO,                                    				\n"
        + "     (	SELECT                                            					\n"
        + "				DATA_INIZIO                                             		\n"
        + "			FROM                                             					\n"
        + "				IUF_T_ITER_PROCEDIMENTO_OGGE ITER                            	\n"
        + "			WHERE                                             					\n"
        + "				ITER.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO       \n"
        + "				AND ITER.ID_STATO_OGGETTO= 10                           		\n"
        + "			)AS DATA_PRESENTAZIONE,                                   			\n"
        + "     (	SELECT                                            					\n"
        + "				ALIV.IMPORTO_ANTICIPO	                                        \n"
        + "			FROM                                             					\n"
        + "				IUF_R_ANTICIPO_PROC_OGG APO,		                            \n"
        + "				IUF_T_ANTICIPO ANT,					                            \n"
        + "				IUF_R_ANTICIPO_LIVELLO  ALIV		                            \n"
        + "			WHERE                                             					\n"
        + "				APO.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO        \n"
        + "				AND ALIV.ID_LIVELLO= L.ID_LIVELLO      		              		\n"
        + "				AND ANT.ID_PROCEDIMENTO= PO.ID_PROCEDIMENTO              		\n"
        + "				AND ANT.ID_ANTICIPO= ALIV.ID_ANTICIPO  		              		\n"
        + "				AND ANT.ID_STATO_OGGETTO = 17            	              		\n"
        + "			)AS CONTRIBUTO_RICHIESTO_ANTICIPO,                         			\n"
        + "     (	SELECT SOMMA FROM 													\n"
        + "			( SELECT                                           					\n"
        + "				L2.ID_LIVELLO AS LIV,     					  					\n"
        + "				PO2.ID_PROCEDIMENTO_OGGETTO AS PROGG,      						\n"
        + "				SUM(REND.CONTRIBUTO_RICHIESTO) AS SOMMA      					\n"
        + "			FROM                                             					\n"
        + "				IUF_T_RENDICONTAZIONE_SPESE REND,                         		\n"
        + "	  			IUF_T_PROCEDIMENTO_OGGETTO PO2,                         		\n"
        + "	  			IUF_T_procedimento P2,                         					\n"
        + "				IUF_R_PROCEDIMENTO_LIVELLO PL2,                          		\n"
        + "   			IUF_R_LIV_BANDO_INTERVENTO LBI,                                 \n"
        + "   			IUF_T_INTERVENTO I,                                             \n"
        + "   			IUF_D_DESCRIZIONE_INTERVENTO DESCINT,                           \n"
        + "	  			IUF_D_LIVELLO L2		                                        \n"
        + "			WHERE                                             					\n"
        + "				PL2.ID_PROCEDIMENTO = P2.ID_PROCEDIMENTO       					\n"
        + "             AND PL2.ID_LIVELLO = L2.ID_LIVELLO       						\n"
        + "             AND P2.ID_PROCEDIMENTO = PO2.ID_PROCEDIMENTO       				\n"
        + "   			AND LBI.ID_DESCRIZIONE_INTERVENTO = DESCINT.ID_DESCRIZIONE_INTERVENTO           \n"
        + "   			AND LBI.ID_LIVELLO = L2.ID_LIVELLO							                    \n"
        + "   			AND REND.ID_INTERVENTO = I.ID_INTERVENTO							            \n"
        + "   			AND DESCINT.ID_DESCRIZIONE_INTERVENTO = I.ID_DESCRIZIONE_INTERVENTO				\n"
        + "   			AND LBI.ID_BANDO = P2.ID_BANDO													\n"
        + "             AND REND.ID_PROCEDIMENTO_OGGETTO=PO2.ID_PROCEDIMENTO_OGGETTO	\n"
        + "			GROUP BY L2.ID_LIVELLO,PO2.ID_PROCEDIMENTO_OGGETTO                  \n"
        + "			)                   												\n"
        + "			WHERE                    											\n"
        + "				LIV = L.ID_LIVELLO  				                  			\n"
        + "				AND PROGG = PO.ID_PROCEDIMENTO_OGGETTO  	        			\n"
        + "			)AS CONTR_RICHIESTO_ACCONTO_SALDO 		                   			\n"
        + " FROM                                               							\n"
        + "     IUF_T_PROCEDIMENTO_OGGETTO PO,                  						\n"
        + "		IUF_R_LEGAME_GRUPPO_OGGETTO LGO,           								\n"
        + "		IUF_T_PROCEDIMENTO P,                   								\n"
        + " 	IUF_D_OGGETTO O,               											\n"
        + "		IUF_D_LIVELLO L,                  										\n"
        + "		IUF_R_PROCEDIMENTO_LIVELLO PL                   						\n"
        + " WHERE                                               						\n"
        + "     PO.CODICE_RAGGRUPPAMENTO IN (" + codiciRaggruppamento
        + ")				\n"
        + "   	AND LGO.ID_OGGETTO = O.ID_OGGETTO                    					\n"
        + "   	AND LGO.ID_LEGAME_GRUPPO_OGGETTO = PO.ID_LEGAME_GRUPPO_OGGETTO          \n"
        + "   	AND O.FLAG_ISTANZA = 'S'		             							\n"
        + "   	AND PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                  			\n"
        + "   	AND P.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                				\n"
        + "   	AND PL.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO                   			\n"
        + "   	AND L.ID_LIVELLO = PL.ID_LIVELLO                   						\n"
        + " ORDER BY 							             							\n"
        + "   L.ID_LIVELLO, DATA_PRESENTAZIONE											\n";

    return QUERY;
  }

  private String getInnerQueryCodiciRaggruppamento(long idProcedimento)
  {

    String QUERY = " SELECT                                             					\n"
        + "   POG.CODICE_RAGGRUPPAMENTO											\n"
        + " FROM																	\n"
        + "	IUF_D_GRUPPO_OGGETTO GOG, 											\n"
        + "	IUF_R_LEGAME_GRUPPO_OGGETTO LGOG,									\n"
        + "	IUF_D_OGGETTO OG, 													\n"
        + "	IUF_T_PROCEDIMENTO PG, 												\n"
        + "	IUF_T_PROCEDIMENTO_OGGETTO POG, 									\n"
        + "	IUF_D_ESITO EG														\n"
        + "WHERE 																	\n"
        + "	GOG.ID_GRUPPO_OGGETTO = LGOG.ID_GRUPPO_OGGETTO						\n"
        + "	AND LGOG.ID_OGGETTO = OG.ID_OGGETTO									\n"
        + "	AND LGOG.ID_LEGAME_GRUPPO_OGGETTO = POG.ID_LEGAME_GRUPPO_OGGETTO	\n"
        + "	AND POG.ID_PROCEDIMENTO = PG.ID_PROCEDIMENTO						\n"
        + "	AND PG.ID_PROCEDIMENTO = :ID_PROCEDIMENTO							\n"
        + "	AND OG.TIPO_PAGAMENTO_SIGOP IS NOT NULL								\n"
        + "	AND POG.ID_ESITO = EG.ID_ESITO										\n"
        + "	AND EG.CODICE = 'APP-P'									\n"
        + "	AND EG.TIPO_ESITO = 'O'              				              	\n";
    return QUERY;
  }

  public void clearSuperficieRinuncia(long idParticellaUtilizzo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::clearSuperficieRinuncia]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " UPDATE IUF_T_PARTICELLA_UTILIZZO 						 \n"
        + " SET SUPERFICIE_RINUNCIATA = NULL 						     \n"
        + " WHERE ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateSuperficieRinuncia(long idParticellaUtilizzo,
      BigDecimal superficieRinunciata) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateSuperficieRinuncia]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " UPDATE IUF_T_PARTICELLA_UTILIZZO 						 \n"
        + " SET SUPERFICIE_RINUNCIATA = :SUPERFICIE_RINUNCIATA      \n"
        + " WHERE ID_PARTICELLA_UTILIZZO = :ID_PARTICELLA_UTILIZZO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PARTICELLA_UTILIZZO",
          idParticellaUtilizzo, Types.NUMERIC);
      mapParameterSource.addValue("SUPERFICIE_RINUNCIATA", superficieRinunciata,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idParticellaUtilizzo", idParticellaUtilizzo),
              new LogParameter("superficieRinunciata", superficieRinunciata)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<IntegrazioneAlPremioDTO> getIntegrazioneAlPremio(
      long idProcedimento, long idProcedimentoOggetto, List<Long> ids)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIntegrazioneAlPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT 		                                     				\n"
        + "   L.ID_LIVELLO ,                                               				\n"
        + "   L.CODICE || ' - ' || L.DESCRIZIONE AS OPERAZIONE,             			\n"
        + "   PL.CONTRIBUTO_CONCESSO AS CONTRIBUTO_CONCESSO,                 			\n"
        + "   PL.CONTRIBUTO_EROGABILE AS TOTALE_LIQUIDATO,                              \n"
        + "   PL.CONTRIBUTO_NON_EROGABILE AS ECONOMIE,							    	\n"
        + "    (SELECT 																	\n"
        + "       CONTRIBUTO_EROGABILE 													\n"
        + "     FROM    																\n"
        + "       IUF_R_PROCEDIMENTO_OGG_LIVEL POL									\n"
        + "     WHERE																	\n"
        + "       POL.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO				\n"
        + "       AND POL.ID_LIVELLO = L.ID_LIVELLO										\n"
        + "     ) AS CONTRIBUTO_INTEGRAZIONE,											\n"
        + "    (SELECT 																	\n"
        + "       SANZIONI*(-1)															\n"
        + "     FROM    																\n"
        + "       IUF_R_PROCEDIMENTO_OGG_LIVEL POL									\n"
        + "     WHERE																	\n"
        + "       POL.ID_PROCEDIMENTO_OGGETTO = PO.ID_PROCEDIMENTO_OGGETTO				\n"
        + "       AND POL.ID_LIVELLO = L.ID_LIVELLO										\n"
        + "     ) AS CONTRIBUTO_RIDUZIONI_SANZIONI,										\n"
        + "    (SELECT 																	\n"
        + "       nvl(SUM(IMPORTO),0)													\n"
        + "     FROM    																\n"
        + "       IUF_T_PROC_OGGETTO_SANZIONE POL										\n"
        + "     WHERE																	\n"
        + "       POL.ID_PROCEDIMENTO_OGGETTO  IN 										\n"
        + "		(																		\n"
        + "			SELECT  PO2.ID_PROCEDIMENTO_OGGETTO									\n"
        + "			FROM																\n"
        + "			IUF_T_PROCEDIMENTO P2, IUF_T_PROCEDIMENTO_OGGETTO PO2 , IUF_D_ESITO EG				\n"
        + " 		WHERE P2.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO						\n"
        + "			AND PO2.ID_ESITO = EG.ID_ESITO 										\n"
        + "			AND EG.CODICE = 'APP-P'												\n"
        + "			AND EG.TIPO_ESITO = 'O'												\n"
        + "			 AND PO2.ID_PROCEDIMENTO = P2.ID_PROCEDIMENTO						\n"
        + "		)																		\n"
        + "       AND POL.ID_LIVELLO = L.ID_LIVELLO										\n"
        + "     ) AS MAX_RIDUZIONI_SANZIONI												\n"
        + "   FROM    																	\n"
        + "		IUF_R_PROCEDIMENTO_LIVELLO PL,                   						\n"
        + "		IUF_D_LIVELLO L,				                   						\n"
        + "   	IUF_T_PROCEDIMENTO P,    												\n"
        + "   	IUF_T_PROCEDIMENTO_OGGETTO PO 											\n"
        + "   WHERE    																	\n"
        + "		PL.ID_LIVELLO = L.ID_LIVELLO	                   						\n"
        + "		AND PL.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO             					\n"
        + "		AND PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO             					\n"
        + "		AND P.ID_PROCEDIMENTO = :ID_PROCEDIMENTO             					\n"
        + "		AND PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO				\n";
    if (ids != null)
      QUERY += getInCondition("L.ID_LIVELLO", ids);

    QUERY += "   ORDER BY 																\n"
        + "		L.ORDINAMENTO ASC														\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);

      return queryForList(QUERY, mapParameterSource,
          IntegrazioneAlPremioDTO.class);

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateIntegrazioneAlPremio(Long idLivello,
      long idProcedimentoOggetto, BigDecimal importo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateIntegrazioneAlPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                       			\n"
        + "   IUF_R_PROCEDIMENTO_OGG_LIVEL                              	\n"
        + " SET                                                           	\n"
        + "   CONTRIBUTO_EROGABILE = :IMPORTO,                       		\n"
        + "   CONTRIBUTO_NON_EROGABILE = :IMPORTO2                     		\n"
        + " WHERE                                                        	\n"
        + "   ID_LIVELLO = :ID_LIVELLO          							\n"
        + "   AND ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO        \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO", importo, Types.DECIMAL);
      mapParameterSource.addValue("IMPORTO2", importo.negate(), Types.DECIMAL);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idLivello", idLivello)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertIntegrazioneAlPremio(Long idLivello,
      long idProcedimentoOggetto, BigDecimal importo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertIntegrazioneAlPremio]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      		\n"
        + " INTO                                        \n"
        + "   IUF_R_PROCEDIMENTO_OGG_LIVEL            \n"
        + "   (                                         \n"
        + "     ID_PROCEDIMENTO_OGGETTO,          		\n"
        + "     ID_LIVELLO,                    		    \n"
        + "     CONTRIBUTO_EROGABILE,                   \n"
        + "     CONTRIBUTO_NON_EROGABILE, 	            \n"
        + "     CONTRIBUTO_CALCOLATO, 	            	\n"
        + "     CONTRIBUTO_ABBATTUTO, 	            	\n"
        + "     CONTRIBUTO_SANZIONABILE, 	            \n"
        + "     CONTRIBUTO_RISPENDIBILE	 	            \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_PROCEDIMENTO_OGGETTO,               \n"
        + "     :ID_LIVELLO,                 			\n"
        + "     :IMPORTO,                               \n"
        + "     :IMPORTO2,0,0,0,0      					\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO", importo, Types.DECIMAL);
      mapParameterSource.addValue("IMPORTO2", importo.negate(), Types.DECIMAL);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idLivello", idLivello)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean existRecordInIUF_R_PROC_OGG_LIV(long idProcedimentoOggetto,
      Long idLivello)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::existRecordInIUF_R_PROC_OGG_LIV]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                          			\n"
        + "   COUNT(*)                                     			\n"
        + " FROM                                           			\n"
        + "   IUF_R_PROCEDIMENTO_OGG_LIVEL               			\n"
        + " WHERE                                          			\n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	\n"
        + "   AND ID_LIVELLO = :ID_LIVELLO 							\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) == 0; // Posso inserire se
                                                           // non c' gi il
                                                           // record presente
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isAmmissioneFuoriLinea(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isAmmissioneFuoriLinea]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                 \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO                            \n"
        + " FROM                                                   \n"
        + "   IUF_T_ESITO_TECNICO  A,                                \n"
        + "   IUF_D_TIPO_ATTO B                                    \n"
        + " WHERE                                                  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND A.ID_TIPO_ATTO = B.ID_TIPO_ATTO                  \n"
        + "   AND B.FLAG_ALTRE_INFO = 'S'                          \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getProcedimentoOggEstrattoCampioneDescr(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimentoOggEstrattoCampioneDescr]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT                                                          \n"
        + "    FE.DESCRIZIONE                                                \n"
        + "   FROM                                                           \n"
        + "    IUF_T_PROCEDIMENTO_ESTRATTO PE,                               \n"
        + "    IUF_T_ESTRAZIONE_CAMPIONE EC,                                 \n"
        + "    IUF_D_TIPO_ESTRAZIONE TE,                                     \n"
        + "    IUF_T_PROCEDIMENTO_OGGETTO PO,                                \n"
        + "    IUF_D_FLAG_ESTRATTA FE                                        \n"
        + "   WHERE                                                          \n"
        + "    PO.ID_PROCEDIMENTO_OGGETTO       =:ID_PROCEDIMENTO_OGGETTO    \n"
        + "    AND PE.ID_PROCEDIMENTO_OGGETTO   = PO.ID_PROCEDIMENTO_OGGETTO \n"
        + "    AND EC.ID_ESTRAZIONE_CAMPIONE    = PE.ID_ESTRAZIONE_CAMPIONE  \n"
        + "    AND EC.ID_TIPO_ESTRAZIONE        = TE.ID_TIPO_ESTRAZIONE      \n"
        + "    AND EC.FLAG_APPROVATA            = 'S'                        \n"
        + "    AND EC.DATA_ANNULLAMENTO IS NULL                              \n"
        + "    AND FE.FLAG_ESTRATTA = PE.FLAG_ESTRATTA                       \n"
        + "    AND FE.FLAG_ESTRATTA <> 'N'                                   \n"
        + "                                                                  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<String>()
          {
            @Override
            public String extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return rs.getString("DESCRIZIONE");
              }

              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getProcedimentoEstrattoCampioneDescr(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimentoEstrattoCampioneDescr]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                        \n"
        + "  FE.DESCRIZIONE                                               \n"
        + " FROM                                                          \n"
        + "  IUF_T_PROCEDIMENTO_ESTRATTO PE,                              \n"
        + "  IUF_T_ESTRAZIONE_CAMPIONE EC,                                \n"
        + "  IUF_D_FLAG_ESTRATTA FE                                       \n"
        + " WHERE                                                         \n"
        + "   PE.ID_PROCEDIMENTO           = :ID_PROCEDIMENTO             \n"
        + "  AND EC.ID_ESTRAZIONE_CAMPIONE    = PE.ID_ESTRAZIONE_CAMPIONE \n"
        + "  AND EC.FLAG_APPROVATA            = 'S'                       \n"
        + "  AND EC.DATA_ANNULLAMENTO IS NULL                             \n"
        + "  AND FE.FLAG_ESTRATTA = PE.FLAG_ESTRATTA                      \n"
        + "  AND FE.FLAG_ESTRATTA <> 'N'                     \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<String>()
          {
            @Override
            public String extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return rs.getString("DESCRIZIONE");
              }

              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public ProcedimentoDTO getIterProcedimento(long idProcedimento,
      long codiceRaggruppamento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIterProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                          \n"
        + "   A.ID_PROCEDIMENTO,                                           \n"
        + "   A.IDENTIFICATIVO,                                            \n"
        + "   G.DESCRIZIONE AS DESCR_STATO_OGGETTO_PROC,			       \n"
        + "   D.DESCRIZIONE AS DESCR_GRUPPO_OGGETTO,                       \n"
        + "   F.DESCRIZIONE AS DESCR_ITER,                                 \n"
        + "   DO.DESCRIZIONE AS DESCR_OGGETTO,                             \n"
        + "   DO.ID_OGGETTO,					                           \n"
        + "   DO.CODICE AS COD_OGGETTO,  		                           \n"
        + "   B.ID_PROCEDIMENTO_OGGETTO,                                   \n"
        + "   B.IDENTIFICATIVO AS IDENTIF_PROC_OGG,                        \n"
        + "   E.DATA_INIZIO AS ITER_DATA_INIZ,                             \n"
        + "   E.ID_ITER_PROCEDIMENTO_OGGETT,                               \n"
        + "   E.ID_STATO_OGGETTO AS ITER_ID_STATO_OGGETTO,                 \n"
        + "   E.EXT_ID_UTENTE_AGGIORNAMENTO  AS ITER_ID_UTENTE,            \n"
        + "   E.NOTE,													   \n"
        + "   B.CODICE_RAGGRUPPAMENTO,                                     \n"
        + "   VD.DENOMINAZIONE AS DENOMINAZIONE_DELEGA           		   \n"
        + " FROM                                                           \n"
        + "   IUF_T_PROCEDIMENTO A,                                        \n"
        + "   IUF_D_STATO_OGGETTO G,                                       \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO B,                                \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO C,                               \n"
        + "   IUF_D_GRUPPO_OGGETTO D,                                      \n"
        + "   IUF_D_OGGETTO DO,                                     	   \n"
        + "   IUF_T_ITER_PROCEDIMENTO_OGGE E,                            \n"
        + "   IUF_D_STATO_OGGETTO F,									   \n"
        + "   SMRGAA_V_DATI_DELEGA VD,									   \n"
        + "    IUF_T_PROCEDIMENTO_AZIENDA PA                        	   \n"
        + " WHERE                                                          \n"
        + "   A.ID_PROCEDIMENTO = B.ID_PROCEDIMENTO                        \n"
        + "   AND B.ID_LEGAME_GRUPPO_OGGETTO = C.ID_LEGAME_GRUPPO_OGGETTO  \n"
        + "   AND B.CODICE_RAGGRUPPAMENTO = :CODICE_RAGGRUPPAMENTO		   \n"
        + "   AND C.ID_GRUPPO_OGGETTO = D.ID_GRUPPO_OGGETTO                \n"
        + "   AND B.ID_PROCEDIMENTO_OGGETTO = E.ID_PROCEDIMENTO_OGGETTO    \n"
        + "   AND DO.ID_OGGETTO = C.ID_OGGETTO    						   \n"
        + "   AND F.ID_STATO_OGGETTO = E.ID_STATO_OGGETTO                  \n"
        + "   AND A.ID_STATO_OGGETTO = G.ID_STATO_OGGETTO                  \n"
        + "   AND A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO					   \n"
        + "	  AND VD.ID_AZIENDA(+) = PA.EXT_ID_AZIENDA 					   \n"
        + "   AND PA.ID_PROCEDIMENTO (+)= A.ID_PROCEDIMENTO            	   \n"
        + "   AND VD.DATA_FINE_VALIDITA(+) IS NULL                   	   \n"
        + "    AND PA.DATA_FINE (+) IS NULL                                \n"
        + " ORDER BY B.ID_PROCEDIMENTO_OGGETTO, B.CODICE_RAGGRUPPAMENTO, D.ORDINE, C.ORDINE, B.DATA_INIZIO, E.DATA_INIZIO \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("CODICE_RAGGRUPPAMENTO", codiceRaggruppamento,
          Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<ProcedimentoDTO>()
          {

            @Override
            public ProcedimentoDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ProcedimentoDTO result = null;
              List<ProcedimentoOggettoDTO> lProcOggetto = new ArrayList<ProcedimentoOggettoDTO>();
              List<IterProcedimentoOggettoDTO> lIterProcOggetto = null;
              Long lastProcOggetto = null;
              while (rs.next())
              {
                if (result == null)
                {
                  result = new ProcedimentoDTO();
                  result.setDescrStatoOggetto(
                      rs.getString("DESCR_STATO_OGGETTO_PROC"));
                  result.setIdentificativo(rs.getString("IDENTIFICATIVO"));
                  result.setIdProcedimento(rs.getLong("ID_PROCEDIMENTO"));
                  result.setDenominazioneDelega(
                      rs.getString("DENOMINAZIONE_DELEGA"));
                  result.setProcedimentoOggetto(lProcOggetto);
                }

                long idProcOggetto = rs.getLong("ID_PROCEDIMENTO_OGGETTO");
                if (lastProcOggetto == null || lastProcOggetto != idProcOggetto)
                {
                  lastProcOggetto = idProcOggetto;
                  ProcedimentoOggettoDTO procedimentoOggettoDTO = new ProcedimentoOggettoDTO();
                  procedimentoOggettoDTO
                      .setIdentificativo(rs.getString("IDENTIF_PROC_OGG"));
                  procedimentoOggettoDTO
                      .setIdProcedimentoOggetto(idProcOggetto);
                  procedimentoOggettoDTO.setDescrGruppoOggetto(
                      rs.getString("DESCR_GRUPPO_OGGETTO"));
                  procedimentoOggettoDTO
                      .setDescrOggetto(rs.getString("DESCR_OGGETTO"));
                  procedimentoOggettoDTO
                      .setCodOggetto(rs.getString("COD_OGGETTO"));
                  procedimentoOggettoDTO.setIdOggetto(rs.getLong("ID_OGGETTO"));
                  procedimentoOggettoDTO.setCodiceRaggruppamento(
                      rs.getInt("CODICE_RAGGRUPPAMENTO"));
                  lIterProcOggetto = new ArrayList<IterProcedimentoOggettoDTO>();
                  procedimentoOggettoDTO
                      .setIterProcedimentoggetto(lIterProcOggetto);
                  lProcOggetto.add(procedimentoOggettoDTO);
                }

                IterProcedimentoOggettoDTO iter = new IterProcedimentoOggettoDTO();
                iter.setDescrizione(rs.getString("DESCR_ITER"));
                iter.setNote(rs.getString("NOTE"));
                iter.setExtIdUtenteAggiornamento(rs.getLong("ITER_ID_UTENTE"));
                iter.setIdIterProcedimentoOggett(
                    rs.getLong("ID_ITER_PROCEDIMENTO_OGGETT"));
                iter.setIdStatoOggetto(rs.getLong("ITER_ID_STATO_OGGETTO"));
                iter.setDataInizio(rs.getTimestamp("ITER_DATA_INIZ"));
                lIterProcOggetto.add(iter);
              }
              return result;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO", idProcedimento),
              new LogParameter("CODICE_RAGGRUPPAMENTO", codiceRaggruppamento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String checkFlagAltreInfoAtto(long idTipoAtto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::checkFlagAltreInfoAtto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                       		 \n"
        + "   FLAG_ALTRE_INFO											 \n"
        + " FROM                                                         \n"
        + "   IUF_D_TIPO_ATTO           	                             \n"
        + " WHERE                                                        \n"
        + "   ID_TIPO_ATTO             = :ID_TIPO_ATTO        	 		 \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_TIPO_ATTO", idTipoAtto, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idTipoAtto", idTipoAtto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getElencoAtti()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoAtti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                     			\n"
        + "   ID_TIPO_ATTO AS ID,		\n"
        + "   DESCRIZIONE AS CODICE,   	\n"
        + "   DESCRIZIONE  				\n"
        + " FROM                       	\n"
        + "   IUF_D_TIPO_ATTO      		\n"
        + " ORDER BY DESCRIZIONE 	  	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {},
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isEsisteImpBaseByCodiceLivello(long idProcedimentoOggetto,
      String codiceLivello) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isDatiPascoloStampabili]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                 \n"
        + "   E.ID_IMPEGNO                                         \n"
        + " FROM                                                   \n"
        + "   IUF_T_DATI_PROCEDIMENTO A,                           \n"
        + "   IUF_T_IMPEGNO_PROC_OGG B,                            \n"
        + "   IUF_D_LIVELLO C,                                     \n"
        + "   IUF_R_DETTAGLIO_IMPEGNO D,                           \n"
        + "   IUF_D_IMPEGNO E                                      \n"
        + " WHERE                                                  \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND A.ID_DATI_PROCEDIMENTO  = B.ID_DATI_PROCEDIMENTO \n"
        + "   AND B.ID_LIVELLO = C.ID_LIVELLO                      \n"
        + "   AND C.CODICE_LIVELLO = :CODICE_LIVELLO               \n"
        + "   AND D.ID_IMPEGNO_PROC_OGG = B.ID_IMPEGNO_PROC_OGG    \n"
        + "   AND D.FLAG_ESCLUSIONE = 'N'                          \n"
        + "   AND E.ID_IMPEGNO = D.ID_IMPEGNO                      \n"
        + "   AND E.TIPO_IMPEGNO = 'B'                             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("CODICE_LIVELLO", codiceLivello,
          Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("codiceLivello", codiceLivello)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateRProcedimentoOggettoSanzione(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "updateSanzioniAccertamento";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String INSERT = " UPDATE                                              \n"
        + "   IUF_R_PROCEDIMENTO_OGG_LIVEL P                            \n"
        + " SET                                                           \n"
        + "   P.SANZIONI =                                                \n"
        + "   (                                                           \n"
        + "     SELECT                                                    \n"
        + "       SUM(POL.IMPORTO)				                          \n"
        + "     FROM                                                      \n"
        + "       IUF_T_PROC_OGGETTO_SANZIONE POL 	                      \n"
        + "     WHERE                                                     \n"
        + "       POL.ID_PROCEDIMENTO_OGGETTO = P.ID_PROCEDIMENTO_OGGETTO \n"
        + "       AND POL.ID_LIVELLO          = P.ID_LIVELLO              \n"
        + "   )                                                           \n"
        + " WHERE                                                         \n"
        + "   P.ID_PROCEDIMENTO_OGGETTO   = :ID_PROCEDIMENTO_OGGETTO  	  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {
          }, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public void updateRProcedimentoOggettoSanzione(long idProcedimentoOggetto,
      Long idLivello, BigDecimal contributoRiduzioniSanzioni)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "updateSanzioniAccertamento";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String INSERT = " UPDATE                                              \n"
        + "   IUF_R_PROCEDIMENTO_OGG_LIVEL P                            \n"
        + " SET                                                           \n"
        + "   P.SANZIONI = :SANZIONI									  \n"
        + " WHERE                                                         \n"
        + "   P.ID_PROCEDIMENTO_OGGETTO   = :ID_PROCEDIMENTO_OGGETTO  	  \n"
        + "   AND P.ID_LIVELLO          = :ID_LIVELLO		              \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_LIVELLO", idLivello, Types.NUMERIC);
    if (contributoRiduzioniSanzioni != null)
      mapParameterSource.addValue("SANZIONI",
          contributoRiduzioniSanzioni.negate(), Types.DECIMAL);
    else
      mapParameterSource.addValue("SANZIONI", null, Types.DECIMAL);

    try
    {
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
          },
          new LogVariable[]
          {
          }, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public boolean isDataAmmissioneDaGestire(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isDataAmmissioneDaGestire]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                 \n"
        + "   A.ID_PROCEDIMENTO,                   \n"
        + "   A.ID_LIVELLO                         \n"
        + " FROM                                   \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO A         \n"
        + " WHERE                                  \n"
        + "   A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO \n"
        + "   AND A.CONTRIBUTO_CONCESSO > 0       \n"
        + "   AND A.DATA_AMMISSIONE IS NULL        \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateDataAmmissione(long idProcedimento, Date dataAmmissione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateDataAmmissione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " UPDATE                                 \n"
        + "   IUF_R_PROCEDIMENTO_LIVELLO A         \n"
        + " SET							         \n"
        + "   A.DATA_AMMISSIONE = TRUNC(:DATA_AMMISSIONE) \n"
        + " WHERE                                  \n"
        + "   A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO \n"
        + "   AND A.CONTRIBUTO_CONCESSO > 0       \n"
        + "   AND A.DATA_AMMISSIONE IS NULL        \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_AMMISSIONE", dataAmmissione,
          Types.DATE);
      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("dataAmmissione", dataAmmissione)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Date findDataProtocolloLettera(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "findDatiProtocolloLettera";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                                        \n"
        + "   NVL(A.DATA_PROTOCOLLO , A.DATA_PROTOCOLLO_EMERGENZA) AS DATA_PROTOCOLLO     \n"
        + " FROM                                                                          \n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP A,                                            \n"
        + "   IUF_R_OGGETTO_ICONA B,                                                      \n"
        + "   DOQUIAGRI_V_TIPO_DOC C                                                      \n"
        + " WHERE                                                                         \n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO                        \n"
        + "   AND A.ID_OGGETTO_ICONA = B.ID_OGGETTO_ICONA                                 \n"
        + "   AND B.EXT_ID_TIPO_DOCUMENTO = C.ID_TIPO_DOCUMENTO                           \n"
        + "   AND C.ID_CATEGORIA_DOC = :ID_CATEGORIA_DOC                                  \n"
        + "   AND A.DATA_FINE IS NULL                                                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    mapParameterSource.addValue("ID_CATEGORIA_DOC",
        IuffiConstants.IUFFI.ID_CATEGORIA_DOC_LETTERE_IUF_SU_DOQUIAGRI,
        Types.NUMERIC);
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Date>()
          {
            @Override
            public Date extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return rs.getDate("DATA_PROTOCOLLO");
              }
              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getTecniciByUfficioDiZona(Long idUfficioZona,
      int idProcedimentoAgricolo)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getTecniciByUfficioDiZona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT DISTINCT                                                                                \n"
        + "   T.ID_TECNICO AS ID,                                                                                       \n"
        + "   T.ID_TECNICO AS CODICE,                                                                                   \n"
        + "   T.COGNOME,                                                                                                \n"
        + "   T.NOME,                                                                                                   \n"
        + "   T.MATRICOLA,                                                                                              \n"
        + "   (T.COGNOME                                                                                                \n"
        + "   || ' '                                                                                                    \n"
        + "   || T.NOME) AS DESCRIZIONE                                                                                 \n"
        + " FROM                                                                                                        \n"
        + "   SMRCOMUNE_V_TECNICO T                                                                                     \n"
        + " WHERE                                                                                                       \n"
        + "    T.EXT_ID_PROCEDIMENTO    = " + idProcedimentoAgricolo
        + "	                                                                         	\n";
    if (idUfficioZona != null)
      QUERY += "   AND T.ID_UFFICIO_ZONA   = :ID_UFFICIO	                                                    	\n";
    QUERY += " ORDER BY                                                                                              \n"
        + "   T.COGNOME,                                                                                                \n"
        + "   T.NOME,                                                                                                   \n"
        + "   T.MATRICOLA                                                                                               \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    if (idUfficioZona != null)
      mapParameterSource.addValue("ID_UFFICIO", idUfficioZona, Types.NUMERIC);

    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {},
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DocumentoSpesaVO> getElencoDocumentiSpesa(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoDocumentiSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = "   SELECT                                                                                                                                                              \n"
        + "      C.ID_DOCUMENTO_SPESA,                                                                                                                                            \n"
        + "      C.ID_DETT_DOCUMENTO_SPESA,                                                                                                                                       \n"
        + "      C.ID_FORNITORE,                                                                                                                                                  \n"
        + "      C.ID_TIPO_DOCUMENTO_SPESA,                                                                                                                                       \n"
        + "      C.ID_MODALITA_PAGAMENTO,                                                                                                                                         \n"
        + "      C.DATA_DOCUMENTO_SPESA,                                                                                                                                          \n"
        + "      C.NUMERO_DOCUMENTO_SPESA,                                                                                                                                        \n"
        + "      C.DATA_PAGAMENTO,                                                                                                                                                \n"
        + "      C.IMPORTO_SPESA,                                                                                                                                                 \n"
        + "      C.IMPORTO_IVA_SPESA IMPORTO_IVA,                                                                                                                                                 \n"
        + "      C.NOTE,                                                                                                                                                          \n"
        + "      D.DESCRIZIONE AS DESCR_MOD_PAGAMENTO,                                                                                                                            \n"
        + "      E.DESCRIZIONE AS DESCR_TIPO_DOCUMENTO,                                                                                                                           \n"
        + "      F.CODICE_FORNITORE,                                                                                                                                              \n"
        + "      F.RAGIONE_SOCIALE,                                                                                                                                               \n"
        + "      F.INDIRIZZO_SEDE_LEGALE,                                                                                                                                         \n"
        + "                                                                                                                                                                       \n"
        + " (                                                                                                                                                                \n"
        + "         (SELECT NVL(SUM(F1.IMPORTO),0) FROM IUF_R_DOCUMENTO_SPESA_INTERV F1                                                                                         \n"
        + "         WHERE F1.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA)    ) as IMPORTO_ASSOCIATO,																					\n"
        + "                                                                                                                                                                       \n"
        + "      ((SELECT SUM(F3.IMPORTO_RENDICONTATO) FROM IUF_R_DOC_SPESA_INT_PROC_OGG F3  , IUF_R_DOCUMENTO_SPESA_INTERV C2                                                   \n"
        + "       WHERE F3.ID_DOCUMENTO_SPESA_INTERVEN = C2.ID_DOCUMENTO_SPESA_INTERVEN AND C2.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA                                          \n"
        + "       AND F3.ID_PROCEDIMENTO_OGGETTO IN (SELECT B2.ID_PROCEDIMENTO_OGGETTO FROM IUF_T_PROCEDIMENTO_OGGETTO B2, IUF_T_ITER_PROCEDIMENTO_OGGE B3 WHERE                \n"
        + "                                            B2.ID_PROCEDIMENTO = A.ID_PROCEDIMENTO AND B3.ID_PROCEDIMENTO_OGGETTO = B2.ID_PROCEDIMENTO_OGGETTO                         \n"
        + "                                            AND B3.ID_STATO_OGGETTO IN (10,22))                                                                                        \n"
        + "     )"
        + ""
        + "       -                                                                                                                                                               \n"
        + "         ( SELECT NVL(SUM(C1.IMPORTO_DISPONIBILE),0) FROM IUF_R_DOC_SPESA_INT_ACC_SPES C1, IUF_R_DOCUMENTO_SPESA_INTERV C2                                          \n"
        + "          WHERE C1.ID_DOCUMENTO_SPESA_INTERVEN= C2.ID_DOCUMENTO_SPESA_INTERVEN AND C2.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA                                        \n"
        + "          AND C1.ID_PROCEDIMENTO_OGGETTO IN (SELECT B2.ID_PROCEDIMENTO_OGGETTO FROM IUF_T_PROCEDIMENTO_OGGETTO B2, IUF_T_ITER_PROCEDIMENTO_OGGE B3 WHERE             \n"
        + "                                            B2.ID_PROCEDIMENTO = A.ID_PROCEDIMENTO AND B3.ID_PROCEDIMENTO_OGGETTO = B2.ID_PROCEDIMENTO_OGGETTO                         \n"
        + "                                            AND B3.ID_STATO_OGGETTO IN (10,22)))                                                                                       \n"

        + ""
        + ") AS IMPORTO_RENDICONTATO,                                                                                                                                        \n"
        + "                                                                                                                                                                       \n"
        + "      DECODE((SELECT DISTINCT B1.ID_DOCUMENTO_SPESA                                                                                                                    \n"
        + "         FROM IUF_R_DOC_SPESA_INT_PROC_OGG C1, IUF_R_DOCUMENTO_SPESA_INTERV B1                                                                                       \n"
        + "         WHERE B1.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA AND B1.ID_DOCUMENTO_SPESA_INTERVEN = C1.ID_DOCUMENTO_SPESA_INTERVEN ), NULL, 'S', 'N') AS FLAG_ELIMINABILE \n"
        + "    FROM                                                                                                                                                               \n"
        + "      IUF_T_DOCUMENTO_SPESA A,                                                                                                                                         \n"
        + "      IUF_T_DETT_DOCUMENTO_SPESA C,                                                                                                                                    \n"
        + "      IUF_D_MODALITA_PAGAMENTO D,                                                                                                                                      \n"
        + "      IUF_D_TIPO_DOCUMENTO_SPESA E,                                                                                                                                    \n"
        + "      IUF_T_FORNITORE F                                                                                                                                                \n"
        + "    WHERE                                                                                                                                                              \n"
        + "      A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO                                                                                                                             \n"
        + "      AND A.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA                                                                                                                  \n"
        + "      AND C.DATA_FINE IS NULL                                                                                                                 \n"
        + "      AND D.ID_MODALITA_PAGAMENTO(+) = C.ID_MODALITA_PAGAMENTO                                                                                                         \n"
        + "      AND E.ID_TIPO_DOCUMENTO_SPESA = C.ID_TIPO_DOCUMENTO_SPESA                                                                                                        \n"
        + "      AND F.ID_FORNITORE(+) = C.ID_FORNITORE                                                                                                                           \n"
        + "    ORDER BY C.ID_DOCUMENTO_SPESA, C.DATA_PAGAMENTO asc, C.DATA_DOCUMENTO_SPESA asc, C.NUMERO_DOCUMENTO_SPESA asc                                                                            \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {

      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, DocumentoSpesaVO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {

              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void aggiornaDatiProtocollazioneStampa(long idProcedimOggettoStampa,
      Date dataProtocolloDocumento, String numeroProtocolloDocumento,
      Date dataProtocolloEmergenza, String numeroProtocolloEmergenza)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::aggiornaDatiProtocollazioneStampa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                     			\n"
        + "   IUF_T_PROCEDIM_OGGETTO_STAMP                               		\n"
        + " SET                                                           		\n"
        + "   DATA_PROTOCOLLO               = :DATA_PROTOCOLLO,                 \n"
        + "   NUMERO_PROTOCOLLO 			= :NUMERO_PROTOCOLLO, 				\n"
        + "   DATA_PROTOCOLLO_EMERGENZA   	= :DATA_PROTOCOLLO_EMERGENZA,       \n"
        + "   NUMERO_PROTOCOLLO_EMERGENZA   = :NUMERO_PROTOCOLLO_EMERGENZA      \n"
        + " WHERE                                                         		\n"
        + "   ID_PROCEDIM_OGGETTO_STAMPA = :ID_PROCEDIM_OGGETTO_STAMPA     		\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("DATA_PROTOCOLLO", dataProtocolloDocumento,
          Types.DATE);
      mapParameterSource.addValue("NUMERO_PROTOCOLLO",
          numeroProtocolloDocumento, Types.VARCHAR);
      mapParameterSource.addValue("DATA_PROTOCOLLO_EMERGENZA",
          dataProtocolloEmergenza, Types.DATE);
      mapParameterSource.addValue("NUMERO_PROTOCOLLO_EMERGENZA",
          numeroProtocolloEmergenza, Types.VARCHAR);
      mapParameterSource.addValue("ID_PROCEDIM_OGGETTO_STAMPA",
          idProcedimOggettoStampa, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimOggettoStampa",
                  idProcedimOggettoStampa),
              new LogParameter("dataProtocolloDocumento",
                  dataProtocolloDocumento),
              new LogParameter("numeroProtocolloDocumento",
                  numeroProtocolloDocumento),
              new LogParameter("numeroProtocolloEmergenza",
                  numeroProtocolloEmergenza),
              new LogParameter("dataProtocolloEmergenza",
                  dataProtocolloEmergenza)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> geElencoTipiDocumenti()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::geElencoTipiDocumenti]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 \n"
        + "   A.ID_TIPO_DOCUMENTO_SPESA AS ID, 	 \n"
        + "   A.ID_TIPO_DOCUMENTO_SPESA AS CODICE, \n"
        + "   A.DESCRIZIONE                		 \n"
        + " FROM                                   \n"
        + "   IUF_D_TIPO_DOCUMENTO_SPESA A         \n"
        + " ORDER BY A.ORDINE                 	 \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> geElencoFornitori()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::geElencoFornitori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 			\n"
        + "   A.ID_FORNITORE AS ID, 	 			 			\n"
        + "   A.ID_FORNITORE AS CODICE, 			 			\n"
        + "   A.RAGIONE_SOCIALE || ' - ' ||        			\n"
        + "		TRIM(A.CODICE_FORNITORE) || ' - ' ||   			\n"
        + "		A.INDIRIZZO_SEDE_LEGALE  || ' - ' || B.DESCRIZIONE_COMUNE || '(' || B.SIGLA_PROVINCIA || ')'         			\n"
        + "	 AS DESCRIZIONE                      			\n"
        + " FROM                                   			\n"
        + "   IUF_T_FORNITORE A,         			 			\n"
        + "   SMRGAA_V_DATI_AMMINISTRATIVI B			 			\n"
        + " WHERE				        			 			\n"
        + " 	A.EXT_ISTAT_COMUNE_SEDE_LEGALE(+) = B.ISTAT_COMUNE		 	\n"
        + " ORDER BY A.DATA_INIZIO DESC             			\n";
    ;

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> geElencoModalitaPagamento()
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::geElencoModalitaPagamento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 		\n"
        + "   A.ID_MODALITA_PAGAMENTO AS ID, 	 			\n"
        + "   A.ID_MODALITA_PAGAMENTO AS CODICE, 			\n"
        + "   A.DESCRIZIONE      							\n"
        + " FROM                                   		\n"
        + "   IUF_D_MODALITA_PAGAMENTO A         	 		\n"
        + " ORDER BY A.ORDINE		                 		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public TipoDocumentoSpesaVO getDettagioTipoDocumento(
      long idTipoDocumentoSpesa) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDettagioTipoDocumento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                 \n"
        + "   A.ID_TIPO_DOCUMENTO_SPESA,                           \n"
        + "   A.DESCRIZIONE,                                       \n"
        + "   A.ORDINE,                                            \n"
        + "   A.FLAG_ID_FORNITORE,                                 \n"
        + "   A.FLAG_DATA_DOCUMENTO_SPESA,                         \n"
        + "   A.FLAG_NUMERO_DOCUMENTO_SPESA,                       \n"
        + "   A.FLAG_DATA_PAGAMENTO,                               \n"
        + "   A.FLAG_ID_MODALITA_PAGAMENTO,                        \n"
        + "   A.FLAG_NOTE,                                         \n"
        + "   A.FLAG_FILE_DOCUMENTO_SPESA                          \n"
        + " FROM                                                   \n"
        + "   IUF_D_TIPO_DOCUMENTO_SPESA A                         \n"
        + " WHERE                                                  \n"
        + "   A.ID_TIPO_DOCUMENTO_SPESA = :ID_TIPO_DOCUMENTO_SPESA \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_TIPO_DOCUMENTO_SPESA",
          idTipoDocumentoSpesa, Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource,
          TipoDocumentoSpesaVO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idTipoDocumentoSpesa", idTipoDocumentoSpesa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long inserisciDettDocumentoSpesa(DocumentoSpesaVO documentoVO,
      String extCodAttore) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciDettDocumentoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_DETT_DOCUMENTO_SPESA            	\n"
        + "   (                                         \n"
        + "     ID_DETT_DOCUMENTO_SPESA,            	\n"
        + "     ID_DOCUMENTO_SPESA,            			\n"
        + "     ID_FORNITORE,                        	\n"
        + "     DATA_DOCUMENTO_SPESA,                   \n"
        + "     NUMERO_DOCUMENTO_SPESA,                 \n"
        + "     ID_TIPO_DOCUMENTO_SPESA,             	\n"
        + "     DATA_PAGAMENTO,             			\n"
        + "     ID_MODALITA_PAGAMENTO,             		\n"
        + "     IMPORTO_SPESA,             				\n"
        + "     NOTE,					             	\n"
        // + " NOME_FILE_LOGICO_DOCUMENTO_SPE, \n"
        // + " FILE_DOCUMENTO_SPESA, \n"
        // + " NOME_FILE_FISICO_DOCUMENTO_SPE, \n"
        + "     DATA_ULTIMO_AGGIORNAMENTO,         		\n"
        + "     EXT_COD_ATTORE,         				\n"
        + "     DATA_INIZIO,							\n"
        + "		IMPORTO_IVA_SPESA      					\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_DETT_DOCUMENTO_SPESA,			 	\n"
        + "     :ID_DOCUMENTO_SPESA,			 		\n"
        + "     :ID_FORNITORE,                        	\n"
        + "     :DATA_DOCUMENTO_SPESA,                  \n"
        + "     :NUMERO_DOCUMENTO_SPESA,                \n"
        + "     :ID_TIPO_DOCUMENTO_SPESA,             	\n"
        + "     :DATA_PAGAMENTO,             			\n"
        + "     :ID_MODALITA_PAGAMENTO,             	\n"
        + "     :IMPORTO_SPESA,             			\n"
        + "     :NOTE,					             	\n"
        // + " :NOME_FILE_LOGICO_DOCUMENTO_SPE, \n"
        // + " :FILE_DOCUMENTO_SPESA, \n"
        // + " :NOME_FILE_FISICO_DOCUMENTO_SPE, \n"
        + "     SYSDATE,         						\n"
        + "     :EXT_COD_ATTORE,         				\n"
        + "     SYSDATE,         						\n"
        + "		:IMPORTO_IVA_SPESA      				\n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      long id = getNextSequenceValue("SEQ_IUF_T_DETT_DOCUMENTO_SPE");
      mapParameterSource.addValue("ID_DETT_DOCUMENTO_SPESA", id, Types.NUMERIC);
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA",
          documentoVO.getIdDocumentoSpesa(), Types.NUMERIC);
      mapParameterSource.addValue("ID_FORNITORE", documentoVO.getIdFornitore(),
          Types.NUMERIC);
      mapParameterSource.addValue("DATA_DOCUMENTO_SPESA",
          documentoVO.getDataDocumentoSpesa(), Types.DATE);
      mapParameterSource.addValue("NUMERO_DOCUMENTO_SPESA",
          documentoVO.getNumeroDocumentoSpesa(), Types.VARCHAR);
      mapParameterSource.addValue("ID_TIPO_DOCUMENTO_SPESA",
          documentoVO.getIdTipoDocumentoSpesa(), Types.NUMERIC);
      mapParameterSource.addValue("DATA_PAGAMENTO",
          documentoVO.getDataPagamento(), Types.DATE);
      mapParameterSource.addValue("ID_MODALITA_PAGAMENTO",
          documentoVO.getIdModalitaPagamento(), Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO_SPESA",
          documentoVO.getImportoSpesa(), Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO_IVA_SPESA",
          documentoVO.getImportoIva(), Types.NUMERIC);
      mapParameterSource.addValue("NOTE", documentoVO.getNote(), Types.VARCHAR);
      /*
       * mapParameterSource.addValue("NOME_FILE_LOGICO_DOCUMENTO_SPE",
       * documentoVO.getNomeFileLogicoDocumentoSpe(), Types.VARCHAR);
       * mapParameterSource.addValue("FILE_DOCUMENTO_SPESA", new
       * SqlLobValue(documentoVO.getFileDocumentoSpesa()), Types.BLOB);
       * mapParameterSource.addValue("NOME_FILE_FISICO_DOCUMENTO_SPE",
       * documentoVO.getNomeFileFisicoDocumentoSpe(), Types.VARCHAR);
       */
      mapParameterSource.addValue("EXT_COD_ATTORE", extCodAttore,
          Types.VARCHAR);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
      return id;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_FORNITORE", documentoVO.getIdFornitore()),
              new LogParameter("ID_PROCEDIMENTO",
                  documentoVO.getIdProcedimento()),
              new LogParameter("DATA_DOCUMENTO_SPESA",
                  documentoVO.getDataDocumentoSpesa()),
              new LogParameter("NUMERO_DOCUMENTO_SPESA",
                  documentoVO.getNumeroDocumentoSpesa()),
              new LogParameter("ID_TIPO_DOCUMENTO_SPESA",
                  documentoVO.getIdTipoDocumentoSpesa()),
              new LogParameter("DATA_PAGAMENTO",
                  documentoVO.getDataPagamento()),
              new LogParameter("ID_MODALITA_PAGAMENTO",
                  documentoVO.getIdModalitaPagamento()),
              new LogParameter("IMPORTO_SPESA", documentoVO.getImportoSpesa()),
              new LogParameter("NOTE", documentoVO.getNote())

          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void inserisciInterventoSpesa(long idDocumentoSpesa,
      ImportoInterventoVO importo, long idUtente)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciInterventoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT INTO IUF_R_DOCUMENTO_SPESA_INTERV                                 \n"
        + "   (               						  \n"
        + "   ID_DOCUMENTO_SPESA_INTERVEN,               	  \n"
        + "   ID_DOCUMENTO_SPESA,               	  \n"
        + "   ID_INTERVENTO,               			  \n"
        + "   DATA_ULTIMO_AGGIORNAMENTO,               			  \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO,               			  \n"
        + "   IMPORTO              					  \n"
        + "   )               						  \n"
        + " VALUES                                    \n"
        + "   (               						  \n"
        + "   SEQ_IUF_R_DOCUMEN_SPESA_INTE.NEXTVAL,               	  \n"
        + "   :ID_DOCUMENTO_SPESA,               	  \n"
        + "   :ID_INTERVENTO,               		  \n"
        + "   SYSDATE,               		  \n"
        + "   :EXT_ID_UTENTE_AGGIORNAMENTO,               		  \n"
        + "   :IMPORTO               				  \n"
        + "   )               						  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_INTERVENTO", importo.getIdIntervento(),
          Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO", importo.getImporto(),
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO", idUtente,
          Types.NUMERIC);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa),
              new LogParameter("idIntervento", importo.getIdIntervento()),
              new LogParameter("importo", importo.getImporto()),
              new LogParameter("idUtente", idUtente)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> geElencoFornitori(String piva)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::geElencoFornitori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 			\n"
        + "   A.ID_FORNITORE AS ID, 	 			 			\n"
        + "   A.ID_FORNITORE AS CODICE, 			 			\n"
        + "   A.RAGIONE_SOCIALE || ' - ' ||        			\n"
        + "		TRIM(A.CODICE_FORNITORE) || ' - ' ||   			\n"
        + "		A.INDIRIZZO_SEDE_LEGALE  || ' - ' || B.DESCRIZIONE_COMUNE || ' (' || B.SIGLA_PROVINCIA || ')'         			\n"
        + "	 AS DESCRIZIONE                      			\n"
        + " FROM                                   			\n"
        + "   IUF_T_FORNITORE A,         			 			\n"
        + "   SMRGAA_V_DATI_AMMINISTRATIVI B			 			\n"
        + " WHERE				        			 			\n"
        + " 	A.CODICE_FORNITORE = :CODICE_FORNITORE		 	\n"
        + " 	AND A.EXT_ISTAT_COMUNE_SEDE_LEGALE = B.ISTAT_COMUNE(+)		 	\n"
        + " ORDER BY A.DATA_INIZIO DESC             			\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("CODICE_FORNITORE", piva, Types.VARCHAR);
    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long inserisciFornitore(FornitoreDTO fornitore)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciFornitore]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    long id = 0;
    final String UPDATE = " INSERT                                  \n"
        + " INTO                                    \n"
        + "   IUF_T_FORNITORE            			\n"
        + "   (                                     \n"
        + "     ID_FORNITORE,            			\n"
        + "     CODICE_FORNITORE,     				\n"
        + "     RAGIONE_SOCIALE,                  	\n"
        + "     INDIRIZZO_SEDE_LEGALE,              \n"
        + "     DATA_INIZIO,              \n"
        + "     EXT_ISTAT_COMUNE_SEDE_LEGALE        \n"
        + "   )                                     \n"
        + "   VALUES                                \n"
        + "   (                                     \n"
        + "     :ID_FORNITORE,            			\n"
        + "     :CODICE_FORNITORE,         			\n"
        + "     :RAGIONE_SOCIALE,                  	\n"
        + "     :INDIRIZZO_SEDE_LEGALE,             \n"
        + "     SYSDATE,             				\n"
        + "     :EXT_ISTAT_COMUNE_SEDE_LEGALE       \n"
        + "   )                                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      id = getNextSequenceValue("SEQ_IUF_T_FORNITORE");
      mapParameterSource.addValue("ID_FORNITORE", id, Types.NUMERIC);
      mapParameterSource.addValue("CODICE_FORNITORE",
          fornitore.getCodiceFornitore(), Types.VARCHAR);
      mapParameterSource.addValue("RAGIONE_SOCIALE",
          fornitore.getRagioneSociale(), Types.VARCHAR);
      mapParameterSource.addValue("INDIRIZZO_SEDE_LEGALE",
          fornitore.getIndirizzoSedeLegale(), Types.VARCHAR);
      mapParameterSource.addValue("EXT_ISTAT_COMUNE_SEDE_LEGALE",
          (GenericValidator
              .isBlankOrNull(fornitore.getExtIstatComuneSedeLegale()) ? null
                  : fornitore.getExtIstatComuneSedeLegale()),
          Types.VARCHAR);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
      return id;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("fornitore", fornitore)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public FornitoreDTO getDettaglioFornitore(long idFornitore)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDettaglioFornitore]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 \n"
        + "   ID_FORNITORE, 	 			 		 \n"
        + "   CODICE_FORNITORE, 			 		 \n"
        + "   RAGIONE_SOCIALE, 	 			 	 \n"
        + "   INDIRIZZO_SEDE_LEGALE, 	 			 \n"
        + "   EXT_ISTAT_COMUNE_SEDE_LEGALE	 	 \n"
        + " FROM                                   \n"
        + "   IUF_T_FORNITORE A         			 \n"
        + " WHERE				        			 \n"
        + " 	A.ID_FORNITORE = :ID_FORNITORE		 \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_FORNITORE", idFornitore, Types.VARCHAR);
    try
    {
      return queryForObject(QUERY, mapParameterSource, FornitoreDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public DocumentoSpesaVO getDettagioDocumentoSpesa(long idDocumentoSpesa)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDettagioDocumentoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                                                                                               \n"
        + "    C.ID_DOCUMENTO_SPESA,                                                                                                                                             \n"
        + "    C.ID_DETT_DOCUMENTO_SPESA,                                                                                                                                             \n"
        + "    C.ID_FORNITORE,                                                                                                                                                   \n"
        + "    C.ID_TIPO_DOCUMENTO_SPESA,                                                                                                                                        \n"
        + "    C.ID_MODALITA_PAGAMENTO,                                                                                                                                          \n"
        + "    C.DATA_DOCUMENTO_SPESA,                                                                                                                                           \n"
        + "    C.NUMERO_DOCUMENTO_SPESA,                                                                                                                                         \n"
        + "    C.DATA_PAGAMENTO,                                                                                                                                                 \n"
        + "    C.IMPORTO_SPESA,                                                                                                                                                  \n"
        + "    C.IMPORTO_IVA_SPESA IMPORTO_IVA,                                                                                                                                                  \n"
        + "    C.NOTE,                                                                                                                                                           \n"
        + "    D.DESCRIZIONE AS DESCR_MOD_PAGAMENTO,                                                                                                                             \n"
        + "    E.DESCRIZIONE AS DESCR_TIPO_DOCUMENTO,                                                                                                                            \n"
        + "    F.CODICE_FORNITORE,                                                                                                                                                    \n"
        + "    F.RAGIONE_SOCIALE,                                                                                                                                                \n"
        + "    F.INDIRIZZO_SEDE_LEGALE,                                                                                                                                          \n"
        + "     DECODE((SELECT DISTINCT B1.ID_DOCUMENTO_SPESA                                                                                                                    \n"
        + "        FROM IUF_R_DOC_SPESA_INT_PROC_OGG C1, IUF_R_DOCUMENTO_SPESA_INTERV B1                                                                                       \n"
        + "        WHERE B1.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA AND B1.ID_DOCUMENTO_SPESA_INTERVEN = C1.ID_DOCUMENTO_SPESA_INTERVEN ), NULL, 'S', 'N') AS FLAG_ELIMINABILE \n"
        + "  FROM                                                                                                                                                                \n"
        + "    IUF_T_DETT_DOCUMENTO_SPESA C,                                                                                                                                     \n"
        + "    IUF_D_MODALITA_PAGAMENTO D,                                                                                                                                       \n"
        + "    IUF_D_TIPO_DOCUMENTO_SPESA E,                                                                                                                                     \n"
        + "    IUF_T_FORNITORE F                                                                                                                                                 \n"
        + "  WHERE                                                                                                                                                               \n"
        + "    C.ID_DOCUMENTO_SPESA = :ID_DOCUMENTO_SPESA                                                                                                                        \n"
        + "    AND D.ID_MODALITA_PAGAMENTO(+) = C.ID_MODALITA_PAGAMENTO                                                                                                          \n"
        + "    AND C.DATA_FINE IS NULL                                                                                                         								   \n"
        + "    AND E.ID_TIPO_DOCUMENTO_SPESA = C.ID_TIPO_DOCUMENTO_SPESA                                                                                                         \n"
        + "    AND F.ID_FORNITORE(+) = C.ID_FORNITORE                                                                                                                            \n"
        + "  ORDER BY  E.DESCRIZIONE                                                                                                                                             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      return queryForObject(QUERY, mapParameterSource, DocumentoSpesaVO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void aggiornaDocumentoSpesa(long idDettDocumentoSpesa,
      DocumentoSpesaVO documentoVO) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaDocumentoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String UPDATE = " UPDATE                                                                       \n"
        + "   IUF_T_DETT_DOCUMENTO_SPESA            		 	                                 \n"
        + "   SET                                                                        \n"
        + "     DATA_DOCUMENTO_SPESA = :DATA_DOCUMENTO_SPESA,                            \n"
        + "     NUMERO_DOCUMENTO_SPESA = :NUMERO_DOCUMENTO_SPESA,                        \n"
        + "     ID_TIPO_DOCUMENTO_SPESA = :ID_TIPO_DOCUMENTO_SPESA,             	     \n"
        + "     DATA_PAGAMENTO = :DATA_PAGAMENTO,             						     \n"
        + "     ID_MODALITA_PAGAMENTO = :ID_MODALITA_PAGAMENTO,             			 \n"
        + "     IMPORTO_SPESA = :IMPORTO_SPESA,             							 \n"
        + "     IMPORTO_IVA_SPESA = :IMPORTO_SPESA_IVA,             					 \n"

        + "     NOTE = :NOTE,					             							 \n"
        + "     ID_FORNITORE = :ID_FORNITORE			       							 \n";
    /*
     * +
     * "     NOME_FILE_LOGICO_DOCUMENTO_SPE = :NOME_FILE_LOGICO_DOCUMENTO_SPE	     \n"
     * ;
     * 
     * if(documentoVO.getFileDocumentoSpesa()!=null){ UPDATE +=
     * "     ,FILE_DOCUMENTO_SPESA = :FILE_DOCUMENTO_SPESA,			       			 \n"
     * +
     * "     NOME_FILE_FISICO_DOCUMENTO_SPE = :NOME_FILE_FISICO_DOCUMENTO_SPE         \n"
     * ; }
     */
    UPDATE += "   WHERE ID_DETT_DOCUMENTO_SPESA = :ID_DETT_DOCUMENTO_SPESA                             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DETT_DOCUMENTO_SPESA",
          idDettDocumentoSpesa, Types.NUMERIC);
      mapParameterSource.addValue("DATA_DOCUMENTO_SPESA",
          documentoVO.getDataDocumentoSpesa(), Types.DATE);
      mapParameterSource.addValue("NUMERO_DOCUMENTO_SPESA",
          documentoVO.getNumeroDocumentoSpesa(), Types.VARCHAR);
      mapParameterSource.addValue("ID_TIPO_DOCUMENTO_SPESA",
          documentoVO.getIdTipoDocumentoSpesa(), Types.NUMERIC);
      mapParameterSource.addValue("DATA_PAGAMENTO",
          documentoVO.getDataPagamento(), Types.DATE);
      mapParameterSource.addValue("ID_MODALITA_PAGAMENTO",
          documentoVO.getIdModalitaPagamento(), Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO_SPESA",
          documentoVO.getImportoSpesa(), Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO_SPESA_IVA",
          documentoVO.getImportoIva(), Types.NUMERIC);
      mapParameterSource.addValue("NOTE", documentoVO.getNote(), Types.VARCHAR);
      mapParameterSource.addValue("ID_FORNITORE", documentoVO.getIdFornitore(),
          Types.NUMERIC);

      /*
       * mapParameterSource.addValue("NOME_FILE_LOGICO_DOCUMENTO_SPE",
       * documentoVO.getNomeFileLogicoDocumentoSpe(), Types.VARCHAR);
       * if(documentoVO.getFileDocumentoSpesa()!=null){
       * mapParameterSource.addValue("FILE_DOCUMENTO_SPESA", new
       * SqlLobValue(documentoVO.getFileDocumentoSpesa()), Types.BLOB);
       * mapParameterSource.addValue("NOME_FILE_FISICO_DOCUMENTO_SPE",
       * documentoVO.getNomeFileFisicoDocumentoSpe(), Types.VARCHAR); }
       */
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDettDocumentoSpesa", idDettDocumentoSpesa),
              new LogParameter("DATA_DOCUMENTO_SPESA",
                  documentoVO.getDataDocumentoSpesa()),
              new LogParameter("NUMERO_DOCUMENTO_SPESA",
                  documentoVO.getNumeroDocumentoSpesa()),
              new LogParameter("ID_TIPO_DOCUMENTO_SPESA",
                  documentoVO.getIdTipoDocumentoSpesa()),
              new LogParameter("DATA_PAGAMENTO",
                  documentoVO.getDataPagamento()),
              new LogParameter("ID_MODALITA_PAGAMENTO",
                  documentoVO.getIdModalitaPagamento()),
              new LogParameter("IMPORTO_SPESA", documentoVO.getImportoSpesa()),
              new LogParameter("NOTE", documentoVO.getNote())

          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void aggiornaInterventoSpesa(long idProcedimentoOggetto,
      long idDocumentoSpesa, List<ImportoInterventoVO> importi)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaInterventoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE IUF_R_DOCUMENTO_SPESA_INTERV           \n"
        + "   SET IMPORTO = :IMPORTO 					    \n"
        + "  WHERE                						  	\n"
        + "   ID_INTERVENTO = :ID_INTERVENTO               \n"
        + "   AND ID_DOCUMENTO_SPESA = :ID_DOCUMENTO_SPESA  \n";

    int size = importi.size();
    MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[size];
    try
    {
      int idx = 0;
      for (ImportoInterventoVO importo : importi)
      {
        MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
        mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
            Types.NUMERIC);
        mapParameterSource.addValue("ID_INTERVENTO", importo.getIdIntervento(),
            Types.NUMERIC);
        mapParameterSource.addValue("IMPORTO", importo.getImporto(),
            Types.NUMERIC);
        batchParameters[idx++] = mapParameterSource;
      }
      namedParameterJdbcTemplate.batchUpdate(UPDATE, batchParameters);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("importi", importi),
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, UPDATE, batchParameters);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public BigDecimal getImportoIntervento(long idDocumentoSpesa,
      long idIntervento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getImportoIntervento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT                                  \n"
        + "         IMPORTO                                       	\n"
        + "       FROM                                              \n"
        + "         IUF_R_DOCUMENTO_SPESA_INTERV                  \n"
        + "       WHERE                                             \n"
        + "         ID_DOCUMENTO_SPESA      = :ID_DOCUMENTO_SPESA  	\n"
        + "         AND ID_INTERVENTO      = :ID_INTERVENTO  		\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_INTERVENTO", idIntervento, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<BigDecimal>()
          {

            @Override
            public BigDecimal extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              BigDecimal ret = null;
              if (rs.next())
              {
                ret = rs.getBigDecimal("IMPORTO");
              }
              return ret;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa),
              new LogParameter("idIntervento", idIntervento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public FileAllegatoDTO getFileAllegatoDocSpesa(long idDocumentoSpesaFile)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getFileAllegatoDocSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
      logger.debug(
          THIS_METHOD + " idDocumentoSpesaFile = " + idDocumentoSpesaFile);
    }
    final String QUERY = " SELECT                                        					\n"
        + "   FILE_DOCUMENTO_SPESA,                             		\n"
        + "   NOME_FILE_FISICO_DOCUMENTO_SPE                          	\n"
        + " FROM                                          				\n"
        + "   IUF_T_DOCUMENTO_SPESA_FILE                    			\n"
        + " WHERE                                         				\n"
        + "   ID_DOCUMENTO_SPESA_FILE = :ID_DOCUMENTO_SPESA_FILE 		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA_FILE",
          idDocumentoSpesaFile, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<FileAllegatoDTO>()
          {
            @Override
            public FileAllegatoDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                FileAllegatoDTO file = new FileAllegatoDTO();
                file.setNomeFile(
                    rs.getString("NOME_FILE_FISICO_DOCUMENTO_SPE"));
                file.setFileAllegato(rs.getBytes("FILE_DOCUMENTO_SPESA"));
                return file;
              }
              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesaFile", idDocumentoSpesaFile)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Boolean checkSeIProcSelezHannoLaStessaAmm(
      Vector<Long> idProcSelezionati)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::checkSeIProcSelezHannoLaStessaAmm]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                      \n"
        + "   COUNT(DISTINCT A.EXT_ID_AMM_COMPETENZA)            \n"
        + " FROM                                                 \n"
        + "   IUF_T_PROCEDIMENTO P,			                     \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO A			         \n"
        + " WHERE                                                \n"
        + "   P.ID_PROCEDIMENTO = A.ID_PROCEDIMENTO				 \n"
        + "   AND A.DATA_FINE IS NULL							 \n";
    QUERY += getInCondition("P.ID_PROCEDIMENTO", idProcSelezionati);
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      return queryForLong(QUERY, mapParameterSource) == 1; // Posso inserire se
                                                           // non c' gi il
                                                           // record presente
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkStatiOggetti(Vector<Long> vect)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::checkSeIProcSelezHannoLaStessaAmm]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                      			\n"
        + "   COUNT(DISTINCT P.ID_STATO_OGGETTO)            				\n"
        + " FROM                                                 			\n"
        + "   IUF_T_PROCEDIMENTO P			                     			\n"
        + " WHERE                                                			\n"
        + "   (P.ID_STATO_OGGETTO < 10 OR P.ID_STATO_OGGETTO >90)			\n";
    QUERY += getInCondition("P.ID_PROCEDIMENTO", vect);
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      return queryForLong(QUERY, mapParameterSource) == 0; // Posso inserire se
                                                           // non c' gi il
                                                           // record presente
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkSeIProcSelezAppartengonoAlloStessoBando(
      Vector<Long> idProcSelezionati)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::checkSeIProcSelezAppartengonoAlloStessoBando]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                      \n"
        + "   COUNT(DISTINCT P.ID_BANDO)			             \n"
        + " FROM                                                 \n"
        + "   IUF_T_PROCEDIMENTO P			                     \n"
        + " WHERE 1=1                                            \n";
    QUERY += getInCondition("P.ID_PROCEDIMENTO", idProcSelezionati);
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      return queryForLong(QUERY, mapParameterSource) == 1;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public EsitoFinaleDTO getEsitoDefinitivo(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getEsitoDefinitivo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                                	\n"
        + "  A.ID_ESITO_FINALE,					                  	\n"
        + "  A.ID_ESITO ,                        						\n"
        + "  A.EXT_ID_FUNZIONARIO_ISTRUTTORE,                        	\n"
        + "  A.EXT_ID_FUNZIONARIO_GRADO_SUP,                        	\n"
        + "  B.DESCRIZIONE,                                       	\n"
        + "  B.CODICE,                                            	\n"
        + "  C.COGNOME || ' ' || C.NOME AS DESCR_TECNICO ,        	\n"
        + "  D.COGNOME || ' ' || D.NOME AS DESCR_GRADO_SUP,        	\n"
        + "  A.ID_ESITO_DEFINITIVO,						        	\n"
        + "  A.MOTIVAZIONE,									    	\n"
        + "  E.DESCRIZIONE AS DESCR_ESITO_DEF					    	\n"
        + " FROM                                                  	\n"
        + "  IUF_T_ESITO_FINALE A,                                	\n"
        + "  IUF_D_ESITO B,                                       	\n"
        + "  DB_TECNICO C,                                        	\n"
        + "  DB_TECNICO D,                                         	\n"
        + "  IUF_D_ESITO E	                                       	\n"
        + " WHERE                                                 	\n"
        + "  A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 	\n"
        + "  AND B.ID_ESITO (+)= A.ID_ESITO                       	\n"
        + "  AND E.ID_ESITO (+)= A.ID_ESITO_DEFINITIVO                \n"
        + "  AND C.ID_TECNICO(+)= A.EXT_ID_FUNZIONARIO_ISTRUTTORE 	\n"
        + "  AND D.ID_TECNICO (+) = A.EXT_ID_FUNZIONARIO_GRADO_SUP   	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      EsitoFinaleDTO ret = namedParameterJdbcTemplate.query(QUERY,
          mapParameterSource, new ResultSetExtractor<EsitoFinaleDTO>()
          {
            @Override
            public EsitoFinaleDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                EsitoFinaleDTO esito = new EsitoFinaleDTO();
                esito.setIdEsito(rs.getLong("ID_ESITO"));
                esito.setIdEsitoFinale(rs.getLong("ID_ESITO_FINALE"));
                esito.setExtIdFunzionarioIstruttore(
                    rs.getLong("EXT_ID_FUNZIONARIO_ISTRUTTORE"));
                esito.setExtIdFunzionarioGradoSup(
                    rs.getLong("EXT_ID_FUNZIONARIO_GRADO_SUP"));
                esito.setDescrEsito(rs.getString("DESCRIZIONE"));
                esito.setCodiceEsito(rs.getString("CODICE"));
                esito.setDescrTecnico(rs.getString("DESCR_TECNICO"));
                esito.setDescrGradoSup(rs.getString("DESCR_GRADO_SUP"));
                esito.setIdEsitoDefinitivo(rs.getLong("ID_ESITO_DEFINITIVO"));
                esito.setMotivazione(rs.getString("MOTIVAZIONE"));
                esito.setDescrEsitoDefinitivo(rs.getString("DESCR_ESITO_DEF"));
                return esito;
              }
              return null;
            }
          });
      return ret;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkIfMotivazioniObbligatorieEsito(Long idEsito)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::checkIfMotivazioniObbligatorieEsito]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                \n"
        + "   COUNT(*)                                           \n"
        + " FROM                                                 \n"
        + "   IUF_D_ESITO					                     \n"
        + " WHERE                                                \n"
        + "   ID_ESITO = :ID_ESITO								 \n"
        + "   AND CODICE LIKE '%-CO%'        					 \n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_ESITO", idEsito, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) == 1;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void insertEsitoDefinitivo(long idProcedimentoOggetto,
      EsitoFinaleDTO esito) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertEsitoDefinitivo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT INTO                       	  		\n"
        + "   IUF_T_ESITO_FINALE		      		\n"
        + " (                                 		\n"
        + "     ID_ESITO_FINALE,	      	  		\n"
        + "     ID_ESITO, 			      	  		\n"
        + "     ID_ESITO_DEFINITIVO,       	  		\n"
        + "     ID_PROCEDIMENTO_OGGETTO,      		\n"
        + "     MOTIVAZIONE,                  		\n"
        + "     EXT_ID_FUNZIONARIO_ISTRUTTORE,		\n"
        + "     EXT_ID_FUNZIONARIO_GRADO_SUP  		\n"
        + " )                                 		\n"
        + " VALUES                            		\n"
        + " (                                 		\n"
        + "   	SEQ_IUF_T_ESITO_FINALE.NEXTVAL, 	\n"
        + "   	:ID_ESITO, 			      	  		\n"
        + "   	:ID_ESITO_DEFINITIVO,           	\n"
        + "   	:ID_PROCEDIMENTO_OGGETTO,       	\n"
        + "   	:MOTIVAZIONE,  				  		\n"
        + "   	:EXT_ID_FUNZIONARIO_ISTRUTTORE, 	\n"
        + "   	:EXT_ID_FUNZIONARIO_GRADO_SUP   	\n"
        + " )                                 		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_ESITO_DEFINITIVO",
          esito.getIdEsitoDefinitivo(), Types.NUMERIC);
      mapParameterSource.addValue("ID_ESITO", esito.getIdEsito(),
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("MOTIVAZIONE", esito.getMotivazione(),
          Types.CLOB);
      mapParameterSource.addValue("EXT_ID_FUNZIONARIO_ISTRUTTORE",
          esito.getExtIdFunzionarioIstruttore(), Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_FUNZIONARIO_GRADO_SUP",
          esito.getExtIdFunzionarioGradoSup(), Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getCuaaByIdProcedimentoOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getCuaaByIdProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                            						\n"
        + "   A.CUAA             										\n"
        + " FROM                              						\n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                 			\n"
        + "   IUF_T_PROCEDIMENTO_AZIENDA PA,	         				\n"
        + "   SMRGAA_V_DATI_ANAGRAFICI A,		         				\n"
        + "   IUF_T_PROCEDIMENTO P		                 			\n"
        + " WHERE                    									\n"
        + "   PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO   \n"
        + "   AND P.ID_PROCEDIMENTO = PA.ID_PROCEDIMENTO 				\n"
        + "   AND A.ID_AZIENDA = PA.EXT_ID_AZIENDA					\n"
        + "   AND A.DATA_FINE_VALIDITA IS NULL						\n"
        + "   AND PO.ID_PROCEDIMENTO = P.ID_PROCEDIMENTO				\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<ImportoLiquidatoDTO> getListeDegliImportiLiquidazione(
      long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getListeDegliImportiLiquidazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = "  SELECT DISTINCT											  \n"
        + " 	LL.ID_LISTA_LIQUIDAZIONE,										  \n"
        + "		LL.FLAG_STATO_LISTA, 										  	  \n"
        + "		f.ext_id_documento_index,								  		  \n"
        + "		LL.NUMERO_LISTA 				 							  	  \n"
        + "   FROM 	                                                              \n"
        + "     IUF_t_importi_liquidati il,  									  \n"
        + " 	IUF_R_LISTA_LIQUIDAZ_IMP_LIQ lil,  								  \n"
        + " 	IUF_T_LISTA_LIQUIDAZIONE ll, 									  \n"
        + " 	IUF_D_LIVELLO liv,												  \n"
        + " 	IUF_T_FILE_LISTA_LIQUIDAZION f,								  \n"
        + " 	DB_TECNICO v	   								  				  \n"
        + "   WHERE                                                         	  \n"
        + "         il.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO    	  \n"
        + "         AND liv.ID_LIVELLO = il.ID_LIVELLO          				  \n"
        + "         AND ll.ID_LISTA_LIQUIDAZIONE (+)= lil.ID_LISTA_LIQUIDAZIONE	  \n"
        + "         AND  lil.ID_IMPORTI_LIQUIDATI (+)= il.ID_IMPORTI_LIQUIDATI    \n"
        + " 		AND v.ID_TECNICO (+) = ll.EXT_ID_TECNICO_LIQUIDATORE		  \n"
        + " 		AND f.ID_LISTA_LIQUIDAZIONE (+)= lil.ID_LISTA_LIQUIDAZIONE	  \n"
        + " 		AND (LL.FLAG_STATO_LISTA = 'A' OR LL.FLAG_STATO_LISTA = 'T')  \n"
        + "	ORDER BY NUMERO_LISTA												  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource, ImportoLiquidatoDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto) },
          new LogVariable[]
          {}, QUERY,
          mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long countRecordIuffiRAttivPartecipInterv(Long idAttivita,
      Long idPartecipante)
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::countRecordIuffiRAttivPartecipInterv]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = " SELECT                                                  		\n"
        + "   COUNT(API.ID_ATTIVITA_PARTECIPANTE)          		  		\n"
        + " FROM                                                    		\n"
        + "   IUF_R_ATTIV_PARTECIP_INTERV API,					  		\n"
        + "	IUF_R_ATTIVITA_PARTECIPANTE AP                        		\n"
        + " WHERE                                                   		\n"
        + "   API.ID_ATTIVITA_PARTECIPANTE = AP.ID_ATTIVITA_PARTECIPANTE 	\n"
        + "   AND AP.ID_ATTIVITA = :ID_ATTIVITA 						  	\n";
    if (idPartecipante != null)
      QUERY += "AND AP.ID_PARTECIPANTE = :ID_PARTECIPANTE					\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_ATTIVITA", idAttivita, Types.NUMERIC);
    mapParameterSource.addValue("ID_PARTECIPANTE", idPartecipante,
        Types.NUMERIC);

    return queryForLong(QUERY, mapParameterSource);
  }

  public void deleteRAttPartInt(long idAttivita)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteRAttPartInt]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = "DELETE FROM IUF_R_ATTIV_PARTECIP_INTERV	    	\n"
        + " WHERE ID_ATTIVITA_PARTECIPANTE IN ( 							\n"
        + "		SELECT  													\n"
        + "			ID_ATTIVITA_PARTECIPANTE  								\n"
        + "		FROM  						 								\n"
        + "			IUF_R_ATTIVITA_PARTECIPANTE 							\n"
        + " 	WHERE  							 							\n"
        + "			ID_ATTIVITA = :ID_ATTIVITA) 							\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_ATTIVITA", idAttivita, Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idAttivita", idAttivita)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteEsitoTecnico(long idProcedimentoOggetto,
      long idQuadroOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteEsitoTecnico]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE                                               \n"
        + " FROM                                                 \n"
        + "   IUF_T_ESITO_TECNICO                                 \n"
        + " WHERE                                                \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND ID_QUADRO_OGGETTO = :ID_QUADRO_OGGETTO             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idQuadroOggetto", idQuadroOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteVisitaLuogo(long idProcedimentoOggetto,
      long idQuadroOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteVisitaLuogo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String DELETE = " DELETE                                               	\n"
        + " FROM                                                 \n"
        + "   IUF_T_VISITA_LUOGO                                 \n"
        + " WHERE                                                \n"
        + "   ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND ID_QUADRO_OGGETTO = :ID_QUADRO_OGGETTO             \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              new LogParameter("idQuadroOggetto", idQuadroOggetto)
          },
          new LogVariable[]
          {}, DELETE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkIfProcHaveSameUfficioZona(
      Vector<Long> idProcedimentiSelezionati)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::checkIfProcHaveSameUfficioZona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                               		 \n"
        + "   COUNT(DISTINCT EXT_ID_UFFICIO_ZONA) + COUNT(DISTINCT CASE WHEN EXT_ID_UFFICIO_ZONA IS NULL THEN 1 END)           	 \n"
        + " FROM                                                 \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO		             \n"
        + " WHERE                                                \n"
        + " 	DATA_FINE IS NULL								 \n";
    QUERY += getInCondition("ID_PROCEDIMENTO", idProcedimentiSelezionati);

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      return queryForLong(QUERY, mapParameterSource) == 1;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean checkIfProcHaveSameTecnico(
      Vector<Long> idProcedimentiSelezionati)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::checkIfProcHaveSameTecnico]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                               		 \n"
        + "   COUNT(DISTINCT EXT_ID_TECNICO) + COUNT(DISTINCT CASE WHEN EXT_ID_TECNICO IS NULL THEN 1 END)           	 \n"
        + " FROM                                                 \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO		             \n"
        + " WHERE                                                \n"
        + "  DATA_FINE IS NULL									 \n";
    QUERY += getInCondition("ID_PROCEDIMENTO", idProcedimentiSelezionati);

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      return queryForLong(QUERY, mapParameterSource) == 1; //
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deleteRAttivitaPartecipante(Long idAttivita, Long idPartecipante)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deleteRAttivitaPartecipante]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String DELETE = " DELETE FROM                                             		\n"
        + "   IUF_R_ATTIVITA_PARTECIPANTE          		  				\n"
        + " WHERE                                                   		\n"
        + "   ID_ATTIVITA = :ID_ATTIVITA 						  			\n"
        + "   AND ID_PARTECIPANTE = :ID_PARTECIPANTE						\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_ATTIVITA", idAttivita, Types.NUMERIC);
    mapParameterSource.addValue("ID_PARTECIPANTE", idPartecipante,
        Types.NUMERIC);
    namedParameterJdbcTemplate.update(DELETE, mapParameterSource);
  }

  public void aggiornaFlagRendizontazione(String flagRendicontazione,
      long idProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaFlagRendizontazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "UPDATE IUF_T_PROCEDIMENTO "
        + " SET FLAG_RENDICONTAZIONE_CON_IVA = :FLAG_RENDICONTAZIONE_CON_IVA "
        + " WHERE ID_PROCEDIMENTO = :ID_PROCEDIMENTO\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("FLAG_RENDICONTAZIONE_CON_IVA",
          flagRendicontazione, Types.VARCHAR);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("flagRendicontazione", flagRendicontazione)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<Long> searchDocumentoSpesaByKey(
      TipoDocumentoSpesaVO documentoSpesaVO, DocumentoSpesaVO documentoVO)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::searchDocumentoSpesaByKey]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final StringBuilder QUERY = new StringBuilder();
    QUERY.append(
        " SELECT A.ID_PROCEDIMENTO 						\n"
            + " FROM 											\n"
            + "	IUF_T_DOCUMENTO_SPESA A, 					\n"
            + "	IUF_T_DETT_DOCUMENTO_SPESA B,				\n"
            + "   IUF_T_FORNITORE C			 				\n"
            + " WHERE 										\n"
            + "   A.ID_DOCUMENTO_SPESA = B.ID_DOCUMENTO_SPESA \n"

            + "   AND B.ID_TIPO_DOCUMENTO_SPESA = :ID_TIPO_DOCUMENTO_SPESA \n"
            + "    AND B.DATA_FINE IS NULL                                                                                                         \n"

            + "	AND C.ID_FORNITORE(+) = B.ID_FORNITORE   "
            + "	AND A.ID_DOCUMENTO_SPESA <>  :ID_DOCUMENTO_SPESA  \n");

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_TIPO_DOCUMENTO_SPESA",
          documentoVO.getIdTipoDocumentoSpesa(), Types.NUMERIC);
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA",
          documentoVO.getIdDocumentoSpesa(), Types.NUMERIC);

      final String FLAG_KEY = "K";
      if (FLAG_KEY.equals(documentoSpesaVO.getFlagIdFornitore()))
      {
        QUERY.append(" AND C.CODICE_FORNITORE = :PARTITA_IVA");
        mapParameterSource.addValue("PARTITA_IVA",
            documentoVO.getCodiceFornitore(), Types.VARCHAR);
      }
      if (FLAG_KEY.equals(documentoSpesaVO.getFlagDataDocumentoSpesa()))
      {
        QUERY.append(" AND B.DATA_DOCUMENTO_SPESA = :DATA_DOCUMENTO_SPESA");
        mapParameterSource.addValue("DATA_DOCUMENTO_SPESA",
            documentoVO.getDataDocumentoSpesa(), Types.DATE);
      }
      if (FLAG_KEY.equals(documentoSpesaVO.getFlagNumeroDocumentoSpesa()))
      {
        QUERY.append(" AND B.NUMERO_DOCUMENTO_SPESA = :NUMERO_DOCUMENTO_SPESA");
        mapParameterSource.addValue("NUMERO_DOCUMENTO_SPESA",
            documentoVO.getNumeroDocumentoSpesa(), Types.VARCHAR);
      }
      if (FLAG_KEY.equals(documentoSpesaVO.getFlagDataPagamento()))
      {
        QUERY.append(" AND B.DATA_PAGAMENTO = :DATA_PAGAMENTO");
        mapParameterSource.addValue("DATA_PAGAMENTO",
            documentoVO.getDataPagamento(), Types.DATE);
      }
      if (FLAG_KEY.equals(documentoSpesaVO.getFlagIdModalitaPagamento()))
      {
        QUERY.append(" AND B.ID_MODALITA_PAGAMENTO = :ID_MODALITA_PAGAMENTO");
        mapParameterSource.addValue("ID_MODALITA_PAGAMENTO",
            documentoVO.getIdModalitaPagamento(), Types.NUMERIC);
      }
      if (FLAG_KEY.equals(documentoSpesaVO.getFlagNote()))
      {
        QUERY.append(" AND B.NOTE = :NOTE");
        mapParameterSource.addValue("NOTE", documentoVO.getNote(),
            Types.VARCHAR);
      }

      return namedParameterJdbcTemplate.query(QUERY.toString(),
          mapParameterSource, new ResultSetExtractor<List<Long>>()
          {

            @Override
            public List<Long> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              ArrayList<Long> list = new ArrayList<Long>();

              while (rs.next())
              {
                list.add(rs.getLong("ID_PROCEDIMENTO"));
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("documentoSpesaVO", documentoSpesaVO),
              new LogParameter("documentoVO", documentoVO)
          },
          new LogVariable[]
          {}, QUERY.toString(), mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long inserisciTDocumentoSpesa(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::inserisciTDocumentoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_DOCUMENTO_SPESA            		\n"
        + "   (                                         \n"
        + "     ID_DOCUMENTO_SPESA,            			\n"
        + "     ID_PROCEDIMENTO                        	\n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     :ID_DOCUMENTO_SPESA,		     		\n"
        + "     :ID_PROCEDIMENTO                        \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idDocumentoSpesa = 0;
    try
    {
      idDocumentoSpesa = getNextSequenceValue("SEQ_IUF_T_DOCUMENTO_SPESA");
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
      return idDocumentoSpesa;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long aggiornaFornitore(FornitoreDTO fornitore)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaFornitore]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    long id = 0;
    final String UPDATE = " UPDATE                                  \n"
        + " INTO                                    \n"
        + "   IUF_T_FORNITORE            			\n"
        + "   (                                     \n"
        + "     ID_FORNITORE,            			\n"
        + "     CODICE_FORNITORE,      				\n"
        + "     RAGIONE_SOCIALE,                  	\n"
        + "     INDIRIZZO_SEDE_LEGALE,              \n"
        + "     EXT_ISTAT_COMUNE_SEDE_LEGALE        \n"
        + "   )                                     \n"
        + "   VALUES                                \n"
        + "   (                                     \n"
        + "     :ID_FORNITORE,            			\n"
        + "     :CODICE_FORNITORE,     				\n"
        + "     :RAGIONE_SOCIALE,                  	\n"
        + "     :INDIRIZZO_SEDE_LEGALE,             \n"
        + "     :EXT_ISTAT_COMUNE_SEDE_LEGALE       \n"
        + "   )                                     \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      id = getNextSequenceValue("SEQ_IUF_T_FORNITORE");
      mapParameterSource.addValue("ID_FORNITORE", id, Types.NUMERIC);
      mapParameterSource.addValue("CODICE_FORNITORE",
          fornitore.getCodiceFornitore(), Types.NUMERIC);
      mapParameterSource.addValue("RAGIONE_SOCIALE",
          fornitore.getRagioneSociale(), Types.DATE);
      mapParameterSource.addValue("INDIRIZZO_SEDE_LEGALE",
          fornitore.getIndirizzoSedeLegale(), Types.DATE);
      mapParameterSource.addValue("EXT_ISTAT_COMUNE_SEDE_LEGALE",
          fornitore.getExtIstatComuneSedeLegale(), Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
      return id;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("fornitore", fornitore)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void aggiornaFornitore(long idDocumentoSpesa, long idFornitore)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::aggiornaFornitore]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = "UPDATE IUF_T_DETT_DOCUMENTO_SPESA SET ID_FORNITORE = :ID_FORNITORE WHERE ID_DETT_DOCUMENTO_SPESA = :ID_DETT_DOCUMENTO_SPESA ";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_FORNITORE", idFornitore, Types.NUMERIC);
      mapParameterSource.addValue("ID_DETT_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFornitore", idFornitore),
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public FornitoreDTO getDettaglioFornitoreByPiva(String piva)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getDettaglioFornitoreByPiva]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 \n"
        + "   ID_FORNITORE, 	 			 		 \n"
        + "   CODICE_FORNITORE,			 		 \n"
        + "   RAGIONE_SOCIALE, 	 			 	 \n"
        + "   INDIRIZZO_SEDE_LEGALE, 	 			 \n"
        + "   EXT_ISTAT_COMUNE_SEDE_LEGALE	 	 \n"
        + " FROM                                   \n"
        + "   IUF_T_FORNITORE A         			 \n"
        + " WHERE				        			 \n"
        + " 	A.CODICE_FORNITORE = :CODICE_FORNITORE AND A.DATA_FINE IS NULL		 \n"
        + " ORDER BY DATA_INIZIO 					 ";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("CODICE_FORNITORE", piva, Types.VARCHAR);
    try
    {
      return queryForObject(QUERY, mapParameterSource, FornitoreDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void storicizzaFornitore(long idFornitore)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::storicizzaFornitore]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE IUF_T_FORNITORE           				\n"
        + "   SET DATA_FINE = SYSDATE 					    \n"
        + "  WHERE                						  	\n"
        + "   ID_FORNITORE = :ID_FORNITORE               	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_FORNITORE", idFornitore, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idFornitore", idFornitore)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getCodiceAmmCompetenza(long extIdAmmComp)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getCodiceAmmCompetenza]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                           		        \n"
        + "   PA.CODICE_AMMINISTRAZIONE             \n"
        + " FROM                                    \n"
        + "   SMRCOMUNE_V_AMM_COMPETENZA PA		    \n"
        + " WHERE                                   \n"
        + "   PA.ID_AMM_COMPETENZA = :ID_AMMINISTRAZIONE_COMPETENZA \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_AMMINISTRAZIONE_COMPETENZA", extIdAmmComp,
          Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("extIdAmmComp", extIdAmmComp)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DocumentoSpesaVO> getElencoDocumentiSpesa(long idProcedimento,
      long[] idsDoc, long idIntervento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoDocumentiSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    String QUERY = "  SELECT                                                                                         \n"
        + "    C.ID_DOCUMENTO_SPESA,                                                                        \n"
        + "    C.ID_DETT_DOCUMENTO_SPESA,                                                                   \n"
        + "    C.ID_FORNITORE,                                                                              \n"
        + "    C.ID_TIPO_DOCUMENTO_SPESA,                                                                   \n"
        + "    C.ID_MODALITA_PAGAMENTO,                                                                     \n"
        + "    C.DATA_DOCUMENTO_SPESA,                                                                      \n"
        + "    C.NUMERO_DOCUMENTO_SPESA,                                                                    \n"
        + "    C.DATA_PAGAMENTO,                                                                            \n"
        + "    C.IMPORTO_SPESA,                                                                             \n"
        + "    C.IMPORTO_IVA_SPESA IMPORTO_IVA,                                                             \n"
        + "    C.NOTE,                                                                                      \n"
        + "    FIL.NOME_FILE_LOGICO_DOCUMENTO_SPE,                                                            \n"
        + "    FIL.NOME_FILE_FISICO_DOCUMENTO_SPE,                                                            \n"
        + "    D.DESCRIZIONE AS DESCR_MOD_PAGAMENTO,                                                        \n"
        + "    E.DESCRIZIONE AS DESCR_TIPO_DOCUMENTO,                                                       \n"
        + "    F.CODICE_FORNITORE,                                                                          \n"
        + "    F.RAGIONE_SOCIALE,                                                                           \n"
        + "    F.INDIRIZZO_SEDE_LEGALE,                                                                     \n"
        + "    I.IMPORTO AS IMPORTO_RENDICONTATO,                                                           \n"
        + "    DECODE((SELECT DISTINCT B1.ID_DOCUMENTO_SPESA                                                \n"
        + "       FROM IUF_R_DOC_SPESA_INT_PROC_OGG C1, IUF_R_DOCUMENTO_SPESA_INTERV B1                                                      \n"
        + "       WHERE B1.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA AND B1.ID_DOCUMENTO_SPESA_INTERVEN = C1.ID_DOCUMENTO_SPESA_INTERVEN ), NULL, 'S', 'N') AS FLAG_ELIMINABILE \n"
        + "  FROM                                                                                           \n"
        + "    IUF_T_DOCUMENTO_SPESA A,                                                                     \n"
        + "    IUF_T_DOCUMENTO_SPESA_FILE FIL,                                                              \n"
        + "    IUF_T_DETT_DOCUMENTO_SPESA C,                                                                \n"
        + "    IUF_D_MODALITA_PAGAMENTO D,                                                                  \n"
        + "    IUF_D_TIPO_DOCUMENTO_SPESA E,                                                                \n"
        + "    IUF_R_DOCUMENTO_SPESA_INTERV I,                                                            \n"
        + "    IUF_T_FORNITORE F                                                                            \n"
        + "  WHERE                                                                                          \n"
        + "    A.ID_PROCEDIMENTO = :ID_PROCEDIMENTO			          	                                  \n"
        + "    AND C.DATA_FINE IS NULL                                                                      \n"
        + "    AND C.ID_DOCUMENTO_SPESA = FIL.ID_DOCUMENTO_SPESA	                                          \n"
        + "    AND FIL.ID_DOCUMENTO_SPESA_FILE = (SELECT MAX(ID_DOCUMENTO_SPESA_FILE) FROM IUF_T_DOCUMENTO_SPESA_FILE WHERE  ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA)                                          \n"
        + "    AND I.ID_INTERVENTO (+)= :ID_INTERVENTO			          	                              \n"
        + "    AND I.ID_DOCUMENTO_SPESA (+)= A.ID_DOCUMENTO_SPESA			          	                      \n"
        + "    AND A.ID_DOCUMENTO_SPESA = C.ID_DOCUMENTO_SPESA          	                                  \n";
    QUERY += getInCondition(" A.ID_DOCUMENTO_SPESA", idsDoc);
    QUERY += "    AND D.ID_MODALITA_PAGAMENTO(+) = C.ID_MODALITA_PAGAMENTO                                 \n"
        + "    AND E.ID_TIPO_DOCUMENTO_SPESA = C.ID_TIPO_DOCUMENTO_SPESA                                    \n"
        + "    AND F.ID_FORNITORE(+) = C.ID_FORNITORE                                                       \n"
        + "  ORDER BY F.RAGIONE_SOCIALE asc, C.DATA_DOCUMENTO_SPESA asc, C.DATA_PAGAMENTO asc, C.NUMERO_DOCUMENTO_SPESA asc                                                                         \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_INTERVENTO", idIntervento, Types.NUMERIC);

      return queryForList(QUERY, mapParameterSource, DocumentoSpesaVO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idIntervento", idIntervento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> getElencoFronitoriProcedimento(
      long idProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::geElencoFornitori]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT DISTINCT                         		 			\n"
        + "   A.ID_FORNITORE AS ID, 	 			 					\n"
        + "   A.ID_FORNITORE AS CODICE, 			 					\n"
        + "   A.RAGIONE_SOCIALE,		 			 					\n"
        + "   A.RAGIONE_SOCIALE || ' - ' ||        					\n"
        + "		TRIM(A.CODICE_FORNITORE) || ' - ' ||   					\n"
        + "		A.INDIRIZZO_SEDE_LEGALE || ' - ' || VA.DESCRIZIONE_COMUNE || ' (' || VA.SIGLA_PROVINCIA || ')'        					\n"
        + "	 AS DESCRIZIONE                      					\n"
        + " FROM                                   					\n"
        + "   IUF_T_FORNITORE A,					 					\n"
        + "	IUF_T_DETT_DOCUMENTO_SPESA DETT,	 					\n"
        + "	IUF_T_DOCUMENTO_SPESA DS,         	 					\n"
        + "	SMRGAA_V_DATI_AMMINISTRATIVI VA         	 					\n"
        + " WHERE  					  				  				\n"
        + "	DETT.ID_FORNITORE = A.ID_FORNITORE   					\n"
        + "   AND DETT.ID_DOCUMENTO_SPESA = DS.ID_DOCUMENTO_SPESA 	\n"
        + "	AND DS.ID_PROCEDIMENTO = :ID_PROCEDIMENTO 				\n"
        + "	AND VA.ISTAT_COMUNE(+) = A.EXT_ISTAT_COMUNE_SEDE_LEGALE  				\n"
        + " ORDER BY A.RAGIONE_SOCIALE             					\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateProgressiviEliminazioneAttivita(long idAttivita,
      Long progressivo) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateProgressivoAttivita]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        \n"
        + "   IUF_T_ATTIVITA                                 			  \n"
        + " SET                                                           \n"
        + "   PROGRESSIVO = PROGRESSIVO-1			                      \n"
        + " WHERE                                                         \n"
        + "   ID_DATI_PROCEDIMENTO = (SELECT ID_DATI_PROCEDIMENTO FROM IUF_T_ATTIVITA WHERE ID_ATTIVITA = :ID_ATTIVITA)	\n"
        + "	AND PROGRESSIVO > :PROGRESSIVO								  \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_ATTIVITA", idAttivita, Types.NUMERIC);
      mapParameterSource.addValue("PROGRESSIVO", progressivo, Types.NUMERIC);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idAttivita", idAttivita),
              new LogParameter("progressivo", progressivo)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<RigaRendicontazioneDocumentiSpesaDTO> getListInterventiByIdDocumentoSpesa(
      long idDocumentoSpesa) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getListInterventiByIdDocumentoSpesa]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                                                                                                               \n"
        + "   D.PROGRESSIVO,                                                                                                                                     \n"
        + "   C.DESCRIZIONE AS DESC_INTERVENTO,                                                                                                                  \n"
        + "   B.ID_INTERVENTO,                                                                                                                  \n"
        + "                                                                                                                                                      \n"
        + "   (                                                                                                                                                  \n"
        + "    (SELECT NVL(SUM(F1.IMPORTO),0) FROM IUF_R_DOCUMENTO_SPESA_INTERV F1                                                                             \n"
        + "    WHERE F1.ID_DOCUMENTO_SPESA = A.ID_DOCUMENTO_SPESA                                                                                               \n"
        + "    AND F1.ID_INTERVENTO = B.ID_INTERVENTO)                                                                                               \n"
        + "  -                                                                                                                                                   \n"
        + "    (SELECT NVL(SUM(F2.IMPORTO_RENDICONTATO),0) FROM IUF_R_DOC_SPESA_INT_PROC_OGG F2 , IUF_R_DOCUMENTO_SPESA_INTERV C2                              \n"
        + "    WHERE F2.ID_DOCUMENTO_SPESA_INTERVEN = C2.ID_DOCUMENTO_SPESA_INTERVEN AND C2.ID_DOCUMENTO_SPESA = A.ID_DOCUMENTO_SPESA                            \n"
        + "    AND C2.ID_INTERVENTO = B.ID_INTERVENTO                            \n"
        + "    AND F2.ID_PROCEDIMENTO_OGGETTO IN (SELECT B2.ID_PROCEDIMENTO_OGGETTO FROM IUF_T_PROCEDIMENTO_OGGETTO B2, IUF_T_ITER_PROCEDIMENTO_OGGE B3 WHERE  \n"
        + "                                       B2.ID_PROCEDIMENTO = SP.ID_PROCEDIMENTO AND B3.ID_PROCEDIMENTO_OGGETTO = B2.ID_PROCEDIMENTO_OGGETTO            \n"
        + "                                       AND B3.ID_STATO_OGGETTO IN (10,22))                                                                            \n"
        + "     )                                                                                                                                                \n"
        + "  +                                                                                                                                                   \n"
        + "    ( SELECT NVL(SUM(C1.IMPORTO_DISPONIBILE),0) FROM IUF_R_DOC_SPESA_INT_ACC_SPES C1, IUF_R_DOCUMENTO_SPESA_INTERV C2                              \n"
        + "     WHERE C1.ID_DOCUMENTO_SPESA_INTERVEN= C2.ID_DOCUMENTO_SPESA_INTERVEN AND C2.ID_DOCUMENTO_SPESA = A.ID_DOCUMENTO_SPESA                            \n"
        + "    AND C2.ID_INTERVENTO = B.ID_INTERVENTO                            \n"
        + "     AND C1.ID_PROCEDIMENTO_OGGETTO IN (SELECT B2.ID_PROCEDIMENTO_OGGETTO FROM IUF_T_PROCEDIMENTO_OGGETTO B2, IUF_T_ITER_PROCEDIMENTO_OGGE B3 WHERE \n"
        + "                                       B2.ID_PROCEDIMENTO = SP.ID_PROCEDIMENTO AND B3.ID_PROCEDIMENTO_OGGETTO = B2.ID_PROCEDIMENTO_OGGETTO            \n"
        + "                                       AND B3.ID_STATO_OGGETTO IN (10,22)))                                                                           \n"
        + "  )AS IMPORTO_DA_RENDICONTARE,                                                                                                                        \n"
        + "                                                                                                                                                      \n"
        + " ( ( SELECT SUM(F3.IMPORTO_RENDICONTATO) FROM IUF_R_DOC_SPESA_INT_PROC_OGG F3  , IUF_R_DOCUMENTO_SPESA_INTERV C2                                       \n"
        + "  WHERE F3.ID_DOCUMENTO_SPESA_INTERVEN = C2.ID_DOCUMENTO_SPESA_INTERVEN AND C2.ID_DOCUMENTO_SPESA = A.ID_DOCUMENTO_SPESA                              \n"
        + "    AND C2.ID_INTERVENTO = B.ID_INTERVENTO                            \n"
        + "  AND F3.ID_PROCEDIMENTO_OGGETTO IN (SELECT B2.ID_PROCEDIMENTO_OGGETTO FROM IUF_T_PROCEDIMENTO_OGGETTO B2, IUF_T_ITER_PROCEDIMENTO_OGGE B3     		\n"
        + "										, IUF_T_PROCEDIMENTO P3 WHERE P3.ID_PROCEDIMENTO = B2.ID_PROCEDIMENTO AND P3.ID_STATO_OGGETTO <= 90 AND 		\n"
        + "                                       B2.ID_PROCEDIMENTO = SP.ID_PROCEDIMENTO AND B3.ID_PROCEDIMENTO_OGGETTO = B2.ID_PROCEDIMENTO_OGGETTO            \n"
        + "                                       AND B3.ID_STATO_OGGETTO IN (10,22))   )                                                                         \n"
        + "  -                                                                                                                                                   \n"
        + "    ( SELECT NVL(SUM(C1.IMPORTO_DISPONIBILE),0) FROM IUF_R_DOC_SPESA_INT_ACC_SPES C1, IUF_R_DOCUMENTO_SPESA_INTERV C2                              \n"
        + "     WHERE C1.ID_DOCUMENTO_SPESA_INTERVEN= C2.ID_DOCUMENTO_SPESA_INTERVEN AND C2.ID_DOCUMENTO_SPESA = A.ID_DOCUMENTO_SPESA                            \n"
        + "    AND C2.ID_INTERVENTO = B.ID_INTERVENTO                            \n"
        + "     AND C1.ID_PROCEDIMENTO_OGGETTO IN (SELECT B2.ID_PROCEDIMENTO_OGGETTO FROM IUF_T_PROCEDIMENTO_OGGETTO B2, IUF_T_ITER_PROCEDIMENTO_OGGE B3 	   \n"
        + "                                       B2.ID_PROCEDIMENTO = SP.ID_PROCEDIMENTO AND B3.ID_PROCEDIMENTO_OGGETTO = B2.ID_PROCEDIMENTO_OGGETTO            \n"
        + "                                       AND B3.ID_STATO_OGGETTO IN (10,22)))                                                                           \n"

        + " ) AS IMPORTO_RENDICONTATO                                                                                                                            \n"
        + "                                                                                                                                                      \n"
        + "                                                                                                                                                      \n"
        + " FROM                                                                                                                                                 \n"
        + "   IUF_T_DOCUMENTO_SPESA SP,                                                                                                                          \n"
        + "   IUF_R_DOCUMENTO_SPESA_INTERV A,                                                                                                                  \n"
        + "   IUF_T_INTERVENTO B,                                                                                                                                \n"
        + "   IUF_D_DESCRIZIONE_INTERVENTO C,                                                                                                                    \n"
        + "   IUF_T_DETTAGLIO_INTERVENTO D                                                                                                                       \n"
        + " WHERE                                                                                                                                                \n"
        + "   A.ID_DOCUMENTO_SPESA = :ID_DOCUMENTO_SPESA                                                                                                         \n"
        + "   AND SP.ID_DOCUMENTO_SPESA = A.ID_DOCUMENTO_SPESA                                                                                                   \n"
        + "   AND A.ID_INTERVENTO = B.ID_INTERVENTO                                                                                                              \n"
        + "   AND B.ID_DESCRIZIONE_INTERVENTO = C.ID_DESCRIZIONE_INTERVENTO                                                                                      \n"
        + "   AND D.ID_INTERVENTO = B.ID_INTERVENTO                                                                                                              \n"
        + "   AND D.DATA_FINE IS NULL                                                                                                                            \n"
        + " ORDER BY D.PROGRESSIVO                                                                                                                               \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          RigaRendicontazioneDocumentiSpesaDTO.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<DecodificaDTO<Long>> geElencoFornitoriRicercaFatture(String CUAA,
      String denominazione) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getElencoTecniciDisponibili]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT		                                                                           		 	\n"
        + "   ID_FORNITORE AS ID,                                                                                       \n"
        + "   TRIM(CODICE_FORNITORE) || ' - ' ||  RAGIONE_SOCIALE AS CODICE,           		                                \n"
        + "   INDIRIZZO_SEDE_LEGALE AS DESCRIZIONE										                                \n"
        + " FROM                                                                                                        \n"
        + "   IUF_T_FORNITORE                                                                            				\n"
        + " WHERE 		                                                                                                \n";
    if (CUAA != null && CUAA.compareTo("") != 0)
      QUERY += " UPPER(CODICE_FORNITORE) = UPPER(:CUAA)                                                     	\n";
    if (denominazione != null && denominazione.compareTo("") != 0)
    {
      if (CUAA != null && CUAA.compareTo("") != 0)
        QUERY += "   AND	   						                                                        \n";
      QUERY += "      UPPER(RAGIONE_SOCIALE) LIKE UPPER(:DENOMINAZIONE)                                      \n";
    }

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("CUAA", CUAA, Types.VARCHAR);
    mapParameterSource.addValue("DENOMINAZIONE", "%" + denominazione + "%",
        Types.VARCHAR);

    try
    {
      return queryForDecodificaLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("CUAA", CUAA),
              new LogParameter("denominazione", CUAA) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Boolean isComunicazionePagamento(long idOggetto, String cuName)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isComunicazionePagamento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                  \n"
        + "   A.EXT_ID_TIPO_DOCUMENTO               \n"
        + " FROM                                    \n"
        + "   IUF_R_OGGETTO_ICONA A,                \n"
        + "   IUF_D_ELENCO_CDU B                    \n"
        + " WHERE                                   \n"
        + "   A.ID_OGGETTO = :ID_OGGETTO            \n"
        + "   AND A.ID_ELENCO_CDU = B.ID_ELENCO_CDU \n"
        + "   AND B.CODICE_CDU = :CODICE_CDU        \n"
        + "   AND A.EXT_ID_TIPO_DOCUMENTO = :ID_TIPO_DOCUMENTO    \n";

    if (cuName.indexOf("-P") > 0 || cuName.indexOf("-N") > 0)
    {
      cuName = cuName.substring(0, cuName.lastIndexOf("-"));
    }

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_OGGETTO", idOggetto, Types.NUMERIC);
    mapParameterSource.addValue("CODICE_CDU", cuName, Types.VARCHAR);
    mapParameterSource.addValue("ID_TIPO_DOCUMENTO",
        IuffiConstants.TIPO_DOCUMENTO.COMUNICAZIONE_ESITO_PAGAMENTO,
        Types.NUMERIC);

    try
    {
      Boolean res = namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return Boolean.TRUE;
              }
              return Boolean.FALSE;
            }
          });
      return res;
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          { new LogParameter("idOggetto", idOggetto),
              new LogParameter("cuName", cuName) },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean findFornitore(FornitoreDTO fornitore)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::findFornitore]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                         		 \n"
        + "   ID_FORNITORE 	 			 		 \n"
        + " FROM                                   \n"
        + "   IUF_T_FORNITORE A         			 \n"
        + " WHERE				        			 \n"
        + " 	A.CODICE_FORNITORE = :CODICE_FORNITORE  \n"
        + " 	AND A.RAGIONE_SOCIALE = :RAGIONE_SOCIALE  \n"
        + " 	AND A.INDIRIZZO_SEDE_LEGALE = :INDIRIZZO_SEDE_LEGALE  \n"
        + " 	AND A.EXT_ISTAT_COMUNE_SEDE_LEGALE = :EXT_ISTAT_COMUNE_SEDE_LEGALE  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();

    try
    {
      mapParameterSource.addValue("CODICE_FORNITORE",
          fornitore.getCodiceFornitore(), Types.VARCHAR);
      mapParameterSource.addValue("RAGIONE_SOCIALE",
          fornitore.getRagioneSociale(), Types.VARCHAR);
      mapParameterSource.addValue("INDIRIZZO_SEDE_LEGALE",
          fornitore.getIndirizzoSedeLegale(), Types.VARCHAR);
      mapParameterSource.addValue("EXT_ISTAT_COMUNE_SEDE_LEGALE",
          fornitore.getExtIstatComuneSedeLegale(), Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getStatoOggetto(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getStatoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                       		 	\n"
        + "   SO.DESCRIZIONE												\n"
        + " FROM                                                         	\n"
        + "   IUF_T_ITER_PROCEDIMENTO_GRUP PG,                         	\n"
        + "   IUF_D_STATO_OGGETTO SO                                      	\n"
        + " WHERE                                               	     	\n"
        + "   PG.ID_PROCEDIMENTO     = :ID_PROCEDIMENTO         			\n"
        + "   AND PG.ID_STATO_OGGETTO = SO.ID_STATO_OGGETTO			  		\n"
        + "   AND PG.DATA_FINE IS NULL								  		\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean docSpesaHasIntervento(long idDocumentoSpesa, long idIntervento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::docSpesaHasIntervento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " SELECT                                                                         \n"
        + "   ID_DOCUMENTO_SPESA		                                                                 \n"
        + " FROM                                                                                       \n"
        + "   IUF_R_DOCUMENTO_SPESA_INTERV		                                                     \n"
        + " WHERE                                                                                      \n"
        + "   ID_DOCUMENTO_SPESA = :ID_DOCUMENTO_SPESA                                                 \n"
        + "   AND ID_INTERVENTO = :ID_INTERVENTO                              						 \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_INTERVENTO", idIntervento, Types.VARCHAR);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateRDocSpesaIntervento(long idDocumentoSpesa,
      ImportoInterventoVO importo) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateNoteProcedimentoOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        		\n"
        + "   IUF_R_DOCUMENTO_SPESA_INTERV                                \n"
        + " SET                                                           	\n"
        + "   IMPORTO = :IMPORTO             						        \n"
        + " WHERE                                                         	\n"
        + "   ID_DOCUMENTO_SPESA = :ID_DOCUMENTO_SPESA          			\n"
        + "	  AND ID_INTERVENTO = :ID_INTERVENTO							\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_INTERVENTO", importo.getIdIntervento(),
          Types.NUMERIC);
      mapParameterSource.addValue("IMPORTO", importo.getImporto(),
          Types.NUMERIC);

      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa),
              new LogParameter("idIntervento", importo.getIdIntervento()),
              new LogParameter("importo", importo.getImporto())
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public BigDecimal findImportoRendicontaTO(long idDocumentoSpesa,
      long idIntervento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::findImportoDaRendicontare]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = "  "
        + " WITH PONUM AS (																			\n"
        + "  	SELECT DISTINCT PO.ID_PROCEDIMENTO_OGGETTO,											\n"
        + "			(	SELECT  																	\n"
        + "					COUNT(*) 																\n"
        + "				FROM 																		\n"
        + "					IUF_T_PROCEDIMENTO_OGGETTO PO1,											\n"
        + "					IUF_D_ESITO E															\n"
        + "				WHERE																		\n"
        + "					PO1.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO								\n"
        + "					AND PO1.ID_ESITO = E.ID_ESITO											\n"
        + "					AND E.CODICE = 'APP-N'													\n"
        + "					AND PO1.ID_PROCEDIMENTO_OGGETTO<>PO.ID_PROCEDIMENTO_OGGETTO				\n"
        + "					AND PO1.CODICE_RAGGRUPPAMENTO = PO.CODICE_RAGGRUPPAMENTO				\n"
        + "				) NUMERO_IST_NEG															\n"
        + "		FROM																				\n"
        + "			IUF_R_DOC_SPESA_INT_PROC_OGG A,													\n"
        + "			IUF_R_DOCUMENTO_SPESA_INTERV B, 												\n"
        + "			IUF_T_PROCEDIMENTO_OGGETTO PO													\n"
        + "		WHERE																				\n"
        + "			B.ID_DOCUMENTO_SPESA =:ID_DOCUMENTO_SPESA										\n"
        + "			AND PO.ID_PROCEDIMENTO_OGGETTO = A.ID_PROCEDIMENTO_OGGETTO						\n"
        + "			AND A.ID_DOCUMENTO_SPESA_INTERVEN = B.ID_DOCUMENTO_SPESA_INTERVEN)				\n"
        + "SELECT                                         											\n"
        + "         SUM(IMPORTO_RENDICONTATO) AS RENDICONTATO                  						\n"
        + "     FROM                                                     							\n"
        + "         IUF_R_DOC_SPESA_INT_PROC_OGG A,													\n"
        + "			IUF_R_DOCUMENTO_SPESA_INTERV B,   											\n"
        + "			IUF_T_PROCEDIMENTO_OGGETTO PO,   												\n"
        + "			PONUM PON                        												\n"
        + " 	WHERE 																				\n"
        + "	 		B.ID_DOCUMENTO_SPESA =:ID_DOCUMENTO_SPESA										\n"
        + "	 		AND A.ID_DOCUMENTO_SPESA_INTERVEN = B.ID_DOCUMENTO_SPESA_INTERVEN				\n"
        + "	 		AND B.ID_INTERVENTO =:ID_INTERVENTO												\n"
        + "			AND PO.ID_PROCEDIMENTO_OGGETTO = A.ID_PROCEDIMENTO_OGGETTO						\n"
        + "			AND PON.ID_PROCEDIMENTO_OGGETTO=PO.ID_PROCEDIMENTO_OGGETTO						\n"
        + "	        AND PON.NUMERO_IST_NEG<2														\n";

    /*
     * final String QUERY =
     * "  SELECT                                                                           			\n"
     * +
     * " SUM(  ( NVL(C.IMPORTO_RENDICONTATO,0)                                             \n"
     * +
     * "     - NVL(                                                                        \n"
     * +
     * "     (                                                                             \n"
     * +
     * "       SELECT                                                                      \n"
     * +
     * "         B.IMPORTO_DISPONIBILE                                                     \n"
     * +
     * "       FROM                                                                        \n"
     * +
     * "         IUF_R_DOC_SPESA_INT_ACC_SPES B                                           \n"
     * +
     * "       WHERE                                                                       \n"
     * +
     * "          A.ID_DOCUMENTO_SPESA_INTERVEN = B.ID_DOCUMENTO_SPESA_INTERVEN            \n"
     * +
     * "          AND EXISTS (                                                             \n"
     * +
     * "             SELECT D1.ID_STATO_OGGETTO                                            \n"
     * +
     * "             FROM IUF_T_PROCEDIMENTO_OGGETTO C1, IUF_T_ITER_PROCEDIMENTO_OGGE D1 \n"
     * +
     * "             WHERE D1.ID_PROCEDIMENTO_OGGETTO = C1.ID_PROCEDIMENTO_OGGETTO         \n"
     * +
     * "             AND C1.ID_PROCEDIMENTO_OGGETTO = B.ID_PROCEDIMENTO_OGGETTO            \n"
     * +
     * "             AND D1.ID_STATO_OGGETTO = 22                                          \n"
     * +
     * "             )                                                                     \n"
     * +
     * "       ) ,0)                                                                       \n"
     * +
     * "    ) )AS RENDICONTATO                                                             \n"
     * +
     * "  FROM                                                                             \n"
     * +
     * "   IUF_R_DOCUMENTO_SPESA_INTERV A,                                               \n"
     * +
     * "   IUF_R_DOC_SPESA_INT_PROC_OGG C,                                                 \n"
     * + "   IUF_T_PROCEDIMENTO P, 															\n" +
     * "   IUF_T_PROCEDIMENTO_OGGETTO PO   												\n"
     * 
     * +
     * "  WHERE                                                                            \n"
     * +
     * "   PO.ID_PROCEDIMENTO_OGGETTO = C.ID_PROCEDIMENTO_OGGETTO 							\n"
     * + "	AND P.ID_PROCEDIMENTO = PO.ID_PROCEDIMENTO							 			\n" +
     * "	AND P.ID_STATO_OGGETTO <= 90 													\n" +
     * "	AND A.ID_DOCUMENTO_SPESA = :ID_DOCUMENTO_SPESA                                  \n"
     * +
     * "   AND A.ID_INTERVENTO = :ID_INTERVENTO                                            \n"
     * +
     * "   AND A.ID_DOCUMENTO_SPESA_INTERVEN = C.ID_DOCUMENTO_SPESA_INTERVEN (+)           \n"
     * ;
     */

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_DOCUMENTO_SPESA", idDocumentoSpesa,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_INTERVENTO", idIntervento, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<BigDecimal>()
          {

            @Override
            public BigDecimal extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              BigDecimal ret = null;
              if (rs.next())
              {
                ret = rs.getBigDecimal("RENDICONTATO");
              }
              return ret;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idDocumentoSpesa", idDocumentoSpesa),
              new LogParameter("idIntervento", idIntervento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public List<String> getMacroCDUList(long idLegameGruppoOggetto)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getMacroCDUList]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                           \n"
        + "   AZ.EXT_COD_MACRO_CDU                                           \n"
        + " FROM                                                             \n"
        + "   IUF_R_QUADRO_OGGETTO_AZIONE AZ,                                \n"
        + "   IUF_R_QUADRO_OGGETTO QO,                                       \n"
        + "   IUF_R_BANDO_OGGETTO_QUADRO BOQ,                                \n"
        + "   IUF_R_BANDO_OGGETTO BO,                                        \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO LGO                                \n"
        + " WHERE                                                            \n"
        + "   LGO.ID_LEGAME_GRUPPO_OGGETTO = :ID_LEGAME_GRUPPO_OGGETTO       \n"
        + "   AND LGO.ID_LEGAME_GRUPPO_OGGETTO = BO.ID_LEGAME_GRUPPO_OGGETTO \n"
        + "   AND BO.ID_BANDO_OGGETTO = BOQ.ID_BANDO_OGGETTO                 \n"
        + "   AND BOQ.ID_QUADRO_OGGETTO = QO.ID_QUADRO_OGGETTO               \n"
        + "   AND QO.ID_QUADRO_OGGETTO = AZ.ID_QUADRO_OGGETTO                \n"
        + "   GROUP BY AZ.EXT_COD_MACRO_CDU                                  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_LEGAME_GRUPPO_OGGETTO",
          idLegameGruppoOggetto, Types.NUMERIC);

      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<List<String>>()
          {

            @Override
            public List<String> extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              List<String> list = new ArrayList<>();
              while (rs.next())
              {
                list.add(rs.getString("EXT_COD_MACRO_CDU"));
              }
              return list;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idLegameGruppoOggetto", idLegameGruppoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public MainControlloDTO callMainApprovazione(long idProcedimentoOggetto,
      long idEsito, long idUtenteLogin, String note)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainApprovazione";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_GESTIONE_PROC_OGGETT.MainApprovazione");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PIDESITO", idEsito, Types.NUMERIC);
      parameterSource.addValue("PNOTE", note, Types.VARCHAR);
      parameterSource.addValue("PNOTEGRUPPO", null, Types.VARCHAR);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_GESTIONE_PROC_OGGETT")
              .withProcedureName("MainApprovazione")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDESITO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PNOTE", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PNOTEGRUPPO", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public MainControlloDTO callMainAvvioIstruttoria(long idProcedimentoOggetto,
      long idUtenteLogin)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainAvvioIstruttoria";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_GESTIONE_PROC_OGGETT.MainAvvioIstruttoria");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PNOTE", null, Types.VARCHAR);
      parameterSource.addValue("PNOTEGRUPPO", null, Types.VARCHAR);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_GESTIONE_PROC_OGGETT")
              .withProcedureName("MainAvvioIstruttoria")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PNOTE", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PNOTEGRUPPO", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public MainControlloDTO callMainCalcoloPremio(long idProcedimentoOggetto,
      long idUtenteLogin)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainCalcoloPremio";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_GESTIONE_PROC_OGGETT.MainCalcoloPremio");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PNOTE", null, Types.VARCHAR);
      parameterSource.addValue("PNOTEGRUPPO", null, Types.VARCHAR);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_GESTIONE_PROC_OGGETT")
              .withProcedureName("MainCalcoloPremio")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PNOTE", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PNOTEGRUPPO", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public MainControlloDTO callMainTrasmissione(long idProcedimentoOggetto,
      long idUtenteLogin, String note)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "callMainTrasmissione";
    StringBuffer CALL = new StringBuffer(
        "PCK_IUF_GESTIONE_PROC_OGGETT.MainTrasmissione");
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] BEGIN.");
    }
    try
    {
      MapSqlParameterSource parameterSource = new MapSqlParameterSource();
      parameterSource.addValue("PIDPROCEDIMENTOOGGETTO", idProcedimentoOggetto,
          Types.NUMERIC);
      parameterSource.addValue("PIDESITO", null, Types.NUMERIC);
      parameterSource.addValue("PNOTE", note, Types.VARCHAR);
      parameterSource.addValue("PNOTEGRUPPO", null, Types.VARCHAR);
      parameterSource.addValue("PEXTIDUTENTE", idUtenteLogin, Types.NUMERIC);

      SimpleJdbcCall call = new SimpleJdbcCall(
          (DataSource) appContext.getBean("dataSource"))
              .withCatalogName("PCK_IUF_GESTIONE_PROC_OGGETT")
              .withProcedureName("MainTrasmissione")
              .withoutProcedureColumnMetaDataAccess();

      call.addDeclaredParameter(
          new SqlParameter("PIDPROCEDIMENTOOGGETTO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PIDESITO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlParameter("PNOTE", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PNOTEGRUPPO", java.sql.Types.VARCHAR));
      call.addDeclaredParameter(
          new SqlParameter("PEXTIDUTENTE", java.sql.Types.NUMERIC));

      call.addDeclaredParameter(
          new SqlOutParameter("PRISULTATO", java.sql.Types.NUMERIC));
      call.addDeclaredParameter(
          new SqlOutParameter("PMESSAGGIO", java.sql.Types.VARCHAR));

      Map<String, Object> results = call.execute(parameterSource);

      MainControlloDTO dto = new MainControlloDTO();
      dto.setRisultato(((BigDecimal) results.get("PRISULTATO")).intValue());
      dto.setMessaggio(safeMessaggioPLSQL((String) results.get("PMESSAGGIO")));
      return dto;

    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          CALL.toString());
      logInternalUnexpectedException(e,
          "[" + THIS_CLASS + ":: " + THIS_METHOD + "]");
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + ":: " + THIS_METHOD + "] END.");
      }
    }
  }

  public int insertLog(String descrizione) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::insertLog]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      \n"
        + " INTO                                        \n"
        + "   IUF_T_LOG            \n"
        + "   (                                         \n"
        + "     ID_LOG,            \n"
        + "     DESCRIZIONE_ERRORE                        \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_LOG.NEXTVAL, \n"
        + "     :DESCRIZIONE_ERRORE                       \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("DESCRIZIONE_ERRORE", descrizione,
          Types.VARCHAR);
      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("descrizione", descrizione)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isPrimoOggettoDelGruppo(long idProcedimento,
      long codiceRaggruppamento)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isPrimoOggettoDelGruppo]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT           													\n"
        + "   COUNT(*)                      									\n"
        + "FROM 																\n"
        + "		IUF_T_PROCEDIMENTO_OGGETTO A									\n"
        + "WHERE 																\n"
        + "		A.CODICE_RAGGRUPPAMENTO=:CODICE_RAGGRUPPAMENTO					\n"
        + "		AND A.ID_PROCEDIMENTO=:ID_PROCEDIMENTO 							\n";

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("CODICE_RAGGRUPPAMENTO", codiceRaggruppamento,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) == 1;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean hasTecnico(long idProcedimento)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::hasTecnico]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT           													\n"
        + "   COUNT(*)                      									\n"
        + "FROM 																\n"
        + "		IUF_T_PROCEDIM_AMMINISTRAZIO 									\n"
        + "WHERE 																\n"
        + "		EXT_ID_TECNICO IS NOT NULL			 							\n"
        + "		AND DATA_FINE IS NULL					 						\n"
        + "		AND ID_PROCEDIMENTO=:ID_PROCEDIMENTO 							\n";

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) != 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public int insertNuovaAmmCompetenzaProcedimento(long idProcedimento,
      Long extIdAmm, Long extIdUffZona, Long extIdUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::insertNuovaAmmCompetenzaProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " INSERT                                      		\n"
        + " INTO                                        \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO            \n"
        + "   (                                         \n"
        + "     ID_PROCEDIM_AMMINISTRAZIONE,            \n"
        + "     ID_PROCEDIMENTO,                        \n"
        + "     EXT_ID_AMM_COMPETENZA,                  \n"
        + "     EXT_ID_UFFICIO_ZONA,  	                \n"
        + "     DATA_INIZIO,                            \n"
        + "     EXT_ID_UTENTE_AGGIORNAMENTO             \n"
        + "   )                                         \n"
        + "   VALUES                                    \n"
        + "   (                                         \n"
        + "     SEQ_IUF_T_PROCEDIM_AMMINISTR.NEXTVAL, \n"
        + "     :ID_PROCEDIMENTO,                       \n"
        + "     :EXT_ID_AMM_COMPETENZA,                 \n"
        + "     :EXT_ID_UFFICIO_ZONA,                 	\n"
        + "     SYSDATE,                                \n"
        + "     :EXT_ID_UTENTE_AGGIORNAMENTO            \n"
        + "   )                                         \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_AMM_COMPETENZA", extIdAmm,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UFFICIO_ZONA", extIdUffZona,
          Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          extIdUtenteAggiornamento, Types.NUMERIC);

      return namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento),
              new LogParameter("idAmmCompetenza", extIdAmm),
              new LogParameter("extIdUffZona", extIdUffZona),
              new LogParameter("extIdUtenteAggiornamento",
                  extIdUtenteAggiornamento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdUfficioZona(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdUfficioZona]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                  		\n"
        + "   PA.EXT_ID_UFFICIO_ZONA	            \n"
        + " FROM                                    \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO PA     \n"
        + " WHERE                                   \n"
        + "   PA.ID_PROCEDIMENTO = :ID_PROCEDIMENTO \n"
        + "   AND DATA_FINE     IS NULL             \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isSoggettoAdApprovazione(Long idOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isSoggettoAdApprovazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT           													\n"
        + "   COUNT(*)                      									\n"
        + "FROM 																\n"
        + "		IUF_R_OGGETTO_ICONA 											\n"
        + "WHERE 																\n"
        + "		ID_ICONA = 23							 						\n"
        + "		AND ID_OGGETTO=:ID_OGGETTO			 							\n";

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_OGGETTO", idOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) != 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean bandoHasLivWithVERCOD(long idBando)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::bandoHasLivWithVERCOD]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT           													\n"
        + "   COUNT(*)                      									\n"
        + "FROM 																\n"
        + "		IUF_R_LIVELLO_BANDO LB,											\n"
        + "		IUF_D_LIVELLO L 												\n"
        + "WHERE 																\n"
        + "		LB.ID_BANDO=:ID_BANDO					 						\n"
        + "		AND L.FLAG_VERCOD = 'S'				 							\n"
        + "		AND LB.ID_LIVELLO = L.ID_LIVELLO								\n";

    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_BANDO", idBando, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) != 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void updateVercodProcedimento(Long VERCOD, Date dataVisuraCamerale,
      Long idProcedimento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::updateVercodProcedimento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                                        	  \n"
        + "   IUF_T_PROCEDIMENTO		                                  \n"
        + " SET                                                           \n"
        + "   NUMERO_VERCOD = :VERCOD,                  				  \n"
        + "   DATA_VISURA 	= :DATA_VISURA								  \n"
        + " WHERE                                                         \n"
        + "   ID_PROCEDIMENTO = :ID_PROCEDIMENTO  					      \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("VERCOD", VERCOD, Types.NUMERIC);
      mapParameterSource.addValue("DATA_VISURA", dataVisuraCamerale,
          Types.DATE);
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("VERCOD", VERCOD),
              new LogParameter("ID_PROCEDIMENTO", idProcedimento),
              new LogParameter("DATA_VISURA", dataVisuraCamerale)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void deletedocSpesaIntervento(long[] idDocumentoSpesa,
      long idIntervento) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::deletedocSpesaIntervento]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }

    final String QUERY = " DELETE                                                 \n"
        + " FROM                                                   \n"
        + "   IUF_R_DOCUMENTO_SPESA_INTERV		                 \n"
        + " WHERE                                                  \n"
        + "   ID_INTERVENTO = :ID_INTERVENTO                       \n"
        + getInCondition("ID_DOCUMENTO_SPESA", idDocumentoSpesa);

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_INTERVENTO", idIntervento, Types.VARCHAR);
      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public boolean isEsitoApprovato(long idEsito)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isEsitoApprovato]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                            \n"
        + "   ID_ESITO                            			\n"
        + " FROM                                              \n"
        + "   IUF_D_ESITO                                    	\n"
        + " WHERE                                             \n"
        + "   ID_ESITO = :ID_ESITO 							\n"
        + "   AND ( CODICE LIKE 'APP%' OR CODICE LIKE 'NOLIQ%' ) 	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_ESITO", idEsito, Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<Boolean>()
          {
            @Override
            public Boolean extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (!rs.next())
              {
                return Boolean.FALSE;
              }
              else
              {
                return Boolean.TRUE;
              }
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idEsito", idEsito)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public Long getIdTecnicoCorrente(long idProcedimentoOggetto,
      long idQuadroOggetto) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::getIdTecnicoCorrente]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT NVL (                                                                                                                                                                  \n"
        + "   (SELECT A.EXT_ID_TECNICO FROM IUF_T_ESITO_TECNICO A WHERE A.ID_QUADRO_OGGETTO = :ID_QUADRO_OGGETTO AND A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO)                \n"
        + "   ,                                                                                                                                                                           \n"
        + "   (SELECT B.EXT_ID_FUNZIONARIO_ISTRUTTORE FROM IUF_T_ESITO_FINALE B WHERE B.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO) \n"
        + " ) AS ID_TECNICO FROM DUAL                                                                                                                                                     \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_QUADRO_OGGETTO", idQuadroOggetto,
          Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idQuadroOggetto", idQuadroOggetto),
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void storicizzaAmministrazione(long idProcedimAmministrazione)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::storicizzaAmministrazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE IUF_T_PROCEDIM_AMMINISTRAZIO           				\n"
        + "   SET DATA_FINE = SYSDATE 					    \n"
        + "  WHERE                						  	\n"
        + "   ID_PROCEDIM_AMMINISTRAZIONE = :ID_PROCEDIM_AMMINISTRAZIONE               	\n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIM_AMMINISTRAZIONE",
          idProcedimAmministrazione, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimAmministrazione",
                  idProcedimAmministrazione)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public long inserisciTProcedimAmministrazione(long idProcedimAmmRef,
      long idTecnico, long idUtenteAggiornamento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::inserisciTProcedimAmministrazione]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String INSERT = " INSERT INTO IUF_T_PROCEDIM_AMMINISTRAZIO                   \n"
        + " (                                                            \n"
        + "   ID_PROCEDIM_AMMINISTRAZIONE,                               \n"
        + "   ID_PROCEDIMENTO,                                           \n"
        + "   EXT_ID_AMM_COMPETENZA,                                     \n"
        + "   DATA_INIZIO,                                               \n"
        + "   DATA_FINE,                                                 \n"
        + "   EXT_ID_UTENTE_AGGIORNAMENTO,                               \n"
        + "   NOTE,                                                      \n"
        + "   EXT_ID_TECNICO,                                            \n"
        + "   EXT_ID_UFFICIO_ZONA                                        \n"
        + " )                                                            \n"
        + " SELECT                                                       \n"
        + "   SEQ_IUF_T_PROCEDIM_AMMINISTR.NEXTVAL,                   \n"
        + "   ID_PROCEDIMENTO,                                           \n"
        + "   EXT_ID_AMM_COMPETENZA,                                     \n"
        + "   SYSDATE,                                                   \n"
        + "   NULL,                                                      \n"
        + "   :EXT_ID_UTENTE_AGGIORNAMENTO,                              \n"
        + "   NULL,                                                      \n"
        + "   :EXT_ID_TECNICO,                                           \n"
        + "   EXT_ID_UFFICIO_ZONA                                        \n"
        + " FROM                                                         \n"
        + "   IUF_T_PROCEDIM_AMMINISTRAZIO                             \n"
        + " WHERE                                                        \n"
        + "   ID_PROCEDIM_AMMINISTRAZIONE = :ID_PROCEDIM_AMMINISTRAZIONE \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    long idRazzaAllevata = 0;
    try
    {
      mapParameterSource.addValue("EXT_ID_UTENTE_AGGIORNAMENTO",
          idUtenteAggiornamento, Types.NUMERIC);
      mapParameterSource.addValue("EXT_ID_TECNICO", idTecnico, Types.NUMERIC);
      mapParameterSource.addValue("ID_PROCEDIM_AMMINISTRAZIONE",
          idProcedimAmmRef, Types.NUMERIC);
      namedParameterJdbcTemplate.update(INSERT, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idUtenteAggiornamento", idUtenteAggiornamento),
              new LogParameter("idTecnico", idTecnico),
              new LogParameter("idProcedimAmmRef", idProcedimAmmRef)
          },
          new LogVariable[]
          {}, INSERT, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
    return idRazzaAllevata;
  }

  public boolean isOggettoIstanzaPagamentoByProcOggetto(
      long idProcedimentoOggetto)
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::isOggettoIstanzaByProcOggetto]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT               											\n"
        + "   COUNT(*)                          							\n"
        + " FROM                                							\n"
        + "   IUF_t_procedimento_oggetto a,     							\n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO B,								\n"
        + "	  IUF_D_OGGETTO C				        						\n"
        + " WHERE                               							\n"
        + "   A.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO 			\n"
        + "	  AND A.ID_LEGAME_GRUPPO_OGGETTO = B.ID_LEGAME_GRUPPO_OGGETTO	\n"
        + "   AND B.ID_OGGETTO = C.ID_OGGETTO								\n"
        + "   AND C.CODICE IN ('DANT','DSAL','DACC')								\n"
        + "   AND C.FLAG_ISTANZA = 'S' 										\n";
    try
    {
      MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
          idProcedimentoOggetto, Types.NUMERIC);
      return queryForLong(QUERY, mapParameterSource) > 0;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public OggettoDTO findDatiInvioPecByOggetto(long idProcedimentoOggetto)
      throws InternalUnexpectedException
  {
    final String THIS_METHOD = "findDatiInvioPecByOggetto";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    String QUERY = " SELECT                                                       \n"
        + "   C.OGGETTO_RICEVUTA_DEFAULT,                                \n"
        + "   C.CORPO_RICEVUTA_DEFAULT                                   \n"
        + " FROM                                                         \n"
        + "   IUF_R_LEGAME_GRUPPO_OGGETTO A,                             \n"
        + "   IUF_T_PROCEDIMENTO_OGGETTO PO,                             \n"
        + "   IUF_D_OGGETTO C                                            \n"
        + " WHERE                                                        \n"
        + "   PO.ID_LEGAME_GRUPPO_OGGETTO = A.ID_LEGAME_GRUPPO_OGGETTO   \n"
        + "   AND C.ID_OGGETTO = A.ID_OGGETTO                            \n"
        + "   AND PO.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO  \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO",
        idProcedimentoOggetto, Types.VARCHAR);
    try
    {
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<OggettoDTO>()
          {
            @Override
            public OggettoDTO extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              OggettoDTO ogg = new OggettoDTO();
              if (rs.next())
              {
                ogg.setOggettoRicevutaDefault(
                    rs.getString("OGGETTO_RICEVUTA_DEFAULT"));
                ogg.setCorpoRicevutaDefault(
                    rs.getString("CORPO_RICEVUTA_DEFAULT"));
              }
              return ogg;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto)
          },
          new LogVariable[]
          {
          }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }

  public void clearCodiceBpol(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::clearCodiceBpol]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                                  \n"
        + "   IUF_T_BPOL                         	\n"
        + " SET                                     \n"
        + "   CODICE_BPOL = NULL,    				\n"
        + "   FLAG_DEFINITIVO = 'N'    				\n"
        + " WHERE                                   \n"
        + "   ID_PROCEDIMENTO = :ID_PROCEDIMENTO	\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public void chiudiDefinitivoBPOL(long idBpol, String codice)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::chiudiDefinitivoBPOL]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String UPDATE = " UPDATE                      \n"
        + "   IUF_T_BPOL                \n"
        + " SET                         \n"
        + "   CODICE_BPOL = :CODICE,    \n"
        + "   FLAG_DEFINITIVO = 'S'    	\n"
        + " WHERE                       \n"
        + "   ID_BPOL = :ID_BPOL		\n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("CODICE", codice, Types.VARCHAR);
      mapParameterSource.addValue("ID_BPOL", idBpol, Types.NUMERIC);
      namedParameterJdbcTemplate.update(UPDATE, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("codice", codice),
              new LogParameter("idBpol", idBpol)
          },
          new LogVariable[]
          {}, UPDATE, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getProcedimentoEstrattoCampioneExPostDescr(long idProcedimento)
      throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS
        + "::getProcedimentoEstrattoCampioneExPostDescr]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT                                                        \n"
        + "  FE.DESCRIZIONE                                               \n"
        + " FROM                                                          \n"
        + "  IUF_T_PROCEDIMENTO_ESTR_EXPO PE,                              \n"
        + "  IUF_T_ESTRAZIONE_CAMPIONE EC,                                \n"
        + "  IUF_D_FLAG_ESTRATTA FE                                       \n"
        + " WHERE                                                         \n"
        + "   PE.ID_PROCEDIMENTO           = :ID_PROCEDIMENTO             \n"
        + "  AND EC.ID_ESTRAZIONE_CAMPIONE    = PE.ID_ESTRAZIONE_CAMPIONE \n"
        + "  AND EC.FLAG_APPROVATA            = 'S'                       \n"
        + "  AND EC.DATA_ANNULLAMENTO IS NULL                             \n"
        + "  AND FE.FLAG_ESTRATTA = PE.FLAG_ESTRATTA                      \n"
        + "  AND FE.FLAG_ESTRATTA <> 'N'                     \n";

    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO", idProcedimento,
          Types.NUMERIC);
      return namedParameterJdbcTemplate.query(QUERY, mapParameterSource,
          new ResultSetExtractor<String>()
          {
            @Override
            public String extractData(ResultSet rs)
                throws SQLException, DataAccessException
            {
              if (rs.next())
              {
                return rs.getString("DESCRIZIONE");
              }

              return null;
            }
          });
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimento", idProcedimento)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getCodClassRegionale(
      int idProcedimentoAgricolo, long idBando) throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT  "
        + "   NVL( (SELECT COD_CLASS_REGIONALE FROM IUF_D_BANDO WHERE ID_BANDO=:ID_BANDO), COD_CLASS_REGIONALE ) as COD_CLASS_REGIONALE                  "
        + "FROM IUF_D_PROCEDIMENTO_AGRICOLO WHERE ID_PROCEDIMENTO_AGRICOLO = :ID_PROCEDIMENTO_AGRICOLO "

    ;
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_AGRICOLO",
          idProcedimentoAgricolo, Types.NUMERIC);
      mapParameterSource.addValue("ID_BANDO",
          idBando, Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_PROCEDIMENTO_AGRICOLO",
                  idProcedimentoAgricolo)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }

  public String getMessaggioErrore(
      long idMessaggioErrore) throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY = " SELECT DESCRIZIONE FROM IUF_D_MESSAGGIO_ERRORE WHERE ID_MESSAGGIO_ERRORE = :ID_MESSAGGIO_ERRORE "

    ;
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_MESSAGGIO_ERRORE", idMessaggioErrore,
          Types.NUMERIC);
      return queryForString(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("ID_MESSAGGIO_ERRORE", idMessaggioErrore)
          }, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public List<RicercaDistretto> getIdDistrettoOgur(Long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    String methodName = new Object()
    {
    }.getClass().getEnclosingMethod().getName();
    String THIS_METHOD = "[" + THIS_CLASS + "::" + methodName + "]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    String QUERY = "select pdo.id_distretto as iddistretto, pdo.ID_OGUR_DA_REGIONE as iddistrettoregione from IUF_T_PIANO_OGUR PO " + 
        " left join IUF_T_PIANO_DISTRETTO_OGUR PDO on po.id_piano_ogur = pdo.id_piano_ogur " + 
        " where po.id_procedimento_oggetto = :ID_PROCEDIMENTO_OGGETTO";   
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    try
    {
      mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO", idProcedimentoOggetto, Types.NUMERIC);
      return queryForList(QUERY, mapParameterSource,
          RicercaDistretto.class);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {}, new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  public boolean isPraticaInElencoPerTrasmissioneMassiva(long idProcedimentoOggetto) throws InternalUnexpectedException
  {
    final String THIS_METHOD = "isPraticaInElencoPerTrasmissioneMassiva";
    if (logger.isDebugEnabled())
    {
      logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " BEGIN.");
    }
    final String QUERY =         " SELECT                                                  \n"
        + "   COUNT(*)                                              \n"
        + " FROM                                                    \n"
        + "   IUF_T_ELAB_MASSIVA EM                                 \n"
        + " WHERE                                                   \n"
        + "   EM.ID_PROCEDIMENTO_OGGETTO = :ID_PROCEDIMENTO_OGGETTO \n"
        + "   AND EM.TIPO_ELABORAZIONE   = 'TRMAS'                  \n"
        + "   AND EM.ESITO              <> '1'                      \n";
    MapSqlParameterSource mapParameterSource = new MapSqlParameterSource();
    mapParameterSource.addValue("ID_PROCEDIMENTO_OGGETTO", idProcedimentoOggetto, Types.NUMERIC);
    try
    {
      return namedParameterJdbcTemplate.queryForLong(QUERY, mapParameterSource) > 0; // In teoria dovrebbe essere solo 0 o 1
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
              {
                 new LogParameter("idProcedimentoOggetto", idProcedimentoOggetto),
              },
              new LogVariable[]
                  {
                      // new LogParameter("idVariabile", idVariabile),
                  }, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }
    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug("[" + THIS_CLASS + "." + THIS_METHOD + " END.");
      }
    }
  }
  
  
  public void chiudiIterStampaByKey(long idProcedimOggettoStampa) throws InternalUnexpectedException
  {
    String THIS_METHOD = "[" + THIS_CLASS + "::chiudiIterStampaByKey]";
    if (logger.isDebugEnabled())
    {
      logger.debug(THIS_METHOD + " BEGIN.");
    }
    final String QUERY =
          " UPDATE                                                        \n"
            + "   IUF_T_PROCEDIM_OGGETTO_STAMP                               \n"
            + " SET                                                           \n"
            + "   DATA_FINE = SYSDATE                                 \n"
            + " WHERE                                                         \n"
            + "   ID_PROCEDIM_OGGETTO_STAMPA = :ID_PROCEDIM_OGGETTO_STAMPA          \n";
    
    MapSqlParameterSource mapParameterSource = null;
    try
    {
      mapParameterSource = new MapSqlParameterSource();
      mapParameterSource.addValue("ID_PROCEDIM_OGGETTO_STAMPA", idProcedimOggettoStampa, Types.NUMERIC);
      
      namedParameterJdbcTemplate.update(QUERY, mapParameterSource);
    }
    catch (Throwable t)
    {
      InternalUnexpectedException e = new InternalUnexpectedException(t,
          new LogParameter[]
          {
              new LogParameter("idProcedimOggettoStampa", idProcedimOggettoStampa)
          },
          new LogVariable[]
          {}, QUERY, mapParameterSource);
      logInternalUnexpectedException(e, THIS_METHOD);
      throw e;
    }

    finally
    {
      if (logger.isDebugEnabled())
      {
        logger.debug(THIS_METHOD + " END.");
      }
    }
  }
  
  
}